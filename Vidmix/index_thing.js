
/*		if (window.location.href.indexOf("vidmix.app") != -1) {
			if (typeof SharedArrayBuffer === "undefined") {
				alert("SharedArrayBuffer missing!");
				window.location.href = "missingsupport.html";
			}
// 			if (navigator.userAgent.indexOf("iPhone") != -1) {
// 				window.location.href = "missingsupport.html";
// 			}
			if (window.safari !== undefined) {
				let safariOK = false;
				let uaparts = navigator.userAgent.split(" ");
				for (let ix = 0; ix < uaparts.length; ix++) {
					if (uaparts[ix].indexOf("Version/") == 0) {
						let vstr = uaparts[ix].substr(8); 
						let vparts = vstr.split(".");
						if (vparts.length >= 2) {
							let major = parseInt(vparts[0]); 
							let minor = parseInt(vparts[1]);
							alert("safari version: ",major,minor);
							if ((major >= 15) || (minor >= 4))
								safariOK = true;
						}
					}
				}
				if (!safariOK) {
					window.location.href = "missingsupport.html";				
				}				
			} else if ((navigator.userAgent.indexOf("Chrome") == -1) && (navigator.userAgent.indexOf("Firefox") == -1)) {
				alert("unknown browser");
				window.location.href = "missingsupport.html";
			}
		}
		*/
		
		function loadScript(src) {
			return new Promise(function (resolve, reject) {
				var s;
				s = document.createElement('script');
				s.src = src;
				s.onload = resolve;
				s.onerror = reject;
				document.head.appendChild(s);
			});
		}
		
		var FFmpegModule;
		var FFworker;

		async function startFF() {
				
			if ((typeof SharedArrayBuffer !== 'undefined') && (window.location.hash != "#nosab")) {
				try { 		
					if (WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]))) {
			//			console.log("has SIMD, hardwareConcurrency: "+navigator.hardwareConcurrency);
						await loadScript("ffmpeg-simd-1705683713.js");
					} else {
			//			console.log("no SIMD, hardwareConcurrency: "+navigator.hardwareConcurrency);
						await loadScript("ffmpeg-1705683713.js");
					}
				} catch (e) {
					console.log("Failed to load ffmpeg (js)");
				}
					
				FFmpegModuleCreate().then(function(fmodule) {
					FFmpegModule = fmodule;
				
					FFmpegModule.FS.mkdir("/LayerAssets");
					FFmpegModule.FS.mount(FFmpegModule.FS.filesystems.PROXYFS, {
						root: "/LayerAssets/",
						fs: FS
					}, "/LayerAssets/");					

					_jsFFmpegModuleFinishedLoading();							
				}).catch(function(error) {
					alert("..." + error);
				});
			} else {
				const b64toBlob = (b64Data, contentType='', sliceSize=512) => {
					const byteCharacters = atob(b64Data);
					const byteArrays = [];
				  
					for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
					  const slice = byteCharacters.slice(offset, offset + sliceSize);
				  
					  const byteNumbers = new Array(slice.length);
					  for (let i = 0; i < slice.length; i++) {
						byteNumbers[i] = slice.charCodeAt(i);
					  }
				  
					  const byteArray = new Uint8Array(byteNumbers);
					  byteArrays.push(byteArray);
					}
					  
					const blob = new Blob(byteArrays, {type: contentType});
					return blob;
				  }
				var wr = "ffbgworker.js"
				//wr = ""
				//wr = "https://cdn.jsdelivr.net/gh/jackb0back/streamingAssets@main/Vidmix/ffbgworker.js"
				var b64 = "";
				b64 = "CnZhciBGRm1wZWdNb2R1bGU7Cgp2YXIgRkZtcGVnTW9kdWxlQ3JlYXRlID0gKCgpID0+IHsKCXZhciBfc2NyaXB0RGlyID0gdHlwZW9mIGRvY3VtZW50ICE9PSAndW5kZWZpbmVkJyAmJiBkb2N1bWVudC5jdXJyZW50U2NyaXB0ID8gZG9jdW1lbnQuY3VycmVudFNjcmlwdC5zcmMgOiB1bmRlZmluZWQ7CglpZiAodHlwZW9mIF9fZmlsZW5hbWUgIT09ICd1bmRlZmluZWQnKSBfc2NyaXB0RGlyID0gX3NjcmlwdERpciB8fCBfX2ZpbGVuYW1lOwoJcmV0dXJuICgKCQlmdW5jdGlvbihGRm1wZWdNb2R1bGVDcmVhdGUgPSB7fSkgewogIAoJCQl2YXIgTW9kdWxlID0gdHlwZW9mIEZGbXBlZ01vZHVsZUNyZWF0ZSAhPSAidW5kZWZpbmVkIiA/IEZGbXBlZ01vZHVsZUNyZWF0ZSA6IHt9OwoJCQl2YXIgcmVhZHlQcm9taXNlUmVzb2x2ZSwgcmVhZHlQcm9taXNlUmVqZWN0OwoJCQlNb2R1bGVbInJlYWR5Il0gPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkJCQlyZWFkeVByb21pc2VSZXNvbHZlID0gcmVzb2x2ZTsKCQkJCXJlYWR5UHJvbWlzZVJlamVjdCA9IHJlamVjdAoJCQl9KTsKCQkJdmFyIG1vZHVsZU92ZXJyaWRlcyA9IE9iamVjdC5hc3NpZ24oe30sIE1vZHVsZSk7CgkJCXZhciBhcmd1bWVudHNfID0gW107CgkJCXZhciB0aGlzUHJvZ3JhbSA9ICIuL3RoaXMucHJvZ3JhbSI7CgkJCXZhciBxdWl0XyA9IChzdGF0dXMsIHRvVGhyb3cpID0+IHsKCQkJCXRocm93IHRvVGhyb3cKCQkJfTsKCQkJdmFyIEVOVklST05NRU5UX0lTX1dFQiA9IHR5cGVvZiB3aW5kb3cgPT0gIm9iamVjdCI7CgkJCXZhciBFTlZJUk9OTUVOVF9JU19XT1JLRVIgPSB0eXBlb2YgaW1wb3J0U2NyaXB0cyA9PSAiZnVuY3Rpb24iOwoJCQl2YXIgRU5WSVJPTk1FTlRfSVNfTk9ERSA9IHR5cGVvZiBwcm9jZXNzID09ICJvYmplY3QiICYmIHR5cGVvZiBwcm9jZXNzLnZlcnNpb25zID09ICJvYmplY3QiICYmIHR5cGVvZiBwcm9jZXNzLnZlcnNpb25zLm5vZGUgPT0gInN0cmluZyI7CgkJCXZhciBzY3JpcHREaXJlY3RvcnkgPSAiIjsKICAKCQkJZnVuY3Rpb24gbG9jYXRlRmlsZShwYXRoKSB7CgkJCQlpZiAoTW9kdWxlWyJsb2NhdGVGaWxlIl0pIHsKCQkJCQlyZXR1cm4gTW9kdWxlWyJsb2NhdGVGaWxlIl0ocGF0aCwgc2NyaXB0RGlyZWN0b3J5KQoJCQkJfQoJCQkJcmV0dXJuIHNjcmlwdERpcmVjdG9yeSArIHBhdGgKCQkJfQoJCQl2YXIgcmVhZF8sIHJlYWRBc3luYywgcmVhZEJpbmFyeSwgc2V0V2luZG93VGl0bGU7CgkJCWlmIChFTlZJUk9OTUVOVF9JU19OT0RFKSB7CgkJCQl2YXIgZnMgPSByZXF1aXJlKCJmcyIpOwoJCQkJdmFyIG5vZGVQYXRoID0gcmVxdWlyZSgicGF0aCIpOwoJCQkJaWYgKEVOVklST05NRU5UX0lTX1dPUktFUikgewoJCQkJCXNjcmlwdERpcmVjdG9yeSA9IG5vZGVQYXRoLmRpcm5hbWUoc2NyaXB0RGlyZWN0b3J5KSArICIvIgoJCQkJfSBlbHNlIHsKCQkJCQlzY3JpcHREaXJlY3RvcnkgPSBfX2Rpcm5hbWUgKyAiLyIKCQkJCX0KCQkJCXJlYWRfID0gKGZpbGVuYW1lLCBiaW5hcnkpID0+IHsKCQkJCQlmaWxlbmFtZSA9IGlzRmlsZVVSSShmaWxlbmFtZSkgPyBuZXcgVVJMKGZpbGVuYW1lKSA6IG5vZGVQYXRoLm5vcm1hbGl6ZShmaWxlbmFtZSk7CgkJCQkJcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhmaWxlbmFtZSwgYmluYXJ5ID8gdW5kZWZpbmVkIDogInV0ZjgiKQoJCQkJfTsKCQkJCXJlYWRCaW5hcnkgPSBmaWxlbmFtZSA9PiB7CgkJCQkJdmFyIHJldCA9IHJlYWRfKGZpbGVuYW1lLCB0cnVlKTsKCQkJCQlpZiAoIXJldC5idWZmZXIpIHsKCQkJCQkJcmV0ID0gbmV3IFVpbnQ4QXJyYXkocmV0KQoJCQkJCX0KCQkJCQlyZXR1cm4gcmV0CgkJCQl9OwoJCQkJcmVhZEFzeW5jID0gKGZpbGVuYW1lLCBvbmxvYWQsIG9uZXJyb3IsIGJpbmFyeSA9IHRydWUpID0+IHsKCQkJCQlmaWxlbmFtZSA9IGlzRmlsZVVSSShmaWxlbmFtZSkgPyBuZXcgVVJMKGZpbGVuYW1lKSA6IG5vZGVQYXRoLm5vcm1hbGl6ZShmaWxlbmFtZSk7CgkJCQkJZnMucmVhZEZpbGUoZmlsZW5hbWUsIGJpbmFyeSA/IHVuZGVmaW5lZCA6ICJ1dGY4IiwgKGVyciwgZGF0YSkgPT4gewoJCQkJCQlpZiAoZXJyKSBvbmVycm9yKGVycik7CgkJCQkJCWVsc2Ugb25sb2FkKGJpbmFyeSA/IGRhdGEuYnVmZmVyIDogZGF0YSkKCQkJCQl9KQoJCQkJfTsKCQkJCWlmICghTW9kdWxlWyJ0aGlzUHJvZ3JhbSJdICYmIHByb2Nlc3MuYXJndi5sZW5ndGggPiAxKSB7CgkJCQkJdGhpc1Byb2dyYW0gPSBwcm9jZXNzLmFyZ3ZbMV0ucmVwbGFjZSgvXFwvZywgIi8iKQoJCQkJfQoJCQkJYXJndW1lbnRzXyA9IHByb2Nlc3MuYXJndi5zbGljZSgyKTsKCQkJCXF1aXRfID0gKHN0YXR1cywgdG9UaHJvdykgPT4gewoJCQkJCXByb2Nlc3MuZXhpdENvZGUgPSBzdGF0dXM7CgkJCQkJdGhyb3cgdG9UaHJvdwoJCQkJfTsKCQkJCU1vZHVsZVsiaW5zcGVjdCJdID0gKCkgPT4gIltFbXNjcmlwdGVuIE1vZHVsZSBvYmplY3RdIgoJCQl9IGVsc2UgaWYgKEVOVklST05NRU5UX0lTX1dFQiB8fCBFTlZJUk9OTUVOVF9JU19XT1JLRVIpIHsKCQkJCWlmIChFTlZJUk9OTUVOVF9JU19XT1JLRVIpIHsKCQkJCQlzY3JpcHREaXJlY3RvcnkgPSBzZWxmLmxvY2F0aW9uLmhyZWYKCQkJCX0gZWxzZSBpZiAodHlwZW9mIGRvY3VtZW50ICE9ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQpIHsKCQkJCQlzY3JpcHREaXJlY3RvcnkgPSBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYwoJCQkJfQoJCQkJaWYgKF9zY3JpcHREaXIpIHsKCQkJCQlzY3JpcHREaXJlY3RvcnkgPSBfc2NyaXB0RGlyCgkJCQl9CgkJCQlpZiAoc2NyaXB0RGlyZWN0b3J5LmluZGV4T2YoImJsb2I6IikgIT09IDApIHsKCQkJCQlzY3JpcHREaXJlY3RvcnkgPSBzY3JpcHREaXJlY3Rvcnkuc3Vic3RyKDAsIHNjcmlwdERpcmVjdG9yeS5yZXBsYWNlKC9bPyNdLiovLCAiIikubGFzdEluZGV4T2YoIi8iKSArIDEpCgkJCQl9IGVsc2UgewoJCQkJCXNjcmlwdERpcmVjdG9yeSA9ICIiCgkJCQl9IHsKCQkJCQlyZWFkXyA9IHVybCA9PiB7CgkJCQkJCXZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3Q7CgkJCQkJCXhoci5vcGVuKCJHRVQiLCB1cmwsIGZhbHNlKTsKCQkJCQkJeGhyLnNlbmQobnVsbCk7CgkJCQkJCXJldHVybiB4aHIucmVzcG9uc2VUZXh0CgkJCQkJfTsKCQkJCQlpZiAoRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CgkJCQkJCXJlYWRCaW5hcnkgPSB1cmwgPT4gewoJCQkJCQkJdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdDsKCQkJCQkJCXhoci5vcGVuKCJHRVQiLCB1cmwsIGZhbHNlKTsKCQkJCQkJCXhoci5yZXNwb25zZVR5cGUgPSAiYXJyYXlidWZmZXIiOwoJCQkJCQkJeGhyLnNlbmQobnVsbCk7CgkJCQkJCQlyZXR1cm4gbmV3IFVpbnQ4QXJyYXkoeGhyLnJlc3BvbnNlKQoJCQkJCQl9CgkJCQkJfQoJCQkJCXJlYWRBc3luYyA9ICh1cmwsIG9ubG9hZCwgb25lcnJvcikgPT4gewoJCQkJCQl2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0OwoJCQkJCQl4aHIub3BlbigiR0VUIiwgdXJsLCB0cnVlKTsKCQkJCQkJeGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CgkJCQkJCXhoci5vbmxvYWQgPSAoKSA9PiB7CgkJCQkJCQlpZiAoeGhyLnN0YXR1cyA9PSAyMDAgfHwgeGhyLnN0YXR1cyA9PSAwICYmIHhoci5yZXNwb25zZSkgewoJCQkJCQkJCW9ubG9hZCh4aHIucmVzcG9uc2UpOwoJCQkJCQkJCXJldHVybgoJCQkJCQkJfQoJCQkJCQkJb25lcnJvcigpCgkJCQkJCX07CgkJCQkJCXhoci5vbmVycm9yID0gb25lcnJvcjsKCQkJCQkJeGhyLnNlbmQobnVsbCkKCQkJCQl9CgkJCQl9CgkJCQlzZXRXaW5kb3dUaXRsZSA9IHRpdGxlID0+IGRvY3VtZW50LnRpdGxlID0gdGl0bGUKCQkJfSBlbHNlIHt9CgkJCXZhciBvdXQgPSBNb2R1bGVbInByaW50Il0gfHwgY29uc29sZS5sb2cuYmluZChjb25zb2xlKTsKCQkJdmFyIGVyciA9IE1vZHVsZVsicHJpbnRFcnIiXSB8fCBjb25zb2xlLndhcm4uYmluZChjb25zb2xlKTsKCQkJT2JqZWN0LmFzc2lnbihNb2R1bGUsIG1vZHVsZU92ZXJyaWRlcyk7CgkJCW1vZHVsZU92ZXJyaWRlcyA9IG51bGw7CgkJCWlmIChNb2R1bGVbImFyZ3VtZW50cyJdKSBhcmd1bWVudHNfID0gTW9kdWxlWyJhcmd1bWVudHMiXTsKCQkJaWYgKE1vZHVsZVsidGhpc1Byb2dyYW0iXSkgdGhpc1Byb2dyYW0gPSBNb2R1bGVbInRoaXNQcm9ncmFtIl07CgkJCWlmIChNb2R1bGVbInF1aXQiXSkgcXVpdF8gPSBNb2R1bGVbInF1aXQiXTsKCQkJdmFyIHdhc21CaW5hcnk7CgkJCWlmIChNb2R1bGVbIndhc21CaW5hcnkiXSkgd2FzbUJpbmFyeSA9IE1vZHVsZVsid2FzbUJpbmFyeSJdOwoJCQl2YXIgbm9FeGl0UnVudGltZSA9IE1vZHVsZVsibm9FeGl0UnVudGltZSJdIHx8IHRydWU7CgkJCWlmICh0eXBlb2YgV2ViQXNzZW1ibHkgIT0gIm9iamVjdCIpIHsKCQkJCWFib3J0KCJubyBuYXRpdmUgd2FzbSBzdXBwb3J0IGRldGVjdGVkIikKCQkJfQoJCQl2YXIgd2FzbU1lbW9yeTsKCQkJdmFyIEFCT1JUID0gZmFsc2U7CgkJCXZhciBFWElUU1RBVFVTOwogIAoJCQlmdW5jdGlvbiBhc3NlcnQoY29uZGl0aW9uLCB0ZXh0KSB7CgkJCQlpZiAoIWNvbmRpdGlvbikgewoJCQkJCWFib3J0KHRleHQpCgkJCQl9CgkJCX0KCQkJdmFyIEhFQVA4LCBIRUFQVTgsIEhFQVAxNiwgSEVBUFUxNiwgSEVBUDMyLCBIRUFQVTMyLCBIRUFQRjMyLCBIRUFQRjY0OwogIAoJCQlmdW5jdGlvbiB1cGRhdGVNZW1vcnlWaWV3cygpIHsKCQkJCXZhciBiID0gd2FzbU1lbW9yeS5idWZmZXI7CgkJCQlNb2R1bGVbIkhFQVA4Il0gPSBIRUFQOCA9IG5ldyBJbnQ4QXJyYXkoYik7CgkJCQlNb2R1bGVbIkhFQVAxNiJdID0gSEVBUDE2ID0gbmV3IEludDE2QXJyYXkoYik7CgkJCQlNb2R1bGVbIkhFQVAzMiJdID0gSEVBUDMyID0gbmV3IEludDMyQXJyYXkoYik7CgkJCQlNb2R1bGVbIkhFQVBVOCJdID0gSEVBUFU4ID0gbmV3IFVpbnQ4QXJyYXkoYik7CgkJCQlNb2R1bGVbIkhFQVBVMTYiXSA9IEhFQVBVMTYgPSBuZXcgVWludDE2QXJyYXkoYik7CgkJCQlNb2R1bGVbIkhFQVBVMzIiXSA9IEhFQVBVMzIgPSBuZXcgVWludDMyQXJyYXkoYik7CgkJCQlNb2R1bGVbIkhFQVBGMzIiXSA9IEhFQVBGMzIgPSBuZXcgRmxvYXQzMkFycmF5KGIpOwoJCQkJTW9kdWxlWyJIRUFQRjY0Il0gPSBIRUFQRjY0ID0gbmV3IEZsb2F0NjRBcnJheShiKQoJCQl9CgkJCXZhciB3YXNtVGFibGU7CgkJCXZhciBfX0FUUFJFUlVOX18gPSBbXTsKCQkJdmFyIF9fQVRJTklUX18gPSBbXTsKCQkJdmFyIF9fQVRQT1NUUlVOX18gPSBbXTsKCQkJdmFyIHJ1bnRpbWVJbml0aWFsaXplZCA9IGZhbHNlOwoJCQl2YXIgcnVudGltZUtlZXBhbGl2ZUNvdW50ZXIgPSAwOwogIAoJCQlmdW5jdGlvbiBrZWVwUnVudGltZUFsaXZlKCkgewoJCQkJcmV0dXJuIG5vRXhpdFJ1bnRpbWUgfHwgcnVudGltZUtlZXBhbGl2ZUNvdW50ZXIgPiAwCgkJCX0KICAKCQkJZnVuY3Rpb24gcHJlUnVuKCkgewoJCQkJaWYgKE1vZHVsZVsicHJlUnVuIl0pIHsKCQkJCQlpZiAodHlwZW9mIE1vZHVsZVsicHJlUnVuIl0gPT0gImZ1bmN0aW9uIikgTW9kdWxlWyJwcmVSdW4iXSA9IFtNb2R1bGVbInByZVJ1biJdXTsKCQkJCQl3aGlsZSAoTW9kdWxlWyJwcmVSdW4iXS5sZW5ndGgpIHsKCQkJCQkJYWRkT25QcmVSdW4oTW9kdWxlWyJwcmVSdW4iXS5zaGlmdCgpKQoJCQkJCX0KCQkJCX0KCQkJCWNhbGxSdW50aW1lQ2FsbGJhY2tzKF9fQVRQUkVSVU5fXykKCQkJfQogIAoJCQlmdW5jdGlvbiBpbml0UnVudGltZSgpIHsKCQkJCXJ1bnRpbWVJbml0aWFsaXplZCA9IHRydWU7CgkJCQlpZiAoIU1vZHVsZVsibm9GU0luaXQiXSAmJiAhRlMuaW5pdC5pbml0aWFsaXplZCkgRlMuaW5pdCgpOwoJCQkJRlMuaWdub3JlUGVybWlzc2lvbnMgPSBmYWxzZTsKCQkJCVRUWS5pbml0KCk7CgkJCQljYWxsUnVudGltZUNhbGxiYWNrcyhfX0FUSU5JVF9fKQoJCQl9CiAgCgkJCWZ1bmN0aW9uIHBvc3RSdW4oKSB7CgkJCQlpZiAoTW9kdWxlWyJwb3N0UnVuIl0pIHsKCQkJCQlpZiAodHlwZW9mIE1vZHVsZVsicG9zdFJ1biJdID09ICJmdW5jdGlvbiIpIE1vZHVsZVsicG9zdFJ1biJdID0gW01vZHVsZVsicG9zdFJ1biJdXTsKCQkJCQl3aGlsZSAoTW9kdWxlWyJwb3N0UnVuIl0ubGVuZ3RoKSB7CgkJCQkJCWFkZE9uUG9zdFJ1bihNb2R1bGVbInBvc3RSdW4iXS5zaGlmdCgpKQoJCQkJCX0KCQkJCX0KCQkJCWNhbGxSdW50aW1lQ2FsbGJhY2tzKF9fQVRQT1NUUlVOX18pCgkJCX0KICAKCQkJZnVuY3Rpb24gYWRkT25QcmVSdW4oY2IpIHsKCQkJCV9fQVRQUkVSVU5fXy51bnNoaWZ0KGNiKQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGFkZE9uSW5pdChjYikgewoJCQkJX19BVElOSVRfXy51bnNoaWZ0KGNiKQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGFkZE9uUG9zdFJ1bihjYikgewoJCQkJX19BVFBPU1RSVU5fXy51bnNoaWZ0KGNiKQoJCQl9CgkJCXZhciBydW5EZXBlbmRlbmNpZXMgPSAwOwoJCQl2YXIgcnVuRGVwZW5kZW5jeVdhdGNoZXIgPSBudWxsOwoJCQl2YXIgZGVwZW5kZW5jaWVzRnVsZmlsbGVkID0gbnVsbDsKICAKCQkJZnVuY3Rpb24gZ2V0VW5pcXVlUnVuRGVwZW5kZW5jeShpZCkgewoJCQkJcmV0dXJuIGlkCgkJCX0KICAKCQkJZnVuY3Rpb24gYWRkUnVuRGVwZW5kZW5jeShpZCkgewoJCQkJcnVuRGVwZW5kZW5jaWVzKys7CgkJCQlpZiAoTW9kdWxlWyJtb25pdG9yUnVuRGVwZW5kZW5jaWVzIl0pIHsKCQkJCQlNb2R1bGVbIm1vbml0b3JSdW5EZXBlbmRlbmNpZXMiXShydW5EZXBlbmRlbmNpZXMpCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gcmVtb3ZlUnVuRGVwZW5kZW5jeShpZCkgewoJCQkJcnVuRGVwZW5kZW5jaWVzLS07CgkJCQlpZiAoTW9kdWxlWyJtb25pdG9yUnVuRGVwZW5kZW5jaWVzIl0pIHsKCQkJCQlNb2R1bGVbIm1vbml0b3JSdW5EZXBlbmRlbmNpZXMiXShydW5EZXBlbmRlbmNpZXMpCgkJCQl9CgkJCQlpZiAocnVuRGVwZW5kZW5jaWVzID09IDApIHsKCQkJCQlpZiAocnVuRGVwZW5kZW5jeVdhdGNoZXIgIT09IG51bGwpIHsKCQkJCQkJY2xlYXJJbnRlcnZhbChydW5EZXBlbmRlbmN5V2F0Y2hlcik7CgkJCQkJCXJ1bkRlcGVuZGVuY3lXYXRjaGVyID0gbnVsbAoJCQkJCX0KCQkJCQlpZiAoZGVwZW5kZW5jaWVzRnVsZmlsbGVkKSB7CgkJCQkJCXZhciBjYWxsYmFjayA9IGRlcGVuZGVuY2llc0Z1bGZpbGxlZDsKCQkJCQkJZGVwZW5kZW5jaWVzRnVsZmlsbGVkID0gbnVsbDsKCQkJCQkJY2FsbGJhY2soKQoJCQkJCX0KCQkJCX0KCQkJfQogIAoJCQlmdW5jdGlvbiBhYm9ydCh3aGF0KSB7CgkJCQlpZiAoTW9kdWxlWyJvbkFib3J0Il0pIHsKCQkJCQlNb2R1bGVbIm9uQWJvcnQiXSh3aGF0KQoJCQkJfQoJCQkJd2hhdCA9ICJBYm9ydGVkKCIgKyB3aGF0ICsgIikiOwoJCQkJZXJyKHdoYXQpOwoJCQkJQUJPUlQgPSB0cnVlOwoJCQkJRVhJVFNUQVRVUyA9IDE7CgkJCQl3aGF0ICs9ICIuIEJ1aWxkIHdpdGggLXNBU1NFUlRJT05TIGZvciBtb3JlIGluZm8uIjsKCQkJCXZhciBlID0gbmV3IFdlYkFzc2VtYmx5LlJ1bnRpbWVFcnJvcih3aGF0KTsKCQkJCXJlYWR5UHJvbWlzZVJlamVjdChlKTsKCQkJCXRocm93IGUKCQkJfQoJCQl2YXIgZGF0YVVSSVByZWZpeCA9ICJkYXRhOmFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbTtiYXNlNjQsIjsKICAKCQkJZnVuY3Rpb24gaXNEYXRhVVJJKGZpbGVuYW1lKSB7CgkJCQlyZXR1cm4gZmlsZW5hbWUuc3RhcnRzV2l0aChkYXRhVVJJUHJlZml4KQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGlzRmlsZVVSSShmaWxlbmFtZSkgewoJCQkJcmV0dXJuIGZpbGVuYW1lLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKQoJCQl9CgkJCXZhciB3YXNtQmluYXJ5RmlsZTsKCQkJd2FzbUJpbmFyeUZpbGUgPSAiZmZtcGVnLXNpbWQtbm9zYWItMTY5OTk4NTE3Mi53YXNtIjsKCQkJaWYgKCFpc0RhdGFVUkkod2FzbUJpbmFyeUZpbGUpKSB7CgkJCQl3YXNtQmluYXJ5RmlsZSA9IGxvY2F0ZUZpbGUod2FzbUJpbmFyeUZpbGUpCgkJCX0KICAKCQkJZnVuY3Rpb24gZ2V0QmluYXJ5KGZpbGUpIHsKCQkJCXRyeSB7CgkJCQkJaWYgKGZpbGUgPT0gd2FzbUJpbmFyeUZpbGUgJiYgd2FzbUJpbmFyeSkgewoJCQkJCQlyZXR1cm4gbmV3IFVpbnQ4QXJyYXkod2FzbUJpbmFyeSkKCQkJCQl9CgkJCQkJaWYgKHJlYWRCaW5hcnkpIHsKCQkJCQkJcmV0dXJuIHJlYWRCaW5hcnkoZmlsZSkKCQkJCQl9CgkJCQkJdGhyb3cgImJvdGggYXN5bmMgYW5kIHN5bmMgZmV0Y2hpbmcgb2YgdGhlIHdhc20gZmFpbGVkIgoJCQkJfSBjYXRjaCAoZXJyKSB7CgkJCQkJYWJvcnQoZXJyKQoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGdldEJpbmFyeVByb21pc2UoYmluYXJ5RmlsZSkgewoJCQkJaWYgKCF3YXNtQmluYXJ5ICYmIChFTlZJUk9OTUVOVF9JU19XRUIgfHwgRU5WSVJPTk1FTlRfSVNfV09SS0VSKSkgewoJCQkJCWlmICh0eXBlb2YgZmV0Y2ggPT0gImZ1bmN0aW9uIiAmJiAhaXNGaWxlVVJJKGJpbmFyeUZpbGUpKSB7CgkJCQkJCXJldHVybiBmZXRjaChiaW5hcnlGaWxlLCB7CgkJCQkJCQkvL2NyZWRlbnRpYWxzOiAic2FtZS1vcmlnaW4iCgkJCQkJCX0pLnRoZW4ocmVzcG9uc2UgPT4gewoJCQkJCQkJaWYgKCFyZXNwb25zZVsib2siXSkgewoJCQkJCQkJCXRocm93ICJmYWlsZWQgdG8gbG9hZCB3YXNtIGJpbmFyeSBmaWxlIGF0ICciICsgYmluYXJ5RmlsZSArICInIgoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJlc3BvbnNlWyJhcnJheUJ1ZmZlciJdKCkKCQkJCQkJfSkuY2F0Y2goKCkgPT4gZ2V0QmluYXJ5KGJpbmFyeUZpbGUpKQoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmIChyZWFkQXN5bmMpIHsKCQkJCQkJCXJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkJCQkJCQkJcmVhZEFzeW5jKGJpbmFyeUZpbGUsIHJlc3BvbnNlID0+IHJlc29sdmUobmV3IFVpbnQ4QXJyYXkocmVzcG9uc2UpKSwgcmVqZWN0KQoJCQkJCQkJfSkKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGdldEJpbmFyeShiaW5hcnlGaWxlKSkKCQkJfQogIAoJCQlmdW5jdGlvbiBpbnN0YW50aWF0ZUFycmF5QnVmZmVyKGJpbmFyeUZpbGUsIGltcG9ydHMsIHJlY2VpdmVyKSB7CgkJCQlyZXR1cm4gZ2V0QmluYXJ5UHJvbWlzZShiaW5hcnlGaWxlKS50aGVuKGJpbmFyeSA9PiB7CgkJCQkJcmV0dXJuIFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlKGJpbmFyeSwgaW1wb3J0cykKCQkJCX0pLnRoZW4oaW5zdGFuY2UgPT4gewoJCQkJCXJldHVybiBpbnN0YW5jZQoJCQkJfSkudGhlbihyZWNlaXZlciwgcmVhc29uID0+IHsKCQkJCQllcnIoImZhaWxlZCB0byBhc3luY2hyb25vdXNseSBwcmVwYXJlIHdhc206ICIgKyByZWFzb24pOwoJCQkJCWFib3J0KHJlYXNvbikKCQkJCX0pCgkJCX0KICAKCQkJZnVuY3Rpb24gaW5zdGFudGlhdGVBc3luYyhiaW5hcnksIGJpbmFyeUZpbGUsIGltcG9ydHMsIGNhbGxiYWNrKSB7CgkJCQlpZiAoIWJpbmFyeSAmJiB0eXBlb2YgV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmcgPT0gImZ1bmN0aW9uIiAmJiAhaXNEYXRhVVJJKGJpbmFyeUZpbGUpICYmICFpc0ZpbGVVUkkoYmluYXJ5RmlsZSkgJiYgIUVOVklST05NRU5UX0lTX05PREUgJiYgdHlwZW9mIGZldGNoID09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXR1cm4gZmV0Y2goYmluYXJ5RmlsZSwgewoJCQkJCQkvL2NyZWRlbnRpYWxzOiAic2FtZS1vcmlnaW4iCgkJCQkJfSkudGhlbihyZXNwb25zZSA9PiB7CgkJCQkJCXZhciByZXN1bHQgPSBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyhyZXNwb25zZSwgaW1wb3J0cyk7CgkJCQkJCXJldHVybiByZXN1bHQudGhlbihjYWxsYmFjaywgZnVuY3Rpb24ocmVhc29uKSB7CgkJCQkJCQllcnIoIndhc20gc3RyZWFtaW5nIGNvbXBpbGUgZmFpbGVkOiAiICsgcmVhc29uKTsKCQkJCQkJCWVycigiZmFsbGluZyBiYWNrIHRvIEFycmF5QnVmZmVyIGluc3RhbnRpYXRpb24iKTsKCQkJCQkJCXJldHVybiBpbnN0YW50aWF0ZUFycmF5QnVmZmVyKGJpbmFyeUZpbGUsIGltcG9ydHMsIGNhbGxiYWNrKQoJCQkJCQl9KQoJCQkJCX0pCgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBpbnN0YW50aWF0ZUFycmF5QnVmZmVyKGJpbmFyeUZpbGUsIGltcG9ydHMsIGNhbGxiYWNrKQoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGNyZWF0ZVdhc20oKSB7CgkJCQl2YXIgaW5mbyA9IHsKCQkJCQkiYSI6IHdhc21JbXBvcnRzCgkJCQl9OwogIAoJCQkJZnVuY3Rpb24gcmVjZWl2ZUluc3RhbmNlKGluc3RhbmNlLCBtb2R1bGUpIHsKCQkJCQl2YXIgZXhwb3J0cyA9IGluc3RhbmNlLmV4cG9ydHM7CgkJCQkJZXhwb3J0cyA9IEFzeW5jaWZ5Lmluc3RydW1lbnRXYXNtRXhwb3J0cyhleHBvcnRzKTsKCQkJCQlNb2R1bGVbImFzbSJdID0gZXhwb3J0czsKCQkJCQl3YXNtTWVtb3J5ID0gTW9kdWxlWyJhc20iXVsiViJdOwoJCQkJCXVwZGF0ZU1lbW9yeVZpZXdzKCk7CgkJCQkJd2FzbVRhYmxlID0gTW9kdWxlWyJhc20iXVsiWCJdOwoJCQkJCWFkZE9uSW5pdChNb2R1bGVbImFzbSJdWyJXIl0pOwoJCQkJCXJlbW92ZVJ1bkRlcGVuZGVuY3koIndhc20taW5zdGFudGlhdGUiKTsKCQkJCQlyZXR1cm4gZXhwb3J0cwoJCQkJfQoJCQkJYWRkUnVuRGVwZW5kZW5jeSgid2FzbS1pbnN0YW50aWF0ZSIpOwogIAoJCQkJZnVuY3Rpb24gcmVjZWl2ZUluc3RhbnRpYXRpb25SZXN1bHQocmVzdWx0KSB7CgkJCQkJcmVjZWl2ZUluc3RhbmNlKHJlc3VsdFsiaW5zdGFuY2UiXSkKCQkJCX0KCQkJCWlmIChNb2R1bGVbImluc3RhbnRpYXRlV2FzbSJdKSB7CgkJCQkJdHJ5IHsKCQkJCQkJcmV0dXJuIE1vZHVsZVsiaW5zdGFudGlhdGVXYXNtIl0oaW5mbywgcmVjZWl2ZUluc3RhbmNlKQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJZXJyKCJNb2R1bGUuaW5zdGFudGlhdGVXYXNtIGNhbGxiYWNrIGZhaWxlZCB3aXRoIGVycm9yOiAiICsgZSk7CgkJCQkJCXJlYWR5UHJvbWlzZVJlamVjdChlKQoJCQkJCX0KCQkJCX0KCQkJCWluc3RhbnRpYXRlQXN5bmMod2FzbUJpbmFyeSwgd2FzbUJpbmFyeUZpbGUsIGluZm8sIHJlY2VpdmVJbnN0YW50aWF0aW9uUmVzdWx0KS5jYXRjaChyZWFkeVByb21pc2VSZWplY3QpOwoJCQkJcmV0dXJuIHt9CgkJCX0KCQkJdmFyIHRlbXBEb3VibGU7CgkJCXZhciB0ZW1wSTY0OwoJCQl2YXIgQVNNX0NPTlNUUyA9IHsKCQkJCTg2MTc4MDogJDAgPT4gewoJCQkJCWxldCBzID0gRkZtcGVnTW9kdWxlLlVURjhUb1N0cmluZygkMCk7CgkJCQkJaWYgKHdpbmRvdy5mZlByb2dyZXNzUmVwb3J0KSB7CgkJCQkJCXdpbmRvdy5mZlByb2dyZXNzUmVwb3J0KHMpCgkJCQkJfQoJCQkJCUZGbXBlZ01vZHVsZS5fZnJlZSgkMCkKCQkJCX0sCgkJCQk4NjE5MDg6ICgkMCwgJDEpID0+IHsKCQkJCQl3aW5kb3cuZmZDb25zb2xlT3V0cHV0KCQxLCBVVEY4VG9TdHJpbmcoJDApKTsKCQkJCQlGRm1wZWdNb2R1bGUuX2ZyZWUoJDApCgkJCQl9LAoJCQkJODYxOTgxOiAoJDAsICQxLCAkMiwgJDMsICQ0KSA9PiB7CgkJCQkJc2VsZi5wb3N0TWVzc2FnZSh7CgkJCQkJCSJjbWQiOiAiZmlsZXJlYWRyZXEiLAoJCQkJCQkiYXJncyI6IHsKCQkJCQkJCSJyZXFJRCI6ICQwLAoJCQkJCQkJImZpbGVIYW5kbGVJRCI6ICQxLAoJCQkJCQkJIm9mZnNldF9sIjogJDIsCgkJCQkJCQkib2Zmc2V0X2giOiAkMywKCQkJCQkJCSJyZWFkbGVuZ3RoIjogJDQKCQkJCQkJfQoJCQkJCX0pCgkJCQl9LAoJCQkJODYyMTI4OiAoJDAsICQxLCAkMiwgJDMsICQ0LCAkNSkgPT4gewoJCQkJCWxldCByZXNidWZmID0gRkZtcGVnTW9kdWxlLkhFQVBVOC5idWZmZXIuc2xpY2UoJDMsICQzICsgJDQgKiAkNSAqIDMgLyAyKTsKCQkJCQlzZWxmLnBvc3RNZXNzYWdlKHsKCQkJCQkJImNtZCI6ICJnZXRGRlZpZGVvRGVjb2RlckZyYW1lIiwKCQkJCQkJInJlcyI6IHsKCQkJCQkJCSJ2aWQiOiAkMCwKCQkJCQkJCSJyZXFJRCI6ICQxLAoJCQkJCQkJInRzIjogJDIsCgkJCQkJCQkiYnVmZiI6IHJlc2J1ZmYsCgkJCQkJCQkid2lkdGgiOiAkNCwKCQkJCQkJCSJoZWlnaHQiOiAkNQoJCQkJCQl9CgkJCQkJfSwgW3Jlc2J1ZmZdKQoJCQkJfSwKCQkJCTg2MjM2NTogJDAgPT4gewoJCQkJCXNlbGYucG9zdE1lc3NhZ2UoewoJCQkJCQkiY21kIjogIm9wZW5maWxlIiwKCQkJCQkJImFyZ3MiOiB7CgkJCQkJCQkiYnVmZiI6IG5ldyBVaW50OEFycmF5KDApLAoJCQkJCQkJInJlZiI6ICQwCgkJCQkJCX0KCQkJCQl9KQoJCQkJfSwKCQkJCTg2MjQ2MTogKCkgPT4gewoJCQkJCWZmbXBlZ2NtZF9iZ19maW5pc2hlZCgpCgkJCQl9LAoJCQkJODYyNDkwOiAoJDAsICQxLCAkMiwgJDMpID0+IHsKCQkJCQlsZXQgcmVzYnVmZiA9IEZGbXBlZ01vZHVsZS5IRUFQVTguYnVmZmVyLnNsaWNlKCQyLCAkMiArICQzKTsKCQkJCQlzZWxmLnBvc3RNZXNzYWdlKHsKCQkJCQkJImNtZCI6ICJnZXRGRkF1ZGlvRGF0YSIsCgkJCQkJCSJyZXMiOiB7CgkJCQkJCQkidmlkIjogJDAsCgkJCQkJCQkicmVxSUQiOiAkMSwKCQkJCQkJCSJidWZmIjogcmVzYnVmZgoJCQkJCQl9CgkJCQkJfSwgW3Jlc2J1ZmZdKQoJCQkJfSwKCQkJCTg2MjY2NzogKCQwLCAkMSkgPT4gewoJCQkJCXNlbGYucG9zdE1lc3NhZ2UoewoJCQkJCQkiY21kIjogIm9wZW5maWxlLXByb2dyZXNzIiwKCQkJCQkJImFyZ3MiOiB7CgkJCQkJCQkicHJvZ3Jlc3MiOiAkMCwKCQkJCQkJCSJyZWYiOiAkMQoJCQkJCQl9CgkJCQkJfSkKCQkJCX0sCgkJCQk4NjI3NjI6ICgkMCwgJDEsICQyKSA9PiB7CgkJCQkJbGV0IGZmYnVmZiA9IG5ldyBVaW50OEFycmF5KCQxKTsKCQkJCQlmZmJ1ZmYuc2V0KG5ldyBVaW50OEFycmF5KEZGbXBlZ01vZHVsZS5IRUFQVTguYnVmZmVyLCAkMCwgJDEpLCAwKTsKCQkJCQlzZWxmLnBvc3RNZXNzYWdlKHsKCQkJCQkJImNtZCI6ICJvcGVuZmlsZSIsCgkJCQkJCSJyZXMiOiB7CgkJCQkJCQkiYnVmZiI6IGZmYnVmZiwKCQkJCQkJCSJyZWYiOiAkMgoJCQkJCQl9CgkJCQkJfSkKCQkJCX0sCgkJCQk4NjI5NDY6ICgkMCwgJDEsICQyLCAkMywgJDQsICQ1LCAkNiwgJDcsICQ4KSA9PiB7CgkJCQkJbGV0IGZmYnVmZiA9IG5ldyBVaW50OEFycmF5KEZGbXBlZ01vZHVsZS5IRUFQVTguYnVmZmVyLCAkMCwgJDEpOwoJCQkJCXZhciBwdHIgPSB3aW5kb3cuTW9kdWxlLl9tYWxsb2MoJDEpOwoJCQkJCXdpbmRvdy5Nb2R1bGUuSEVBUFU4LnNldChmZmJ1ZmYsIHB0cik7CgkJCQkJZmZTZXFGcmFtZVJlYWRSZXN1bHQocHRyLCAkMSwgJDYsICQ3LCAkMiwgJDMsICQ4LCAkNCwgJDUpOwoJCQkJCUZGbXBlZ01vZHVsZS5fZnJlZSgkMCkKCQkJCX0sCgkJCQk4NjMxNzM6ICgkMCwgJDEsICQyKSA9PiB7CgkJCQkJbGV0IGIgPSBGRm1wZWdNb2R1bGUuSEVBUFU4LmJ1ZmZlci5zbGljZSgkMCwgJDAgKyAkMSk7CgkJCQkJc2VsZi5wb3N0TWVzc2FnZSh7CgkJCQkJCSJjbWQiOiAid3JpdGVUb1ZpZGVvT3V0cHV0RmlsZSIsCgkJCQkJCSJidWZmIjogYiwKCQkJCQkJImZoaWQiOiAkMgoJCQkJCX0sIFtiXSkKCQkJCX0sCgkJCQk4NjMzMTE6ICgkMCwgJDEsICQyLCAkMykgPT4gewoJCQkJCXNlbGYucG9zdE1lc3NhZ2UoewoJCQkJCQkiY21kIjogInNlZWtWaWRlb091dHB1dEZpbGUiLAoJCQkJCQkib2Zmc2V0X2giOiAkMCwKCQkJCQkJIm9mZnNldF9sIjogJDEsCgkJCQkJCSJ3aGVuY2UiOiAkMiwKCQkJCQkJImZoaWQiOiAkMwoJCQkJCX0pCgkJCQl9LAoJCQkJODYzNDE5OiAoKSA9PiB7CgkJCQkJc2VsZi5wb3N0TWVzc2FnZSh7CgkJCQkJCSJjbWQiOiAicmVhZHlGb3JWaWRlb0J1ZmZlciIKCQkJCQl9KQoJCQkJfSwKCQkJCTg2MzQ3MzogJDAgPT4gewoJCQkJCXNlbGYucG9zdE1lc3NhZ2UoewoJCQkJCQkiY21kIjogImZmbXBlZ0RvbmVBdWRpb0ZyYW1lQ2FsbGJhY2siLAoJCQkJCQkiYXJncyI6IHsKCQkJCQkJCSJyaWQiOiAkMAoJCQkJCQl9CgkJCQkJfSkKCQkJCX0sCgkJCQk4NjM1NTQ6ICQwID0+IHsKCQkJCQlzZWxmLnBvc3RNZXNzYWdlKHsKCQkJCQkJImNtZCI6ICJmZm1wZWdEb25lQXVkaW9GcmFtZUNhbGxiYWNrIiwKCQkJCQkJImFyZ3MiOiB7CgkJCQkJCQkicmlkIjogJDAKCQkJCQkJfQoJCQkJCX0pCgkJCQl9LAoJCQkJODYzNjM1OiAkMCA9PiB7CgkJCQkJc2VsZi5wb3N0TWVzc2FnZSh7CgkJCQkJCSJjbWQiOiAiZmZtcGVnT3V0cHV0RG93bmxvYWQiLAoJCQkJCQkiYXJncyI6IHsKCQkJCQkJCSJyaWQiOiAkMAoJCQkJCQl9CgkJCQkJfSkKCQkJCX0KCQkJfTsKICAKCQkJZnVuY3Rpb24gX19hc3luY2pzX193YWl0Rm9yUmVhZFJlc3VsdEFzeW5jKCkgewoJCQkJcmV0dXJuIEFzeW5jaWZ5LmhhbmRsZUFzeW5jKGFzeW5jICgpID0+IHsKCQkJCQlhd2FpdCAoKCkgPT4gewoJCQkJCQlyZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7CgkJCQkJCQlzZWxmLmZpbGVyZWFkcmVzb2x2ZSA9IHJlc29sdmUKCQkJCQkJfSkKCQkJCQl9KSgpCgkJCQl9KQoJCQl9CiAgCgkJCWZ1bmN0aW9uIEV4aXRTdGF0dXMoc3RhdHVzKSB7CgkJCQl0aGlzLm5hbWUgPSAiRXhpdFN0YXR1cyI7CgkJCQl0aGlzLm1lc3NhZ2UgPSAiUHJvZ3JhbSB0ZXJtaW5hdGVkIHdpdGggZXhpdCgiICsgc3RhdHVzICsgIikiOwoJCQkJdGhpcy5zdGF0dXMgPSBzdGF0dXMKCQkJfQogIAoJCQlmdW5jdGlvbiBjYWxsUnVudGltZUNhbGxiYWNrcyhjYWxsYmFja3MpIHsKCQkJCXdoaWxlIChjYWxsYmFja3MubGVuZ3RoID4gMCkgewoJCQkJCWNhbGxiYWNrcy5zaGlmdCgpKE1vZHVsZSkKCQkJCX0KCQkJfQogIAoJCQlmdW5jdGlvbiBFeGNlcHRpb25JbmZvKGV4Y1B0cikgewoJCQkJdGhpcy5leGNQdHIgPSBleGNQdHI7CgkJCQl0aGlzLnB0ciA9IGV4Y1B0ciAtIDI0OwoJCQkJdGhpcy5zZXRfdHlwZSA9IGZ1bmN0aW9uKHR5cGUpIHsKCQkJCQlIRUFQVTMyW3RoaXMucHRyICsgNCA+PiAyXSA9IHR5cGUKCQkJCX07CgkJCQl0aGlzLmdldF90eXBlID0gZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIEhFQVBVMzJbdGhpcy5wdHIgKyA0ID4+IDJdCgkJCQl9OwoJCQkJdGhpcy5zZXRfZGVzdHJ1Y3RvciA9IGZ1bmN0aW9uKGRlc3RydWN0b3IpIHsKCQkJCQlIRUFQVTMyW3RoaXMucHRyICsgOCA+PiAyXSA9IGRlc3RydWN0b3IKCQkJCX07CgkJCQl0aGlzLmdldF9kZXN0cnVjdG9yID0gZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIEhFQVBVMzJbdGhpcy5wdHIgKyA4ID4+IDJdCgkJCQl9OwoJCQkJdGhpcy5zZXRfY2F1Z2h0ID0gZnVuY3Rpb24oY2F1Z2h0KSB7CgkJCQkJY2F1Z2h0ID0gY2F1Z2h0ID8gMSA6IDA7CgkJCQkJSEVBUDhbdGhpcy5wdHIgKyAxMiA+PiAwXSA9IGNhdWdodAoJCQkJfTsKCQkJCXRoaXMuZ2V0X2NhdWdodCA9IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBIRUFQOFt0aGlzLnB0ciArIDEyID4+IDBdICE9IDAKCQkJCX07CgkJCQl0aGlzLnNldF9yZXRocm93biA9IGZ1bmN0aW9uKHJldGhyb3duKSB7CgkJCQkJcmV0aHJvd24gPSByZXRocm93biA/IDEgOiAwOwoJCQkJCUhFQVA4W3RoaXMucHRyICsgMTMgPj4gMF0gPSByZXRocm93bgoJCQkJfTsKCQkJCXRoaXMuZ2V0X3JldGhyb3duID0gZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIEhFQVA4W3RoaXMucHRyICsgMTMgPj4gMF0gIT0gMAoJCQkJfTsKCQkJCXRoaXMuaW5pdCA9IGZ1bmN0aW9uKHR5cGUsIGRlc3RydWN0b3IpIHsKCQkJCQl0aGlzLnNldF9hZGp1c3RlZF9wdHIoMCk7CgkJCQkJdGhpcy5zZXRfdHlwZSh0eXBlKTsKCQkJCQl0aGlzLnNldF9kZXN0cnVjdG9yKGRlc3RydWN0b3IpCgkJCQl9OwoJCQkJdGhpcy5zZXRfYWRqdXN0ZWRfcHRyID0gZnVuY3Rpb24oYWRqdXN0ZWRQdHIpIHsKCQkJCQlIRUFQVTMyW3RoaXMucHRyICsgMTYgPj4gMl0gPSBhZGp1c3RlZFB0cgoJCQkJfTsKCQkJCXRoaXMuZ2V0X2FkanVzdGVkX3B0ciA9IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBIRUFQVTMyW3RoaXMucHRyICsgMTYgPj4gMl0KCQkJCX07CgkJCQl0aGlzLmdldF9leGNlcHRpb25fcHRyID0gZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGlzUG9pbnRlciA9IF9fX2N4YV9pc19wb2ludGVyX3R5cGUodGhpcy5nZXRfdHlwZSgpKTsKCQkJCQlpZiAoaXNQb2ludGVyKSB7CgkJCQkJCXJldHVybiBIRUFQVTMyW3RoaXMuZXhjUHRyID4+IDJdCgkJCQkJfQoJCQkJCXZhciBhZGp1c3RlZCA9IHRoaXMuZ2V0X2FkanVzdGVkX3B0cigpOwoJCQkJCWlmIChhZGp1c3RlZCAhPT0gMCkgcmV0dXJuIGFkanVzdGVkOwoJCQkJCXJldHVybiB0aGlzLmV4Y1B0cgoJCQkJfQoJCQl9CgkJCXZhciBleGNlcHRpb25MYXN0ID0gMDsKCQkJdmFyIHVuY2F1Z2h0RXhjZXB0aW9uQ291bnQgPSAwOwogIAoJCQlmdW5jdGlvbiBfX19jeGFfdGhyb3cocHRyLCB0eXBlLCBkZXN0cnVjdG9yKSB7CgkJCQl2YXIgaW5mbyA9IG5ldyBFeGNlcHRpb25JbmZvKHB0cik7CgkJCQlpbmZvLmluaXQodHlwZSwgZGVzdHJ1Y3Rvcik7CgkJCQlleGNlcHRpb25MYXN0ID0gcHRyOwoJCQkJdW5jYXVnaHRFeGNlcHRpb25Db3VudCsrOwoJCQkJdGhyb3cgZXhjZXB0aW9uTGFzdAoJCQl9CgkJCXZhciBQQVRIID0gewoJCQkJaXNBYnM6IHBhdGggPT4gcGF0aC5jaGFyQXQoMCkgPT09ICIvIiwKCQkJCXNwbGl0UGF0aDogZmlsZW5hbWUgPT4gewoJCQkJCXZhciBzcGxpdFBhdGhSZSA9IC9eKFwvP3wpKFtcc1xTXSo/KSgoPzpcLnsxLDJ9fFteXC9dKz98KShcLlteLlwvXSp8KSkoPzpbXC9dKikkLzsKCQkJCQlyZXR1cm4gc3BsaXRQYXRoUmUuZXhlYyhmaWxlbmFtZSkuc2xpY2UoMSkKCQkJCX0sCgkJCQlub3JtYWxpemVBcnJheTogKHBhcnRzLCBhbGxvd0Fib3ZlUm9vdCkgPT4gewoJCQkJCXZhciB1cCA9IDA7CgkJCQkJZm9yICh2YXIgaSA9IHBhcnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCQkJCXZhciBsYXN0ID0gcGFydHNbaV07CgkJCQkJCWlmIChsYXN0ID09PSAiLiIpIHsKCQkJCQkJCXBhcnRzLnNwbGljZShpLCAxKQoJCQkJCQl9IGVsc2UgaWYgKGxhc3QgPT09ICIuLiIpIHsKCQkJCQkJCXBhcnRzLnNwbGljZShpLCAxKTsKCQkJCQkJCXVwKysKCQkJCQkJfSBlbHNlIGlmICh1cCkgewoJCQkJCQkJcGFydHMuc3BsaWNlKGksIDEpOwoJCQkJCQkJdXAtLQoJCQkJCQl9CgkJCQkJfQoJCQkJCWlmIChhbGxvd0Fib3ZlUm9vdCkgewoJCQkJCQlmb3IgKDsgdXA7IHVwLS0pIHsKCQkJCQkJCXBhcnRzLnVuc2hpZnQoIi4uIikKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXR1cm4gcGFydHMKCQkJCX0sCgkJCQlub3JtYWxpemU6IHBhdGggPT4gewoJCQkJCXZhciBpc0Fic29sdXRlID0gUEFUSC5pc0FicyhwYXRoKSwKCQkJCQkJdHJhaWxpbmdTbGFzaCA9IHBhdGguc3Vic3RyKC0xKSA9PT0gIi8iOwoJCQkJCXBhdGggPSBQQVRILm5vcm1hbGl6ZUFycmF5KHBhdGguc3BsaXQoIi8iKS5maWx0ZXIocCA9PiAhIXApLCAhaXNBYnNvbHV0ZSkuam9pbigiLyIpOwoJCQkJCWlmICghcGF0aCAmJiAhaXNBYnNvbHV0ZSkgewoJCQkJCQlwYXRoID0gIi4iCgkJCQkJfQoJCQkJCWlmIChwYXRoICYmIHRyYWlsaW5nU2xhc2gpIHsKCQkJCQkJcGF0aCArPSAiLyIKCQkJCQl9CgkJCQkJcmV0dXJuIChpc0Fic29sdXRlID8gIi8iIDogIiIpICsgcGF0aAoJCQkJfSwKCQkJCWRpcm5hbWU6IHBhdGggPT4gewoJCQkJCXZhciByZXN1bHQgPSBQQVRILnNwbGl0UGF0aChwYXRoKSwKCQkJCQkJcm9vdCA9IHJlc3VsdFswXSwKCQkJCQkJZGlyID0gcmVzdWx0WzFdOwoJCQkJCWlmICghcm9vdCAmJiAhZGlyKSB7CgkJCQkJCXJldHVybiAiLiIKCQkJCQl9CgkJCQkJaWYgKGRpcikgewoJCQkJCQlkaXIgPSBkaXIuc3Vic3RyKDAsIGRpci5sZW5ndGggLSAxKQoJCQkJCX0KCQkJCQlyZXR1cm4gcm9vdCArIGRpcgoJCQkJfSwKCQkJCWJhc2VuYW1lOiBwYXRoID0+IHsKCQkJCQlpZiAocGF0aCA9PT0gIi8iKSByZXR1cm4gIi8iOwoJCQkJCXBhdGggPSBQQVRILm5vcm1hbGl6ZShwYXRoKTsKCQkJCQlwYXRoID0gcGF0aC5yZXBsYWNlKC9cLyQvLCAiIik7CgkJCQkJdmFyIGxhc3RTbGFzaCA9IHBhdGgubGFzdEluZGV4T2YoIi8iKTsKCQkJCQlpZiAobGFzdFNsYXNoID09PSAtMSkgcmV0dXJuIHBhdGg7CgkJCQkJcmV0dXJuIHBhdGguc3Vic3RyKGxhc3RTbGFzaCArIDEpCgkJCQl9LAoJCQkJam9pbjogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHBhdGhzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKCQkJCQlyZXR1cm4gUEFUSC5ub3JtYWxpemUocGF0aHMuam9pbigiLyIpKQoJCQkJfSwKCQkJCWpvaW4yOiAobCwgcikgPT4gewoJCQkJCXJldHVybiBQQVRILm5vcm1hbGl6ZShsICsgIi8iICsgcikKCQkJCX0KCQkJfTsKICAKCQkJZnVuY3Rpb24gaW5pdFJhbmRvbUZpbGwoKSB7CgkJCQlpZiAodHlwZW9mIGNyeXB0byA9PSAib2JqZWN0IiAmJiB0eXBlb2YgY3J5cHRvWyJnZXRSYW5kb21WYWx1ZXMiXSA9PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0dXJuIHZpZXcgPT4gY3J5cHRvLmdldFJhbmRvbVZhbHVlcyh2aWV3KQoJCQkJfSBlbHNlIGlmIChFTlZJUk9OTUVOVF9JU19OT0RFKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIGNyeXB0b19tb2R1bGUgPSByZXF1aXJlKCJjcnlwdG8iKTsKCQkJCQkJdmFyIHJhbmRvbUZpbGxTeW5jID0gY3J5cHRvX21vZHVsZVsicmFuZG9tRmlsbFN5bmMiXTsKCQkJCQkJaWYgKHJhbmRvbUZpbGxTeW5jKSB7CgkJCQkJCQlyZXR1cm4gdmlldyA9PiBjcnlwdG9fbW9kdWxlWyJyYW5kb21GaWxsU3luYyJdKHZpZXcpCgkJCQkJCX0KCQkJCQkJdmFyIHJhbmRvbUJ5dGVzID0gY3J5cHRvX21vZHVsZVsicmFuZG9tQnl0ZXMiXTsKCQkJCQkJcmV0dXJuIHZpZXcgPT4gKHZpZXcuc2V0KHJhbmRvbUJ5dGVzKHZpZXcuYnl0ZUxlbmd0aCkpLCB2aWV3KQoJCQkJCX0gY2F0Y2ggKGUpIHt9CgkJCQl9CgkJCQlhYm9ydCgiaW5pdFJhbmRvbURldmljZSIpCgkJCX0KICAKCQkJZnVuY3Rpb24gcmFuZG9tRmlsbCh2aWV3KSB7CgkJCQlyZXR1cm4gKHJhbmRvbUZpbGwgPSBpbml0UmFuZG9tRmlsbCgpKSh2aWV3KQoJCQl9CgkJCXZhciBQQVRIX0ZTID0gewoJCQkJcmVzb2x2ZTogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHJlc29sdmVkUGF0aCA9ICIiLAoJCQkJCQlyZXNvbHZlZEFic29sdXRlID0gZmFsc2U7CgkJCQkJZm9yICh2YXIgaSA9IGFyZ3VtZW50cy5sZW5ndGggLSAxOyBpID49IC0xICYmICFyZXNvbHZlZEFic29sdXRlOyBpLS0pIHsKCQkJCQkJdmFyIHBhdGggPSBpID49IDAgPyBhcmd1bWVudHNbaV0gOiBGUy5jd2QoKTsKCQkJCQkJaWYgKHR5cGVvZiBwYXRoICE9ICJzdHJpbmciKSB7CgkJCQkJCQl0aHJvdyBuZXcgVHlwZUVycm9yKCJBcmd1bWVudHMgdG8gcGF0aC5yZXNvbHZlIG11c3QgYmUgc3RyaW5ncyIpCgkJCQkJCX0gZWxzZSBpZiAoIXBhdGgpIHsKCQkJCQkJCXJldHVybiAiIgoJCQkJCQl9CgkJCQkJCXJlc29sdmVkUGF0aCA9IHBhdGggKyAiLyIgKyByZXNvbHZlZFBhdGg7CgkJCQkJCXJlc29sdmVkQWJzb2x1dGUgPSBQQVRILmlzQWJzKHBhdGgpCgkJCQkJfQoJCQkJCXJlc29sdmVkUGF0aCA9IFBBVEgubm9ybWFsaXplQXJyYXkocmVzb2x2ZWRQYXRoLnNwbGl0KCIvIikuZmlsdGVyKHAgPT4gISFwKSwgIXJlc29sdmVkQWJzb2x1dGUpLmpvaW4oIi8iKTsKCQkJCQlyZXR1cm4gKHJlc29sdmVkQWJzb2x1dGUgPyAiLyIgOiAiIikgKyByZXNvbHZlZFBhdGggfHwgIi4iCgkJCQl9LAoJCQkJcmVsYXRpdmU6IChmcm9tLCB0bykgPT4gewoJCQkJCWZyb20gPSBQQVRIX0ZTLnJlc29sdmUoZnJvbSkuc3Vic3RyKDEpOwoJCQkJCXRvID0gUEFUSF9GUy5yZXNvbHZlKHRvKS5zdWJzdHIoMSk7CiAgCgkJCQkJZnVuY3Rpb24gdHJpbShhcnIpIHsKCQkJCQkJdmFyIHN0YXJ0ID0gMDsKCQkJCQkJZm9yICg7IHN0YXJ0IDwgYXJyLmxlbmd0aDsgc3RhcnQrKykgewoJCQkJCQkJaWYgKGFycltzdGFydF0gIT09ICIiKSBicmVhawoJCQkJCQl9CgkJCQkJCXZhciBlbmQgPSBhcnIubGVuZ3RoIC0gMTsKCQkJCQkJZm9yICg7IGVuZCA+PSAwOyBlbmQtLSkgewoJCQkJCQkJaWYgKGFycltlbmRdICE9PSAiIikgYnJlYWsKCQkJCQkJfQoJCQkJCQlpZiAoc3RhcnQgPiBlbmQpIHJldHVybiBbXTsKCQkJCQkJcmV0dXJuIGFyci5zbGljZShzdGFydCwgZW5kIC0gc3RhcnQgKyAxKQoJCQkJCX0KCQkJCQl2YXIgZnJvbVBhcnRzID0gdHJpbShmcm9tLnNwbGl0KCIvIikpOwoJCQkJCXZhciB0b1BhcnRzID0gdHJpbSh0by5zcGxpdCgiLyIpKTsKCQkJCQl2YXIgbGVuZ3RoID0gTWF0aC5taW4oZnJvbVBhcnRzLmxlbmd0aCwgdG9QYXJ0cy5sZW5ndGgpOwoJCQkJCXZhciBzYW1lUGFydHNMZW5ndGggPSBsZW5ndGg7CgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJCQkJCQlpZiAoZnJvbVBhcnRzW2ldICE9PSB0b1BhcnRzW2ldKSB7CgkJCQkJCQlzYW1lUGFydHNMZW5ndGggPSBpOwoJCQkJCQkJYnJlYWsKCQkJCQkJfQoJCQkJCX0KCQkJCQl2YXIgb3V0cHV0UGFydHMgPSBbXTsKCQkJCQlmb3IgKHZhciBpID0gc2FtZVBhcnRzTGVuZ3RoOyBpIDwgZnJvbVBhcnRzLmxlbmd0aDsgaSsrKSB7CgkJCQkJCW91dHB1dFBhcnRzLnB1c2goIi4uIikKCQkJCQl9CgkJCQkJb3V0cHV0UGFydHMgPSBvdXRwdXRQYXJ0cy5jb25jYXQodG9QYXJ0cy5zbGljZShzYW1lUGFydHNMZW5ndGgpKTsKCQkJCQlyZXR1cm4gb3V0cHV0UGFydHMuam9pbigiLyIpCgkJCQl9CgkJCX07CiAgCgkJCWZ1bmN0aW9uIGxlbmd0aEJ5dGVzVVRGOChzdHIpIHsKCQkJCXZhciBsZW4gPSAwOwoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKCQkJCQl2YXIgYyA9IHN0ci5jaGFyQ29kZUF0KGkpOwoJCQkJCWlmIChjIDw9IDEyNykgewoJCQkJCQlsZW4rKwoJCQkJCX0gZWxzZSBpZiAoYyA8PSAyMDQ3KSB7CgkJCQkJCWxlbiArPSAyCgkJCQkJfSBlbHNlIGlmIChjID49IDU1Mjk2ICYmIGMgPD0gNTczNDMpIHsKCQkJCQkJbGVuICs9IDQ7CgkJCQkJCSsraQoJCQkJCX0gZWxzZSB7CgkJCQkJCWxlbiArPSAzCgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIGxlbgoJCQl9CiAgCgkJCWZ1bmN0aW9uIHN0cmluZ1RvVVRGOEFycmF5KHN0ciwgaGVhcCwgb3V0SWR4LCBtYXhCeXRlc1RvV3JpdGUpIHsKCQkJCWlmICghKG1heEJ5dGVzVG9Xcml0ZSA+IDApKSByZXR1cm4gMDsKCQkJCXZhciBzdGFydElkeCA9IG91dElkeDsKCQkJCXZhciBlbmRJZHggPSBvdXRJZHggKyBtYXhCeXRlc1RvV3JpdGUgLSAxOwoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKCQkJCQl2YXIgdSA9IHN0ci5jaGFyQ29kZUF0KGkpOwoJCQkJCWlmICh1ID49IDU1Mjk2ICYmIHUgPD0gNTczNDMpIHsKCQkJCQkJdmFyIHUxID0gc3RyLmNoYXJDb2RlQXQoKytpKTsKCQkJCQkJdSA9IDY1NTM2ICsgKCh1ICYgMTAyMykgPDwgMTApIHwgdTEgJiAxMDIzCgkJCQkJfQoJCQkJCWlmICh1IDw9IDEyNykgewoJCQkJCQlpZiAob3V0SWR4ID49IGVuZElkeCkgYnJlYWs7CgkJCQkJCWhlYXBbb3V0SWR4KytdID0gdQoJCQkJCX0gZWxzZSBpZiAodSA8PSAyMDQ3KSB7CgkJCQkJCWlmIChvdXRJZHggKyAxID49IGVuZElkeCkgYnJlYWs7CgkJCQkJCWhlYXBbb3V0SWR4KytdID0gMTkyIHwgdSA+PiA2OwoJCQkJCQloZWFwW291dElkeCsrXSA9IDEyOCB8IHUgJiA2MwoJCQkJCX0gZWxzZSBpZiAodSA8PSA2NTUzNSkgewoJCQkJCQlpZiAob3V0SWR4ICsgMiA+PSBlbmRJZHgpIGJyZWFrOwoJCQkJCQloZWFwW291dElkeCsrXSA9IDIyNCB8IHUgPj4gMTI7CgkJCQkJCWhlYXBbb3V0SWR4KytdID0gMTI4IHwgdSA+PiA2ICYgNjM7CgkJCQkJCWhlYXBbb3V0SWR4KytdID0gMTI4IHwgdSAmIDYzCgkJCQkJfSBlbHNlIHsKCQkJCQkJaWYgKG91dElkeCArIDMgPj0gZW5kSWR4KSBicmVhazsKCQkJCQkJaGVhcFtvdXRJZHgrK10gPSAyNDAgfCB1ID4+IDE4OwoJCQkJCQloZWFwW291dElkeCsrXSA9IDEyOCB8IHUgPj4gMTIgJiA2MzsKCQkJCQkJaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1ID4+IDYgJiA2MzsKCQkJCQkJaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1ICYgNjMKCQkJCQl9CgkJCQl9CgkJCQloZWFwW291dElkeF0gPSAwOwoJCQkJcmV0dXJuIG91dElkeCAtIHN0YXJ0SWR4CgkJCX0KICAKCQkJZnVuY3Rpb24gaW50QXJyYXlGcm9tU3RyaW5nKHN0cmluZ3ksIGRvbnRBZGROdWxsLCBsZW5ndGgpIHsKCQkJCXZhciBsZW4gPSBsZW5ndGggPiAwID8gbGVuZ3RoIDogbGVuZ3RoQnl0ZXNVVEY4KHN0cmluZ3kpICsgMTsKCQkJCXZhciB1OGFycmF5ID0gbmV3IEFycmF5KGxlbik7CgkJCQl2YXIgbnVtQnl0ZXNXcml0dGVuID0gc3RyaW5nVG9VVEY4QXJyYXkoc3RyaW5neSwgdThhcnJheSwgMCwgdThhcnJheS5sZW5ndGgpOwoJCQkJaWYgKGRvbnRBZGROdWxsKSB1OGFycmF5Lmxlbmd0aCA9IG51bUJ5dGVzV3JpdHRlbjsKCQkJCXJldHVybiB1OGFycmF5CgkJCX0KCQkJdmFyIFVURjhEZWNvZGVyID0gdHlwZW9mIFRleHREZWNvZGVyICE9ICJ1bmRlZmluZWQiID8gbmV3IFRleHREZWNvZGVyKCJ1dGY4IikgOiB1bmRlZmluZWQ7CiAgCgkJCWZ1bmN0aW9uIFVURjhBcnJheVRvU3RyaW5nKGhlYXBPckFycmF5LCBpZHgsIG1heEJ5dGVzVG9SZWFkKSB7CgkJCQl2YXIgZW5kSWR4ID0gaWR4ICsgbWF4Qnl0ZXNUb1JlYWQ7CgkJCQl2YXIgZW5kUHRyID0gaWR4OwoJCQkJd2hpbGUgKGhlYXBPckFycmF5W2VuZFB0cl0gJiYgIShlbmRQdHIgPj0gZW5kSWR4KSkgKytlbmRQdHI7CgkJCQlpZiAoZW5kUHRyIC0gaWR4ID4gMTYgJiYgaGVhcE9yQXJyYXkuYnVmZmVyICYmIFVURjhEZWNvZGVyKSB7CgkJCQkJcmV0dXJuIFVURjhEZWNvZGVyLmRlY29kZShoZWFwT3JBcnJheS5zdWJhcnJheShpZHgsIGVuZFB0cikpCgkJCQl9CgkJCQl2YXIgc3RyID0gIiI7CgkJCQl3aGlsZSAoaWR4IDwgZW5kUHRyKSB7CgkJCQkJdmFyIHUwID0gaGVhcE9yQXJyYXlbaWR4KytdOwoJCQkJCWlmICghKHUwICYgMTI4KSkgewoJCQkJCQlzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSh1MCk7CgkJCQkJCWNvbnRpbnVlCgkJCQkJfQoJCQkJCXZhciB1MSA9IGhlYXBPckFycmF5W2lkeCsrXSAmIDYzOwoJCQkJCWlmICgodTAgJiAyMjQpID09IDE5MikgewoJCQkJCQlzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgodTAgJiAzMSkgPDwgNiB8IHUxKTsKCQkJCQkJY29udGludWUKCQkJCQl9CgkJCQkJdmFyIHUyID0gaGVhcE9yQXJyYXlbaWR4KytdICYgNjM7CgkJCQkJaWYgKCh1MCAmIDI0MCkgPT0gMjI0KSB7CgkJCQkJCXUwID0gKHUwICYgMTUpIDw8IDEyIHwgdTEgPDwgNiB8IHUyCgkJCQkJfSBlbHNlIHsKCQkJCQkJdTAgPSAodTAgJiA3KSA8PCAxOCB8IHUxIDw8IDEyIHwgdTIgPDwgNiB8IGhlYXBPckFycmF5W2lkeCsrXSAmIDYzCgkJCQkJfQoJCQkJCWlmICh1MCA8IDY1NTM2KSB7CgkJCQkJCXN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHUwKQoJCQkJCX0gZWxzZSB7CgkJCQkJCXZhciBjaCA9IHUwIC0gNjU1MzY7CgkJCQkJCXN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDU1Mjk2IHwgY2ggPj4gMTAsIDU2MzIwIHwgY2ggJiAxMDIzKQoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiBzdHIKCQkJfQoJCQl2YXIgVFRZID0gewoJCQkJdHR5czogW10sCgkJCQlpbml0OiBmdW5jdGlvbigpIHt9LAoJCQkJc2h1dGRvd246IGZ1bmN0aW9uKCkge30sCgkJCQlyZWdpc3RlcjogZnVuY3Rpb24oZGV2LCBvcHMpIHsKCQkJCQlUVFkudHR5c1tkZXZdID0gewoJCQkJCQlpbnB1dDogW10sCgkJCQkJCW91dHB1dDogW10sCgkJCQkJCW9wczogb3BzCgkJCQkJfTsKCQkJCQlGUy5yZWdpc3RlckRldmljZShkZXYsIFRUWS5zdHJlYW1fb3BzKQoJCQkJfSwKCQkJCXN0cmVhbV9vcHM6IHsKCQkJCQlvcGVuOiBmdW5jdGlvbihzdHJlYW0pIHsKCQkJCQkJdmFyIHR0eSA9IFRUWS50dHlzW3N0cmVhbS5ub2RlLnJkZXZdOwoJCQkJCQlpZiAoIXR0eSkgewoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDMpCgkJCQkJCX0KCQkJCQkJc3RyZWFtLnR0eSA9IHR0eTsKCQkJCQkJc3RyZWFtLnNlZWthYmxlID0gZmFsc2UKCQkJCQl9LAoJCQkJCWNsb3NlOiBmdW5jdGlvbihzdHJlYW0pIHsKCQkJCQkJc3RyZWFtLnR0eS5vcHMuZnN5bmMoc3RyZWFtLnR0eSkKCQkJCQl9LAoJCQkJCWZzeW5jOiBmdW5jdGlvbihzdHJlYW0pIHsKCQkJCQkJc3RyZWFtLnR0eS5vcHMuZnN5bmMoc3RyZWFtLnR0eSkKCQkJCQl9LAoJCQkJCXJlYWQ6IGZ1bmN0aW9uKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zKSB7CgkJCQkJCWlmICghc3RyZWFtLnR0eSB8fCAhc3RyZWFtLnR0eS5vcHMuZ2V0X2NoYXIpIHsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYwKQoJCQkJCQl9CgkJCQkJCXZhciBieXRlc1JlYWQgPSAwOwoJCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJCQkJCQl2YXIgcmVzdWx0OwoJCQkJCQkJdHJ5IHsKCQkJCQkJCQlyZXN1bHQgPSBzdHJlYW0udHR5Lm9wcy5nZXRfY2hhcihzdHJlYW0udHR5KQoJCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI5KQoJCQkJCQkJfQoJCQkJCQkJaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkICYmIGJ5dGVzUmVhZCA9PT0gMCkgewoJCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYpCgkJCQkJCQl9CgkJCQkJCQlpZiAocmVzdWx0ID09PSBudWxsIHx8IHJlc3VsdCA9PT0gdW5kZWZpbmVkKSBicmVhazsKCQkJCQkJCWJ5dGVzUmVhZCsrOwoJCQkJCQkJYnVmZmVyW29mZnNldCArIGldID0gcmVzdWx0CgkJCQkJCX0KCQkJCQkJaWYgKGJ5dGVzUmVhZCkgewoJCQkJCQkJc3RyZWFtLm5vZGUudGltZXN0YW1wID0gRGF0ZS5ub3coKQoJCQkJCQl9CgkJCQkJCXJldHVybiBieXRlc1JlYWQKCQkJCQl9LAoJCQkJCXdyaXRlOiBmdW5jdGlvbihzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvcykgewoJCQkJCQlpZiAoIXN0cmVhbS50dHkgfHwgIXN0cmVhbS50dHkub3BzLnB1dF9jaGFyKSB7CgkJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig2MCkKCQkJCQkJfQoJCQkJCQl0cnkgewoJCQkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJCQkJCQkJCXN0cmVhbS50dHkub3BzLnB1dF9jaGFyKHN0cmVhbS50dHksIGJ1ZmZlcltvZmZzZXQgKyBpXSkKCQkJCQkJCX0KCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjkpCgkJCQkJCX0KCQkJCQkJaWYgKGxlbmd0aCkgewoJCQkJCQkJc3RyZWFtLm5vZGUudGltZXN0YW1wID0gRGF0ZS5ub3coKQoJCQkJCQl9CgkJCQkJCXJldHVybiBpCgkJCQkJfQoJCQkJfSwKCQkJCWRlZmF1bHRfdHR5X29wczogewoJCQkJCWdldF9jaGFyOiBmdW5jdGlvbih0dHkpIHsKCQkJCQkJaWYgKCF0dHkuaW5wdXQubGVuZ3RoKSB7CgkJCQkJCQl2YXIgcmVzdWx0ID0gbnVsbDsKCQkJCQkJCWlmIChFTlZJUk9OTUVOVF9JU19OT0RFKSB7CgkJCQkJCQkJdmFyIEJVRlNJWkUgPSAyNTY7CgkJCQkJCQkJdmFyIGJ1ZiA9IEJ1ZmZlci5hbGxvYyhCVUZTSVpFKTsKCQkJCQkJCQl2YXIgYnl0ZXNSZWFkID0gMDsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQlieXRlc1JlYWQgPSBmcy5yZWFkU3luYyhwcm9jZXNzLnN0ZGluLmZkLCBidWYsIDAsIEJVRlNJWkUsIC0xKQoJCQkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCQkJaWYgKGUudG9TdHJpbmcoKS5pbmNsdWRlcygiRU9GIikpIGJ5dGVzUmVhZCA9IDA7CgkJCQkJCQkJCWVsc2UgdGhyb3cgZQoJCQkJCQkJCX0KCQkJCQkJCQlpZiAoYnl0ZXNSZWFkID4gMCkgewoJCQkJCQkJCQlyZXN1bHQgPSBidWYuc2xpY2UoMCwgYnl0ZXNSZWFkKS50b1N0cmluZygidXRmLTgiKQoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCXJlc3VsdCA9IG51bGwKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZiB3aW5kb3cgIT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5wcm9tcHQgPT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJlc3VsdCA9IHdpbmRvdy5wcm9tcHQoIklucHV0OiAiKTsKCQkJCQkJCQlpZiAocmVzdWx0ICE9PSBudWxsKSB7CgkJCQkJCQkJCXJlc3VsdCArPSAiXG4iCgkJCQkJCQkJfQoJCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YgcmVhZGxpbmUgPT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJlc3VsdCA9IHJlYWRsaW5lKCk7CgkJCQkJCQkJaWYgKHJlc3VsdCAhPT0gbnVsbCkgewoJCQkJCQkJCQlyZXN1bHQgKz0gIlxuIgoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJCWlmICghcmVzdWx0KSB7CgkJCQkJCQkJcmV0dXJuIG51bGwKCQkJCQkJCX0KCQkJCQkJCXR0eS5pbnB1dCA9IGludEFycmF5RnJvbVN0cmluZyhyZXN1bHQsIHRydWUpCgkJCQkJCX0KCQkJCQkJcmV0dXJuIHR0eS5pbnB1dC5zaGlmdCgpCgkJCQkJfSwKCQkJCQlwdXRfY2hhcjogZnVuY3Rpb24odHR5LCB2YWwpIHsKCQkJCQkJaWYgKHZhbCA9PT0gbnVsbCB8fCB2YWwgPT09IDEwKSB7CgkJCQkJCQlvdXQoVVRGOEFycmF5VG9TdHJpbmcodHR5Lm91dHB1dCwgMCkpOwoJCQkJCQkJdHR5Lm91dHB1dCA9IFtdCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlpZiAodmFsICE9IDApIHR0eS5vdXRwdXQucHVzaCh2YWwpCgkJCQkJCX0KCQkJCQl9LAoJCQkJCWZzeW5jOiBmdW5jdGlvbih0dHkpIHsKCQkJCQkJaWYgKHR0eS5vdXRwdXQgJiYgdHR5Lm91dHB1dC5sZW5ndGggPiAwKSB7CgkJCQkJCQlvdXQoVVRGOEFycmF5VG9TdHJpbmcodHR5Lm91dHB1dCwgMCkpOwoJCQkJCQkJdHR5Lm91dHB1dCA9IFtdCgkJCQkJCX0KCQkJCQl9CgkJCQl9LAoJCQkJZGVmYXVsdF90dHkxX29wczogewoJCQkJCXB1dF9jaGFyOiBmdW5jdGlvbih0dHksIHZhbCkgewoJCQkJCQlpZiAodmFsID09PSBudWxsIHx8IHZhbCA9PT0gMTApIHsKCQkJCQkJCWVycihVVEY4QXJyYXlUb1N0cmluZyh0dHkub3V0cHV0LCAwKSk7CgkJCQkJCQl0dHkub3V0cHV0ID0gW10KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWlmICh2YWwgIT0gMCkgdHR5Lm91dHB1dC5wdXNoKHZhbCkKCQkJCQkJfQoJCQkJCX0sCgkJCQkJZnN5bmM6IGZ1bmN0aW9uKHR0eSkgewoJCQkJCQlpZiAodHR5Lm91dHB1dCAmJiB0dHkub3V0cHV0Lmxlbmd0aCA+IDApIHsKCQkJCQkJCWVycihVVEY4QXJyYXlUb1N0cmluZyh0dHkub3V0cHV0LCAwKSk7CgkJCQkJCQl0dHkub3V0cHV0ID0gW10KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfTsKICAKCQkJZnVuY3Rpb24gemVyb01lbW9yeShhZGRyZXNzLCBzaXplKSB7CgkJCQlIRUFQVTguZmlsbCgwLCBhZGRyZXNzLCBhZGRyZXNzICsgc2l6ZSk7CgkJCQlyZXR1cm4gYWRkcmVzcwoJCQl9CiAgCgkJCWZ1bmN0aW9uIGFsaWduTWVtb3J5KHNpemUsIGFsaWdubWVudCkgewoJCQkJcmV0dXJuIE1hdGguY2VpbChzaXplIC8gYWxpZ25tZW50KSAqIGFsaWdubWVudAoJCQl9CiAgCgkJCWZ1bmN0aW9uIG1tYXBBbGxvYyhzaXplKSB7CgkJCQlzaXplID0gYWxpZ25NZW1vcnkoc2l6ZSwgNjU1MzYpOwoJCQkJdmFyIHB0ciA9IF9lbXNjcmlwdGVuX2J1aWx0aW5fbWVtYWxpZ24oNjU1MzYsIHNpemUpOwoJCQkJaWYgKCFwdHIpIHJldHVybiAwOwoJCQkJcmV0dXJuIHplcm9NZW1vcnkocHRyLCBzaXplKQoJCQl9CgkJCXZhciBNRU1GUyA9IHsKCQkJCW9wc190YWJsZTogbnVsbCwKCQkJCW1vdW50OiBmdW5jdGlvbihtb3VudCkgewoJCQkJCXJldHVybiBNRU1GUy5jcmVhdGVOb2RlKG51bGwsICIvIiwgMTYzODQgfCA1MTEsIDApCgkJCQl9LAoJCQkJY3JlYXRlTm9kZTogZnVuY3Rpb24ocGFyZW50LCBuYW1lLCBtb2RlLCBkZXYpIHsKCQkJCQlpZiAoRlMuaXNCbGtkZXYobW9kZSkgfHwgRlMuaXNGSUZPKG1vZGUpKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYzKQoJCQkJCX0KCQkJCQlpZiAoIU1FTUZTLm9wc190YWJsZSkgewoJCQkJCQlNRU1GUy5vcHNfdGFibGUgPSB7CgkJCQkJCQlkaXI6IHsKCQkJCQkJCQlub2RlOiB7CgkJCQkJCQkJCWdldGF0dHI6IE1FTUZTLm5vZGVfb3BzLmdldGF0dHIsCgkJCQkJCQkJCXNldGF0dHI6IE1FTUZTLm5vZGVfb3BzLnNldGF0dHIsCgkJCQkJCQkJCWxvb2t1cDogTUVNRlMubm9kZV9vcHMubG9va3VwLAoJCQkJCQkJCQlta25vZDogTUVNRlMubm9kZV9vcHMubWtub2QsCgkJCQkJCQkJCXJlbmFtZTogTUVNRlMubm9kZV9vcHMucmVuYW1lLAoJCQkJCQkJCQl1bmxpbms6IE1FTUZTLm5vZGVfb3BzLnVubGluaywKCQkJCQkJCQkJcm1kaXI6IE1FTUZTLm5vZGVfb3BzLnJtZGlyLAoJCQkJCQkJCQlyZWFkZGlyOiBNRU1GUy5ub2RlX29wcy5yZWFkZGlyLAoJCQkJCQkJCQlzeW1saW5rOiBNRU1GUy5ub2RlX29wcy5zeW1saW5rCgkJCQkJCQkJfSwKCQkJCQkJCQlzdHJlYW06IHsKCQkJCQkJCQkJbGxzZWVrOiBNRU1GUy5zdHJlYW1fb3BzLmxsc2VlawoJCQkJCQkJCX0KCQkJCQkJCX0sCgkJCQkJCQlmaWxlOiB7CgkJCQkJCQkJbm9kZTogewoJCQkJCQkJCQlnZXRhdHRyOiBNRU1GUy5ub2RlX29wcy5nZXRhdHRyLAoJCQkJCQkJCQlzZXRhdHRyOiBNRU1GUy5ub2RlX29wcy5zZXRhdHRyCgkJCQkJCQkJfSwKCQkJCQkJCQlzdHJlYW06IHsKCQkJCQkJCQkJbGxzZWVrOiBNRU1GUy5zdHJlYW1fb3BzLmxsc2VlaywKCQkJCQkJCQkJcmVhZDogTUVNRlMuc3RyZWFtX29wcy5yZWFkLAoJCQkJCQkJCQl3cml0ZTogTUVNRlMuc3RyZWFtX29wcy53cml0ZSwKCQkJCQkJCQkJYWxsb2NhdGU6IE1FTUZTLnN0cmVhbV9vcHMuYWxsb2NhdGUsCgkJCQkJCQkJCW1tYXA6IE1FTUZTLnN0cmVhbV9vcHMubW1hcCwKCQkJCQkJCQkJbXN5bmM6IE1FTUZTLnN0cmVhbV9vcHMubXN5bmMKCQkJCQkJCQl9CgkJCQkJCQl9LAoJCQkJCQkJbGluazogewoJCQkJCQkJCW5vZGU6IHsKCQkJCQkJCQkJZ2V0YXR0cjogTUVNRlMubm9kZV9vcHMuZ2V0YXR0ciwKCQkJCQkJCQkJc2V0YXR0cjogTUVNRlMubm9kZV9vcHMuc2V0YXR0ciwKCQkJCQkJCQkJcmVhZGxpbms6IE1FTUZTLm5vZGVfb3BzLnJlYWRsaW5rCgkJCQkJCQkJfSwKCQkJCQkJCQlzdHJlYW06IHt9CgkJCQkJCQl9LAoJCQkJCQkJY2hyZGV2OiB7CgkJCQkJCQkJbm9kZTogewoJCQkJCQkJCQlnZXRhdHRyOiBNRU1GUy5ub2RlX29wcy5nZXRhdHRyLAoJCQkJCQkJCQlzZXRhdHRyOiBNRU1GUy5ub2RlX29wcy5zZXRhdHRyCgkJCQkJCQkJfSwKCQkJCQkJCQlzdHJlYW06IEZTLmNocmRldl9zdHJlYW1fb3BzCgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQkJdmFyIG5vZGUgPSBGUy5jcmVhdGVOb2RlKHBhcmVudCwgbmFtZSwgbW9kZSwgZGV2KTsKCQkJCQlpZiAoRlMuaXNEaXIobm9kZS5tb2RlKSkgewoJCQkJCQlub2RlLm5vZGVfb3BzID0gTUVNRlMub3BzX3RhYmxlLmRpci5ub2RlOwoJCQkJCQlub2RlLnN0cmVhbV9vcHMgPSBNRU1GUy5vcHNfdGFibGUuZGlyLnN0cmVhbTsKCQkJCQkJbm9kZS5jb250ZW50cyA9IHt9CgkJCQkJfSBlbHNlIGlmIChGUy5pc0ZpbGUobm9kZS5tb2RlKSkgewoJCQkJCQlub2RlLm5vZGVfb3BzID0gTUVNRlMub3BzX3RhYmxlLmZpbGUubm9kZTsKCQkJCQkJbm9kZS5zdHJlYW1fb3BzID0gTUVNRlMub3BzX3RhYmxlLmZpbGUuc3RyZWFtOwoJCQkJCQlub2RlLnVzZWRCeXRlcyA9IDA7CgkJCQkJCW5vZGUuY29udGVudHMgPSBudWxsCgkJCQkJfSBlbHNlIGlmIChGUy5pc0xpbmsobm9kZS5tb2RlKSkgewoJCQkJCQlub2RlLm5vZGVfb3BzID0gTUVNRlMub3BzX3RhYmxlLmxpbmsubm9kZTsKCQkJCQkJbm9kZS5zdHJlYW1fb3BzID0gTUVNRlMub3BzX3RhYmxlLmxpbmsuc3RyZWFtCgkJCQkJfSBlbHNlIGlmIChGUy5pc0NocmRldihub2RlLm1vZGUpKSB7CgkJCQkJCW5vZGUubm9kZV9vcHMgPSBNRU1GUy5vcHNfdGFibGUuY2hyZGV2Lm5vZGU7CgkJCQkJCW5vZGUuc3RyZWFtX29wcyA9IE1FTUZTLm9wc190YWJsZS5jaHJkZXYuc3RyZWFtCgkJCQkJfQoJCQkJCW5vZGUudGltZXN0YW1wID0gRGF0ZS5ub3coKTsKCQkJCQlpZiAocGFyZW50KSB7CgkJCQkJCXBhcmVudC5jb250ZW50c1tuYW1lXSA9IG5vZGU7CgkJCQkJCXBhcmVudC50aW1lc3RhbXAgPSBub2RlLnRpbWVzdGFtcAoJCQkJCX0KCQkJCQlyZXR1cm4gbm9kZQoJCQkJfSwKCQkJCWdldEZpbGVEYXRhQXNUeXBlZEFycmF5OiBmdW5jdGlvbihub2RlKSB7CgkJCQkJaWYgKCFub2RlLmNvbnRlbnRzKSByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoMCk7CgkJCQkJaWYgKG5vZGUuY29udGVudHMuc3ViYXJyYXkpIHJldHVybiBub2RlLmNvbnRlbnRzLnN1YmFycmF5KDAsIG5vZGUudXNlZEJ5dGVzKTsKCQkJCQlyZXR1cm4gbmV3IFVpbnQ4QXJyYXkobm9kZS5jb250ZW50cykKCQkJCX0sCgkJCQlleHBhbmRGaWxlU3RvcmFnZTogZnVuY3Rpb24obm9kZSwgbmV3Q2FwYWNpdHkpIHsKCQkJCQl2YXIgcHJldkNhcGFjaXR5ID0gbm9kZS5jb250ZW50cyA/IG5vZGUuY29udGVudHMubGVuZ3RoIDogMDsKCQkJCQlpZiAocHJldkNhcGFjaXR5ID49IG5ld0NhcGFjaXR5KSByZXR1cm47CgkJCQkJdmFyIENBUEFDSVRZX0RPVUJMSU5HX01BWCA9IDEwMjQgKiAxMDI0OwoJCQkJCW5ld0NhcGFjaXR5ID0gTWF0aC5tYXgobmV3Q2FwYWNpdHksIHByZXZDYXBhY2l0eSAqIChwcmV2Q2FwYWNpdHkgPCBDQVBBQ0lUWV9ET1VCTElOR19NQVggPyAyIDogMS4xMjUpID4+PiAwKTsKCQkJCQlpZiAocHJldkNhcGFjaXR5ICE9IDApIG5ld0NhcGFjaXR5ID0gTWF0aC5tYXgobmV3Q2FwYWNpdHksIDI1Nik7CgkJCQkJdmFyIG9sZENvbnRlbnRzID0gbm9kZS5jb250ZW50czsKCQkJCQlub2RlLmNvbnRlbnRzID0gbmV3IFVpbnQ4QXJyYXkobmV3Q2FwYWNpdHkpOwoJCQkJCWlmIChub2RlLnVzZWRCeXRlcyA+IDApIG5vZGUuY29udGVudHMuc2V0KG9sZENvbnRlbnRzLnN1YmFycmF5KDAsIG5vZGUudXNlZEJ5dGVzKSwgMCkKCQkJCX0sCgkJCQlyZXNpemVGaWxlU3RvcmFnZTogZnVuY3Rpb24obm9kZSwgbmV3U2l6ZSkgewoJCQkJCWlmIChub2RlLnVzZWRCeXRlcyA9PSBuZXdTaXplKSByZXR1cm47CgkJCQkJaWYgKG5ld1NpemUgPT0gMCkgewoJCQkJCQlub2RlLmNvbnRlbnRzID0gbnVsbDsKCQkJCQkJbm9kZS51c2VkQnl0ZXMgPSAwCgkJCQkJfSBlbHNlIHsKCQkJCQkJdmFyIG9sZENvbnRlbnRzID0gbm9kZS5jb250ZW50czsKCQkJCQkJbm9kZS5jb250ZW50cyA9IG5ldyBVaW50OEFycmF5KG5ld1NpemUpOwoJCQkJCQlpZiAob2xkQ29udGVudHMpIHsKCQkJCQkJCW5vZGUuY29udGVudHMuc2V0KG9sZENvbnRlbnRzLnN1YmFycmF5KDAsIE1hdGgubWluKG5ld1NpemUsIG5vZGUudXNlZEJ5dGVzKSkpCgkJCQkJCX0KCQkJCQkJbm9kZS51c2VkQnl0ZXMgPSBuZXdTaXplCgkJCQkJfQoJCQkJfSwKCQkJCW5vZGVfb3BzOiB7CgkJCQkJZ2V0YXR0cjogZnVuY3Rpb24obm9kZSkgewoJCQkJCQl2YXIgYXR0ciA9IHt9OwoJCQkJCQlhdHRyLmRldiA9IEZTLmlzQ2hyZGV2KG5vZGUubW9kZSkgPyBub2RlLmlkIDogMTsKCQkJCQkJYXR0ci5pbm8gPSBub2RlLmlkOwoJCQkJCQlhdHRyLm1vZGUgPSBub2RlLm1vZGU7CgkJCQkJCWF0dHIubmxpbmsgPSAxOwoJCQkJCQlhdHRyLnVpZCA9IDA7CgkJCQkJCWF0dHIuZ2lkID0gMDsKCQkJCQkJYXR0ci5yZGV2ID0gbm9kZS5yZGV2OwoJCQkJCQlpZiAoRlMuaXNEaXIobm9kZS5tb2RlKSkgewoJCQkJCQkJYXR0ci5zaXplID0gNDA5NgoJCQkJCQl9IGVsc2UgaWYgKEZTLmlzRmlsZShub2RlLm1vZGUpKSB7CgkJCQkJCQlhdHRyLnNpemUgPSBub2RlLnVzZWRCeXRlcwoJCQkJCQl9IGVsc2UgaWYgKEZTLmlzTGluayhub2RlLm1vZGUpKSB7CgkJCQkJCQlhdHRyLnNpemUgPSBub2RlLmxpbmsubGVuZ3RoCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlhdHRyLnNpemUgPSAwCgkJCQkJCX0KCQkJCQkJYXR0ci5hdGltZSA9IG5ldyBEYXRlKG5vZGUudGltZXN0YW1wKTsKCQkJCQkJYXR0ci5tdGltZSA9IG5ldyBEYXRlKG5vZGUudGltZXN0YW1wKTsKCQkJCQkJYXR0ci5jdGltZSA9IG5ldyBEYXRlKG5vZGUudGltZXN0YW1wKTsKCQkJCQkJYXR0ci5ibGtzaXplID0gNDA5NjsKCQkJCQkJYXR0ci5ibG9ja3MgPSBNYXRoLmNlaWwoYXR0ci5zaXplIC8gYXR0ci5ibGtzaXplKTsKCQkJCQkJcmV0dXJuIGF0dHIKCQkJCQl9LAoJCQkJCXNldGF0dHI6IGZ1bmN0aW9uKG5vZGUsIGF0dHIpIHsKCQkJCQkJaWYgKGF0dHIubW9kZSAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJCQlub2RlLm1vZGUgPSBhdHRyLm1vZGUKCQkJCQkJfQoJCQkJCQlpZiAoYXR0ci50aW1lc3RhbXAgIT09IHVuZGVmaW5lZCkgewoJCQkJCQkJbm9kZS50aW1lc3RhbXAgPSBhdHRyLnRpbWVzdGFtcAoJCQkJCQl9CgkJCQkJCWlmIChhdHRyLnNpemUgIT09IHVuZGVmaW5lZCkgewoJCQkJCQkJTUVNRlMucmVzaXplRmlsZVN0b3JhZ2Uobm9kZSwgYXR0ci5zaXplKQoJCQkJCQl9CgkJCQkJfSwKCQkJCQlsb29rdXA6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSkgewoJCQkJCQl0aHJvdyBGUy5nZW5lcmljRXJyb3JzWzQ0XQoJCQkJCX0sCgkJCQkJbWtub2Q6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSwgbW9kZSwgZGV2KSB7CgkJCQkJCXJldHVybiBNRU1GUy5jcmVhdGVOb2RlKHBhcmVudCwgbmFtZSwgbW9kZSwgZGV2KQoJCQkJCX0sCgkJCQkJcmVuYW1lOiBmdW5jdGlvbihvbGRfbm9kZSwgbmV3X2RpciwgbmV3X25hbWUpIHsKCQkJCQkJaWYgKEZTLmlzRGlyKG9sZF9ub2RlLm1vZGUpKSB7CgkJCQkJCQl2YXIgbmV3X25vZGU7CgkJCQkJCQl0cnkgewoJCQkJCQkJCW5ld19ub2RlID0gRlMubG9va3VwTm9kZShuZXdfZGlyLCBuZXdfbmFtZSkKCQkJCQkJCX0gY2F0Y2ggKGUpIHt9CgkJCQkJCQlpZiAobmV3X25vZGUpIHsKCQkJCQkJCQlmb3IgKHZhciBpIGluIG5ld19ub2RlLmNvbnRlbnRzKSB7CgkJCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDU1KQoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQlkZWxldGUgb2xkX25vZGUucGFyZW50LmNvbnRlbnRzW29sZF9ub2RlLm5hbWVdOwoJCQkJCQlvbGRfbm9kZS5wYXJlbnQudGltZXN0YW1wID0gRGF0ZS5ub3coKTsKCQkJCQkJb2xkX25vZGUubmFtZSA9IG5ld19uYW1lOwoJCQkJCQluZXdfZGlyLmNvbnRlbnRzW25ld19uYW1lXSA9IG9sZF9ub2RlOwoJCQkJCQluZXdfZGlyLnRpbWVzdGFtcCA9IG9sZF9ub2RlLnBhcmVudC50aW1lc3RhbXA7CgkJCQkJCW9sZF9ub2RlLnBhcmVudCA9IG5ld19kaXIKCQkJCQl9LAoJCQkJCXVubGluazogZnVuY3Rpb24ocGFyZW50LCBuYW1lKSB7CgkJCQkJCWRlbGV0ZSBwYXJlbnQuY29udGVudHNbbmFtZV07CgkJCQkJCXBhcmVudC50aW1lc3RhbXAgPSBEYXRlLm5vdygpCgkJCQkJfSwKCQkJCQlybWRpcjogZnVuY3Rpb24ocGFyZW50LCBuYW1lKSB7CgkJCQkJCXZhciBub2RlID0gRlMubG9va3VwTm9kZShwYXJlbnQsIG5hbWUpOwoJCQkJCQlmb3IgKHZhciBpIGluIG5vZGUuY29udGVudHMpIHsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDU1KQoJCQkJCQl9CgkJCQkJCWRlbGV0ZSBwYXJlbnQuY29udGVudHNbbmFtZV07CgkJCQkJCXBhcmVudC50aW1lc3RhbXAgPSBEYXRlLm5vdygpCgkJCQkJfSwKCQkJCQlyZWFkZGlyOiBmdW5jdGlvbihub2RlKSB7CgkJCQkJCXZhciBlbnRyaWVzID0gWyIuIiwgIi4uIl07CgkJCQkJCWZvciAodmFyIGtleSBpbiBub2RlLmNvbnRlbnRzKSB7CgkJCQkJCQlpZiAoIW5vZGUuY29udGVudHMuaGFzT3duUHJvcGVydHkoa2V5KSkgewoJCQkJCQkJCWNvbnRpbnVlCgkJCQkJCQl9CgkJCQkJCQllbnRyaWVzLnB1c2goa2V5KQoJCQkJCQl9CgkJCQkJCXJldHVybiBlbnRyaWVzCgkJCQkJfSwKCQkJCQlzeW1saW5rOiBmdW5jdGlvbihwYXJlbnQsIG5ld25hbWUsIG9sZHBhdGgpIHsKCQkJCQkJdmFyIG5vZGUgPSBNRU1GUy5jcmVhdGVOb2RlKHBhcmVudCwgbmV3bmFtZSwgNTExIHwgNDA5NjAsIDApOwoJCQkJCQlub2RlLmxpbmsgPSBvbGRwYXRoOwoJCQkJCQlyZXR1cm4gbm9kZQoJCQkJCX0sCgkJCQkJcmVhZGxpbms6IGZ1bmN0aW9uKG5vZGUpIHsKCQkJCQkJaWYgKCFGUy5pc0xpbmsobm9kZS5tb2RlKSkgewoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjgpCgkJCQkJCX0KCQkJCQkJcmV0dXJuIG5vZGUubGluawoJCQkJCX0KCQkJCX0sCgkJCQlzdHJlYW1fb3BzOiB7CgkJCQkJcmVhZDogZnVuY3Rpb24oc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbikgewoJCQkJCQl2YXIgY29udGVudHMgPSBzdHJlYW0ubm9kZS5jb250ZW50czsKCQkJCQkJaWYgKHBvc2l0aW9uID49IHN0cmVhbS5ub2RlLnVzZWRCeXRlcykgcmV0dXJuIDA7CgkJCQkJCXZhciBzaXplID0gTWF0aC5taW4oc3RyZWFtLm5vZGUudXNlZEJ5dGVzIC0gcG9zaXRpb24sIGxlbmd0aCk7CgkJCQkJCWlmIChzaXplID4gOCAmJiBjb250ZW50cy5zdWJhcnJheSkgewoJCQkJCQkJYnVmZmVyLnNldChjb250ZW50cy5zdWJhcnJheShwb3NpdGlvbiwgcG9zaXRpb24gKyBzaXplKSwgb2Zmc2V0KQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzaXplOyBpKyspIGJ1ZmZlcltvZmZzZXQgKyBpXSA9IGNvbnRlbnRzW3Bvc2l0aW9uICsgaV0KCQkJCQkJfQoJCQkJCQlyZXR1cm4gc2l6ZQoJCQkJCX0sCgkJCQkJd3JpdGU6IGZ1bmN0aW9uKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zaXRpb24sIGNhbk93bikgewoJCQkJCQlpZiAoYnVmZmVyLmJ1ZmZlciA9PT0gSEVBUDguYnVmZmVyKSB7CgkJCQkJCQljYW5Pd24gPSBmYWxzZQoJCQkJCQl9CgkJCQkJCWlmICghbGVuZ3RoKSByZXR1cm4gMDsKCQkJCQkJdmFyIG5vZGUgPSBzdHJlYW0ubm9kZTsKCQkJCQkJbm9kZS50aW1lc3RhbXAgPSBEYXRlLm5vdygpOwoJCQkJCQlpZiAoYnVmZmVyLnN1YmFycmF5ICYmICghbm9kZS5jb250ZW50cyB8fCBub2RlLmNvbnRlbnRzLnN1YmFycmF5KSkgewoJCQkJCQkJaWYgKGNhbk93bikgewoJCQkJCQkJCW5vZGUuY29udGVudHMgPSBidWZmZXIuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyBsZW5ndGgpOwoJCQkJCQkJCW5vZGUudXNlZEJ5dGVzID0gbGVuZ3RoOwoJCQkJCQkJCXJldHVybiBsZW5ndGgKCQkJCQkJCX0gZWxzZSBpZiAobm9kZS51c2VkQnl0ZXMgPT09IDAgJiYgcG9zaXRpb24gPT09IDApIHsKCQkJCQkJCQlub2RlLmNvbnRlbnRzID0gYnVmZmVyLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgbGVuZ3RoKTsKCQkJCQkJCQlub2RlLnVzZWRCeXRlcyA9IGxlbmd0aDsKCQkJCQkJCQlyZXR1cm4gbGVuZ3RoCgkJCQkJCQl9IGVsc2UgaWYgKHBvc2l0aW9uICsgbGVuZ3RoIDw9IG5vZGUudXNlZEJ5dGVzKSB7CgkJCQkJCQkJbm9kZS5jb250ZW50cy5zZXQoYnVmZmVyLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgbGVuZ3RoKSwgcG9zaXRpb24pOwoJCQkJCQkJCXJldHVybiBsZW5ndGgKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQlNRU1GUy5leHBhbmRGaWxlU3RvcmFnZShub2RlLCBwb3NpdGlvbiArIGxlbmd0aCk7CgkJCQkJCWlmIChub2RlLmNvbnRlbnRzLnN1YmFycmF5ICYmIGJ1ZmZlci5zdWJhcnJheSkgewoJCQkJCQkJbm9kZS5jb250ZW50cy5zZXQoYnVmZmVyLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgbGVuZ3RoKSwgcG9zaXRpb24pCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJCQkJCQkJbm9kZS5jb250ZW50c1twb3NpdGlvbiArIGldID0gYnVmZmVyW29mZnNldCArIGldCgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJbm9kZS51c2VkQnl0ZXMgPSBNYXRoLm1heChub2RlLnVzZWRCeXRlcywgcG9zaXRpb24gKyBsZW5ndGgpOwoJCQkJCQlyZXR1cm4gbGVuZ3RoCgkJCQkJfSwKCQkJCQlsbHNlZWs6IGZ1bmN0aW9uKHN0cmVhbSwgb2Zmc2V0LCB3aGVuY2UpIHsKCQkJCQkJdmFyIHBvc2l0aW9uID0gb2Zmc2V0OwoJCQkJCQlpZiAod2hlbmNlID09PSAxKSB7CgkJCQkJCQlwb3NpdGlvbiArPSBzdHJlYW0ucG9zaXRpb24KCQkJCQkJfSBlbHNlIGlmICh3aGVuY2UgPT09IDIpIHsKCQkJCQkJCWlmIChGUy5pc0ZpbGUoc3RyZWFtLm5vZGUubW9kZSkpIHsKCQkJCQkJCQlwb3NpdGlvbiArPSBzdHJlYW0ubm9kZS51c2VkQnl0ZXMKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQlpZiAocG9zaXRpb24gPCAwKSB7CgkJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOCkKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcG9zaXRpb24KCQkJCQl9LAoJCQkJCWFsbG9jYXRlOiBmdW5jdGlvbihzdHJlYW0sIG9mZnNldCwgbGVuZ3RoKSB7CgkJCQkJCU1FTUZTLmV4cGFuZEZpbGVTdG9yYWdlKHN0cmVhbS5ub2RlLCBvZmZzZXQgKyBsZW5ndGgpOwoJCQkJCQlzdHJlYW0ubm9kZS51c2VkQnl0ZXMgPSBNYXRoLm1heChzdHJlYW0ubm9kZS51c2VkQnl0ZXMsIG9mZnNldCArIGxlbmd0aCkKCQkJCQl9LAoJCQkJCW1tYXA6IGZ1bmN0aW9uKHN0cmVhbSwgbGVuZ3RoLCBwb3NpdGlvbiwgcHJvdCwgZmxhZ3MpIHsKCQkJCQkJaWYgKCFGUy5pc0ZpbGUoc3RyZWFtLm5vZGUubW9kZSkpIHsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQzKQoJCQkJCQl9CgkJCQkJCXZhciBwdHI7CgkJCQkJCXZhciBhbGxvY2F0ZWQ7CgkJCQkJCXZhciBjb250ZW50cyA9IHN0cmVhbS5ub2RlLmNvbnRlbnRzOwoJCQkJCQlpZiAoIShmbGFncyAmIDIpICYmIGNvbnRlbnRzLmJ1ZmZlciA9PT0gSEVBUDguYnVmZmVyKSB7CgkJCQkJCQlhbGxvY2F0ZWQgPSBmYWxzZTsKCQkJCQkJCXB0ciA9IGNvbnRlbnRzLmJ5dGVPZmZzZXQKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWlmIChwb3NpdGlvbiA+IDAgfHwgcG9zaXRpb24gKyBsZW5ndGggPCBjb250ZW50cy5sZW5ndGgpIHsKCQkJCQkJCQlpZiAoY29udGVudHMuc3ViYXJyYXkpIHsKCQkJCQkJCQkJY29udGVudHMgPSBjb250ZW50cy5zdWJhcnJheShwb3NpdGlvbiwgcG9zaXRpb24gKyBsZW5ndGgpCgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJY29udGVudHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChjb250ZW50cywgcG9zaXRpb24sIHBvc2l0aW9uICsgbGVuZ3RoKQoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJCWFsbG9jYXRlZCA9IHRydWU7CgkJCQkJCQlwdHIgPSBtbWFwQWxsb2MobGVuZ3RoKTsKCQkJCQkJCWlmICghcHRyKSB7CgkJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDgpCgkJCQkJCQl9CgkJCQkJCQlIRUFQOC5zZXQoY29udGVudHMsIHB0cikKCQkJCQkJfQoJCQkJCQlyZXR1cm4gewoJCQkJCQkJcHRyOiBwdHIsCgkJCQkJCQlhbGxvY2F0ZWQ6IGFsbG9jYXRlZAoJCQkJCQl9CgkJCQkJfSwKCQkJCQltc3luYzogZnVuY3Rpb24oc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBtbWFwRmxhZ3MpIHsKCQkJCQkJTUVNRlMuc3RyZWFtX29wcy53cml0ZShzdHJlYW0sIGJ1ZmZlciwgMCwgbGVuZ3RoLCBvZmZzZXQsIGZhbHNlKTsKCQkJCQkJcmV0dXJuIDAKCQkJCQl9CgkJCQl9CgkJCX07CiAgCgkJCWZ1bmN0aW9uIGFzeW5jTG9hZCh1cmwsIG9ubG9hZCwgb25lcnJvciwgbm9SdW5EZXApIHsKCQkJCXZhciBkZXAgPSAhbm9SdW5EZXAgPyBnZXRVbmlxdWVSdW5EZXBlbmRlbmN5KCJhbCAiICsgdXJsKSA6ICIiOwoJCQkJcmVhZEFzeW5jKHVybCwgYXJyYXlCdWZmZXIgPT4gewoJCQkJCWFzc2VydChhcnJheUJ1ZmZlciwgYExvYWRpbmcgZGF0YSBmaWxlICIke3VybH0iIGZhaWxlZCAobm8gYXJyYXlCdWZmZXIpLmApOwoJCQkJCW9ubG9hZChuZXcgVWludDhBcnJheShhcnJheUJ1ZmZlcikpOwoJCQkJCWlmIChkZXApIHJlbW92ZVJ1bkRlcGVuZGVuY3koZGVwKQoJCQkJfSwgZXZlbnQgPT4gewoJCQkJCWlmIChvbmVycm9yKSB7CgkJCQkJCW9uZXJyb3IoKQoJCQkJCX0gZWxzZSB7CgkJCQkJCXRocm93IGBMb2FkaW5nIGRhdGEgZmlsZSAiJHt1cmx9IiBmYWlsZWQuYAoJCQkJCX0KCQkJCX0pOwoJCQkJaWYgKGRlcCkgYWRkUnVuRGVwZW5kZW5jeShkZXApCgkJCX0KCQkJdmFyIHByZWxvYWRQbHVnaW5zID0gTW9kdWxlWyJwcmVsb2FkUGx1Z2lucyJdIHx8IFtdOwogIAoJCQlmdW5jdGlvbiBGU19oYW5kbGVkQnlQcmVsb2FkUGx1Z2luKGJ5dGVBcnJheSwgZnVsbG5hbWUsIGZpbmlzaCwgb25lcnJvcikgewoJCQkJaWYgKHR5cGVvZiBCcm93c2VyICE9ICJ1bmRlZmluZWQiKSBCcm93c2VyLmluaXQoKTsKCQkJCXZhciBoYW5kbGVkID0gZmFsc2U7CgkJCQlwcmVsb2FkUGx1Z2lucy5mb3JFYWNoKGZ1bmN0aW9uKHBsdWdpbikgewoJCQkJCWlmIChoYW5kbGVkKSByZXR1cm47CgkJCQkJaWYgKHBsdWdpblsiY2FuSGFuZGxlIl0oZnVsbG5hbWUpKSB7CgkJCQkJCXBsdWdpblsiaGFuZGxlIl0oYnl0ZUFycmF5LCBmdWxsbmFtZSwgZmluaXNoLCBvbmVycm9yKTsKCQkJCQkJaGFuZGxlZCA9IHRydWUKCQkJCQl9CgkJCQl9KTsKCQkJCXJldHVybiBoYW5kbGVkCgkJCX0KICAKCQkJZnVuY3Rpb24gRlNfY3JlYXRlUHJlbG9hZGVkRmlsZShwYXJlbnQsIG5hbWUsIHVybCwgY2FuUmVhZCwgY2FuV3JpdGUsIG9ubG9hZCwgb25lcnJvciwgZG9udENyZWF0ZUZpbGUsIGNhbk93biwgcHJlRmluaXNoKSB7CgkJCQl2YXIgZnVsbG5hbWUgPSBuYW1lID8gUEFUSF9GUy5yZXNvbHZlKFBBVEguam9pbjIocGFyZW50LCBuYW1lKSkgOiBwYXJlbnQ7CgkJCQl2YXIgZGVwID0gZ2V0VW5pcXVlUnVuRGVwZW5kZW5jeSgiY3AgIiArIGZ1bGxuYW1lKTsKICAKCQkJCWZ1bmN0aW9uIHByb2Nlc3NEYXRhKGJ5dGVBcnJheSkgewoJCQkJCWZ1bmN0aW9uIGZpbmlzaChieXRlQXJyYXkpIHsKCQkJCQkJaWYgKHByZUZpbmlzaCkgcHJlRmluaXNoKCk7CgkJCQkJCWlmICghZG9udENyZWF0ZUZpbGUpIHsKCQkJCQkJCUZTLmNyZWF0ZURhdGFGaWxlKHBhcmVudCwgbmFtZSwgYnl0ZUFycmF5LCBjYW5SZWFkLCBjYW5Xcml0ZSwgY2FuT3duKQoJCQkJCQl9CgkJCQkJCWlmIChvbmxvYWQpIG9ubG9hZCgpOwoJCQkJCQlyZW1vdmVSdW5EZXBlbmRlbmN5KGRlcCkKCQkJCQl9CgkJCQkJaWYgKEZTX2hhbmRsZWRCeVByZWxvYWRQbHVnaW4oYnl0ZUFycmF5LCBmdWxsbmFtZSwgZmluaXNoLCAoKSA9PiB7CgkJCQkJCQlpZiAob25lcnJvcikgb25lcnJvcigpOwoJCQkJCQkJcmVtb3ZlUnVuRGVwZW5kZW5jeShkZXApCgkJCQkJCX0pKSB7CgkJCQkJCXJldHVybgoJCQkJCX0KCQkJCQlmaW5pc2goYnl0ZUFycmF5KQoJCQkJfQoJCQkJYWRkUnVuRGVwZW5kZW5jeShkZXApOwoJCQkJaWYgKHR5cGVvZiB1cmwgPT0gInN0cmluZyIpIHsKCQkJCQlhc3luY0xvYWQodXJsLCBieXRlQXJyYXkgPT4gcHJvY2Vzc0RhdGEoYnl0ZUFycmF5KSwgb25lcnJvcikKCQkJCX0gZWxzZSB7CgkJCQkJcHJvY2Vzc0RhdGEodXJsKQoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIEZTX21vZGVTdHJpbmdUb0ZsYWdzKHN0cikgewoJCQkJdmFyIGZsYWdNb2RlcyA9IHsKCQkJCQkiciI6IDAsCgkJCQkJInIrIjogMiwKCQkJCQkidyI6IDUxMiB8IDY0IHwgMSwKCQkJCQkidysiOiA1MTIgfCA2NCB8IDIsCgkJCQkJImEiOiAxMDI0IHwgNjQgfCAxLAoJCQkJCSJhKyI6IDEwMjQgfCA2NCB8IDIKCQkJCX07CgkJCQl2YXIgZmxhZ3MgPSBmbGFnTW9kZXNbc3RyXTsKCQkJCWlmICh0eXBlb2YgZmxhZ3MgPT0gInVuZGVmaW5lZCIpIHsKCQkJCQl0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZmlsZSBvcGVuIG1vZGU6ICIgKyBzdHIpCgkJCQl9CgkJCQlyZXR1cm4gZmxhZ3MKCQkJfQogIAoJCQlmdW5jdGlvbiBGU19nZXRNb2RlKGNhblJlYWQsIGNhbldyaXRlKSB7CgkJCQl2YXIgbW9kZSA9IDA7CgkJCQlpZiAoY2FuUmVhZCkgbW9kZSB8PSAyOTIgfCA3MzsKCQkJCWlmIChjYW5Xcml0ZSkgbW9kZSB8PSAxNDY7CgkJCQlyZXR1cm4gbW9kZQoJCQl9CgkJCXZhciBFUlJOT19DT0RFUyA9IHt9OwoJCQl2YXIgUFJPWFlGUyA9IHsKCQkJCW1vdW50OiBmdW5jdGlvbihtb3VudCkgewoJCQkJCXJldHVybiBQUk9YWUZTLmNyZWF0ZU5vZGUobnVsbCwgIi8iLCBtb3VudC5vcHRzLmZzLmxzdGF0KG1vdW50Lm9wdHMucm9vdCkubW9kZSwgMCkKCQkJCX0sCgkJCQljcmVhdGVOb2RlOiBmdW5jdGlvbihwYXJlbnQsIG5hbWUsIG1vZGUsIGRldikgewoJCQkJCWlmICghRlMuaXNEaXIobW9kZSkgJiYgIUZTLmlzRmlsZShtb2RlKSAmJiAhRlMuaXNMaW5rKG1vZGUpKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTLkVJTlZBTCkKCQkJCQl9CgkJCQkJdmFyIG5vZGUgPSBGUy5jcmVhdGVOb2RlKHBhcmVudCwgbmFtZSwgbW9kZSk7CgkJCQkJbm9kZS5ub2RlX29wcyA9IFBST1hZRlMubm9kZV9vcHM7CgkJCQkJbm9kZS5zdHJlYW1fb3BzID0gUFJPWFlGUy5zdHJlYW1fb3BzOwoJCQkJCXJldHVybiBub2RlCgkJCQl9LAoJCQkJcmVhbFBhdGg6IGZ1bmN0aW9uKG5vZGUpIHsKCQkJCQl2YXIgcGFydHMgPSBbXTsKCQkJCQl3aGlsZSAobm9kZS5wYXJlbnQgIT09IG5vZGUpIHsKCQkJCQkJcGFydHMucHVzaChub2RlLm5hbWUpOwoJCQkJCQlub2RlID0gbm9kZS5wYXJlbnQKCQkJCQl9CgkJCQkJcGFydHMucHVzaChub2RlLm1vdW50Lm9wdHMucm9vdCk7CgkJCQkJcGFydHMucmV2ZXJzZSgpOwoJCQkJCXJldHVybiBQQVRILmpvaW4uYXBwbHkobnVsbCwgcGFydHMpCgkJCQl9LAoJCQkJbm9kZV9vcHM6IHsKCQkJCQlnZXRhdHRyOiBmdW5jdGlvbihub2RlKSB7CgkJCQkJCXZhciBwYXRoID0gUFJPWFlGUy5yZWFsUGF0aChub2RlKTsKCQkJCQkJdmFyIHN0YXQ7CgkJCQkJCXRyeSB7CgkJCQkJCQlzdGF0ID0gbm9kZS5tb3VudC5vcHRzLmZzLmxzdGF0KHBhdGgpCgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCWlmICghZS5jb2RlKSB0aHJvdyBlOwoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoRVJSTk9fQ09ERVNbZS5jb2RlXSkKCQkJCQkJfQoJCQkJCQlyZXR1cm4gewoJCQkJCQkJZGV2OiBzdGF0LmRldiwKCQkJCQkJCWlubzogc3RhdC5pbm8sCgkJCQkJCQltb2RlOiBzdGF0Lm1vZGUsCgkJCQkJCQlubGluazogc3RhdC5ubGluaywKCQkJCQkJCXVpZDogc3RhdC51aWQsCgkJCQkJCQlnaWQ6IHN0YXQuZ2lkLAoJCQkJCQkJcmRldjogc3RhdC5yZGV2LAoJCQkJCQkJc2l6ZTogc3RhdC5zaXplLAoJCQkJCQkJYXRpbWU6IHN0YXQuYXRpbWUsCgkJCQkJCQltdGltZTogc3RhdC5tdGltZSwKCQkJCQkJCWN0aW1lOiBzdGF0LmN0aW1lLAoJCQkJCQkJYmxrc2l6ZTogc3RhdC5ibGtzaXplLAoJCQkJCQkJYmxvY2tzOiBzdGF0LmJsb2NrcwoJCQkJCQl9CgkJCQkJfSwKCQkJCQlzZXRhdHRyOiBmdW5jdGlvbihub2RlLCBhdHRyKSB7CgkJCQkJCXZhciBwYXRoID0gUFJPWFlGUy5yZWFsUGF0aChub2RlKTsKCQkJCQkJdHJ5IHsKCQkJCQkJCWlmIChhdHRyLm1vZGUgIT09IHVuZGVmaW5lZCkgewoJCQkJCQkJCW5vZGUubW91bnQub3B0cy5mcy5jaG1vZChwYXRoLCBhdHRyLm1vZGUpOwoJCQkJCQkJCW5vZGUubW9kZSA9IGF0dHIubW9kZQoJCQkJCQkJfQoJCQkJCQkJaWYgKGF0dHIudGltZXN0YW1wICE9PSB1bmRlZmluZWQpIHsKCQkJCQkJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKGF0dHIudGltZXN0YW1wKTsKCQkJCQkJCQlub2RlLm1vdW50Lm9wdHMuZnMudXRpbWUocGF0aCwgZGF0ZSwgZGF0ZSkKCQkJCQkJCX0KCQkJCQkJCWlmIChhdHRyLnNpemUgIT09IHVuZGVmaW5lZCkgewoJCQkJCQkJCW5vZGUubW91bnQub3B0cy5mcy50cnVuY2F0ZShwYXRoLCBhdHRyLnNpemUpCgkJCQkJCQl9CgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCWlmICghZS5jb2RlKSB0aHJvdyBlOwoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoRVJSTk9fQ09ERVNbZS5jb2RlXSkKCQkJCQkJfQoJCQkJCX0sCgkJCQkJbG9va3VwOiBmdW5jdGlvbihwYXJlbnQsIG5hbWUpIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCXZhciBwYXRoID0gUEFUSC5qb2luMihQUk9YWUZTLnJlYWxQYXRoKHBhcmVudCksIG5hbWUpOwoJCQkJCQkJdmFyIG1vZGUgPSBwYXJlbnQubW91bnQub3B0cy5mcy5sc3RhdChwYXRoKS5tb2RlOwoJCQkJCQkJdmFyIG5vZGUgPSBQUk9YWUZTLmNyZWF0ZU5vZGUocGFyZW50LCBuYW1lLCBtb2RlKTsKCQkJCQkJCXJldHVybiBub2RlCgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCWlmICghZS5jb2RlKSB0aHJvdyBlOwoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoRVJSTk9fQ09ERVNbZS5jb2RlXSkKCQkJCQkJfQoJCQkJCX0sCgkJCQkJbWtub2Q6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSwgbW9kZSwgZGV2KSB7CgkJCQkJCXZhciBub2RlID0gUFJPWFlGUy5jcmVhdGVOb2RlKHBhcmVudCwgbmFtZSwgbW9kZSwgZGV2KTsKCQkJCQkJdmFyIHBhdGggPSBQUk9YWUZTLnJlYWxQYXRoKG5vZGUpOwoJCQkJCQl0cnkgewoJCQkJCQkJaWYgKEZTLmlzRGlyKG5vZGUubW9kZSkpIHsKCQkJCQkJCQlub2RlLm1vdW50Lm9wdHMuZnMubWtkaXIocGF0aCwgbm9kZS5tb2RlKQoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlub2RlLm1vdW50Lm9wdHMuZnMud3JpdGVGaWxlKHBhdGgsICIiLCB7CgkJCQkJCQkJCW1vZGU6IG5vZGUubW9kZQoJCQkJCQkJCX0pCgkJCQkJCQl9CgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCWlmICghZS5jb2RlKSB0aHJvdyBlOwoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoRVJSTk9fQ09ERVNbZS5jb2RlXSkKCQkJCQkJfQoJCQkJCQlyZXR1cm4gbm9kZQoJCQkJCX0sCgkJCQkJcmVuYW1lOiBmdW5jdGlvbihvbGROb2RlLCBuZXdEaXIsIG5ld05hbWUpIHsKCQkJCQkJdmFyIG9sZFBhdGggPSBQUk9YWUZTLnJlYWxQYXRoKG9sZE5vZGUpOwoJCQkJCQl2YXIgbmV3UGF0aCA9IFBBVEguam9pbjIoUFJPWFlGUy5yZWFsUGF0aChuZXdEaXIpLCBuZXdOYW1lKTsKCQkJCQkJdHJ5IHsKCQkJCQkJCW9sZE5vZGUubW91bnQub3B0cy5mcy5yZW5hbWUob2xkUGF0aCwgbmV3UGF0aCk7CgkJCQkJCQlvbGROb2RlLm5hbWUgPSBuZXdOYW1lOwoJCQkJCQkJb2xkTm9kZS5wYXJlbnQgPSBuZXdEaXIKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJaWYgKCFlLmNvZGUpIHRocm93IGU7CgkJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihFUlJOT19DT0RFU1tlLmNvZGVdKQoJCQkJCQl9CgkJCQkJfSwKCQkJCQl1bmxpbms6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSkgewoJCQkJCQl2YXIgcGF0aCA9IFBBVEguam9pbjIoUFJPWFlGUy5yZWFsUGF0aChwYXJlbnQpLCBuYW1lKTsKCQkJCQkJdHJ5IHsKCQkJCQkJCXBhcmVudC5tb3VudC5vcHRzLmZzLnVubGluayhwYXRoKQoJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQlpZiAoIWUuY29kZSkgdGhyb3cgZTsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCgkJCQkJCX0KCQkJCQl9LAoJCQkJCXJtZGlyOiBmdW5jdGlvbihwYXJlbnQsIG5hbWUpIHsKCQkJCQkJdmFyIHBhdGggPSBQQVRILmpvaW4yKFBST1hZRlMucmVhbFBhdGgocGFyZW50KSwgbmFtZSk7CgkJCQkJCXRyeSB7CgkJCQkJCQlwYXJlbnQubW91bnQub3B0cy5mcy5ybWRpcihwYXRoKQoJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQlpZiAoIWUuY29kZSkgdGhyb3cgZTsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCgkJCQkJCX0KCQkJCQl9LAoJCQkJCXJlYWRkaXI6IGZ1bmN0aW9uKG5vZGUpIHsKCQkJCQkJdmFyIHBhdGggPSBQUk9YWUZTLnJlYWxQYXRoKG5vZGUpOwoJCQkJCQl0cnkgewoJCQkJCQkJcmV0dXJuIG5vZGUubW91bnQub3B0cy5mcy5yZWFkZGlyKHBhdGgpCgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCWlmICghZS5jb2RlKSB0aHJvdyBlOwoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoRVJSTk9fQ09ERVNbZS5jb2RlXSkKCQkJCQkJfQoJCQkJCX0sCgkJCQkJc3ltbGluazogZnVuY3Rpb24ocGFyZW50LCBuZXdOYW1lLCBvbGRQYXRoKSB7CgkJCQkJCXZhciBuZXdQYXRoID0gUEFUSC5qb2luMihQUk9YWUZTLnJlYWxQYXRoKHBhcmVudCksIG5ld05hbWUpOwoJCQkJCQl0cnkgewoJCQkJCQkJcGFyZW50Lm1vdW50Lm9wdHMuZnMuc3ltbGluayhvbGRQYXRoLCBuZXdQYXRoKQoJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQlpZiAoIWUuY29kZSkgdGhyb3cgZTsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCgkJCQkJCX0KCQkJCQl9LAoJCQkJCXJlYWRsaW5rOiBmdW5jdGlvbihub2RlKSB7CgkJCQkJCXZhciBwYXRoID0gUFJPWFlGUy5yZWFsUGF0aChub2RlKTsKCQkJCQkJdHJ5IHsKCQkJCQkJCXJldHVybiBub2RlLm1vdW50Lm9wdHMuZnMucmVhZGxpbmsocGF0aCkKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJaWYgKCFlLmNvZGUpIHRocm93IGU7CgkJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihFUlJOT19DT0RFU1tlLmNvZGVdKQoJCQkJCQl9CgkJCQkJfQoJCQkJfSwKCQkJCXN0cmVhbV9vcHM6IHsKCQkJCQlvcGVuOiBmdW5jdGlvbihzdHJlYW0pIHsKCQkJCQkJdmFyIHBhdGggPSBQUk9YWUZTLnJlYWxQYXRoKHN0cmVhbS5ub2RlKTsKCQkJCQkJdHJ5IHsKCQkJCQkJCXN0cmVhbS5uZmQgPSBzdHJlYW0ubm9kZS5tb3VudC5vcHRzLmZzLm9wZW4ocGF0aCwgc3RyZWFtLmZsYWdzKQoJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQlpZiAoIWUuY29kZSkgdGhyb3cgZTsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCgkJCQkJCX0KCQkJCQl9LAoJCQkJCWNsb3NlOiBmdW5jdGlvbihzdHJlYW0pIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCXN0cmVhbS5ub2RlLm1vdW50Lm9wdHMuZnMuY2xvc2Uoc3RyZWFtLm5mZCkKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJaWYgKCFlLmNvZGUpIHRocm93IGU7CgkJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihFUlJOT19DT0RFU1tlLmNvZGVdKQoJCQkJCQl9CgkJCQkJfSwKCQkJCQlyZWFkOiBmdW5jdGlvbihzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXR1cm4gc3RyZWFtLm5vZGUubW91bnQub3B0cy5mcy5yZWFkKHN0cmVhbS5uZmQsIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKQoJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQlpZiAoIWUuY29kZSkgdGhyb3cgZTsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCgkJCQkJCX0KCQkJCQl9LAoJCQkJCXdyaXRlOiBmdW5jdGlvbihzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXR1cm4gc3RyZWFtLm5vZGUubW91bnQub3B0cy5mcy53cml0ZShzdHJlYW0ubmZkLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbikKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJaWYgKCFlLmNvZGUpIHRocm93IGU7CgkJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihFUlJOT19DT0RFU1tlLmNvZGVdKQoJCQkJCQl9CgkJCQkJfSwKCQkJCQlsbHNlZWs6IGZ1bmN0aW9uKHN0cmVhbSwgb2Zmc2V0LCB3aGVuY2UpIHsKCQkJCQkJdmFyIHBvc2l0aW9uID0gb2Zmc2V0OwoJCQkJCQlpZiAod2hlbmNlID09PSAxKSB7CgkJCQkJCQlwb3NpdGlvbiArPSBzdHJlYW0ucG9zaXRpb24KCQkJCQkJfSBlbHNlIGlmICh3aGVuY2UgPT09IDIpIHsKCQkJCQkJCWlmIChGUy5pc0ZpbGUoc3RyZWFtLm5vZGUubW9kZSkpIHsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQl2YXIgc3RhdCA9IHN0cmVhbS5ub2RlLm5vZGVfb3BzLmdldGF0dHIoc3RyZWFtLm5vZGUpOwoJCQkJCQkJCQlwb3NpdGlvbiArPSBzdGF0LnNpemUKCQkJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCWlmIChwb3NpdGlvbiA8IDApIHsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTLkVJTlZBTCkKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcG9zaXRpb24KCQkJCQl9CgkJCQl9CgkJCX07CgkJCXZhciBGUyA9IHsKCQkJCXJvb3Q6IG51bGwsCgkJCQltb3VudHM6IFtdLAoJCQkJZGV2aWNlczoge30sCgkJCQlzdHJlYW1zOiBbXSwKCQkJCW5leHRJbm9kZTogMSwKCQkJCW5hbWVUYWJsZTogbnVsbCwKCQkJCWN1cnJlbnRQYXRoOiAiLyIsCgkJCQlpbml0aWFsaXplZDogZmFsc2UsCgkJCQlpZ25vcmVQZXJtaXNzaW9uczogdHJ1ZSwKCQkJCUVycm5vRXJyb3I6IG51bGwsCgkJCQlnZW5lcmljRXJyb3JzOiB7fSwKCQkJCWZpbGVzeXN0ZW1zOiBudWxsLAoJCQkJc3luY0ZTUmVxdWVzdHM6IDAsCgkJCQlsb29rdXBQYXRoOiAocGF0aCwgb3B0cyA9IHt9KSA9PiB7CgkJCQkJcGF0aCA9IFBBVEhfRlMucmVzb2x2ZShwYXRoKTsKCQkJCQlpZiAoIXBhdGgpIHJldHVybiB7CgkJCQkJCXBhdGg6ICIiLAoJCQkJCQlub2RlOiBudWxsCgkJCQkJfTsKCQkJCQl2YXIgZGVmYXVsdHMgPSB7CgkJCQkJCWZvbGxvd19tb3VudDogdHJ1ZSwKCQkJCQkJcmVjdXJzZV9jb3VudDogMAoJCQkJCX07CgkJCQkJb3B0cyA9IE9iamVjdC5hc3NpZ24oZGVmYXVsdHMsIG9wdHMpOwoJCQkJCWlmIChvcHRzLnJlY3Vyc2VfY291bnQgPiA4KSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDMyKQoJCQkJCX0KCQkJCQl2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIvIikuZmlsdGVyKHAgPT4gISFwKTsKCQkJCQl2YXIgY3VycmVudCA9IEZTLnJvb3Q7CgkJCQkJdmFyIGN1cnJlbnRfcGF0aCA9ICIvIjsKCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CgkJCQkJCXZhciBpc2xhc3QgPSBpID09PSBwYXJ0cy5sZW5ndGggLSAxOwoJCQkJCQlpZiAoaXNsYXN0ICYmIG9wdHMucGFyZW50KSB7CgkJCQkJCQlicmVhawoJCQkJCQl9CgkJCQkJCWN1cnJlbnQgPSBGUy5sb29rdXBOb2RlKGN1cnJlbnQsIHBhcnRzW2ldKTsKCQkJCQkJY3VycmVudF9wYXRoID0gUEFUSC5qb2luMihjdXJyZW50X3BhdGgsIHBhcnRzW2ldKTsKCQkJCQkJaWYgKEZTLmlzTW91bnRwb2ludChjdXJyZW50KSkgewoJCQkJCQkJaWYgKCFpc2xhc3QgfHwgaXNsYXN0ICYmIG9wdHMuZm9sbG93X21vdW50KSB7CgkJCQkJCQkJY3VycmVudCA9IGN1cnJlbnQubW91bnRlZC5yb290CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJaWYgKCFpc2xhc3QgfHwgb3B0cy5mb2xsb3cpIHsKCQkJCQkJCXZhciBjb3VudCA9IDA7CgkJCQkJCQl3aGlsZSAoRlMuaXNMaW5rKGN1cnJlbnQubW9kZSkpIHsKCQkJCQkJCQl2YXIgbGluayA9IEZTLnJlYWRsaW5rKGN1cnJlbnRfcGF0aCk7CgkJCQkJCQkJY3VycmVudF9wYXRoID0gUEFUSF9GUy5yZXNvbHZlKFBBVEguZGlybmFtZShjdXJyZW50X3BhdGgpLCBsaW5rKTsKCQkJCQkJCQl2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChjdXJyZW50X3BhdGgsIHsKCQkJCQkJCQkJcmVjdXJzZV9jb3VudDogb3B0cy5yZWN1cnNlX2NvdW50ICsgMQoJCQkJCQkJCX0pOwoJCQkJCQkJCWN1cnJlbnQgPSBsb29rdXAubm9kZTsKCQkJCQkJCQlpZiAoY291bnQrKyA+IDQwKSB7CgkJCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDMyKQoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXR1cm4gewoJCQkJCQlwYXRoOiBjdXJyZW50X3BhdGgsCgkJCQkJCW5vZGU6IGN1cnJlbnQKCQkJCQl9CgkJCQl9LAoJCQkJZ2V0UGF0aDogbm9kZSA9PiB7CgkJCQkJdmFyIHBhdGg7CgkJCQkJd2hpbGUgKHRydWUpIHsKCQkJCQkJaWYgKEZTLmlzUm9vdChub2RlKSkgewoJCQkJCQkJdmFyIG1vdW50ID0gbm9kZS5tb3VudC5tb3VudHBvaW50OwoJCQkJCQkJaWYgKCFwYXRoKSByZXR1cm4gbW91bnQ7CgkJCQkJCQlyZXR1cm4gbW91bnRbbW91bnQubGVuZ3RoIC0gMV0gIT09ICIvIiA/IG1vdW50ICsgIi8iICsgcGF0aCA6IG1vdW50ICsgcGF0aAoJCQkJCQl9CgkJCQkJCXBhdGggPSBwYXRoID8gbm9kZS5uYW1lICsgIi8iICsgcGF0aCA6IG5vZGUubmFtZTsKCQkJCQkJbm9kZSA9IG5vZGUucGFyZW50CgkJCQkJfQoJCQkJfSwKCQkJCWhhc2hOYW1lOiAocGFyZW50aWQsIG5hbWUpID0+IHsKCQkJCQl2YXIgaGFzaCA9IDA7CgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBuYW1lLmxlbmd0aDsgaSsrKSB7CgkJCQkJCWhhc2ggPSAoaGFzaCA8PCA1KSAtIGhhc2ggKyBuYW1lLmNoYXJDb2RlQXQoaSkgfCAwCgkJCQkJfQoJCQkJCXJldHVybiAocGFyZW50aWQgKyBoYXNoID4+PiAwKSAlIEZTLm5hbWVUYWJsZS5sZW5ndGgKCQkJCX0sCgkJCQloYXNoQWRkTm9kZTogbm9kZSA9PiB7CgkJCQkJdmFyIGhhc2ggPSBGUy5oYXNoTmFtZShub2RlLnBhcmVudC5pZCwgbm9kZS5uYW1lKTsKCQkJCQlub2RlLm5hbWVfbmV4dCA9IEZTLm5hbWVUYWJsZVtoYXNoXTsKCQkJCQlGUy5uYW1lVGFibGVbaGFzaF0gPSBub2RlCgkJCQl9LAoJCQkJaGFzaFJlbW92ZU5vZGU6IG5vZGUgPT4gewoJCQkJCXZhciBoYXNoID0gRlMuaGFzaE5hbWUobm9kZS5wYXJlbnQuaWQsIG5vZGUubmFtZSk7CgkJCQkJaWYgKEZTLm5hbWVUYWJsZVtoYXNoXSA9PT0gbm9kZSkgewoJCQkJCQlGUy5uYW1lVGFibGVbaGFzaF0gPSBub2RlLm5hbWVfbmV4dAoJCQkJCX0gZWxzZSB7CgkJCQkJCXZhciBjdXJyZW50ID0gRlMubmFtZVRhYmxlW2hhc2hdOwoJCQkJCQl3aGlsZSAoY3VycmVudCkgewoJCQkJCQkJaWYgKGN1cnJlbnQubmFtZV9uZXh0ID09PSBub2RlKSB7CgkJCQkJCQkJY3VycmVudC5uYW1lX25leHQgPSBub2RlLm5hbWVfbmV4dDsKCQkJCQkJCQlicmVhawoJCQkJCQkJfQoJCQkJCQkJY3VycmVudCA9IGN1cnJlbnQubmFtZV9uZXh0CgkJCQkJCX0KCQkJCQl9CgkJCQl9LAoJCQkJbG9va3VwTm9kZTogKHBhcmVudCwgbmFtZSkgPT4gewoJCQkJCXZhciBlcnJDb2RlID0gRlMubWF5TG9va3VwKHBhcmVudCk7CgkJCQkJaWYgKGVyckNvZGUpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoZXJyQ29kZSwgcGFyZW50KQoJCQkJCX0KCQkJCQl2YXIgaGFzaCA9IEZTLmhhc2hOYW1lKHBhcmVudC5pZCwgbmFtZSk7CgkJCQkJZm9yICh2YXIgbm9kZSA9IEZTLm5hbWVUYWJsZVtoYXNoXTsgbm9kZTsgbm9kZSA9IG5vZGUubmFtZV9uZXh0KSB7CgkJCQkJCXZhciBub2RlTmFtZSA9IG5vZGUubmFtZTsKCQkJCQkJaWYgKG5vZGUucGFyZW50LmlkID09PSBwYXJlbnQuaWQgJiYgbm9kZU5hbWUgPT09IG5hbWUpIHsKCQkJCQkJCXJldHVybiBub2RlCgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIEZTLmxvb2t1cChwYXJlbnQsIG5hbWUpCgkJCQl9LAoJCQkJY3JlYXRlTm9kZTogKHBhcmVudCwgbmFtZSwgbW9kZSwgcmRldikgPT4gewoJCQkJCXZhciBub2RlID0gbmV3IEZTLkZTTm9kZShwYXJlbnQsIG5hbWUsIG1vZGUsIHJkZXYpOwoJCQkJCUZTLmhhc2hBZGROb2RlKG5vZGUpOwoJCQkJCXJldHVybiBub2RlCgkJCQl9LAoJCQkJZGVzdHJveU5vZGU6IG5vZGUgPT4gewoJCQkJCUZTLmhhc2hSZW1vdmVOb2RlKG5vZGUpCgkJCQl9LAoJCQkJaXNSb290OiBub2RlID0+IHsKCQkJCQlyZXR1cm4gbm9kZSA9PT0gbm9kZS5wYXJlbnQKCQkJCX0sCgkJCQlpc01vdW50cG9pbnQ6IG5vZGUgPT4gewoJCQkJCXJldHVybiAhIW5vZGUubW91bnRlZAoJCQkJfSwKCQkJCWlzRmlsZTogbW9kZSA9PiB7CgkJCQkJcmV0dXJuIChtb2RlICYgNjE0NDApID09PSAzMjc2OAoJCQkJfSwKCQkJCWlzRGlyOiBtb2RlID0+IHsKCQkJCQlyZXR1cm4gKG1vZGUgJiA2MTQ0MCkgPT09IDE2Mzg0CgkJCQl9LAoJCQkJaXNMaW5rOiBtb2RlID0+IHsKCQkJCQlyZXR1cm4gKG1vZGUgJiA2MTQ0MCkgPT09IDQwOTYwCgkJCQl9LAoJCQkJaXNDaHJkZXY6IG1vZGUgPT4gewoJCQkJCXJldHVybiAobW9kZSAmIDYxNDQwKSA9PT0gODE5MgoJCQkJfSwKCQkJCWlzQmxrZGV2OiBtb2RlID0+IHsKCQkJCQlyZXR1cm4gKG1vZGUgJiA2MTQ0MCkgPT09IDI0NTc2CgkJCQl9LAoJCQkJaXNGSUZPOiBtb2RlID0+IHsKCQkJCQlyZXR1cm4gKG1vZGUgJiA2MTQ0MCkgPT09IDQwOTYKCQkJCX0sCgkJCQlpc1NvY2tldDogbW9kZSA9PiB7CgkJCQkJcmV0dXJuIChtb2RlICYgNDkxNTIpID09PSA0OTE1MgoJCQkJfSwKCQkJCWZsYWdzVG9QZXJtaXNzaW9uU3RyaW5nOiBmbGFnID0+IHsKCQkJCQl2YXIgcGVybXMgPSBbInIiLCAidyIsICJydyJdW2ZsYWcgJiAzXTsKCQkJCQlpZiAoZmxhZyAmIDUxMikgewoJCQkJCQlwZXJtcyArPSAidyIKCQkJCQl9CgkJCQkJcmV0dXJuIHBlcm1zCgkJCQl9LAoJCQkJbm9kZVBlcm1pc3Npb25zOiAobm9kZSwgcGVybXMpID0+IHsKCQkJCQlpZiAoRlMuaWdub3JlUGVybWlzc2lvbnMpIHsKCQkJCQkJcmV0dXJuIDAKCQkJCQl9CgkJCQkJaWYgKHBlcm1zLmluY2x1ZGVzKCJyIikgJiYgIShub2RlLm1vZGUgJiAyOTIpKSB7CgkJCQkJCXJldHVybiAyCgkJCQkJfSBlbHNlIGlmIChwZXJtcy5pbmNsdWRlcygidyIpICYmICEobm9kZS5tb2RlICYgMTQ2KSkgewoJCQkJCQlyZXR1cm4gMgoJCQkJCX0gZWxzZSBpZiAocGVybXMuaW5jbHVkZXMoIngiKSAmJiAhKG5vZGUubW9kZSAmIDczKSkgewoJCQkJCQlyZXR1cm4gMgoJCQkJCX0KCQkJCQlyZXR1cm4gMAoJCQkJfSwKCQkJCW1heUxvb2t1cDogZGlyID0+IHsKCQkJCQl2YXIgZXJyQ29kZSA9IEZTLm5vZGVQZXJtaXNzaW9ucyhkaXIsICJ4Iik7CgkJCQkJaWYgKGVyckNvZGUpIHJldHVybiBlcnJDb2RlOwoJCQkJCWlmICghZGlyLm5vZGVfb3BzLmxvb2t1cCkgcmV0dXJuIDI7CgkJCQkJcmV0dXJuIDAKCQkJCX0sCgkJCQltYXlDcmVhdGU6IChkaXIsIG5hbWUpID0+IHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgbm9kZSA9IEZTLmxvb2t1cE5vZGUoZGlyLCBuYW1lKTsKCQkJCQkJcmV0dXJuIDIwCgkJCQkJfSBjYXRjaCAoZSkge30KCQkJCQlyZXR1cm4gRlMubm9kZVBlcm1pc3Npb25zKGRpciwgInd4IikKCQkJCX0sCgkJCQltYXlEZWxldGU6IChkaXIsIG5hbWUsIGlzZGlyKSA9PiB7CgkJCQkJdmFyIG5vZGU7CgkJCQkJdHJ5IHsKCQkJCQkJbm9kZSA9IEZTLmxvb2t1cE5vZGUoZGlyLCBuYW1lKQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJcmV0dXJuIGUuZXJybm8KCQkJCQl9CgkJCQkJdmFyIGVyckNvZGUgPSBGUy5ub2RlUGVybWlzc2lvbnMoZGlyLCAid3giKTsKCQkJCQlpZiAoZXJyQ29kZSkgewoJCQkJCQlyZXR1cm4gZXJyQ29kZQoJCQkJCX0KCQkJCQlpZiAoaXNkaXIpIHsKCQkJCQkJaWYgKCFGUy5pc0Rpcihub2RlLm1vZGUpKSB7CgkJCQkJCQlyZXR1cm4gNTQKCQkJCQkJfQoJCQkJCQlpZiAoRlMuaXNSb290KG5vZGUpIHx8IEZTLmdldFBhdGgobm9kZSkgPT09IEZTLmN3ZCgpKSB7CgkJCQkJCQlyZXR1cm4gMTAKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmIChGUy5pc0Rpcihub2RlLm1vZGUpKSB7CgkJCQkJCQlyZXR1cm4gMzEKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXR1cm4gMAoJCQkJfSwKCQkJCW1heU9wZW46IChub2RlLCBmbGFncykgPT4gewoJCQkJCWlmICghbm9kZSkgewoJCQkJCQlyZXR1cm4gNDQKCQkJCQl9CgkJCQkJaWYgKEZTLmlzTGluayhub2RlLm1vZGUpKSB7CgkJCQkJCXJldHVybiAzMgoJCQkJCX0gZWxzZSBpZiAoRlMuaXNEaXIobm9kZS5tb2RlKSkgewoJCQkJCQlpZiAoRlMuZmxhZ3NUb1Blcm1pc3Npb25TdHJpbmcoZmxhZ3MpICE9PSAiciIgfHwgZmxhZ3MgJiA1MTIpIHsKCQkJCQkJCXJldHVybiAzMQoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybiBGUy5ub2RlUGVybWlzc2lvbnMobm9kZSwgRlMuZmxhZ3NUb1Blcm1pc3Npb25TdHJpbmcoZmxhZ3MpKQoJCQkJfSwKCQkJCU1BWF9PUEVOX0ZEUzogNDA5NiwKCQkJCW5leHRmZDogKGZkX3N0YXJ0ID0gMCwgZmRfZW5kID0gRlMuTUFYX09QRU5fRkRTKSA9PiB7CgkJCQkJZm9yICh2YXIgZmQgPSBmZF9zdGFydDsgZmQgPD0gZmRfZW5kOyBmZCsrKSB7CgkJCQkJCWlmICghRlMuc3RyZWFtc1tmZF0pIHsKCQkJCQkJCXJldHVybiBmZAoJCQkJCQl9CgkJCQkJfQoJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDMzKQoJCQkJfSwKCQkJCWdldFN0cmVhbTogZmQgPT4gRlMuc3RyZWFtc1tmZF0sCgkJCQljcmVhdGVTdHJlYW06IChzdHJlYW0sIGZkX3N0YXJ0LCBmZF9lbmQpID0+IHsKCQkJCQlpZiAoIUZTLkZTU3RyZWFtKSB7CgkJCQkJCUZTLkZTU3RyZWFtID0gZnVuY3Rpb24oKSB7CgkJCQkJCQl0aGlzLnNoYXJlZCA9IHt9CgkJCQkJCX07CgkJCQkJCUZTLkZTU3RyZWFtLnByb3RvdHlwZSA9IHt9OwoJCQkJCQlPYmplY3QuZGVmaW5lUHJvcGVydGllcyhGUy5GU1N0cmVhbS5wcm90b3R5cGUsIHsKCQkJCQkJCW9iamVjdDogewoJCQkJCQkJCWdldDogZnVuY3Rpb24oKSB7CgkJCQkJCQkJCXJldHVybiB0aGlzLm5vZGUKCQkJCQkJCQl9LAoJCQkJCQkJCXNldDogZnVuY3Rpb24odmFsKSB7CgkJCQkJCQkJCXRoaXMubm9kZSA9IHZhbAoJCQkJCQkJCX0KCQkJCQkJCX0sCgkJCQkJCQlpc1JlYWQ6IHsKCQkJCQkJCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCQkJCQlyZXR1cm4gKHRoaXMuZmxhZ3MgJiAyMDk3MTU1KSAhPT0gMQoJCQkJCQkJCX0KCQkJCQkJCX0sCgkJCQkJCQlpc1dyaXRlOiB7CgkJCQkJCQkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJCQkJCQkJcmV0dXJuICh0aGlzLmZsYWdzICYgMjA5NzE1NSkgIT09IDAKCQkJCQkJCQl9CgkJCQkJCQl9LAoJCQkJCQkJaXNBcHBlbmQ6IHsKCQkJCQkJCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCQkJCQlyZXR1cm4gdGhpcy5mbGFncyAmIDEwMjQKCQkJCQkJCQl9CgkJCQkJCQl9LAoJCQkJCQkJZmxhZ3M6IHsKCQkJCQkJCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCQkJCQlyZXR1cm4gdGhpcy5zaGFyZWQuZmxhZ3MKCQkJCQkJCQl9LAoJCQkJCQkJCXNldDogZnVuY3Rpb24odmFsKSB7CgkJCQkJCQkJCXRoaXMuc2hhcmVkLmZsYWdzID0gdmFsCgkJCQkJCQkJfQoJCQkJCQkJfSwKCQkJCQkJCXBvc2l0aW9uOiB7CgkJCQkJCQkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJCQkJCQkJcmV0dXJuIHRoaXMuc2hhcmVkLnBvc2l0aW9uCgkJCQkJCQkJfSwKCQkJCQkJCQlzZXQ6IGZ1bmN0aW9uKHZhbCkgewoJCQkJCQkJCQl0aGlzLnNoYXJlZC5wb3NpdGlvbiA9IHZhbAoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfSkKCQkJCQl9CgkJCQkJc3RyZWFtID0gT2JqZWN0LmFzc2lnbihuZXcgRlMuRlNTdHJlYW0sIHN0cmVhbSk7CgkJCQkJdmFyIGZkID0gRlMubmV4dGZkKGZkX3N0YXJ0LCBmZF9lbmQpOwoJCQkJCXN0cmVhbS5mZCA9IGZkOwoJCQkJCUZTLnN0cmVhbXNbZmRdID0gc3RyZWFtOwoJCQkJCXJldHVybiBzdHJlYW0KCQkJCX0sCgkJCQljbG9zZVN0cmVhbTogZmQgPT4gewoJCQkJCUZTLnN0cmVhbXNbZmRdID0gbnVsbAoJCQkJfSwKCQkJCWNocmRldl9zdHJlYW1fb3BzOiB7CgkJCQkJb3Blbjogc3RyZWFtID0+IHsKCQkJCQkJdmFyIGRldmljZSA9IEZTLmdldERldmljZShzdHJlYW0ubm9kZS5yZGV2KTsKCQkJCQkJc3RyZWFtLnN0cmVhbV9vcHMgPSBkZXZpY2Uuc3RyZWFtX29wczsKCQkJCQkJaWYgKHN0cmVhbS5zdHJlYW1fb3BzLm9wZW4pIHsKCQkJCQkJCXN0cmVhbS5zdHJlYW1fb3BzLm9wZW4oc3RyZWFtKQoJCQkJCQl9CgkJCQkJfSwKCQkJCQlsbHNlZWs6ICgpID0+IHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNzApCgkJCQkJfQoJCQkJfSwKCQkJCW1ham9yOiBkZXYgPT4gZGV2ID4+IDgsCgkJCQltaW5vcjogZGV2ID0+IGRldiAmIDI1NSwKCQkJCW1ha2VkZXY6IChtYSwgbWkpID0+IG1hIDw8IDggfCBtaSwKCQkJCXJlZ2lzdGVyRGV2aWNlOiAoZGV2LCBvcHMpID0+IHsKCQkJCQlGUy5kZXZpY2VzW2Rldl0gPSB7CgkJCQkJCXN0cmVhbV9vcHM6IG9wcwoJCQkJCX0KCQkJCX0sCgkJCQlnZXREZXZpY2U6IGRldiA9PiBGUy5kZXZpY2VzW2Rldl0sCgkJCQlnZXRNb3VudHM6IG1vdW50ID0+IHsKCQkJCQl2YXIgbW91bnRzID0gW107CgkJCQkJdmFyIGNoZWNrID0gW21vdW50XTsKCQkJCQl3aGlsZSAoY2hlY2subGVuZ3RoKSB7CgkJCQkJCXZhciBtID0gY2hlY2sucG9wKCk7CgkJCQkJCW1vdW50cy5wdXNoKG0pOwoJCQkJCQljaGVjay5wdXNoLmFwcGx5KGNoZWNrLCBtLm1vdW50cykKCQkJCQl9CgkJCQkJcmV0dXJuIG1vdW50cwoJCQkJfSwKCQkJCXN5bmNmczogKHBvcHVsYXRlLCBjYWxsYmFjaykgPT4gewoJCQkJCWlmICh0eXBlb2YgcG9wdWxhdGUgPT0gImZ1bmN0aW9uIikgewoJCQkJCQljYWxsYmFjayA9IHBvcHVsYXRlOwoJCQkJCQlwb3B1bGF0ZSA9IGZhbHNlCgkJCQkJfQoJCQkJCUZTLnN5bmNGU1JlcXVlc3RzKys7CgkJCQkJaWYgKEZTLnN5bmNGU1JlcXVlc3RzID4gMSkgewoJCQkJCQllcnIoIndhcm5pbmc6ICIgKyBGUy5zeW5jRlNSZXF1ZXN0cyArICIgRlMuc3luY2ZzIG9wZXJhdGlvbnMgaW4gZmxpZ2h0IGF0IG9uY2UsIHByb2JhYmx5IGp1c3QgZG9pbmcgZXh0cmEgd29yayIpCgkJCQkJfQoJCQkJCXZhciBtb3VudHMgPSBGUy5nZXRNb3VudHMoRlMucm9vdC5tb3VudCk7CgkJCQkJdmFyIGNvbXBsZXRlZCA9IDA7CiAgCgkJCQkJZnVuY3Rpb24gZG9DYWxsYmFjayhlcnJDb2RlKSB7CgkJCQkJCUZTLnN5bmNGU1JlcXVlc3RzLS07CgkJCQkJCXJldHVybiBjYWxsYmFjayhlcnJDb2RlKQoJCQkJCX0KICAKCQkJCQlmdW5jdGlvbiBkb25lKGVyckNvZGUpIHsKCQkJCQkJaWYgKGVyckNvZGUpIHsKCQkJCQkJCWlmICghZG9uZS5lcnJvcmVkKSB7CgkJCQkJCQkJZG9uZS5lcnJvcmVkID0gdHJ1ZTsKCQkJCQkJCQlyZXR1cm4gZG9DYWxsYmFjayhlcnJDb2RlKQoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuCgkJCQkJCX0KCQkJCQkJaWYgKCsrY29tcGxldGVkID49IG1vdW50cy5sZW5ndGgpIHsKCQkJCQkJCWRvQ2FsbGJhY2sobnVsbCkKCQkJCQkJfQoJCQkJCX0KCQkJCQltb3VudHMuZm9yRWFjaChtb3VudCA9PiB7CgkJCQkJCWlmICghbW91bnQudHlwZS5zeW5jZnMpIHsKCQkJCQkJCXJldHVybiBkb25lKG51bGwpCgkJCQkJCX0KCQkJCQkJbW91bnQudHlwZS5zeW5jZnMobW91bnQsIHBvcHVsYXRlLCBkb25lKQoJCQkJCX0pCgkJCQl9LAoJCQkJbW91bnQ6ICh0eXBlLCBvcHRzLCBtb3VudHBvaW50KSA9PiB7CgkJCQkJdmFyIHJvb3QgPSBtb3VudHBvaW50ID09PSAiLyI7CgkJCQkJdmFyIHBzZXVkbyA9ICFtb3VudHBvaW50OwoJCQkJCXZhciBub2RlOwoJCQkJCWlmIChyb290ICYmIEZTLnJvb3QpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMTApCgkJCQkJfSBlbHNlIGlmICghcm9vdCAmJiAhcHNldWRvKSB7CgkJCQkJCXZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKG1vdW50cG9pbnQsIHsKCQkJCQkJCWZvbGxvd19tb3VudDogZmFsc2UKCQkJCQkJfSk7CgkJCQkJCW1vdW50cG9pbnQgPSBsb29rdXAucGF0aDsKCQkJCQkJbm9kZSA9IGxvb2t1cC5ub2RlOwoJCQkJCQlpZiAoRlMuaXNNb3VudHBvaW50KG5vZGUpKSB7CgkJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigxMCkKCQkJCQkJfQoJCQkJCQlpZiAoIUZTLmlzRGlyKG5vZGUubW9kZSkpIHsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDU0KQoJCQkJCQl9CgkJCQkJfQoJCQkJCXZhciBtb3VudCA9IHsKCQkJCQkJdHlwZTogdHlwZSwKCQkJCQkJb3B0czogb3B0cywKCQkJCQkJbW91bnRwb2ludDogbW91bnRwb2ludCwKCQkJCQkJbW91bnRzOiBbXQoJCQkJCX07CgkJCQkJdmFyIG1vdW50Um9vdCA9IHR5cGUubW91bnQobW91bnQpOwoJCQkJCW1vdW50Um9vdC5tb3VudCA9IG1vdW50OwoJCQkJCW1vdW50LnJvb3QgPSBtb3VudFJvb3Q7CgkJCQkJaWYgKHJvb3QpIHsKCQkJCQkJRlMucm9vdCA9IG1vdW50Um9vdAoJCQkJCX0gZWxzZSBpZiAobm9kZSkgewoJCQkJCQlub2RlLm1vdW50ZWQgPSBtb3VudDsKCQkJCQkJaWYgKG5vZGUubW91bnQpIHsKCQkJCQkJCW5vZGUubW91bnQubW91bnRzLnB1c2gobW91bnQpCgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIG1vdW50Um9vdAoJCQkJfSwKCQkJCXVubW91bnQ6IG1vdW50cG9pbnQgPT4gewoJCQkJCXZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKG1vdW50cG9pbnQsIHsKCQkJCQkJZm9sbG93X21vdW50OiBmYWxzZQoJCQkJCX0pOwoJCQkJCWlmICghRlMuaXNNb3VudHBvaW50KGxvb2t1cC5ub2RlKSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOCkKCQkJCQl9CgkJCQkJdmFyIG5vZGUgPSBsb29rdXAubm9kZTsKCQkJCQl2YXIgbW91bnQgPSBub2RlLm1vdW50ZWQ7CgkJCQkJdmFyIG1vdW50cyA9IEZTLmdldE1vdW50cyhtb3VudCk7CgkJCQkJT2JqZWN0LmtleXMoRlMubmFtZVRhYmxlKS5mb3JFYWNoKGhhc2ggPT4gewoJCQkJCQl2YXIgY3VycmVudCA9IEZTLm5hbWVUYWJsZVtoYXNoXTsKCQkJCQkJd2hpbGUgKGN1cnJlbnQpIHsKCQkJCQkJCXZhciBuZXh0ID0gY3VycmVudC5uYW1lX25leHQ7CgkJCQkJCQlpZiAobW91bnRzLmluY2x1ZGVzKGN1cnJlbnQubW91bnQpKSB7CgkJCQkJCQkJRlMuZGVzdHJveU5vZGUoY3VycmVudCkKCQkJCQkJCX0KCQkJCQkJCWN1cnJlbnQgPSBuZXh0CgkJCQkJCX0KCQkJCQl9KTsKCQkJCQlub2RlLm1vdW50ZWQgPSBudWxsOwoJCQkJCXZhciBpZHggPSBub2RlLm1vdW50Lm1vdW50cy5pbmRleE9mKG1vdW50KTsKCQkJCQlub2RlLm1vdW50Lm1vdW50cy5zcGxpY2UoaWR4LCAxKQoJCQkJfSwKCQkJCWxvb2t1cDogKHBhcmVudCwgbmFtZSkgPT4gewoJCQkJCXJldHVybiBwYXJlbnQubm9kZV9vcHMubG9va3VwKHBhcmVudCwgbmFtZSkKCQkJCX0sCgkJCQlta25vZDogKHBhdGgsIG1vZGUsIGRldikgPT4gewoJCQkJCXZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgsIHsKCQkJCQkJcGFyZW50OiB0cnVlCgkJCQkJfSk7CgkJCQkJdmFyIHBhcmVudCA9IGxvb2t1cC5ub2RlOwoJCQkJCXZhciBuYW1lID0gUEFUSC5iYXNlbmFtZShwYXRoKTsKCQkJCQlpZiAoIW5hbWUgfHwgbmFtZSA9PT0gIi4iIHx8IG5hbWUgPT09ICIuLiIpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjgpCgkJCQkJfQoJCQkJCXZhciBlcnJDb2RlID0gRlMubWF5Q3JlYXRlKHBhcmVudCwgbmFtZSk7CgkJCQkJaWYgKGVyckNvZGUpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoZXJyQ29kZSkKCQkJCQl9CgkJCQkJaWYgKCFwYXJlbnQubm9kZV9vcHMubWtub2QpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNjMpCgkJCQkJfQoJCQkJCXJldHVybiBwYXJlbnQubm9kZV9vcHMubWtub2QocGFyZW50LCBuYW1lLCBtb2RlLCBkZXYpCgkJCQl9LAoJCQkJY3JlYXRlOiAocGF0aCwgbW9kZSkgPT4gewoJCQkJCW1vZGUgPSBtb2RlICE9PSB1bmRlZmluZWQgPyBtb2RlIDogNDM4OwoJCQkJCW1vZGUgJj0gNDA5NTsKCQkJCQltb2RlIHw9IDMyNzY4OwoJCQkJCXJldHVybiBGUy5ta25vZChwYXRoLCBtb2RlLCAwKQoJCQkJfSwKCQkJCW1rZGlyOiAocGF0aCwgbW9kZSkgPT4gewoJCQkJCW1vZGUgPSBtb2RlICE9PSB1bmRlZmluZWQgPyBtb2RlIDogNTExOwoJCQkJCW1vZGUgJj0gNTExIHwgNTEyOwoJCQkJCW1vZGUgfD0gMTYzODQ7CgkJCQkJcmV0dXJuIEZTLm1rbm9kKHBhdGgsIG1vZGUsIDApCgkJCQl9LAoJCQkJbWtkaXJUcmVlOiAocGF0aCwgbW9kZSkgPT4gewoJCQkJCXZhciBkaXJzID0gcGF0aC5zcGxpdCgiLyIpOwoJCQkJCXZhciBkID0gIiI7CgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkaXJzLmxlbmd0aDsgKytpKSB7CgkJCQkJCWlmICghZGlyc1tpXSkgY29udGludWU7CgkJCQkJCWQgKz0gIi8iICsgZGlyc1tpXTsKCQkJCQkJdHJ5IHsKCQkJCQkJCUZTLm1rZGlyKGQsIG1vZGUpCgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCWlmIChlLmVycm5vICE9IDIwKSB0aHJvdyBlCgkJCQkJCX0KCQkJCQl9CgkJCQl9LAoJCQkJbWtkZXY6IChwYXRoLCBtb2RlLCBkZXYpID0+IHsKCQkJCQlpZiAodHlwZW9mIGRldiA9PSAidW5kZWZpbmVkIikgewoJCQkJCQlkZXYgPSBtb2RlOwoJCQkJCQltb2RlID0gNDM4CgkJCQkJfQoJCQkJCW1vZGUgfD0gODE5MjsKCQkJCQlyZXR1cm4gRlMubWtub2QocGF0aCwgbW9kZSwgZGV2KQoJCQkJfSwKCQkJCXN5bWxpbms6IChvbGRwYXRoLCBuZXdwYXRoKSA9PiB7CgkJCQkJaWYgKCFQQVRIX0ZTLnJlc29sdmUob2xkcGF0aCkpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDQpCgkJCQkJfQoJCQkJCXZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKG5ld3BhdGgsIHsKCQkJCQkJcGFyZW50OiB0cnVlCgkJCQkJfSk7CgkJCQkJdmFyIHBhcmVudCA9IGxvb2t1cC5ub2RlOwoJCQkJCWlmICghcGFyZW50KSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQ0KQoJCQkJCX0KCQkJCQl2YXIgbmV3bmFtZSA9IFBBVEguYmFzZW5hbWUobmV3cGF0aCk7CgkJCQkJdmFyIGVyckNvZGUgPSBGUy5tYXlDcmVhdGUocGFyZW50LCBuZXduYW1lKTsKCQkJCQlpZiAoZXJyQ29kZSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihlcnJDb2RlKQoJCQkJCX0KCQkJCQlpZiAoIXBhcmVudC5ub2RlX29wcy5zeW1saW5rKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYzKQoJCQkJCX0KCQkJCQlyZXR1cm4gcGFyZW50Lm5vZGVfb3BzLnN5bWxpbmsocGFyZW50LCBuZXduYW1lLCBvbGRwYXRoKQoJCQkJfSwKCQkJCXJlbmFtZTogKG9sZF9wYXRoLCBuZXdfcGF0aCkgPT4gewoJCQkJCXZhciBvbGRfZGlybmFtZSA9IFBBVEguZGlybmFtZShvbGRfcGF0aCk7CgkJCQkJdmFyIG5ld19kaXJuYW1lID0gUEFUSC5kaXJuYW1lKG5ld19wYXRoKTsKCQkJCQl2YXIgb2xkX25hbWUgPSBQQVRILmJhc2VuYW1lKG9sZF9wYXRoKTsKCQkJCQl2YXIgbmV3X25hbWUgPSBQQVRILmJhc2VuYW1lKG5ld19wYXRoKTsKCQkJCQl2YXIgbG9va3VwLCBvbGRfZGlyLCBuZXdfZGlyOwoJCQkJCWxvb2t1cCA9IEZTLmxvb2t1cFBhdGgob2xkX3BhdGgsIHsKCQkJCQkJcGFyZW50OiB0cnVlCgkJCQkJfSk7CgkJCQkJb2xkX2RpciA9IGxvb2t1cC5ub2RlOwoJCQkJCWxvb2t1cCA9IEZTLmxvb2t1cFBhdGgobmV3X3BhdGgsIHsKCQkJCQkJcGFyZW50OiB0cnVlCgkJCQkJfSk7CgkJCQkJbmV3X2RpciA9IGxvb2t1cC5ub2RlOwoJCQkJCWlmICghb2xkX2RpciB8fCAhbmV3X2RpcikgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDQpOwoJCQkJCWlmIChvbGRfZGlyLm1vdW50ICE9PSBuZXdfZGlyLm1vdW50KSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDc1KQoJCQkJCX0KCQkJCQl2YXIgb2xkX25vZGUgPSBGUy5sb29rdXBOb2RlKG9sZF9kaXIsIG9sZF9uYW1lKTsKCQkJCQl2YXIgcmVsYXRpdmUgPSBQQVRIX0ZTLnJlbGF0aXZlKG9sZF9wYXRoLCBuZXdfZGlybmFtZSk7CgkJCQkJaWYgKHJlbGF0aXZlLmNoYXJBdCgwKSAhPT0gIi4iKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQoJCQkJCX0KCQkJCQlyZWxhdGl2ZSA9IFBBVEhfRlMucmVsYXRpdmUobmV3X3BhdGgsIG9sZF9kaXJuYW1lKTsKCQkJCQlpZiAocmVsYXRpdmUuY2hhckF0KDApICE9PSAiLiIpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNTUpCgkJCQkJfQoJCQkJCXZhciBuZXdfbm9kZTsKCQkJCQl0cnkgewoJCQkJCQluZXdfbm9kZSA9IEZTLmxvb2t1cE5vZGUobmV3X2RpciwgbmV3X25hbWUpCgkJCQkJfSBjYXRjaCAoZSkge30KCQkJCQlpZiAob2xkX25vZGUgPT09IG5ld19ub2RlKSB7CgkJCQkJCXJldHVybgoJCQkJCX0KCQkJCQl2YXIgaXNkaXIgPSBGUy5pc0RpcihvbGRfbm9kZS5tb2RlKTsKCQkJCQl2YXIgZXJyQ29kZSA9IEZTLm1heURlbGV0ZShvbGRfZGlyLCBvbGRfbmFtZSwgaXNkaXIpOwoJCQkJCWlmIChlcnJDb2RlKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKGVyckNvZGUpCgkJCQkJfQoJCQkJCWVyckNvZGUgPSBuZXdfbm9kZSA/IEZTLm1heURlbGV0ZShuZXdfZGlyLCBuZXdfbmFtZSwgaXNkaXIpIDogRlMubWF5Q3JlYXRlKG5ld19kaXIsIG5ld19uYW1lKTsKCQkJCQlpZiAoZXJyQ29kZSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihlcnJDb2RlKQoJCQkJCX0KCQkJCQlpZiAoIW9sZF9kaXIubm9kZV9vcHMucmVuYW1lKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYzKQoJCQkJCX0KCQkJCQlpZiAoRlMuaXNNb3VudHBvaW50KG9sZF9ub2RlKSB8fCBuZXdfbm9kZSAmJiBGUy5pc01vdW50cG9pbnQobmV3X25vZGUpKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDEwKQoJCQkJCX0KCQkJCQlpZiAobmV3X2RpciAhPT0gb2xkX2RpcikgewoJCQkJCQllcnJDb2RlID0gRlMubm9kZVBlcm1pc3Npb25zKG9sZF9kaXIsICJ3Iik7CgkJCQkJCWlmIChlcnJDb2RlKSB7CgkJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihlcnJDb2RlKQoJCQkJCQl9CgkJCQkJfQoJCQkJCUZTLmhhc2hSZW1vdmVOb2RlKG9sZF9ub2RlKTsKCQkJCQl0cnkgewoJCQkJCQlvbGRfZGlyLm5vZGVfb3BzLnJlbmFtZShvbGRfbm9kZSwgbmV3X2RpciwgbmV3X25hbWUpCgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQl0aHJvdyBlCgkJCQkJfSBmaW5hbGx5IHsKCQkJCQkJRlMuaGFzaEFkZE5vZGUob2xkX25vZGUpCgkJCQkJfQoJCQkJfSwKCQkJCXJtZGlyOiBwYXRoID0+IHsKCQkJCQl2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CgkJCQkJCXBhcmVudDogdHJ1ZQoJCQkJCX0pOwoJCQkJCXZhciBwYXJlbnQgPSBsb29rdXAubm9kZTsKCQkJCQl2YXIgbmFtZSA9IFBBVEguYmFzZW5hbWUocGF0aCk7CgkJCQkJdmFyIG5vZGUgPSBGUy5sb29rdXBOb2RlKHBhcmVudCwgbmFtZSk7CgkJCQkJdmFyIGVyckNvZGUgPSBGUy5tYXlEZWxldGUocGFyZW50LCBuYW1lLCB0cnVlKTsKCQkJCQlpZiAoZXJyQ29kZSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihlcnJDb2RlKQoJCQkJCX0KCQkJCQlpZiAoIXBhcmVudC5ub2RlX29wcy5ybWRpcikgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig2MykKCQkJCQl9CgkJCQkJaWYgKEZTLmlzTW91bnRwb2ludChub2RlKSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigxMCkKCQkJCQl9CgkJCQkJcGFyZW50Lm5vZGVfb3BzLnJtZGlyKHBhcmVudCwgbmFtZSk7CgkJCQkJRlMuZGVzdHJveU5vZGUobm9kZSkKCQkJCX0sCgkJCQlyZWFkZGlyOiBwYXRoID0+IHsKCQkJCQl2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CgkJCQkJCWZvbGxvdzogdHJ1ZQoJCQkJCX0pOwoJCQkJCXZhciBub2RlID0gbG9va3VwLm5vZGU7CgkJCQkJaWYgKCFub2RlLm5vZGVfb3BzLnJlYWRkaXIpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNTQpCgkJCQkJfQoJCQkJCXJldHVybiBub2RlLm5vZGVfb3BzLnJlYWRkaXIobm9kZSkKCQkJCX0sCgkJCQl1bmxpbms6IHBhdGggPT4gewoJCQkJCXZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgsIHsKCQkJCQkJcGFyZW50OiB0cnVlCgkJCQkJfSk7CgkJCQkJdmFyIHBhcmVudCA9IGxvb2t1cC5ub2RlOwoJCQkJCWlmICghcGFyZW50KSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQ0KQoJCQkJCX0KCQkJCQl2YXIgbmFtZSA9IFBBVEguYmFzZW5hbWUocGF0aCk7CgkJCQkJdmFyIG5vZGUgPSBGUy5sb29rdXBOb2RlKHBhcmVudCwgbmFtZSk7CgkJCQkJdmFyIGVyckNvZGUgPSBGUy5tYXlEZWxldGUocGFyZW50LCBuYW1lLCBmYWxzZSk7CgkJCQkJaWYgKGVyckNvZGUpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoZXJyQ29kZSkKCQkJCQl9CgkJCQkJaWYgKCFwYXJlbnQubm9kZV9vcHMudW5saW5rKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYzKQoJCQkJCX0KCQkJCQlpZiAoRlMuaXNNb3VudHBvaW50KG5vZGUpKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDEwKQoJCQkJCX0KCQkJCQlwYXJlbnQubm9kZV9vcHMudW5saW5rKHBhcmVudCwgbmFtZSk7CgkJCQkJRlMuZGVzdHJveU5vZGUobm9kZSkKCQkJCX0sCgkJCQlyZWFkbGluazogcGF0aCA9PiB7CgkJCQkJdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCk7CgkJCQkJdmFyIGxpbmsgPSBsb29rdXAubm9kZTsKCQkJCQlpZiAoIWxpbmspIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDQpCgkJCQkJfQoJCQkJCWlmICghbGluay5ub2RlX29wcy5yZWFkbGluaykgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOCkKCQkJCQl9CgkJCQkJcmV0dXJuIFBBVEhfRlMucmVzb2x2ZShGUy5nZXRQYXRoKGxpbmsucGFyZW50KSwgbGluay5ub2RlX29wcy5yZWFkbGluayhsaW5rKSkKCQkJCX0sCgkJCQlzdGF0OiAocGF0aCwgZG9udEZvbGxvdykgPT4gewoJCQkJCXZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgsIHsKCQkJCQkJZm9sbG93OiAhZG9udEZvbGxvdwoJCQkJCX0pOwoJCQkJCXZhciBub2RlID0gbG9va3VwLm5vZGU7CgkJCQkJaWYgKCFub2RlKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQ0KQoJCQkJCX0KCQkJCQlpZiAoIW5vZGUubm9kZV9vcHMuZ2V0YXR0cikgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig2MykKCQkJCQl9CgkJCQkJcmV0dXJuIG5vZGUubm9kZV9vcHMuZ2V0YXR0cihub2RlKQoJCQkJfSwKCQkJCWxzdGF0OiBwYXRoID0+IHsKCQkJCQlyZXR1cm4gRlMuc3RhdChwYXRoLCB0cnVlKQoJCQkJfSwKCQkJCWNobW9kOiAocGF0aCwgbW9kZSwgZG9udEZvbGxvdykgPT4gewoJCQkJCXZhciBub2RlOwoJCQkJCWlmICh0eXBlb2YgcGF0aCA9PSAic3RyaW5nIikgewoJCQkJCQl2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CgkJCQkJCQlmb2xsb3c6ICFkb250Rm9sbG93CgkJCQkJCX0pOwoJCQkJCQlub2RlID0gbG9va3VwLm5vZGUKCQkJCQl9IGVsc2UgewoJCQkJCQlub2RlID0gcGF0aAoJCQkJCX0KCQkJCQlpZiAoIW5vZGUubm9kZV9vcHMuc2V0YXR0cikgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig2MykKCQkJCQl9CgkJCQkJbm9kZS5ub2RlX29wcy5zZXRhdHRyKG5vZGUsIHsKCQkJCQkJbW9kZTogbW9kZSAmIDQwOTUgfCBub2RlLm1vZGUgJiB+NDA5NSwKCQkJCQkJdGltZXN0YW1wOiBEYXRlLm5vdygpCgkJCQkJfSkKCQkJCX0sCgkJCQlsY2htb2Q6IChwYXRoLCBtb2RlKSA9PiB7CgkJCQkJRlMuY2htb2QocGF0aCwgbW9kZSwgdHJ1ZSkKCQkJCX0sCgkJCQlmY2htb2Q6IChmZCwgbW9kZSkgPT4gewoJCQkJCXZhciBzdHJlYW0gPSBGUy5nZXRTdHJlYW0oZmQpOwoJCQkJCWlmICghc3RyZWFtKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpCgkJCQkJfQoJCQkJCUZTLmNobW9kKHN0cmVhbS5ub2RlLCBtb2RlKQoJCQkJfSwKCQkJCWNob3duOiAocGF0aCwgdWlkLCBnaWQsIGRvbnRGb2xsb3cpID0+IHsKCQkJCQl2YXIgbm9kZTsKCQkJCQlpZiAodHlwZW9mIHBhdGggPT0gInN0cmluZyIpIHsKCQkJCQkJdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewoJCQkJCQkJZm9sbG93OiAhZG9udEZvbGxvdwoJCQkJCQl9KTsKCQkJCQkJbm9kZSA9IGxvb2t1cC5ub2RlCgkJCQkJfSBlbHNlIHsKCQkJCQkJbm9kZSA9IHBhdGgKCQkJCQl9CgkJCQkJaWYgKCFub2RlLm5vZGVfb3BzLnNldGF0dHIpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNjMpCgkJCQkJfQoJCQkJCW5vZGUubm9kZV9vcHMuc2V0YXR0cihub2RlLCB7CgkJCQkJCXRpbWVzdGFtcDogRGF0ZS5ub3coKQoJCQkJCX0pCgkJCQl9LAoJCQkJbGNob3duOiAocGF0aCwgdWlkLCBnaWQpID0+IHsKCQkJCQlGUy5jaG93bihwYXRoLCB1aWQsIGdpZCwgdHJ1ZSkKCQkJCX0sCgkJCQlmY2hvd246IChmZCwgdWlkLCBnaWQpID0+IHsKCQkJCQl2YXIgc3RyZWFtID0gRlMuZ2V0U3RyZWFtKGZkKTsKCQkJCQlpZiAoIXN0cmVhbSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig4KQoJCQkJCX0KCQkJCQlGUy5jaG93bihzdHJlYW0ubm9kZSwgdWlkLCBnaWQpCgkJCQl9LAoJCQkJdHJ1bmNhdGU6IChwYXRoLCBsZW4pID0+IHsKCQkJCQlpZiAobGVuIDwgMCkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOCkKCQkJCQl9CgkJCQkJdmFyIG5vZGU7CgkJCQkJaWYgKHR5cGVvZiBwYXRoID09ICJzdHJpbmciKSB7CgkJCQkJCXZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgsIHsKCQkJCQkJCWZvbGxvdzogdHJ1ZQoJCQkJCQl9KTsKCQkJCQkJbm9kZSA9IGxvb2t1cC5ub2RlCgkJCQkJfSBlbHNlIHsKCQkJCQkJbm9kZSA9IHBhdGgKCQkJCQl9CgkJCQkJaWYgKCFub2RlLm5vZGVfb3BzLnNldGF0dHIpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNjMpCgkJCQkJfQoJCQkJCWlmIChGUy5pc0Rpcihub2RlLm1vZGUpKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDMxKQoJCQkJCX0KCQkJCQlpZiAoIUZTLmlzRmlsZShub2RlLm1vZGUpKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQoJCQkJCX0KCQkJCQl2YXIgZXJyQ29kZSA9IEZTLm5vZGVQZXJtaXNzaW9ucyhub2RlLCAidyIpOwoJCQkJCWlmIChlcnJDb2RlKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKGVyckNvZGUpCgkJCQkJfQoJCQkJCW5vZGUubm9kZV9vcHMuc2V0YXR0cihub2RlLCB7CgkJCQkJCXNpemU6IGxlbiwKCQkJCQkJdGltZXN0YW1wOiBEYXRlLm5vdygpCgkJCQkJfSkKCQkJCX0sCgkJCQlmdHJ1bmNhdGU6IChmZCwgbGVuKSA9PiB7CgkJCQkJdmFyIHN0cmVhbSA9IEZTLmdldFN0cmVhbShmZCk7CgkJCQkJaWYgKCFzdHJlYW0pIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoOCkKCQkJCQl9CgkJCQkJaWYgKChzdHJlYW0uZmxhZ3MgJiAyMDk3MTU1KSA9PT0gMCkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOCkKCQkJCQl9CgkJCQkJRlMudHJ1bmNhdGUoc3RyZWFtLm5vZGUsIGxlbikKCQkJCX0sCgkJCQl1dGltZTogKHBhdGgsIGF0aW1lLCBtdGltZSkgPT4gewoJCQkJCXZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgsIHsKCQkJCQkJZm9sbG93OiB0cnVlCgkJCQkJfSk7CgkJCQkJdmFyIG5vZGUgPSBsb29rdXAubm9kZTsKCQkJCQlub2RlLm5vZGVfb3BzLnNldGF0dHIobm9kZSwgewoJCQkJCQl0aW1lc3RhbXA6IE1hdGgubWF4KGF0aW1lLCBtdGltZSkKCQkJCQl9KQoJCQkJfSwKCQkJCW9wZW46IChwYXRoLCBmbGFncywgbW9kZSkgPT4gewoJCQkJCWlmIChwYXRoID09PSAiIikgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig0NCkKCQkJCQl9CgkJCQkJZmxhZ3MgPSB0eXBlb2YgZmxhZ3MgPT0gInN0cmluZyIgPyBGU19tb2RlU3RyaW5nVG9GbGFncyhmbGFncykgOiBmbGFnczsKCQkJCQltb2RlID0gdHlwZW9mIG1vZGUgPT0gInVuZGVmaW5lZCIgPyA0MzggOiBtb2RlOwoJCQkJCWlmIChmbGFncyAmIDY0KSB7CgkJCQkJCW1vZGUgPSBtb2RlICYgNDA5NSB8IDMyNzY4CgkJCQkJfSBlbHNlIHsKCQkJCQkJbW9kZSA9IDAKCQkJCQl9CgkJCQkJdmFyIG5vZGU7CgkJCQkJaWYgKHR5cGVvZiBwYXRoID09ICJvYmplY3QiKSB7CgkJCQkJCW5vZGUgPSBwYXRoCgkJCQkJfSBlbHNlIHsKCQkJCQkJcGF0aCA9IFBBVEgubm9ybWFsaXplKHBhdGgpOwoJCQkJCQl0cnkgewoJCQkJCQkJdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewoJCQkJCQkJCWZvbGxvdzogIShmbGFncyAmIDEzMTA3MikKCQkJCQkJCX0pOwoJCQkJCQkJbm9kZSA9IGxvb2t1cC5ub2RlCgkJCQkJCX0gY2F0Y2ggKGUpIHt9CgkJCQkJfQoJCQkJCXZhciBjcmVhdGVkID0gZmFsc2U7CgkJCQkJaWYgKGZsYWdzICYgNjQpIHsKCQkJCQkJaWYgKG5vZGUpIHsKCQkJCQkJCWlmIChmbGFncyAmIDEyOCkgewoJCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDIwKQoJCQkJCQkJfQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbm9kZSA9IEZTLm1rbm9kKHBhdGgsIG1vZGUsIDApOwoJCQkJCQkJY3JlYXRlZCA9IHRydWUKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIW5vZGUpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDQpCgkJCQkJfQoJCQkJCWlmIChGUy5pc0NocmRldihub2RlLm1vZGUpKSB7CgkJCQkJCWZsYWdzICY9IH41MTIKCQkJCQl9CgkJCQkJaWYgKGZsYWdzICYgNjU1MzYgJiYgIUZTLmlzRGlyKG5vZGUubW9kZSkpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNTQpCgkJCQkJfQoJCQkJCWlmICghY3JlYXRlZCkgewoJCQkJCQl2YXIgZXJyQ29kZSA9IEZTLm1heU9wZW4obm9kZSwgZmxhZ3MpOwoJCQkJCQlpZiAoZXJyQ29kZSkgewoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoZXJyQ29kZSkKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoZmxhZ3MgJiA1MTIgJiYgIWNyZWF0ZWQpIHsKCQkJCQkJRlMudHJ1bmNhdGUobm9kZSwgMCkKCQkJCQl9CgkJCQkJZmxhZ3MgJj0gfigxMjggfCA1MTIgfCAxMzEwNzIpOwoJCQkJCXZhciBzdHJlYW0gPSBGUy5jcmVhdGVTdHJlYW0oewoJCQkJCQlub2RlOiBub2RlLAoJCQkJCQlwYXRoOiBGUy5nZXRQYXRoKG5vZGUpLAoJCQkJCQlmbGFnczogZmxhZ3MsCgkJCQkJCXNlZWthYmxlOiB0cnVlLAoJCQkJCQlwb3NpdGlvbjogMCwKCQkJCQkJc3RyZWFtX29wczogbm9kZS5zdHJlYW1fb3BzLAoJCQkJCQl1bmdvdHRlbjogW10sCgkJCQkJCWVycm9yOiBmYWxzZQoJCQkJCX0pOwoJCQkJCWlmIChzdHJlYW0uc3RyZWFtX29wcy5vcGVuKSB7CgkJCQkJCXN0cmVhbS5zdHJlYW1fb3BzLm9wZW4oc3RyZWFtKQoJCQkJCX0KCQkJCQlpZiAoTW9kdWxlWyJsb2dSZWFkRmlsZXMiXSAmJiAhKGZsYWdzICYgMSkpIHsKCQkJCQkJaWYgKCFGUy5yZWFkRmlsZXMpIEZTLnJlYWRGaWxlcyA9IHt9OwoJCQkJCQlpZiAoIShwYXRoIGluIEZTLnJlYWRGaWxlcykpIHsKCQkJCQkJCUZTLnJlYWRGaWxlc1twYXRoXSA9IDEKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXR1cm4gc3RyZWFtCgkJCQl9LAoJCQkJY2xvc2U6IHN0cmVhbSA9PiB7CgkJCQkJaWYgKEZTLmlzQ2xvc2VkKHN0cmVhbSkpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoOCkKCQkJCQl9CgkJCQkJaWYgKHN0cmVhbS5nZXRkZW50cykgc3RyZWFtLmdldGRlbnRzID0gbnVsbDsKCQkJCQl0cnkgewoJCQkJCQlpZiAoc3RyZWFtLnN0cmVhbV9vcHMuY2xvc2UpIHsKCQkJCQkJCXN0cmVhbS5zdHJlYW1fb3BzLmNsb3NlKHN0cmVhbSkKCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJdGhyb3cgZQoJCQkJCX0gZmluYWxseSB7CgkJCQkJCUZTLmNsb3NlU3RyZWFtKHN0cmVhbS5mZCkKCQkJCQl9CgkJCQkJc3RyZWFtLmZkID0gbnVsbAoJCQkJfSwKCQkJCWlzQ2xvc2VkOiBzdHJlYW0gPT4gewoJCQkJCXJldHVybiBzdHJlYW0uZmQgPT09IG51bGwKCQkJCX0sCgkJCQlsbHNlZWs6IChzdHJlYW0sIG9mZnNldCwgd2hlbmNlKSA9PiB7CgkJCQkJaWYgKEZTLmlzQ2xvc2VkKHN0cmVhbSkpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoOCkKCQkJCQl9CgkJCQkJaWYgKCFzdHJlYW0uc2Vla2FibGUgfHwgIXN0cmVhbS5zdHJlYW1fb3BzLmxsc2VlaykgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig3MCkKCQkJCQl9CgkJCQkJaWYgKHdoZW5jZSAhPSAwICYmIHdoZW5jZSAhPSAxICYmIHdoZW5jZSAhPSAyKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQoJCQkJCX0KCQkJCQlzdHJlYW0ucG9zaXRpb24gPSBzdHJlYW0uc3RyZWFtX29wcy5sbHNlZWsoc3RyZWFtLCBvZmZzZXQsIHdoZW5jZSk7CgkJCQkJc3RyZWFtLnVuZ290dGVuID0gW107CgkJCQkJcmV0dXJuIHN0cmVhbS5wb3NpdGlvbgoJCQkJfSwKCQkJCXJlYWQ6IChzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKSA9PiB7CgkJCQkJaWYgKGxlbmd0aCA8IDAgfHwgcG9zaXRpb24gPCAwKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQoJCQkJCX0KCQkJCQlpZiAoRlMuaXNDbG9zZWQoc3RyZWFtKSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig4KQoJCQkJCX0KCQkJCQlpZiAoKHN0cmVhbS5mbGFncyAmIDIwOTcxNTUpID09PSAxKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpCgkJCQkJfQoJCQkJCWlmIChGUy5pc0RpcihzdHJlYW0ubm9kZS5tb2RlKSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigzMSkKCQkJCQl9CgkJCQkJaWYgKCFzdHJlYW0uc3RyZWFtX29wcy5yZWFkKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQoJCQkJCX0KCQkJCQl2YXIgc2Vla2luZyA9IHR5cGVvZiBwb3NpdGlvbiAhPSAidW5kZWZpbmVkIjsKCQkJCQlpZiAoIXNlZWtpbmcpIHsKCQkJCQkJcG9zaXRpb24gPSBzdHJlYW0ucG9zaXRpb24KCQkJCQl9IGVsc2UgaWYgKCFzdHJlYW0uc2Vla2FibGUpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNzApCgkJCQkJfQoJCQkJCXZhciBieXRlc1JlYWQgPSBzdHJlYW0uc3RyZWFtX29wcy5yZWFkKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zaXRpb24pOwoJCQkJCWlmICghc2Vla2luZykgc3RyZWFtLnBvc2l0aW9uICs9IGJ5dGVzUmVhZDsKCQkJCQlyZXR1cm4gYnl0ZXNSZWFkCgkJCQl9LAoJCQkJd3JpdGU6IChzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uLCBjYW5Pd24pID0+IHsKCQkJCQlpZiAobGVuZ3RoIDwgMCB8fCBwb3NpdGlvbiA8IDApIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjgpCgkJCQkJfQoJCQkJCWlmIChGUy5pc0Nsb3NlZChzdHJlYW0pKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpCgkJCQkJfQoJCQkJCWlmICgoc3RyZWFtLmZsYWdzICYgMjA5NzE1NSkgPT09IDApIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoOCkKCQkJCQl9CgkJCQkJaWYgKEZTLmlzRGlyKHN0cmVhbS5ub2RlLm1vZGUpKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDMxKQoJCQkJCX0KCQkJCQlpZiAoIXN0cmVhbS5zdHJlYW1fb3BzLndyaXRlKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQoJCQkJCX0KCQkJCQlpZiAoc3RyZWFtLnNlZWthYmxlICYmIHN0cmVhbS5mbGFncyAmIDEwMjQpIHsKCQkJCQkJRlMubGxzZWVrKHN0cmVhbSwgMCwgMikKCQkJCQl9CgkJCQkJdmFyIHNlZWtpbmcgPSB0eXBlb2YgcG9zaXRpb24gIT0gInVuZGVmaW5lZCI7CgkJCQkJaWYgKCFzZWVraW5nKSB7CgkJCQkJCXBvc2l0aW9uID0gc3RyZWFtLnBvc2l0aW9uCgkJCQkJfSBlbHNlIGlmICghc3RyZWFtLnNlZWthYmxlKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDcwKQoJCQkJCX0KCQkJCQl2YXIgYnl0ZXNXcml0dGVuID0gc3RyZWFtLnN0cmVhbV9vcHMud3JpdGUoc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbiwgY2FuT3duKTsKCQkJCQlpZiAoIXNlZWtpbmcpIHN0cmVhbS5wb3NpdGlvbiArPSBieXRlc1dyaXR0ZW47CgkJCQkJcmV0dXJuIGJ5dGVzV3JpdHRlbgoJCQkJfSwKCQkJCWFsbG9jYXRlOiAoc3RyZWFtLCBvZmZzZXQsIGxlbmd0aCkgPT4gewoJCQkJCWlmIChGUy5pc0Nsb3NlZChzdHJlYW0pKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpCgkJCQkJfQoJCQkJCWlmIChvZmZzZXQgPCAwIHx8IGxlbmd0aCA8PSAwKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQoJCQkJCX0KCQkJCQlpZiAoKHN0cmVhbS5mbGFncyAmIDIwOTcxNTUpID09PSAwKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpCgkJCQkJfQoJCQkJCWlmICghRlMuaXNGaWxlKHN0cmVhbS5ub2RlLm1vZGUpICYmICFGUy5pc0RpcihzdHJlYW0ubm9kZS5tb2RlKSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig0MykKCQkJCQl9CgkJCQkJaWYgKCFzdHJlYW0uc3RyZWFtX29wcy5hbGxvY2F0ZSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigxMzgpCgkJCQkJfQoJCQkJCXN0cmVhbS5zdHJlYW1fb3BzLmFsbG9jYXRlKHN0cmVhbSwgb2Zmc2V0LCBsZW5ndGgpCgkJCQl9LAoJCQkJbW1hcDogKHN0cmVhbSwgbGVuZ3RoLCBwb3NpdGlvbiwgcHJvdCwgZmxhZ3MpID0+IHsKCQkJCQlpZiAoKHByb3QgJiAyKSAhPT0gMCAmJiAoZmxhZ3MgJiAyKSA9PT0gMCAmJiAoc3RyZWFtLmZsYWdzICYgMjA5NzE1NSkgIT09IDIpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMikKCQkJCQl9CgkJCQkJaWYgKChzdHJlYW0uZmxhZ3MgJiAyMDk3MTU1KSA9PT0gMSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyKQoJCQkJCX0KCQkJCQlpZiAoIXN0cmVhbS5zdHJlYW1fb3BzLm1tYXApIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDMpCgkJCQkJfQoJCQkJCXJldHVybiBzdHJlYW0uc3RyZWFtX29wcy5tbWFwKHN0cmVhbSwgbGVuZ3RoLCBwb3NpdGlvbiwgcHJvdCwgZmxhZ3MpCgkJCQl9LAoJCQkJbXN5bmM6IChzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIG1tYXBGbGFncykgPT4gewoJCQkJCWlmICghc3RyZWFtLnN0cmVhbV9vcHMubXN5bmMpIHsKCQkJCQkJcmV0dXJuIDAKCQkJCQl9CgkJCQkJcmV0dXJuIHN0cmVhbS5zdHJlYW1fb3BzLm1zeW5jKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgbW1hcEZsYWdzKQoJCQkJfSwKCQkJCW11bm1hcDogc3RyZWFtID0+IDAsCgkJCQlpb2N0bDogKHN0cmVhbSwgY21kLCBhcmcpID0+IHsKCQkJCQlpZiAoIXN0cmVhbS5zdHJlYW1fb3BzLmlvY3RsKSB7CgkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDU5KQoJCQkJCX0KCQkJCQlyZXR1cm4gc3RyZWFtLnN0cmVhbV9vcHMuaW9jdGwoc3RyZWFtLCBjbWQsIGFyZykKCQkJCX0sCgkJCQlyZWFkRmlsZTogKHBhdGgsIG9wdHMgPSB7fSkgPT4gewoJCQkJCW9wdHMuZmxhZ3MgPSBvcHRzLmZsYWdzIHx8IDA7CgkJCQkJb3B0cy5lbmNvZGluZyA9IG9wdHMuZW5jb2RpbmcgfHwgImJpbmFyeSI7CgkJCQkJaWYgKG9wdHMuZW5jb2RpbmcgIT09ICJ1dGY4IiAmJiBvcHRzLmVuY29kaW5nICE9PSAiYmluYXJ5IikgewoJCQkJCQl0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZW5jb2RpbmcgdHlwZSAiJyArIG9wdHMuZW5jb2RpbmcgKyAnIicpCgkJCQkJfQoJCQkJCXZhciByZXQ7CgkJCQkJdmFyIHN0cmVhbSA9IEZTLm9wZW4ocGF0aCwgb3B0cy5mbGFncyk7CgkJCQkJdmFyIHN0YXQgPSBGUy5zdGF0KHBhdGgpOwoJCQkJCXZhciBsZW5ndGggPSBzdGF0LnNpemU7CgkJCQkJdmFyIGJ1ZiA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCk7CgkJCQkJRlMucmVhZChzdHJlYW0sIGJ1ZiwgMCwgbGVuZ3RoLCAwKTsKCQkJCQlpZiAob3B0cy5lbmNvZGluZyA9PT0gInV0ZjgiKSB7CgkJCQkJCXJldCA9IFVURjhBcnJheVRvU3RyaW5nKGJ1ZiwgMCkKCQkJCQl9IGVsc2UgaWYgKG9wdHMuZW5jb2RpbmcgPT09ICJiaW5hcnkiKSB7CgkJCQkJCXJldCA9IGJ1ZgoJCQkJCX0KCQkJCQlGUy5jbG9zZShzdHJlYW0pOwoJCQkJCXJldHVybiByZXQKCQkJCX0sCgkJCQl3cml0ZUZpbGU6IChwYXRoLCBkYXRhLCBvcHRzID0ge30pID0+IHsKCQkJCQlvcHRzLmZsYWdzID0gb3B0cy5mbGFncyB8fCA1Nzc7CgkJCQkJdmFyIHN0cmVhbSA9IEZTLm9wZW4ocGF0aCwgb3B0cy5mbGFncywgb3B0cy5tb2RlKTsKCQkJCQlpZiAodHlwZW9mIGRhdGEgPT0gInN0cmluZyIpIHsKCQkJCQkJdmFyIGJ1ZiA9IG5ldyBVaW50OEFycmF5KGxlbmd0aEJ5dGVzVVRGOChkYXRhKSArIDEpOwoJCQkJCQl2YXIgYWN0dWFsTnVtQnl0ZXMgPSBzdHJpbmdUb1VURjhBcnJheShkYXRhLCBidWYsIDAsIGJ1Zi5sZW5ndGgpOwoJCQkJCQlGUy53cml0ZShzdHJlYW0sIGJ1ZiwgMCwgYWN0dWFsTnVtQnl0ZXMsIHVuZGVmaW5lZCwgb3B0cy5jYW5Pd24pCgkJCQkJfSBlbHNlIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoZGF0YSkpIHsKCQkJCQkJRlMud3JpdGUoc3RyZWFtLCBkYXRhLCAwLCBkYXRhLmJ5dGVMZW5ndGgsIHVuZGVmaW5lZCwgb3B0cy5jYW5Pd24pCgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhyb3cgbmV3IEVycm9yKCJVbnN1cHBvcnRlZCBkYXRhIHR5cGUiKQoJCQkJCX0KCQkJCQlGUy5jbG9zZShzdHJlYW0pCgkJCQl9LAoJCQkJY3dkOiAoKSA9PiBGUy5jdXJyZW50UGF0aCwKCQkJCWNoZGlyOiBwYXRoID0+IHsKCQkJCQl2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CgkJCQkJCWZvbGxvdzogdHJ1ZQoJCQkJCX0pOwoJCQkJCWlmIChsb29rdXAubm9kZSA9PT0gbnVsbCkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig0NCkKCQkJCQl9CgkJCQkJaWYgKCFGUy5pc0Rpcihsb29rdXAubm9kZS5tb2RlKSkgewoJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig1NCkKCQkJCQl9CgkJCQkJdmFyIGVyckNvZGUgPSBGUy5ub2RlUGVybWlzc2lvbnMobG9va3VwLm5vZGUsICJ4Iik7CgkJCQkJaWYgKGVyckNvZGUpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoZXJyQ29kZSkKCQkJCQl9CgkJCQkJRlMuY3VycmVudFBhdGggPSBsb29rdXAucGF0aAoJCQkJfSwKCQkJCWNyZWF0ZURlZmF1bHREaXJlY3RvcmllczogKCkgPT4gewoJCQkJCUZTLm1rZGlyKCIvdG1wIik7CgkJCQkJRlMubWtkaXIoIi9ob21lIik7CgkJCQkJRlMubWtkaXIoIi9ob21lL3dlYl91c2VyIikKCQkJCX0sCgkJCQljcmVhdGVEZWZhdWx0RGV2aWNlczogKCkgPT4gewoJCQkJCUZTLm1rZGlyKCIvZGV2Iik7CgkJCQkJRlMucmVnaXN0ZXJEZXZpY2UoRlMubWFrZWRldigxLCAzKSwgewoJCQkJCQlyZWFkOiAoKSA9PiAwLAoJCQkJCQl3cml0ZTogKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zKSA9PiBsZW5ndGgKCQkJCQl9KTsKCQkJCQlGUy5ta2RldigiL2Rldi9udWxsIiwgRlMubWFrZWRldigxLCAzKSk7CgkJCQkJVFRZLnJlZ2lzdGVyKEZTLm1ha2VkZXYoNSwgMCksIFRUWS5kZWZhdWx0X3R0eV9vcHMpOwoJCQkJCVRUWS5yZWdpc3RlcihGUy5tYWtlZGV2KDYsIDApLCBUVFkuZGVmYXVsdF90dHkxX29wcyk7CgkJCQkJRlMubWtkZXYoIi9kZXYvdHR5IiwgRlMubWFrZWRldig1LCAwKSk7CgkJCQkJRlMubWtkZXYoIi9kZXYvdHR5MSIsIEZTLm1ha2VkZXYoNiwgMCkpOwoJCQkJCXZhciByYW5kb21CdWZmZXIgPSBuZXcgVWludDhBcnJheSgxMDI0KSwKCQkJCQkJcmFuZG9tTGVmdCA9IDA7CgkJCQkJdmFyIHJhbmRvbUJ5dGUgPSAoKSA9PiB7CgkJCQkJCWlmIChyYW5kb21MZWZ0ID09PSAwKSB7CgkJCQkJCQlyYW5kb21MZWZ0ID0gcmFuZG9tRmlsbChyYW5kb21CdWZmZXIpLmJ5dGVMZW5ndGgKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmFuZG9tQnVmZmVyWy0tcmFuZG9tTGVmdF0KCQkJCQl9OwoJCQkJCUZTLmNyZWF0ZURldmljZSgiL2RldiIsICJyYW5kb20iLCByYW5kb21CeXRlKTsKCQkJCQlGUy5jcmVhdGVEZXZpY2UoIi9kZXYiLCAidXJhbmRvbSIsIHJhbmRvbUJ5dGUpOwoJCQkJCUZTLm1rZGlyKCIvZGV2L3NobSIpOwoJCQkJCUZTLm1rZGlyKCIvZGV2L3NobS90bXAiKQoJCQkJfSwKCQkJCWNyZWF0ZVNwZWNpYWxEaXJlY3RvcmllczogKCkgPT4gewoJCQkJCUZTLm1rZGlyKCIvcHJvYyIpOwoJCQkJCXZhciBwcm9jX3NlbGYgPSBGUy5ta2RpcigiL3Byb2Mvc2VsZiIpOwoJCQkJCUZTLm1rZGlyKCIvcHJvYy9zZWxmL2ZkIik7CgkJCQkJRlMubW91bnQoewoJCQkJCQltb3VudDogKCkgPT4gewoJCQkJCQkJdmFyIG5vZGUgPSBGUy5jcmVhdGVOb2RlKHByb2Nfc2VsZiwgImZkIiwgMTYzODQgfCA1MTEsIDczKTsKCQkJCQkJCW5vZGUubm9kZV9vcHMgPSB7CgkJCQkJCQkJbG9va3VwOiAocGFyZW50LCBuYW1lKSA9PiB7CgkJCQkJCQkJCXZhciBmZCA9ICtuYW1lOwoJCQkJCQkJCQl2YXIgc3RyZWFtID0gRlMuZ2V0U3RyZWFtKGZkKTsKCQkJCQkJCQkJaWYgKCFzdHJlYW0pIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpOwoJCQkJCQkJCQl2YXIgcmV0ID0gewoJCQkJCQkJCQkJcGFyZW50OiBudWxsLAoJCQkJCQkJCQkJbW91bnQ6IHsKCQkJCQkJCQkJCQltb3VudHBvaW50OiAiZmFrZSIKCQkJCQkJCQkJCX0sCgkJCQkJCQkJCQlub2RlX29wczogewoJCQkJCQkJCQkJCXJlYWRsaW5rOiAoKSA9PiBzdHJlYW0ucGF0aAoJCQkJCQkJCQkJfQoJCQkJCQkJCQl9OwoJCQkJCQkJCQlyZXQucGFyZW50ID0gcmV0OwoJCQkJCQkJCQlyZXR1cm4gcmV0CgkJCQkJCQkJfQoJCQkJCQkJfTsKCQkJCQkJCXJldHVybiBub2RlCgkJCQkJCX0KCQkJCQl9LCB7fSwgIi9wcm9jL3NlbGYvZmQiKQoJCQkJfSwKCQkJCWNyZWF0ZVN0YW5kYXJkU3RyZWFtczogKCkgPT4gewoJCQkJCWlmIChNb2R1bGVbInN0ZGluIl0pIHsKCQkJCQkJRlMuY3JlYXRlRGV2aWNlKCIvZGV2IiwgInN0ZGluIiwgTW9kdWxlWyJzdGRpbiJdKQoJCQkJCX0gZWxzZSB7CgkJCQkJCUZTLnN5bWxpbmsoIi9kZXYvdHR5IiwgIi9kZXYvc3RkaW4iKQoJCQkJCX0KCQkJCQlpZiAoTW9kdWxlWyJzdGRvdXQiXSkgewoJCQkJCQlGUy5jcmVhdGVEZXZpY2UoIi9kZXYiLCAic3Rkb3V0IiwgbnVsbCwgTW9kdWxlWyJzdGRvdXQiXSkKCQkJCQl9IGVsc2UgewoJCQkJCQlGUy5zeW1saW5rKCIvZGV2L3R0eSIsICIvZGV2L3N0ZG91dCIpCgkJCQkJfQoJCQkJCWlmIChNb2R1bGVbInN0ZGVyciJdKSB7CgkJCQkJCUZTLmNyZWF0ZURldmljZSgiL2RldiIsICJzdGRlcnIiLCBudWxsLCBNb2R1bGVbInN0ZGVyciJdKQoJCQkJCX0gZWxzZSB7CgkJCQkJCUZTLnN5bWxpbmsoIi9kZXYvdHR5MSIsICIvZGV2L3N0ZGVyciIpCgkJCQkJfQoJCQkJCXZhciBzdGRpbiA9IEZTLm9wZW4oIi9kZXYvc3RkaW4iLCAwKTsKCQkJCQl2YXIgc3Rkb3V0ID0gRlMub3BlbigiL2Rldi9zdGRvdXQiLCAxKTsKCQkJCQl2YXIgc3RkZXJyID0gRlMub3BlbigiL2Rldi9zdGRlcnIiLCAxKQoJCQkJfSwKCQkJCWVuc3VyZUVycm5vRXJyb3I6ICgpID0+IHsKCQkJCQlpZiAoRlMuRXJybm9FcnJvcikgcmV0dXJuOwoJCQkJCUZTLkVycm5vRXJyb3IgPSBmdW5jdGlvbiBFcnJub0Vycm9yKGVycm5vLCBub2RlKSB7CgkJCQkJCXRoaXMubmFtZSA9ICJFcnJub0Vycm9yIjsKCQkJCQkJdGhpcy5ub2RlID0gbm9kZTsKCQkJCQkJdGhpcy5zZXRFcnJubyA9IGZ1bmN0aW9uKGVycm5vKSB7CgkJCQkJCQl0aGlzLmVycm5vID0gZXJybm8KCQkJCQkJfTsKCQkJCQkJdGhpcy5zZXRFcnJubyhlcnJubyk7CgkJCQkJCXRoaXMubWVzc2FnZSA9ICJGUyBlcnJvciIKCQkJCQl9OwoJCQkJCUZTLkVycm5vRXJyb3IucHJvdG90eXBlID0gbmV3IEVycm9yOwoJCQkJCUZTLkVycm5vRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRlMuRXJybm9FcnJvcjsKCQkJCQlbNDRdLmZvckVhY2goY29kZSA9PiB7CgkJCQkJCUZTLmdlbmVyaWNFcnJvcnNbY29kZV0gPSBuZXcgRlMuRXJybm9FcnJvcihjb2RlKTsKCQkJCQkJRlMuZ2VuZXJpY0Vycm9yc1tjb2RlXS5zdGFjayA9ICI8Z2VuZXJpYyBlcnJvciwgbm8gc3RhY2s+IgoJCQkJCX0pCgkJCQl9LAoJCQkJc3RhdGljSW5pdDogKCkgPT4gewoJCQkJCUZTLmVuc3VyZUVycm5vRXJyb3IoKTsKCQkJCQlGUy5uYW1lVGFibGUgPSBuZXcgQXJyYXkoNDA5Nik7CgkJCQkJRlMubW91bnQoTUVNRlMsIHt9LCAiLyIpOwoJCQkJCUZTLmNyZWF0ZURlZmF1bHREaXJlY3RvcmllcygpOwoJCQkJCUZTLmNyZWF0ZURlZmF1bHREZXZpY2VzKCk7CgkJCQkJRlMuY3JlYXRlU3BlY2lhbERpcmVjdG9yaWVzKCk7CgkJCQkJRlMuZmlsZXN5c3RlbXMgPSB7CgkJCQkJCSJNRU1GUyI6IE1FTUZTLAoJCQkJCQkiUFJPWFlGUyI6IFBST1hZRlMKCQkJCQl9CgkJCQl9LAoJCQkJaW5pdDogKGlucHV0LCBvdXRwdXQsIGVycm9yKSA9PiB7CgkJCQkJRlMuaW5pdC5pbml0aWFsaXplZCA9IHRydWU7CgkJCQkJRlMuZW5zdXJlRXJybm9FcnJvcigpOwoJCQkJCU1vZHVsZVsic3RkaW4iXSA9IGlucHV0IHx8IE1vZHVsZVsic3RkaW4iXTsKCQkJCQlNb2R1bGVbInN0ZG91dCJdID0gb3V0cHV0IHx8IE1vZHVsZVsic3Rkb3V0Il07CgkJCQkJTW9kdWxlWyJzdGRlcnIiXSA9IGVycm9yIHx8IE1vZHVsZVsic3RkZXJyIl07CgkJCQkJRlMuY3JlYXRlU3RhbmRhcmRTdHJlYW1zKCkKCQkJCX0sCgkJCQlxdWl0OiAoKSA9PiB7CgkJCQkJRlMuaW5pdC5pbml0aWFsaXplZCA9IGZhbHNlOwoJCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgRlMuc3RyZWFtcy5sZW5ndGg7IGkrKykgewoJCQkJCQl2YXIgc3RyZWFtID0gRlMuc3RyZWFtc1tpXTsKCQkJCQkJaWYgKCFzdHJlYW0pIHsKCQkJCQkJCWNvbnRpbnVlCgkJCQkJCX0KCQkJCQkJRlMuY2xvc2Uoc3RyZWFtKQoJCQkJCX0KCQkJCX0sCgkJCQlmaW5kT2JqZWN0OiAocGF0aCwgZG9udFJlc29sdmVMYXN0TGluaykgPT4gewoJCQkJCXZhciByZXQgPSBGUy5hbmFseXplUGF0aChwYXRoLCBkb250UmVzb2x2ZUxhc3RMaW5rKTsKCQkJCQlpZiAoIXJldC5leGlzdHMpIHsKCQkJCQkJcmV0dXJuIG51bGwKCQkJCQl9CgkJCQkJcmV0dXJuIHJldC5vYmplY3QKCQkJCX0sCgkJCQlhbmFseXplUGF0aDogKHBhdGgsIGRvbnRSZXNvbHZlTGFzdExpbmspID0+IHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CgkJCQkJCQlmb2xsb3c6ICFkb250UmVzb2x2ZUxhc3RMaW5rCgkJCQkJCX0pOwoJCQkJCQlwYXRoID0gbG9va3VwLnBhdGgKCQkJCQl9IGNhdGNoIChlKSB7fQoJCQkJCXZhciByZXQgPSB7CgkJCQkJCWlzUm9vdDogZmFsc2UsCgkJCQkJCWV4aXN0czogZmFsc2UsCgkJCQkJCWVycm9yOiAwLAoJCQkJCQluYW1lOiBudWxsLAoJCQkJCQlwYXRoOiBudWxsLAoJCQkJCQlvYmplY3Q6IG51bGwsCgkJCQkJCXBhcmVudEV4aXN0czogZmFsc2UsCgkJCQkJCXBhcmVudFBhdGg6IG51bGwsCgkJCQkJCXBhcmVudE9iamVjdDogbnVsbAoJCQkJCX07CgkJCQkJdHJ5IHsKCQkJCQkJdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewoJCQkJCQkJcGFyZW50OiB0cnVlCgkJCQkJCX0pOwoJCQkJCQlyZXQucGFyZW50RXhpc3RzID0gdHJ1ZTsKCQkJCQkJcmV0LnBhcmVudFBhdGggPSBsb29rdXAucGF0aDsKCQkJCQkJcmV0LnBhcmVudE9iamVjdCA9IGxvb2t1cC5ub2RlOwoJCQkJCQlyZXQubmFtZSA9IFBBVEguYmFzZW5hbWUocGF0aCk7CgkJCQkJCWxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewoJCQkJCQkJZm9sbG93OiAhZG9udFJlc29sdmVMYXN0TGluawoJCQkJCQl9KTsKCQkJCQkJcmV0LmV4aXN0cyA9IHRydWU7CgkJCQkJCXJldC5wYXRoID0gbG9va3VwLnBhdGg7CgkJCQkJCXJldC5vYmplY3QgPSBsb29rdXAubm9kZTsKCQkJCQkJcmV0Lm5hbWUgPSBsb29rdXAubm9kZS5uYW1lOwoJCQkJCQlyZXQuaXNSb290ID0gbG9va3VwLnBhdGggPT09ICIvIgoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJcmV0LmVycm9yID0gZS5lcnJubwoJCQkJCX0KCQkJCQlyZXR1cm4gcmV0CgkJCQl9LAoJCQkJY3JlYXRlUGF0aDogKHBhcmVudCwgcGF0aCwgY2FuUmVhZCwgY2FuV3JpdGUpID0+IHsKCQkJCQlwYXJlbnQgPSB0eXBlb2YgcGFyZW50ID09ICJzdHJpbmciID8gcGFyZW50IDogRlMuZ2V0UGF0aChwYXJlbnQpOwoJCQkJCXZhciBwYXJ0cyA9IHBhdGguc3BsaXQoIi8iKS5yZXZlcnNlKCk7CgkJCQkJd2hpbGUgKHBhcnRzLmxlbmd0aCkgewoJCQkJCQl2YXIgcGFydCA9IHBhcnRzLnBvcCgpOwoJCQkJCQlpZiAoIXBhcnQpIGNvbnRpbnVlOwoJCQkJCQl2YXIgY3VycmVudCA9IFBBVEguam9pbjIocGFyZW50LCBwYXJ0KTsKCQkJCQkJdHJ5IHsKCQkJCQkJCUZTLm1rZGlyKGN1cnJlbnQpCgkJCQkJCX0gY2F0Y2ggKGUpIHt9CgkJCQkJCXBhcmVudCA9IGN1cnJlbnQKCQkJCQl9CgkJCQkJcmV0dXJuIGN1cnJlbnQKCQkJCX0sCgkJCQljcmVhdGVGaWxlOiAocGFyZW50LCBuYW1lLCBwcm9wZXJ0aWVzLCBjYW5SZWFkLCBjYW5Xcml0ZSkgPT4gewoJCQkJCXZhciBwYXRoID0gUEFUSC5qb2luMih0eXBlb2YgcGFyZW50ID09ICJzdHJpbmciID8gcGFyZW50IDogRlMuZ2V0UGF0aChwYXJlbnQpLCBuYW1lKTsKCQkJCQl2YXIgbW9kZSA9IEZTX2dldE1vZGUoY2FuUmVhZCwgY2FuV3JpdGUpOwoJCQkJCXJldHVybiBGUy5jcmVhdGUocGF0aCwgbW9kZSkKCQkJCX0sCgkJCQljcmVhdGVEYXRhRmlsZTogKHBhcmVudCwgbmFtZSwgZGF0YSwgY2FuUmVhZCwgY2FuV3JpdGUsIGNhbk93bikgPT4gewoJCQkJCXZhciBwYXRoID0gbmFtZTsKCQkJCQlpZiAocGFyZW50KSB7CgkJCQkJCXBhcmVudCA9IHR5cGVvZiBwYXJlbnQgPT0gInN0cmluZyIgPyBwYXJlbnQgOiBGUy5nZXRQYXRoKHBhcmVudCk7CgkJCQkJCXBhdGggPSBuYW1lID8gUEFUSC5qb2luMihwYXJlbnQsIG5hbWUpIDogcGFyZW50CgkJCQkJfQoJCQkJCXZhciBtb2RlID0gRlNfZ2V0TW9kZShjYW5SZWFkLCBjYW5Xcml0ZSk7CgkJCQkJdmFyIG5vZGUgPSBGUy5jcmVhdGUocGF0aCwgbW9kZSk7CgkJCQkJaWYgKGRhdGEpIHsKCQkJCQkJaWYgKHR5cGVvZiBkYXRhID09ICJzdHJpbmciKSB7CgkJCQkJCQl2YXIgYXJyID0gbmV3IEFycmF5KGRhdGEubGVuZ3RoKTsKCQkJCQkJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBkYXRhLmxlbmd0aDsgaSA8IGxlbjsgKytpKSBhcnJbaV0gPSBkYXRhLmNoYXJDb2RlQXQoaSk7CgkJCQkJCQlkYXRhID0gYXJyCgkJCQkJCX0KCQkJCQkJRlMuY2htb2Qobm9kZSwgbW9kZSB8IDE0Nik7CgkJCQkJCXZhciBzdHJlYW0gPSBGUy5vcGVuKG5vZGUsIDU3Nyk7CgkJCQkJCUZTLndyaXRlKHN0cmVhbSwgZGF0YSwgMCwgZGF0YS5sZW5ndGgsIDAsIGNhbk93bik7CgkJCQkJCUZTLmNsb3NlKHN0cmVhbSk7CgkJCQkJCUZTLmNobW9kKG5vZGUsIG1vZGUpCgkJCQkJfQoJCQkJCXJldHVybiBub2RlCgkJCQl9LAoJCQkJY3JlYXRlRGV2aWNlOiAocGFyZW50LCBuYW1lLCBpbnB1dCwgb3V0cHV0KSA9PiB7CgkJCQkJdmFyIHBhdGggPSBQQVRILmpvaW4yKHR5cGVvZiBwYXJlbnQgPT0gInN0cmluZyIgPyBwYXJlbnQgOiBGUy5nZXRQYXRoKHBhcmVudCksIG5hbWUpOwoJCQkJCXZhciBtb2RlID0gRlNfZ2V0TW9kZSghIWlucHV0LCAhIW91dHB1dCk7CgkJCQkJaWYgKCFGUy5jcmVhdGVEZXZpY2UubWFqb3IpIEZTLmNyZWF0ZURldmljZS5tYWpvciA9IDY0OwoJCQkJCXZhciBkZXYgPSBGUy5tYWtlZGV2KEZTLmNyZWF0ZURldmljZS5tYWpvcisrLCAwKTsKCQkJCQlGUy5yZWdpc3RlckRldmljZShkZXYsIHsKCQkJCQkJb3Blbjogc3RyZWFtID0+IHsKCQkJCQkJCXN0cmVhbS5zZWVrYWJsZSA9IGZhbHNlCgkJCQkJCX0sCgkJCQkJCWNsb3NlOiBzdHJlYW0gPT4gewoJCQkJCQkJaWYgKG91dHB1dCAmJiBvdXRwdXQuYnVmZmVyICYmIG91dHB1dC5idWZmZXIubGVuZ3RoKSB7CgkJCQkJCQkJb3V0cHV0KDEwKQoJCQkJCQkJfQoJCQkJCQl9LAoJCQkJCQlyZWFkOiAoc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3MpID0+IHsKCQkJCQkJCXZhciBieXRlc1JlYWQgPSAwOwoJCQkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJCQkJCQkJCXZhciByZXN1bHQ7CgkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJcmVzdWx0ID0gaW5wdXQoKQoJCQkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjkpCgkJCQkJCQkJfQoJCQkJCQkJCWlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCAmJiBieXRlc1JlYWQgPT09IDApIHsKCQkJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNikKCQkJCQkJCQl9CgkJCQkJCQkJaWYgKHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHVuZGVmaW5lZCkgYnJlYWs7CgkJCQkJCQkJYnl0ZXNSZWFkKys7CgkJCQkJCQkJYnVmZmVyW29mZnNldCArIGldID0gcmVzdWx0CgkJCQkJCQl9CgkJCQkJCQlpZiAoYnl0ZXNSZWFkKSB7CgkJCQkJCQkJc3RyZWFtLm5vZGUudGltZXN0YW1wID0gRGF0ZS5ub3coKQoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIGJ5dGVzUmVhZAoJCQkJCQl9LAoJCQkJCQl3cml0ZTogKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zKSA9PiB7CgkJCQkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJb3V0cHV0KGJ1ZmZlcltvZmZzZXQgKyBpXSkKCQkJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI5KQoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJCWlmIChsZW5ndGgpIHsKCQkJCQkJCQlzdHJlYW0ubm9kZS50aW1lc3RhbXAgPSBEYXRlLm5vdygpCgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gaQoJCQkJCQl9CgkJCQkJfSk7CgkJCQkJcmV0dXJuIEZTLm1rZGV2KHBhdGgsIG1vZGUsIGRldikKCQkJCX0sCgkJCQlmb3JjZUxvYWRGaWxlOiBvYmogPT4gewoJCQkJCWlmIChvYmouaXNEZXZpY2UgfHwgb2JqLmlzRm9sZGVyIHx8IG9iai5saW5rIHx8IG9iai5jb250ZW50cykgcmV0dXJuIHRydWU7CgkJCQkJaWYgKHR5cGVvZiBYTUxIdHRwUmVxdWVzdCAhPSAidW5kZWZpbmVkIikgewoJCQkJCQl0aHJvdyBuZXcgRXJyb3IoIkxhenkgbG9hZGluZyBzaG91bGQgaGF2ZSBiZWVuIHBlcmZvcm1lZCAoY29udGVudHMgc2V0KSBpbiBjcmVhdGVMYXp5RmlsZSwgYnV0IGl0IHdhcyBub3QuIExhenkgbG9hZGluZyBvbmx5IHdvcmtzIGluIHdlYiB3b3JrZXJzLiBVc2UgLS1lbWJlZC1maWxlIG9yIC0tcHJlbG9hZC1maWxlIGluIGVtY2Mgb24gdGhlIG1haW4gdGhyZWFkLiIpCgkJCQkJfSBlbHNlIGlmIChyZWFkXykgewoJCQkJCQl0cnkgewoJCQkJCQkJb2JqLmNvbnRlbnRzID0gaW50QXJyYXlGcm9tU3RyaW5nKHJlYWRfKG9iai51cmwpLCB0cnVlKTsKCQkJCQkJCW9iai51c2VkQnl0ZXMgPSBvYmouY29udGVudHMubGVuZ3RoCgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCXRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI5KQoJCQkJCQl9CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgbG9hZCB3aXRob3V0IHJlYWQoKSBvciBYTUxIdHRwUmVxdWVzdC4iKQoJCQkJCX0KCQkJCX0sCgkJCQljcmVhdGVMYXp5RmlsZTogKHBhcmVudCwgbmFtZSwgdXJsLCBjYW5SZWFkLCBjYW5Xcml0ZSkgPT4gewoJCQkJCWZ1bmN0aW9uIExhenlVaW50OEFycmF5KCkgewoJCQkJCQl0aGlzLmxlbmd0aEtub3duID0gZmFsc2U7CgkJCQkJCXRoaXMuY2h1bmtzID0gW10KCQkJCQl9CgkJCQkJTGF6eVVpbnQ4QXJyYXkucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIExhenlVaW50OEFycmF5X2dldChpZHgpIHsKCQkJCQkJaWYgKGlkeCA+IHRoaXMubGVuZ3RoIC0gMSB8fCBpZHggPCAwKSB7CgkJCQkJCQlyZXR1cm4gdW5kZWZpbmVkCgkJCQkJCX0KCQkJCQkJdmFyIGNodW5rT2Zmc2V0ID0gaWR4ICUgdGhpcy5jaHVua1NpemU7CgkJCQkJCXZhciBjaHVua051bSA9IGlkeCAvIHRoaXMuY2h1bmtTaXplIHwgMDsKCQkJCQkJcmV0dXJuIHRoaXMuZ2V0dGVyKGNodW5rTnVtKVtjaHVua09mZnNldF0KCQkJCQl9OwoJCQkJCUxhenlVaW50OEFycmF5LnByb3RvdHlwZS5zZXREYXRhR2V0dGVyID0gZnVuY3Rpb24gTGF6eVVpbnQ4QXJyYXlfc2V0RGF0YUdldHRlcihnZXR0ZXIpIHsKCQkJCQkJdGhpcy5nZXR0ZXIgPSBnZXR0ZXIKCQkJCQl9OwoJCQkJCUxhenlVaW50OEFycmF5LnByb3RvdHlwZS5jYWNoZUxlbmd0aCA9IGZ1bmN0aW9uIExhenlVaW50OEFycmF5X2NhY2hlTGVuZ3RoKCkgewoJCQkJCQl2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0OwoJCQkJCQl4aHIub3BlbigiSEVBRCIsIHVybCwgZmFsc2UpOwoJCQkJCQl4aHIuc2VuZChudWxsKTsKCQkJCQkJaWYgKCEoeGhyLnN0YXR1cyA+PSAyMDAgJiYgeGhyLnN0YXR1cyA8IDMwMCB8fCB4aHIuc3RhdHVzID09PSAzMDQpKSB0aHJvdyBuZXcgRXJyb3IoIkNvdWxkbid0IGxvYWQgIiArIHVybCArICIuIFN0YXR1czogIiArIHhoci5zdGF0dXMpOwoJCQkJCQl2YXIgZGF0YWxlbmd0aCA9IE51bWJlcih4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtbGVuZ3RoIikpOwoJCQkJCQl2YXIgaGVhZGVyOwoJCQkJCQl2YXIgaGFzQnl0ZVNlcnZpbmcgPSAoaGVhZGVyID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKCJBY2NlcHQtUmFuZ2VzIikpICYmIGhlYWRlciA9PT0gImJ5dGVzIjsKCQkJCQkJdmFyIHVzZXNHemlwID0gKGhlYWRlciA9IHhoci5nZXRSZXNwb25zZUhlYWRlcigiQ29udGVudC1FbmNvZGluZyIpKSAmJiBoZWFkZXIgPT09ICJnemlwIjsKCQkJCQkJdmFyIGNodW5rU2l6ZSA9IDEwMjQgKiAxMDI0OwoJCQkJCQlpZiAoIWhhc0J5dGVTZXJ2aW5nKSBjaHVua1NpemUgPSBkYXRhbGVuZ3RoOwoJCQkJCQl2YXIgZG9YSFIgPSAoZnJvbSwgdG8pID0+IHsKCQkJCQkJCWlmIChmcm9tID4gdG8pIHRocm93IG5ldyBFcnJvcigiaW52YWxpZCByYW5nZSAoIiArIGZyb20gKyAiLCAiICsgdG8gKyAiKSBvciBubyBieXRlcyByZXF1ZXN0ZWQhIik7CgkJCQkJCQlpZiAodG8gPiBkYXRhbGVuZ3RoIC0gMSkgdGhyb3cgbmV3IEVycm9yKCJvbmx5ICIgKyBkYXRhbGVuZ3RoICsgIiBieXRlcyBhdmFpbGFibGUhIHByb2dyYW1tZXIgZXJyb3IhIik7CgkJCQkJCQl2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0OwoJCQkJCQkJeGhyLm9wZW4oIkdFVCIsIHVybCwgZmFsc2UpOwoJCQkJCQkJaWYgKGRhdGFsZW5ndGggIT09IGNodW5rU2l6ZSkgeGhyLnNldFJlcXVlc3RIZWFkZXIoIlJhbmdlIiwgImJ5dGVzPSIgKyBmcm9tICsgIi0iICsgdG8pOwoJCQkJCQkJeGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CgkJCQkJCQlpZiAoeGhyLm92ZXJyaWRlTWltZVR5cGUpIHsKCQkJCQkJCQl4aHIub3ZlcnJpZGVNaW1lVHlwZSgidGV4dC9wbGFpbjsgY2hhcnNldD14LXVzZXItZGVmaW5lZCIpCgkJCQkJCQl9CgkJCQkJCQl4aHIuc2VuZChudWxsKTsKCQkJCQkJCWlmICghKHhoci5zdGF0dXMgPj0gMjAwICYmIHhoci5zdGF0dXMgPCAzMDAgfHwgeGhyLnN0YXR1cyA9PT0gMzA0KSkgdGhyb3cgbmV3IEVycm9yKCJDb3VsZG4ndCBsb2FkICIgKyB1cmwgKyAiLiBTdGF0dXM6ICIgKyB4aHIuc3RhdHVzKTsKCQkJCQkJCWlmICh4aHIucmVzcG9uc2UgIT09IHVuZGVmaW5lZCkgewoJCQkJCQkJCXJldHVybiBuZXcgVWludDhBcnJheSh4aHIucmVzcG9uc2UgfHwgW10pCgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gaW50QXJyYXlGcm9tU3RyaW5nKHhoci5yZXNwb25zZVRleHQgfHwgIiIsIHRydWUpCgkJCQkJCX07CgkJCQkJCXZhciBsYXp5QXJyYXkgPSB0aGlzOwoJCQkJCQlsYXp5QXJyYXkuc2V0RGF0YUdldHRlcihjaHVua051bSA9PiB7CgkJCQkJCQl2YXIgc3RhcnQgPSBjaHVua051bSAqIGNodW5rU2l6ZTsKCQkJCQkJCXZhciBlbmQgPSAoY2h1bmtOdW0gKyAxKSAqIGNodW5rU2l6ZSAtIDE7CgkJCQkJCQllbmQgPSBNYXRoLm1pbihlbmQsIGRhdGFsZW5ndGggLSAxKTsKCQkJCQkJCWlmICh0eXBlb2YgbGF6eUFycmF5LmNodW5rc1tjaHVua051bV0gPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJCQlsYXp5QXJyYXkuY2h1bmtzW2NodW5rTnVtXSA9IGRvWEhSKHN0YXJ0LCBlbmQpCgkJCQkJCQl9CgkJCQkJCQlpZiAodHlwZW9mIGxhenlBcnJheS5jaHVua3NbY2h1bmtOdW1dID09ICJ1bmRlZmluZWQiKSB0aHJvdyBuZXcgRXJyb3IoImRvWEhSIGZhaWxlZCEiKTsKCQkJCQkJCXJldHVybiBsYXp5QXJyYXkuY2h1bmtzW2NodW5rTnVtXQoJCQkJCQl9KTsKCQkJCQkJaWYgKHVzZXNHemlwIHx8ICFkYXRhbGVuZ3RoKSB7CgkJCQkJCQljaHVua1NpemUgPSBkYXRhbGVuZ3RoID0gMTsKCQkJCQkJCWRhdGFsZW5ndGggPSB0aGlzLmdldHRlcigwKS5sZW5ndGg7CgkJCQkJCQljaHVua1NpemUgPSBkYXRhbGVuZ3RoOwoJCQkJCQkJb3V0KCJMYXp5RmlsZXMgb24gZ3ppcCBmb3JjZXMgZG93bmxvYWQgb2YgdGhlIHdob2xlIGZpbGUgd2hlbiBsZW5ndGggaXMgYWNjZXNzZWQiKQoJCQkJCQl9CgkJCQkJCXRoaXMuX2xlbmd0aCA9IGRhdGFsZW5ndGg7CgkJCQkJCXRoaXMuX2NodW5rU2l6ZSA9IGNodW5rU2l6ZTsKCQkJCQkJdGhpcy5sZW5ndGhLbm93biA9IHRydWUKCQkJCQl9OwoJCQkJCWlmICh0eXBlb2YgWE1MSHR0cFJlcXVlc3QgIT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJaWYgKCFFTlZJUk9OTUVOVF9JU19XT1JLRVIpIHRocm93ICJDYW5ub3QgZG8gc3luY2hyb25vdXMgYmluYXJ5IFhIUnMgb3V0c2lkZSB3ZWJ3b3JrZXJzIGluIG1vZGVybiBicm93c2Vycy4gVXNlIC0tZW1iZWQtZmlsZSBvciAtLXByZWxvYWQtZmlsZSBpbiBlbWNjIjsKCQkJCQkJdmFyIGxhenlBcnJheSA9IG5ldyBMYXp5VWludDhBcnJheTsKCQkJCQkJT2JqZWN0LmRlZmluZVByb3BlcnRpZXMobGF6eUFycmF5LCB7CgkJCQkJCQlsZW5ndGg6IHsKCQkJCQkJCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCQkJCQlpZiAoIXRoaXMubGVuZ3RoS25vd24pIHsKCQkJCQkJCQkJCXRoaXMuY2FjaGVMZW5ndGgoKQoJCQkJCQkJCQl9CgkJCQkJCQkJCXJldHVybiB0aGlzLl9sZW5ndGgKCQkJCQkJCQl9CgkJCQkJCQl9LAoJCQkJCQkJY2h1bmtTaXplOiB7CgkJCQkJCQkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJCQkJCQkJaWYgKCF0aGlzLmxlbmd0aEtub3duKSB7CgkJCQkJCQkJCQl0aGlzLmNhY2hlTGVuZ3RoKCkKCQkJCQkJCQkJfQoJCQkJCQkJCQlyZXR1cm4gdGhpcy5fY2h1bmtTaXplCgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQkJdmFyIHByb3BlcnRpZXMgPSB7CgkJCQkJCQlpc0RldmljZTogZmFsc2UsCgkJCQkJCQljb250ZW50czogbGF6eUFycmF5CgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQl2YXIgcHJvcGVydGllcyA9IHsKCQkJCQkJCWlzRGV2aWNlOiBmYWxzZSwKCQkJCQkJCXVybDogdXJsCgkJCQkJCX0KCQkJCQl9CgkJCQkJdmFyIG5vZGUgPSBGUy5jcmVhdGVGaWxlKHBhcmVudCwgbmFtZSwgcHJvcGVydGllcywgY2FuUmVhZCwgY2FuV3JpdGUpOwoJCQkJCWlmIChwcm9wZXJ0aWVzLmNvbnRlbnRzKSB7CgkJCQkJCW5vZGUuY29udGVudHMgPSBwcm9wZXJ0aWVzLmNvbnRlbnRzCgkJCQkJfSBlbHNlIGlmIChwcm9wZXJ0aWVzLnVybCkgewoJCQkJCQlub2RlLmNvbnRlbnRzID0gbnVsbDsKCQkJCQkJbm9kZS51cmwgPSBwcm9wZXJ0aWVzLnVybAoJCQkJCX0KCQkJCQlPYmplY3QuZGVmaW5lUHJvcGVydGllcyhub2RlLCB7CgkJCQkJCXVzZWRCeXRlczogewoJCQkJCQkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJCQkJCQlyZXR1cm4gdGhpcy5jb250ZW50cy5sZW5ndGgKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0pOwoJCQkJCXZhciBzdHJlYW1fb3BzID0ge307CgkJCQkJdmFyIGtleXMgPSBPYmplY3Qua2V5cyhub2RlLnN0cmVhbV9vcHMpOwoJCQkJCWtleXMuZm9yRWFjaChrZXkgPT4gewoJCQkJCQl2YXIgZm4gPSBub2RlLnN0cmVhbV9vcHNba2V5XTsKCQkJCQkJc3RyZWFtX29wc1trZXldID0gZnVuY3Rpb24gZm9yY2VMb2FkTGF6eUZpbGUoKSB7CgkJCQkJCQlGUy5mb3JjZUxvYWRGaWxlKG5vZGUpOwoJCQkJCQkJcmV0dXJuIGZuLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJCQkJfQoJCQkJCX0pOwogIAoJCQkJCWZ1bmN0aW9uIHdyaXRlQ2h1bmtzKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zaXRpb24pIHsKCQkJCQkJdmFyIGNvbnRlbnRzID0gc3RyZWFtLm5vZGUuY29udGVudHM7CgkJCQkJCWlmIChwb3NpdGlvbiA+PSBjb250ZW50cy5sZW5ndGgpIHJldHVybiAwOwoJCQkJCQl2YXIgc2l6ZSA9IE1hdGgubWluKGNvbnRlbnRzLmxlbmd0aCAtIHBvc2l0aW9uLCBsZW5ndGgpOwoJCQkJCQlpZiAoY29udGVudHMuc2xpY2UpIHsKCQkJCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CgkJCQkJCQkJYnVmZmVyW29mZnNldCArIGldID0gY29udGVudHNbcG9zaXRpb24gKyBpXQoJCQkJCQkJfQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKCQkJCQkJCQlidWZmZXJbb2Zmc2V0ICsgaV0gPSBjb250ZW50cy5nZXQocG9zaXRpb24gKyBpKQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCXJldHVybiBzaXplCgkJCQkJfQoJCQkJCXN0cmVhbV9vcHMucmVhZCA9IChzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKSA9PiB7CgkJCQkJCUZTLmZvcmNlTG9hZEZpbGUobm9kZSk7CgkJCQkJCXJldHVybiB3cml0ZUNodW5rcyhzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKQoJCQkJCX07CgkJCQkJc3RyZWFtX29wcy5tbWFwID0gKHN0cmVhbSwgbGVuZ3RoLCBwb3NpdGlvbiwgcHJvdCwgZmxhZ3MpID0+IHsKCQkJCQkJRlMuZm9yY2VMb2FkRmlsZShub2RlKTsKCQkJCQkJdmFyIHB0ciA9IG1tYXBBbGxvYyhsZW5ndGgpOwoJCQkJCQlpZiAoIXB0cikgewoJCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDgpCgkJCQkJCX0KCQkJCQkJd3JpdGVDaHVua3Moc3RyZWFtLCBIRUFQOCwgcHRyLCBsZW5ndGgsIHBvc2l0aW9uKTsKCQkJCQkJcmV0dXJuIHsKCQkJCQkJCXB0cjogcHRyLAoJCQkJCQkJYWxsb2NhdGVkOiB0cnVlCgkJCQkJCX0KCQkJCQl9OwoJCQkJCW5vZGUuc3RyZWFtX29wcyA9IHN0cmVhbV9vcHM7CgkJCQkJcmV0dXJuIG5vZGUKCQkJCX0KCQkJfTsKICAKCQkJZnVuY3Rpb24gVVRGOFRvU3RyaW5nKHB0ciwgbWF4Qnl0ZXNUb1JlYWQpIHsKCQkJCXJldHVybiBwdHIgPyBVVEY4QXJyYXlUb1N0cmluZyhIRUFQVTgsIHB0ciwgbWF4Qnl0ZXNUb1JlYWQpIDogIiIKCQkJfQoJCQl2YXIgU1lTQ0FMTFMgPSB7CgkJCQlERUZBVUxUX1BPTExNQVNLOiA1LAoJCQkJY2FsY3VsYXRlQXQ6IGZ1bmN0aW9uKGRpcmZkLCBwYXRoLCBhbGxvd0VtcHR5KSB7CgkJCQkJaWYgKFBBVEguaXNBYnMocGF0aCkpIHsKCQkJCQkJcmV0dXJuIHBhdGgKCQkJCQl9CgkJCQkJdmFyIGRpcjsKCQkJCQlpZiAoZGlyZmQgPT09IC0xMDApIHsKCQkJCQkJZGlyID0gRlMuY3dkKCkKCQkJCQl9IGVsc2UgewoJCQkJCQl2YXIgZGlyc3RyZWFtID0gU1lTQ0FMTFMuZ2V0U3RyZWFtRnJvbUZEKGRpcmZkKTsKCQkJCQkJZGlyID0gZGlyc3RyZWFtLnBhdGgKCQkJCQl9CgkJCQkJaWYgKHBhdGgubGVuZ3RoID09IDApIHsKCQkJCQkJaWYgKCFhbGxvd0VtcHR5KSB7CgkJCQkJCQl0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig0NCkKCQkJCQkJfQoJCQkJCQlyZXR1cm4gZGlyCgkJCQkJfQoJCQkJCXJldHVybiBQQVRILmpvaW4yKGRpciwgcGF0aCkKCQkJCX0sCgkJCQlkb1N0YXQ6IGZ1bmN0aW9uKGZ1bmMsIHBhdGgsIGJ1ZikgewoJCQkJCXRyeSB7CgkJCQkJCXZhciBzdGF0ID0gZnVuYyhwYXRoKQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJaWYgKGUgJiYgZS5ub2RlICYmIFBBVEgubm9ybWFsaXplKHBhdGgpICE9PSBQQVRILm5vcm1hbGl6ZShGUy5nZXRQYXRoKGUubm9kZSkpKSB7CgkJCQkJCQlyZXR1cm4gLTU0CgkJCQkJCX0KCQkJCQkJdGhyb3cgZQoJCQkJCX0KCQkJCQlIRUFQMzJbYnVmID4+IDJdID0gc3RhdC5kZXY7CgkJCQkJSEVBUDMyW2J1ZiArIDggPj4gMl0gPSBzdGF0LmlubzsKCQkJCQlIRUFQMzJbYnVmICsgMTIgPj4gMl0gPSBzdGF0Lm1vZGU7CgkJCQkJSEVBUFUzMltidWYgKyAxNiA+PiAyXSA9IHN0YXQubmxpbms7CgkJCQkJSEVBUDMyW2J1ZiArIDIwID4+IDJdID0gc3RhdC51aWQ7CgkJCQkJSEVBUDMyW2J1ZiArIDI0ID4+IDJdID0gc3RhdC5naWQ7CgkJCQkJSEVBUDMyW2J1ZiArIDI4ID4+IDJdID0gc3RhdC5yZGV2OwoJCQkJCXRlbXBJNjQgPSBbc3RhdC5zaXplID4+PiAwLCAodGVtcERvdWJsZSA9IHN0YXQuc2l6ZSwgK01hdGguYWJzKHRlbXBEb3VibGUpID49IDEgPyB0ZW1wRG91YmxlID4gMCA/ICtNYXRoLmZsb29yKHRlbXBEb3VibGUgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IH5+K01hdGguY2VpbCgodGVtcERvdWJsZSAtICsofn50ZW1wRG91YmxlID4+PiAwKSkgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IDApXSwgSEVBUDMyW2J1ZiArIDQwID4+IDJdID0gdGVtcEk2NFswXSwgSEVBUDMyW2J1ZiArIDQ0ID4+IDJdID0gdGVtcEk2NFsxXTsKCQkJCQlIRUFQMzJbYnVmICsgNDggPj4gMl0gPSA0MDk2OwoJCQkJCUhFQVAzMltidWYgKyA1MiA+PiAyXSA9IHN0YXQuYmxvY2tzOwoJCQkJCXZhciBhdGltZSA9IHN0YXQuYXRpbWUuZ2V0VGltZSgpOwoJCQkJCXZhciBtdGltZSA9IHN0YXQubXRpbWUuZ2V0VGltZSgpOwoJCQkJCXZhciBjdGltZSA9IHN0YXQuY3RpbWUuZ2V0VGltZSgpOwoJCQkJCXRlbXBJNjQgPSBbTWF0aC5mbG9vcihhdGltZSAvIDFlMykgPj4+IDAsICh0ZW1wRG91YmxlID0gTWF0aC5mbG9vcihhdGltZSAvIDFlMyksICtNYXRoLmFicyh0ZW1wRG91YmxlKSA+PSAxID8gdGVtcERvdWJsZSA+IDAgPyArTWF0aC5mbG9vcih0ZW1wRG91YmxlIC8gNDI5NDk2NzI5NikgPj4+IDAgOiB+fitNYXRoLmNlaWwoKHRlbXBEb3VibGUgLSArKH5+dGVtcERvdWJsZSA+Pj4gMCkpIC8gNDI5NDk2NzI5NikgPj4+IDAgOiAwKV0sIEhFQVAzMltidWYgKyA1NiA+PiAyXSA9IHRlbXBJNjRbMF0sIEhFQVAzMltidWYgKyA2MCA+PiAyXSA9IHRlbXBJNjRbMV07CgkJCQkJSEVBUFUzMltidWYgKyA2NCA+PiAyXSA9IGF0aW1lICUgMWUzICogMWUzOwoJCQkJCXRlbXBJNjQgPSBbTWF0aC5mbG9vcihtdGltZSAvIDFlMykgPj4+IDAsICh0ZW1wRG91YmxlID0gTWF0aC5mbG9vcihtdGltZSAvIDFlMyksICtNYXRoLmFicyh0ZW1wRG91YmxlKSA+PSAxID8gdGVtcERvdWJsZSA+IDAgPyArTWF0aC5mbG9vcih0ZW1wRG91YmxlIC8gNDI5NDk2NzI5NikgPj4+IDAgOiB+fitNYXRoLmNlaWwoKHRlbXBEb3VibGUgLSArKH5+dGVtcERvdWJsZSA+Pj4gMCkpIC8gNDI5NDk2NzI5NikgPj4+IDAgOiAwKV0sIEhFQVAzMltidWYgKyA3MiA+PiAyXSA9IHRlbXBJNjRbMF0sIEhFQVAzMltidWYgKyA3NiA+PiAyXSA9IHRlbXBJNjRbMV07CgkJCQkJSEVBUFUzMltidWYgKyA4MCA+PiAyXSA9IG10aW1lICUgMWUzICogMWUzOwoJCQkJCXRlbXBJNjQgPSBbTWF0aC5mbG9vcihjdGltZSAvIDFlMykgPj4+IDAsICh0ZW1wRG91YmxlID0gTWF0aC5mbG9vcihjdGltZSAvIDFlMyksICtNYXRoLmFicyh0ZW1wRG91YmxlKSA+PSAxID8gdGVtcERvdWJsZSA+IDAgPyArTWF0aC5mbG9vcih0ZW1wRG91YmxlIC8gNDI5NDk2NzI5NikgPj4+IDAgOiB+fitNYXRoLmNlaWwoKHRlbXBEb3VibGUgLSArKH5+dGVtcERvdWJsZSA+Pj4gMCkpIC8gNDI5NDk2NzI5NikgPj4+IDAgOiAwKV0sIEhFQVAzMltidWYgKyA4OCA+PiAyXSA9IHRlbXBJNjRbMF0sIEhFQVAzMltidWYgKyA5MiA+PiAyXSA9IHRlbXBJNjRbMV07CgkJCQkJSEVBUFUzMltidWYgKyA5NiA+PiAyXSA9IGN0aW1lICUgMWUzICogMWUzOwoJCQkJCXRlbXBJNjQgPSBbc3RhdC5pbm8gPj4+IDAsICh0ZW1wRG91YmxlID0gc3RhdC5pbm8sICtNYXRoLmFicyh0ZW1wRG91YmxlKSA+PSAxID8gdGVtcERvdWJsZSA+IDAgPyArTWF0aC5mbG9vcih0ZW1wRG91YmxlIC8gNDI5NDk2NzI5NikgPj4+IDAgOiB+fitNYXRoLmNlaWwoKHRlbXBEb3VibGUgLSArKH5+dGVtcERvdWJsZSA+Pj4gMCkpIC8gNDI5NDk2NzI5NikgPj4+IDAgOiAwKV0sIEhFQVAzMltidWYgKyAxMDQgPj4gMl0gPSB0ZW1wSTY0WzBdLCBIRUFQMzJbYnVmICsgMTA4ID4+IDJdID0gdGVtcEk2NFsxXTsKCQkJCQlyZXR1cm4gMAoJCQkJfSwKCQkJCWRvTXN5bmM6IGZ1bmN0aW9uKGFkZHIsIHN0cmVhbSwgbGVuLCBmbGFncywgb2Zmc2V0KSB7CgkJCQkJaWYgKCFGUy5pc0ZpbGUoc3RyZWFtLm5vZGUubW9kZSkpIHsKCQkJCQkJdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDMpCgkJCQkJfQoJCQkJCWlmIChmbGFncyAmIDIpIHsKCQkJCQkJcmV0dXJuIDAKCQkJCQl9CgkJCQkJdmFyIGJ1ZmZlciA9IEhFQVBVOC5zbGljZShhZGRyLCBhZGRyICsgbGVuKTsKCQkJCQlGUy5tc3luYyhzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW4sIGZsYWdzKQoJCQkJfSwKCQkJCXZhcmFyZ3M6IHVuZGVmaW5lZCwKCQkJCWdldDogZnVuY3Rpb24oKSB7CgkJCQkJU1lTQ0FMTFMudmFyYXJncyArPSA0OwoJCQkJCXZhciByZXQgPSBIRUFQMzJbU1lTQ0FMTFMudmFyYXJncyAtIDQgPj4gMl07CgkJCQkJcmV0dXJuIHJldAoJCQkJfSwKCQkJCWdldFN0cjogZnVuY3Rpb24ocHRyKSB7CgkJCQkJdmFyIHJldCA9IFVURjhUb1N0cmluZyhwdHIpOwoJCQkJCXJldHVybiByZXQKCQkJCX0sCgkJCQlnZXRTdHJlYW1Gcm9tRkQ6IGZ1bmN0aW9uKGZkKSB7CgkJCQkJdmFyIHN0cmVhbSA9IEZTLmdldFN0cmVhbShmZCk7CgkJCQkJaWYgKCFzdHJlYW0pIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpOwoJCQkJCXJldHVybiBzdHJlYW0KCQkJCX0KCQkJfTsKICAKCQkJZnVuY3Rpb24gX19fc3lzY2FsbF9fbmV3c2VsZWN0KG5mZHMsIHJlYWRmZHMsIHdyaXRlZmRzLCBleGNlcHRmZHMsIHRpbWVvdXQpIHsKCQkJCXRyeSB7CgkJCQkJdmFyIHRvdGFsID0gMDsKCQkJCQl2YXIgc3JjUmVhZExvdyA9IHJlYWRmZHMgPyBIRUFQMzJbcmVhZGZkcyA+PiAyXSA6IDAsCgkJCQkJCXNyY1JlYWRIaWdoID0gcmVhZGZkcyA/IEhFQVAzMltyZWFkZmRzICsgNCA+PiAyXSA6IDA7CgkJCQkJdmFyIHNyY1dyaXRlTG93ID0gd3JpdGVmZHMgPyBIRUFQMzJbd3JpdGVmZHMgPj4gMl0gOiAwLAoJCQkJCQlzcmNXcml0ZUhpZ2ggPSB3cml0ZWZkcyA/IEhFQVAzMlt3cml0ZWZkcyArIDQgPj4gMl0gOiAwOwoJCQkJCXZhciBzcmNFeGNlcHRMb3cgPSBleGNlcHRmZHMgPyBIRUFQMzJbZXhjZXB0ZmRzID4+IDJdIDogMCwKCQkJCQkJc3JjRXhjZXB0SGlnaCA9IGV4Y2VwdGZkcyA/IEhFQVAzMltleGNlcHRmZHMgKyA0ID4+IDJdIDogMDsKCQkJCQl2YXIgZHN0UmVhZExvdyA9IDAsCgkJCQkJCWRzdFJlYWRIaWdoID0gMDsKCQkJCQl2YXIgZHN0V3JpdGVMb3cgPSAwLAoJCQkJCQlkc3RXcml0ZUhpZ2ggPSAwOwoJCQkJCXZhciBkc3RFeGNlcHRMb3cgPSAwLAoJCQkJCQlkc3RFeGNlcHRIaWdoID0gMDsKCQkJCQl2YXIgYWxsTG93ID0gKHJlYWRmZHMgPyBIRUFQMzJbcmVhZGZkcyA+PiAyXSA6IDApIHwgKHdyaXRlZmRzID8gSEVBUDMyW3dyaXRlZmRzID4+IDJdIDogMCkgfCAoZXhjZXB0ZmRzID8gSEVBUDMyW2V4Y2VwdGZkcyA+PiAyXSA6IDApOwoJCQkJCXZhciBhbGxIaWdoID0gKHJlYWRmZHMgPyBIRUFQMzJbcmVhZGZkcyArIDQgPj4gMl0gOiAwKSB8ICh3cml0ZWZkcyA/IEhFQVAzMlt3cml0ZWZkcyArIDQgPj4gMl0gOiAwKSB8IChleGNlcHRmZHMgPyBIRUFQMzJbZXhjZXB0ZmRzICsgNCA+PiAyXSA6IDApOwoJCQkJCXZhciBjaGVjayA9IGZ1bmN0aW9uKGZkLCBsb3csIGhpZ2gsIHZhbCkgewoJCQkJCQlyZXR1cm4gZmQgPCAzMiA/IGxvdyAmIHZhbCA6IGhpZ2ggJiB2YWwKCQkJCQl9OwoJCQkJCWZvciAodmFyIGZkID0gMDsgZmQgPCBuZmRzOyBmZCsrKSB7CgkJCQkJCXZhciBtYXNrID0gMSA8PCBmZCAlIDMyOwoJCQkJCQlpZiAoIWNoZWNrKGZkLCBhbGxMb3csIGFsbEhpZ2gsIG1hc2spKSB7CgkJCQkJCQljb250aW51ZQoJCQkJCQl9CgkJCQkJCXZhciBzdHJlYW0gPSBTWVNDQUxMUy5nZXRTdHJlYW1Gcm9tRkQoZmQpOwoJCQkJCQl2YXIgZmxhZ3MgPSBTWVNDQUxMUy5ERUZBVUxUX1BPTExNQVNLOwoJCQkJCQlpZiAoc3RyZWFtLnN0cmVhbV9vcHMucG9sbCkgewoJCQkJCQkJZmxhZ3MgPSBzdHJlYW0uc3RyZWFtX29wcy5wb2xsKHN0cmVhbSkKCQkJCQkJfQoJCQkJCQlpZiAoZmxhZ3MgJiAxICYmIGNoZWNrKGZkLCBzcmNSZWFkTG93LCBzcmNSZWFkSGlnaCwgbWFzaykpIHsKCQkJCQkJCWZkIDwgMzIgPyBkc3RSZWFkTG93ID0gZHN0UmVhZExvdyB8IG1hc2sgOiBkc3RSZWFkSGlnaCA9IGRzdFJlYWRIaWdoIHwgbWFzazsKCQkJCQkJCXRvdGFsKysKCQkJCQkJfQoJCQkJCQlpZiAoZmxhZ3MgJiA0ICYmIGNoZWNrKGZkLCBzcmNXcml0ZUxvdywgc3JjV3JpdGVIaWdoLCBtYXNrKSkgewoJCQkJCQkJZmQgPCAzMiA/IGRzdFdyaXRlTG93ID0gZHN0V3JpdGVMb3cgfCBtYXNrIDogZHN0V3JpdGVIaWdoID0gZHN0V3JpdGVIaWdoIHwgbWFzazsKCQkJCQkJCXRvdGFsKysKCQkJCQkJfQoJCQkJCQlpZiAoZmxhZ3MgJiAyICYmIGNoZWNrKGZkLCBzcmNFeGNlcHRMb3csIHNyY0V4Y2VwdEhpZ2gsIG1hc2spKSB7CgkJCQkJCQlmZCA8IDMyID8gZHN0RXhjZXB0TG93ID0gZHN0RXhjZXB0TG93IHwgbWFzayA6IGRzdEV4Y2VwdEhpZ2ggPSBkc3RFeGNlcHRIaWdoIHwgbWFzazsKCQkJCQkJCXRvdGFsKysKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAocmVhZGZkcykgewoJCQkJCQlIRUFQMzJbcmVhZGZkcyA+PiAyXSA9IGRzdFJlYWRMb3c7CgkJCQkJCUhFQVAzMltyZWFkZmRzICsgNCA+PiAyXSA9IGRzdFJlYWRIaWdoCgkJCQkJfQoJCQkJCWlmICh3cml0ZWZkcykgewoJCQkJCQlIRUFQMzJbd3JpdGVmZHMgPj4gMl0gPSBkc3RXcml0ZUxvdzsKCQkJCQkJSEVBUDMyW3dyaXRlZmRzICsgNCA+PiAyXSA9IGRzdFdyaXRlSGlnaAoJCQkJCX0KCQkJCQlpZiAoZXhjZXB0ZmRzKSB7CgkJCQkJCUhFQVAzMltleGNlcHRmZHMgPj4gMl0gPSBkc3RFeGNlcHRMb3c7CgkJCQkJCUhFQVAzMltleGNlcHRmZHMgKyA0ID4+IDJdID0gZHN0RXhjZXB0SGlnaAoJCQkJCX0KCQkJCQlyZXR1cm4gdG90YWwKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwoJCQkJCXJldHVybiAtZS5lcnJubwoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIF9fX3N5c2NhbGxfZmFjY2Vzc2F0KGRpcmZkLCBwYXRoLCBhbW9kZSwgZmxhZ3MpIHsKCQkJCXRyeSB7CgkJCQkJcGF0aCA9IFNZU0NBTExTLmdldFN0cihwYXRoKTsKCQkJCQlwYXRoID0gU1lTQ0FMTFMuY2FsY3VsYXRlQXQoZGlyZmQsIHBhdGgpOwoJCQkJCWlmIChhbW9kZSAmIH43KSB7CgkJCQkJCXJldHVybiAtMjgKCQkJCQl9CgkJCQkJdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewoJCQkJCQlmb2xsb3c6IHRydWUKCQkJCQl9KTsKCQkJCQl2YXIgbm9kZSA9IGxvb2t1cC5ub2RlOwoJCQkJCWlmICghbm9kZSkgewoJCQkJCQlyZXR1cm4gLTQ0CgkJCQkJfQoJCQkJCXZhciBwZXJtcyA9ICIiOwoJCQkJCWlmIChhbW9kZSAmIDQpIHBlcm1zICs9ICJyIjsKCQkJCQlpZiAoYW1vZGUgJiAyKSBwZXJtcyArPSAidyI7CgkJCQkJaWYgKGFtb2RlICYgMSkgcGVybXMgKz0gIngiOwoJCQkJCWlmIChwZXJtcyAmJiBGUy5ub2RlUGVybWlzc2lvbnMobm9kZSwgcGVybXMpKSB7CgkJCQkJCXJldHVybiAtMgoJCQkJCX0KCQkJCQlyZXR1cm4gMAoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCWlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CgkJCQkJcmV0dXJuIC1lLmVycm5vCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gc2V0RXJyTm8odmFsdWUpIHsKCQkJCUhFQVAzMltfX19lcnJub19sb2NhdGlvbigpID4+IDJdID0gdmFsdWU7CgkJCQlyZXR1cm4gdmFsdWUKCQkJfQogIAoJCQlmdW5jdGlvbiBfX19zeXNjYWxsX2ZjbnRsNjQoZmQsIGNtZCwgdmFyYXJncykgewoJCQkJU1lTQ0FMTFMudmFyYXJncyA9IHZhcmFyZ3M7CgkJCQl0cnkgewoJCQkJCXZhciBzdHJlYW0gPSBTWVNDQUxMUy5nZXRTdHJlYW1Gcm9tRkQoZmQpOwoJCQkJCXN3aXRjaCAoY21kKSB7CgkJCQkJCWNhc2UgMDogewoJCQkJCQkJdmFyIGFyZyA9IFNZU0NBTExTLmdldCgpOwoJCQkJCQkJaWYgKGFyZyA8IDApIHsKCQkJCQkJCQlyZXR1cm4gLTI4CgkJCQkJCQl9CgkJCQkJCQl2YXIgbmV3U3RyZWFtOwoJCQkJCQkJbmV3U3RyZWFtID0gRlMuY3JlYXRlU3RyZWFtKHN0cmVhbSwgYXJnKTsKCQkJCQkJCXJldHVybiBuZXdTdHJlYW0uZmQKCQkJCQkJfQoJCQkJCQljYXNlIDE6CgkJCQkJCWNhc2UgMjoKCQkJCQkJCXJldHVybiAwOwoJCQkJCQljYXNlIDM6CgkJCQkJCQlyZXR1cm4gc3RyZWFtLmZsYWdzOwoJCQkJCQljYXNlIDQ6IHsKCQkJCQkJCXZhciBhcmcgPSBTWVNDQUxMUy5nZXQoKTsKCQkJCQkJCXN0cmVhbS5mbGFncyB8PSBhcmc7CgkJCQkJCQlyZXR1cm4gMAoJCQkJCQl9CgkJCQkJCWNhc2UgNTogewoJCQkJCQkJdmFyIGFyZyA9IFNZU0NBTExTLmdldCgpOwoJCQkJCQkJdmFyIG9mZnNldCA9IDA7CgkJCQkJCQlIRUFQMTZbYXJnICsgb2Zmc2V0ID4+IDFdID0gMjsKCQkJCQkJCXJldHVybiAwCgkJCQkJCX0KCQkJCQkJY2FzZSA2OgoJCQkJCQljYXNlIDc6CgkJCQkJCQlyZXR1cm4gMDsKCQkJCQkJY2FzZSAxNjoKCQkJCQkJY2FzZSA4OgoJCQkJCQkJcmV0dXJuIC0yODsKCQkJCQkJY2FzZSA5OgoJCQkJCQkJc2V0RXJyTm8oMjgpOwoJCQkJCQkJcmV0dXJuIC0xOwoJCQkJCQlkZWZhdWx0OiB7CgkJCQkJCQlyZXR1cm4gLTI4CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKCQkJCQlyZXR1cm4gLWUuZXJybm8KCQkJCX0KCQkJfQogIAoJCQlmdW5jdGlvbiBfX19zeXNjYWxsX2ZzdGF0NjQoZmQsIGJ1ZikgewoJCQkJdHJ5IHsKCQkJCQl2YXIgc3RyZWFtID0gU1lTQ0FMTFMuZ2V0U3RyZWFtRnJvbUZEKGZkKTsKCQkJCQlyZXR1cm4gU1lTQ0FMTFMuZG9TdGF0KEZTLnN0YXQsIHN0cmVhbS5wYXRoLCBidWYpCgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKCQkJCQlyZXR1cm4gLWUuZXJybm8KCQkJCX0KCQkJfQogIAoJCQlmdW5jdGlvbiBzdHJpbmdUb1VURjgoc3RyLCBvdXRQdHIsIG1heEJ5dGVzVG9Xcml0ZSkgewoJCQkJcmV0dXJuIHN0cmluZ1RvVVRGOEFycmF5KHN0ciwgSEVBUFU4LCBvdXRQdHIsIG1heEJ5dGVzVG9Xcml0ZSkKCQkJfQogIAoJCQlmdW5jdGlvbiBfX19zeXNjYWxsX2dldGRlbnRzNjQoZmQsIGRpcnAsIGNvdW50KSB7CgkJCQl0cnkgewoJCQkJCXZhciBzdHJlYW0gPSBTWVNDQUxMUy5nZXRTdHJlYW1Gcm9tRkQoZmQpOwoJCQkJCWlmICghc3RyZWFtLmdldGRlbnRzKSB7CgkJCQkJCXN0cmVhbS5nZXRkZW50cyA9IEZTLnJlYWRkaXIoc3RyZWFtLnBhdGgpCgkJCQkJfQoJCQkJCXZhciBzdHJ1Y3Rfc2l6ZSA9IDI4MDsKCQkJCQl2YXIgcG9zID0gMDsKCQkJCQl2YXIgb2ZmID0gRlMubGxzZWVrKHN0cmVhbSwgMCwgMSk7CgkJCQkJdmFyIGlkeCA9IE1hdGguZmxvb3Iob2ZmIC8gc3RydWN0X3NpemUpOwoJCQkJCXdoaWxlIChpZHggPCBzdHJlYW0uZ2V0ZGVudHMubGVuZ3RoICYmIHBvcyArIHN0cnVjdF9zaXplIDw9IGNvdW50KSB7CgkJCQkJCXZhciBpZDsKCQkJCQkJdmFyIHR5cGU7CgkJCQkJCXZhciBuYW1lID0gc3RyZWFtLmdldGRlbnRzW2lkeF07CgkJCQkJCWlmIChuYW1lID09PSAiLiIpIHsKCQkJCQkJCWlkID0gc3RyZWFtLm5vZGUuaWQ7CgkJCQkJCQl0eXBlID0gNAoJCQkJCQl9IGVsc2UgaWYgKG5hbWUgPT09ICIuLiIpIHsKCQkJCQkJCXZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHN0cmVhbS5wYXRoLCB7CgkJCQkJCQkJcGFyZW50OiB0cnVlCgkJCQkJCQl9KTsKCQkJCQkJCWlkID0gbG9va3VwLm5vZGUuaWQ7CgkJCQkJCQl0eXBlID0gNAoJCQkJCQl9IGVsc2UgewoJCQkJCQkJdmFyIGNoaWxkID0gRlMubG9va3VwTm9kZShzdHJlYW0ubm9kZSwgbmFtZSk7CgkJCQkJCQlpZCA9IGNoaWxkLmlkOwoJCQkJCQkJdHlwZSA9IEZTLmlzQ2hyZGV2KGNoaWxkLm1vZGUpID8gMiA6IEZTLmlzRGlyKGNoaWxkLm1vZGUpID8gNCA6IEZTLmlzTGluayhjaGlsZC5tb2RlKSA/IDEwIDogOAoJCQkJCQl9CgkJCQkJCXRlbXBJNjQgPSBbaWQgPj4+IDAsICh0ZW1wRG91YmxlID0gaWQsICtNYXRoLmFicyh0ZW1wRG91YmxlKSA+PSAxID8gdGVtcERvdWJsZSA+IDAgPyArTWF0aC5mbG9vcih0ZW1wRG91YmxlIC8gNDI5NDk2NzI5NikgPj4+IDAgOiB+fitNYXRoLmNlaWwoKHRlbXBEb3VibGUgLSArKH5+dGVtcERvdWJsZSA+Pj4gMCkpIC8gNDI5NDk2NzI5NikgPj4+IDAgOiAwKV0sIEhFQVAzMltkaXJwICsgcG9zID4+IDJdID0gdGVtcEk2NFswXSwgSEVBUDMyW2RpcnAgKyBwb3MgKyA0ID4+IDJdID0gdGVtcEk2NFsxXTsKCQkJCQkJdGVtcEk2NCA9IFsoaWR4ICsgMSkgKiBzdHJ1Y3Rfc2l6ZSA+Pj4gMCwgKHRlbXBEb3VibGUgPSAoaWR4ICsgMSkgKiBzdHJ1Y3Rfc2l6ZSwgK01hdGguYWJzKHRlbXBEb3VibGUpID49IDEgPyB0ZW1wRG91YmxlID4gMCA/ICtNYXRoLmZsb29yKHRlbXBEb3VibGUgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IH5+K01hdGguY2VpbCgodGVtcERvdWJsZSAtICsofn50ZW1wRG91YmxlID4+PiAwKSkgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IDApXSwgSEVBUDMyW2RpcnAgKyBwb3MgKyA4ID4+IDJdID0gdGVtcEk2NFswXSwgSEVBUDMyW2RpcnAgKyBwb3MgKyAxMiA+PiAyXSA9IHRlbXBJNjRbMV07CgkJCQkJCUhFQVAxNltkaXJwICsgcG9zICsgMTYgPj4gMV0gPSAyODA7CgkJCQkJCUhFQVA4W2RpcnAgKyBwb3MgKyAxOCA+PiAwXSA9IHR5cGU7CgkJCQkJCXN0cmluZ1RvVVRGOChuYW1lLCBkaXJwICsgcG9zICsgMTksIDI1Nik7CgkJCQkJCXBvcyArPSBzdHJ1Y3Rfc2l6ZTsKCQkJCQkJaWR4ICs9IDEKCQkJCQl9CgkJCQkJRlMubGxzZWVrKHN0cmVhbSwgaWR4ICogc3RydWN0X3NpemUsIDApOwoJCQkJCXJldHVybiBwb3MKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwoJCQkJCXJldHVybiAtZS5lcnJubwoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIF9fX3N5c2NhbGxfaW9jdGwoZmQsIG9wLCB2YXJhcmdzKSB7CgkJCQlTWVNDQUxMUy52YXJhcmdzID0gdmFyYXJnczsKCQkJCXRyeSB7CgkJCQkJdmFyIHN0cmVhbSA9IFNZU0NBTExTLmdldFN0cmVhbUZyb21GRChmZCk7CgkJCQkJc3dpdGNoIChvcCkgewoJCQkJCQljYXNlIDIxNTA5OgoJCQkJCQljYXNlIDIxNTA1OiB7CgkJCQkJCQlpZiAoIXN0cmVhbS50dHkpIHJldHVybiAtNTk7CgkJCQkJCQlyZXR1cm4gMAoJCQkJCQl9CgkJCQkJCWNhc2UgMjE1MTA6CgkJCQkJCWNhc2UgMjE1MTE6CgkJCQkJCWNhc2UgMjE1MTI6CgkJCQkJCWNhc2UgMjE1MDY6CgkJCQkJCWNhc2UgMjE1MDc6CgkJCQkJCWNhc2UgMjE1MDg6IHsKCQkJCQkJCWlmICghc3RyZWFtLnR0eSkgcmV0dXJuIC01OTsKCQkJCQkJCXJldHVybiAwCgkJCQkJCX0KCQkJCQkJY2FzZSAyMTUxOTogewoJCQkJCQkJaWYgKCFzdHJlYW0udHR5KSByZXR1cm4gLTU5OwoJCQkJCQkJdmFyIGFyZ3AgPSBTWVNDQUxMUy5nZXQoKTsKCQkJCQkJCUhFQVAzMlthcmdwID4+IDJdID0gMDsKCQkJCQkJCXJldHVybiAwCgkJCQkJCX0KCQkJCQkJY2FzZSAyMTUyMDogewoJCQkJCQkJaWYgKCFzdHJlYW0udHR5KSByZXR1cm4gLTU5OwoJCQkJCQkJcmV0dXJuIC0yOAoJCQkJCQl9CgkJCQkJCWNhc2UgMjE1MzE6IHsKCQkJCQkJCXZhciBhcmdwID0gU1lTQ0FMTFMuZ2V0KCk7CgkJCQkJCQlyZXR1cm4gRlMuaW9jdGwoc3RyZWFtLCBvcCwgYXJncCkKCQkJCQkJfQoJCQkJCQljYXNlIDIxNTIzOiB7CgkJCQkJCQlpZiAoIXN0cmVhbS50dHkpIHJldHVybiAtNTk7CgkJCQkJCQlyZXR1cm4gMAoJCQkJCQl9CgkJCQkJCWNhc2UgMjE1MjQ6IHsKCQkJCQkJCWlmICghc3RyZWFtLnR0eSkgcmV0dXJuIC01OTsKCQkJCQkJCXJldHVybiAwCgkJCQkJCX0KCQkJCQkJZGVmYXVsdDoKCQkJCQkJCXJldHVybiAtMjgKCQkJCQl9CgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKCQkJCQlyZXR1cm4gLWUuZXJybm8KCQkJCX0KCQkJfQogIAoJCQlmdW5jdGlvbiBfX19zeXNjYWxsX2xzdGF0NjQocGF0aCwgYnVmKSB7CgkJCQl0cnkgewoJCQkJCXBhdGggPSBTWVNDQUxMUy5nZXRTdHIocGF0aCk7CgkJCQkJcmV0dXJuIFNZU0NBTExTLmRvU3RhdChGUy5sc3RhdCwgcGF0aCwgYnVmKQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCWlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CgkJCQkJcmV0dXJuIC1lLmVycm5vCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gX19fc3lzY2FsbF9uZXdmc3RhdGF0KGRpcmZkLCBwYXRoLCBidWYsIGZsYWdzKSB7CgkJCQl0cnkgewoJCQkJCXBhdGggPSBTWVNDQUxMUy5nZXRTdHIocGF0aCk7CgkJCQkJdmFyIG5vZm9sbG93ID0gZmxhZ3MgJiAyNTY7CgkJCQkJdmFyIGFsbG93RW1wdHkgPSBmbGFncyAmIDQwOTY7CgkJCQkJZmxhZ3MgPSBmbGFncyAmIH42NDAwOwoJCQkJCXBhdGggPSBTWVNDQUxMUy5jYWxjdWxhdGVBdChkaXJmZCwgcGF0aCwgYWxsb3dFbXB0eSk7CgkJCQkJcmV0dXJuIFNZU0NBTExTLmRvU3RhdChub2ZvbGxvdyA/IEZTLmxzdGF0IDogRlMuc3RhdCwgcGF0aCwgYnVmKQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCWlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CgkJCQkJcmV0dXJuIC1lLmVycm5vCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gX19fc3lzY2FsbF9vcGVuYXQoZGlyZmQsIHBhdGgsIGZsYWdzLCB2YXJhcmdzKSB7CgkJCQlTWVNDQUxMUy52YXJhcmdzID0gdmFyYXJnczsKCQkJCXRyeSB7CgkJCQkJcGF0aCA9IFNZU0NBTExTLmdldFN0cihwYXRoKTsKCQkJCQlwYXRoID0gU1lTQ0FMTFMuY2FsY3VsYXRlQXQoZGlyZmQsIHBhdGgpOwoJCQkJCXZhciBtb2RlID0gdmFyYXJncyA/IFNZU0NBTExTLmdldCgpIDogMDsKCQkJCQlyZXR1cm4gRlMub3BlbihwYXRoLCBmbGFncywgbW9kZSkuZmQKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwoJCQkJCXJldHVybiAtZS5lcnJubwoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIF9fX3N5c2NhbGxfcmVuYW1lYXQob2xkZGlyZmQsIG9sZHBhdGgsIG5ld2RpcmZkLCBuZXdwYXRoKSB7CgkJCQl0cnkgewoJCQkJCW9sZHBhdGggPSBTWVNDQUxMUy5nZXRTdHIob2xkcGF0aCk7CgkJCQkJbmV3cGF0aCA9IFNZU0NBTExTLmdldFN0cihuZXdwYXRoKTsKCQkJCQlvbGRwYXRoID0gU1lTQ0FMTFMuY2FsY3VsYXRlQXQob2xkZGlyZmQsIG9sZHBhdGgpOwoJCQkJCW5ld3BhdGggPSBTWVNDQUxMUy5jYWxjdWxhdGVBdChuZXdkaXJmZCwgbmV3cGF0aCk7CgkJCQkJRlMucmVuYW1lKG9sZHBhdGgsIG5ld3BhdGgpOwoJCQkJCXJldHVybiAwCgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKCQkJCQlyZXR1cm4gLWUuZXJybm8KCQkJCX0KCQkJfQogIAoJCQlmdW5jdGlvbiBfX19zeXNjYWxsX3JtZGlyKHBhdGgpIHsKCQkJCXRyeSB7CgkJCQkJcGF0aCA9IFNZU0NBTExTLmdldFN0cihwYXRoKTsKCQkJCQlGUy5ybWRpcihwYXRoKTsKCQkJCQlyZXR1cm4gMAoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCWlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CgkJCQkJcmV0dXJuIC1lLmVycm5vCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gX19fc3lzY2FsbF9zdGF0NjQocGF0aCwgYnVmKSB7CgkJCQl0cnkgewoJCQkJCXBhdGggPSBTWVNDQUxMUy5nZXRTdHIocGF0aCk7CgkJCQkJcmV0dXJuIFNZU0NBTExTLmRvU3RhdChGUy5zdGF0LCBwYXRoLCBidWYpCgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKCQkJCQlyZXR1cm4gLWUuZXJybm8KCQkJCX0KCQkJfQogIAoJCQlmdW5jdGlvbiBfX19zeXNjYWxsX3VubGlua2F0KGRpcmZkLCBwYXRoLCBmbGFncykgewoJCQkJdHJ5IHsKCQkJCQlwYXRoID0gU1lTQ0FMTFMuZ2V0U3RyKHBhdGgpOwoJCQkJCXBhdGggPSBTWVNDQUxMUy5jYWxjdWxhdGVBdChkaXJmZCwgcGF0aCk7CgkJCQkJaWYgKGZsYWdzID09PSAwKSB7CgkJCQkJCUZTLnVubGluayhwYXRoKQoJCQkJCX0gZWxzZSBpZiAoZmxhZ3MgPT09IDUxMikgewoJCQkJCQlGUy5ybWRpcihwYXRoKQoJCQkJCX0gZWxzZSB7CgkJCQkJCWFib3J0KCJJbnZhbGlkIGZsYWdzIHBhc3NlZCB0byB1bmxpbmthdCIpCgkJCQkJfQoJCQkJCXJldHVybiAwCgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKCQkJCQlyZXR1cm4gLWUuZXJybm8KCQkJCX0KCQkJfQoJCQl2YXIgbm93SXNNb25vdG9uaWMgPSB0cnVlOwogIAoJCQlmdW5jdGlvbiBfX2Vtc2NyaXB0ZW5fZ2V0X25vd19pc19tb25vdG9uaWMoKSB7CgkJCQlyZXR1cm4gbm93SXNNb25vdG9uaWMKCQkJfQogIAoJCQlmdW5jdGlvbiBfX2Vtc2NyaXB0ZW5fdGhyb3dfbG9uZ2ptcCgpIHsKCQkJCXRocm93IEluZmluaXR5CgkJCX0KICAKCQkJZnVuY3Rpb24gcmVhZEk1M0Zyb21JNjQocHRyKSB7CgkJCQlyZXR1cm4gSEVBUFUzMltwdHIgPj4gMl0gKyBIRUFQMzJbcHRyICsgNCA+PiAyXSAqIDQyOTQ5NjcyOTYKCQkJfQogIAoJCQlmdW5jdGlvbiBfX2dtdGltZV9qcyh0aW1lLCB0bVB0cikgewoJCQkJdmFyIGRhdGUgPSBuZXcgRGF0ZShyZWFkSTUzRnJvbUk2NCh0aW1lKSAqIDFlMyk7CgkJCQlIRUFQMzJbdG1QdHIgPj4gMl0gPSBkYXRlLmdldFVUQ1NlY29uZHMoKTsKCQkJCUhFQVAzMlt0bVB0ciArIDQgPj4gMl0gPSBkYXRlLmdldFVUQ01pbnV0ZXMoKTsKCQkJCUhFQVAzMlt0bVB0ciArIDggPj4gMl0gPSBkYXRlLmdldFVUQ0hvdXJzKCk7CgkJCQlIRUFQMzJbdG1QdHIgKyAxMiA+PiAyXSA9IGRhdGUuZ2V0VVRDRGF0ZSgpOwoJCQkJSEVBUDMyW3RtUHRyICsgMTYgPj4gMl0gPSBkYXRlLmdldFVUQ01vbnRoKCk7CgkJCQlIRUFQMzJbdG1QdHIgKyAyMCA+PiAyXSA9IGRhdGUuZ2V0VVRDRnVsbFllYXIoKSAtIDE5MDA7CgkJCQlIRUFQMzJbdG1QdHIgKyAyNCA+PiAyXSA9IGRhdGUuZ2V0VVRDRGF5KCk7CgkJCQl2YXIgc3RhcnQgPSBEYXRlLlVUQyhkYXRlLmdldFVUQ0Z1bGxZZWFyKCksIDAsIDEsIDAsIDAsIDAsIDApOwoJCQkJdmFyIHlkYXkgPSAoZGF0ZS5nZXRUaW1lKCkgLSBzdGFydCkgLyAoMWUzICogNjAgKiA2MCAqIDI0KSB8IDA7CgkJCQlIRUFQMzJbdG1QdHIgKyAyOCA+PiAyXSA9IHlkYXkKCQkJfQogIAoJCQlmdW5jdGlvbiBpc0xlYXBZZWFyKHllYXIpIHsKCQkJCXJldHVybiB5ZWFyICUgNCA9PT0gMCAmJiAoeWVhciAlIDEwMCAhPT0gMCB8fCB5ZWFyICUgNDAwID09PSAwKQoJCQl9CgkJCXZhciBNT05USF9EQVlTX0xFQVBfQ1VNVUxBVElWRSA9IFswLCAzMSwgNjAsIDkxLCAxMjEsIDE1MiwgMTgyLCAyMTMsIDI0NCwgMjc0LCAzMDUsIDMzNV07CgkJCXZhciBNT05USF9EQVlTX1JFR1VMQVJfQ1VNVUxBVElWRSA9IFswLCAzMSwgNTksIDkwLCAxMjAsIDE1MSwgMTgxLCAyMTIsIDI0MywgMjczLCAzMDQsIDMzNF07CiAgCgkJCWZ1bmN0aW9uIHlkYXlGcm9tRGF0ZShkYXRlKSB7CgkJCQl2YXIgbGVhcCA9IGlzTGVhcFllYXIoZGF0ZS5nZXRGdWxsWWVhcigpKTsKCQkJCXZhciBtb250aERheXNDdW11bGF0aXZlID0gbGVhcCA/IE1PTlRIX0RBWVNfTEVBUF9DVU1VTEFUSVZFIDogTU9OVEhfREFZU19SRUdVTEFSX0NVTVVMQVRJVkU7CgkJCQl2YXIgeWRheSA9IG1vbnRoRGF5c0N1bXVsYXRpdmVbZGF0ZS5nZXRNb250aCgpXSArIGRhdGUuZ2V0RGF0ZSgpIC0gMTsKCQkJCXJldHVybiB5ZGF5CgkJCX0KICAKCQkJZnVuY3Rpb24gX19sb2NhbHRpbWVfanModGltZSwgdG1QdHIpIHsKCQkJCXZhciBkYXRlID0gbmV3IERhdGUocmVhZEk1M0Zyb21JNjQodGltZSkgKiAxZTMpOwoJCQkJSEVBUDMyW3RtUHRyID4+IDJdID0gZGF0ZS5nZXRTZWNvbmRzKCk7CgkJCQlIRUFQMzJbdG1QdHIgKyA0ID4+IDJdID0gZGF0ZS5nZXRNaW51dGVzKCk7CgkJCQlIRUFQMzJbdG1QdHIgKyA4ID4+IDJdID0gZGF0ZS5nZXRIb3VycygpOwoJCQkJSEVBUDMyW3RtUHRyICsgMTIgPj4gMl0gPSBkYXRlLmdldERhdGUoKTsKCQkJCUhFQVAzMlt0bVB0ciArIDE2ID4+IDJdID0gZGF0ZS5nZXRNb250aCgpOwoJCQkJSEVBUDMyW3RtUHRyICsgMjAgPj4gMl0gPSBkYXRlLmdldEZ1bGxZZWFyKCkgLSAxOTAwOwoJCQkJSEVBUDMyW3RtUHRyICsgMjQgPj4gMl0gPSBkYXRlLmdldERheSgpOwoJCQkJdmFyIHlkYXkgPSB5ZGF5RnJvbURhdGUoZGF0ZSkgfCAwOwoJCQkJSEVBUDMyW3RtUHRyICsgMjggPj4gMl0gPSB5ZGF5OwoJCQkJSEVBUDMyW3RtUHRyICsgMzYgPj4gMl0gPSAtKGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKSAqIDYwKTsKCQkJCXZhciBzdGFydCA9IG5ldyBEYXRlKGRhdGUuZ2V0RnVsbFllYXIoKSwgMCwgMSk7CgkJCQl2YXIgc3VtbWVyT2Zmc2V0ID0gbmV3IERhdGUoZGF0ZS5nZXRGdWxsWWVhcigpLCA2LCAxKS5nZXRUaW1lem9uZU9mZnNldCgpOwoJCQkJdmFyIHdpbnRlck9mZnNldCA9IHN0YXJ0LmdldFRpbWV6b25lT2Zmc2V0KCk7CgkJCQl2YXIgZHN0ID0gKHN1bW1lck9mZnNldCAhPSB3aW50ZXJPZmZzZXQgJiYgZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpID09IE1hdGgubWluKHdpbnRlck9mZnNldCwgc3VtbWVyT2Zmc2V0KSkgfCAwOwoJCQkJSEVBUDMyW3RtUHRyICsgMzIgPj4gMl0gPSBkc3QKCQkJfQogIAoJCQlmdW5jdGlvbiBfX21rdGltZV9qcyh0bVB0cikgewoJCQkJdmFyIGRhdGUgPSBuZXcgRGF0ZShIRUFQMzJbdG1QdHIgKyAyMCA+PiAyXSArIDE5MDAsIEhFQVAzMlt0bVB0ciArIDE2ID4+IDJdLCBIRUFQMzJbdG1QdHIgKyAxMiA+PiAyXSwgSEVBUDMyW3RtUHRyICsgOCA+PiAyXSwgSEVBUDMyW3RtUHRyICsgNCA+PiAyXSwgSEVBUDMyW3RtUHRyID4+IDJdLCAwKTsKCQkJCXZhciBkc3QgPSBIRUFQMzJbdG1QdHIgKyAzMiA+PiAyXTsKCQkJCXZhciBndWVzc2VkT2Zmc2V0ID0gZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpOwoJCQkJdmFyIHN0YXJ0ID0gbmV3IERhdGUoZGF0ZS5nZXRGdWxsWWVhcigpLCAwLCAxKTsKCQkJCXZhciBzdW1tZXJPZmZzZXQgPSBuZXcgRGF0ZShkYXRlLmdldEZ1bGxZZWFyKCksIDYsIDEpLmdldFRpbWV6b25lT2Zmc2V0KCk7CgkJCQl2YXIgd2ludGVyT2Zmc2V0ID0gc3RhcnQuZ2V0VGltZXpvbmVPZmZzZXQoKTsKCQkJCXZhciBkc3RPZmZzZXQgPSBNYXRoLm1pbih3aW50ZXJPZmZzZXQsIHN1bW1lck9mZnNldCk7CgkJCQlpZiAoZHN0IDwgMCkgewoJCQkJCUhFQVAzMlt0bVB0ciArIDMyID4+IDJdID0gTnVtYmVyKHN1bW1lck9mZnNldCAhPSB3aW50ZXJPZmZzZXQgJiYgZHN0T2Zmc2V0ID09IGd1ZXNzZWRPZmZzZXQpCgkJCQl9IGVsc2UgaWYgKGRzdCA+IDAgIT0gKGRzdE9mZnNldCA9PSBndWVzc2VkT2Zmc2V0KSkgewoJCQkJCXZhciBub25Ec3RPZmZzZXQgPSBNYXRoLm1heCh3aW50ZXJPZmZzZXQsIHN1bW1lck9mZnNldCk7CgkJCQkJdmFyIHRydWVPZmZzZXQgPSBkc3QgPiAwID8gZHN0T2Zmc2V0IDogbm9uRHN0T2Zmc2V0OwoJCQkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArICh0cnVlT2Zmc2V0IC0gZ3Vlc3NlZE9mZnNldCkgKiA2ZTQpCgkJCQl9CgkJCQlIRUFQMzJbdG1QdHIgKyAyNCA+PiAyXSA9IGRhdGUuZ2V0RGF5KCk7CgkJCQl2YXIgeWRheSA9IHlkYXlGcm9tRGF0ZShkYXRlKSB8IDA7CgkJCQlIRUFQMzJbdG1QdHIgKyAyOCA+PiAyXSA9IHlkYXk7CgkJCQlIRUFQMzJbdG1QdHIgPj4gMl0gPSBkYXRlLmdldFNlY29uZHMoKTsKCQkJCUhFQVAzMlt0bVB0ciArIDQgPj4gMl0gPSBkYXRlLmdldE1pbnV0ZXMoKTsKCQkJCUhFQVAzMlt0bVB0ciArIDggPj4gMl0gPSBkYXRlLmdldEhvdXJzKCk7CgkJCQlIRUFQMzJbdG1QdHIgKyAxMiA+PiAyXSA9IGRhdGUuZ2V0RGF0ZSgpOwoJCQkJSEVBUDMyW3RtUHRyICsgMTYgPj4gMl0gPSBkYXRlLmdldE1vbnRoKCk7CgkJCQlIRUFQMzJbdG1QdHIgKyAyMCA+PiAyXSA9IGRhdGUuZ2V0WWVhcigpOwoJCQkJcmV0dXJuIGRhdGUuZ2V0VGltZSgpIC8gMWUzIHwgMAoJCQl9CiAgCgkJCWZ1bmN0aW9uIHN0cmluZ1RvTmV3VVRGOChzdHIpIHsKCQkJCXZhciBzaXplID0gbGVuZ3RoQnl0ZXNVVEY4KHN0cikgKyAxOwoJCQkJdmFyIHJldCA9IF9tYWxsb2Moc2l6ZSk7CgkJCQlpZiAocmV0KSBzdHJpbmdUb1VURjgoc3RyLCByZXQsIHNpemUpOwoJCQkJcmV0dXJuIHJldAoJCQl9CiAgCgkJCWZ1bmN0aW9uIF9fdHpzZXRfanModGltZXpvbmUsIGRheWxpZ2h0LCB0em5hbWUpIHsKCQkJCXZhciBjdXJyZW50WWVhciA9IChuZXcgRGF0ZSkuZ2V0RnVsbFllYXIoKTsKCQkJCXZhciB3aW50ZXIgPSBuZXcgRGF0ZShjdXJyZW50WWVhciwgMCwgMSk7CgkJCQl2YXIgc3VtbWVyID0gbmV3IERhdGUoY3VycmVudFllYXIsIDYsIDEpOwoJCQkJdmFyIHdpbnRlck9mZnNldCA9IHdpbnRlci5nZXRUaW1lem9uZU9mZnNldCgpOwoJCQkJdmFyIHN1bW1lck9mZnNldCA9IHN1bW1lci5nZXRUaW1lem9uZU9mZnNldCgpOwoJCQkJdmFyIHN0ZFRpbWV6b25lT2Zmc2V0ID0gTWF0aC5tYXgod2ludGVyT2Zmc2V0LCBzdW1tZXJPZmZzZXQpOwoJCQkJSEVBUFUzMlt0aW1lem9uZSA+PiAyXSA9IHN0ZFRpbWV6b25lT2Zmc2V0ICogNjA7CgkJCQlIRUFQMzJbZGF5bGlnaHQgPj4gMl0gPSBOdW1iZXIod2ludGVyT2Zmc2V0ICE9IHN1bW1lck9mZnNldCk7CiAgCgkJCQlmdW5jdGlvbiBleHRyYWN0Wm9uZShkYXRlKSB7CgkJCQkJdmFyIG1hdGNoID0gZGF0ZS50b1RpbWVTdHJpbmcoKS5tYXRjaCgvXCgoW0EtWmEteiBdKylcKSQvKTsKCQkJCQlyZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICJHTVQiCgkJCQl9CgkJCQl2YXIgd2ludGVyTmFtZSA9IGV4dHJhY3Rab25lKHdpbnRlcik7CgkJCQl2YXIgc3VtbWVyTmFtZSA9IGV4dHJhY3Rab25lKHN1bW1lcik7CgkJCQl2YXIgd2ludGVyTmFtZVB0ciA9IHN0cmluZ1RvTmV3VVRGOCh3aW50ZXJOYW1lKTsKCQkJCXZhciBzdW1tZXJOYW1lUHRyID0gc3RyaW5nVG9OZXdVVEY4KHN1bW1lck5hbWUpOwoJCQkJaWYgKHN1bW1lck9mZnNldCA8IHdpbnRlck9mZnNldCkgewoJCQkJCUhFQVBVMzJbdHpuYW1lID4+IDJdID0gd2ludGVyTmFtZVB0cjsKCQkJCQlIRUFQVTMyW3R6bmFtZSArIDQgPj4gMl0gPSBzdW1tZXJOYW1lUHRyCgkJCQl9IGVsc2UgewoJCQkJCUhFQVBVMzJbdHpuYW1lID4+IDJdID0gc3VtbWVyTmFtZVB0cjsKCQkJCQlIRUFQVTMyW3R6bmFtZSArIDQgPj4gMl0gPSB3aW50ZXJOYW1lUHRyCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gX2Fib3J0KCkgewoJCQkJYWJvcnQoIiIpCgkJCX0KCQkJdmFyIHJlYWRFbUFzbUFyZ3NBcnJheSA9IFtdOwogIAoJCQlmdW5jdGlvbiByZWFkRW1Bc21BcmdzKHNpZ1B0ciwgYnVmKSB7CgkJCQlyZWFkRW1Bc21BcmdzQXJyYXkubGVuZ3RoID0gMDsKCQkJCXZhciBjaDsKCQkJCWJ1ZiA+Pj0gMjsKCQkJCXdoaWxlIChjaCA9IEhFQVBVOFtzaWdQdHIrK10pIHsKCQkJCQlidWYgKz0gY2ggIT0gMTA1ICYgYnVmOwoJCQkJCXJlYWRFbUFzbUFyZ3NBcnJheS5wdXNoKGNoID09IDEwNSA/IEhFQVAzMltidWZdIDogSEVBUEY2NFtidWYrKyA+PiAxXSk7CgkJCQkJKytidWYKCQkJCX0KCQkJCXJldHVybiByZWFkRW1Bc21BcmdzQXJyYXkKCQkJfQogIAoJCQlmdW5jdGlvbiBydW5NYWluVGhyZWFkRW1Bc20oY29kZSwgc2lnUHRyLCBhcmdidWYsIHN5bmMpIHsKCQkJCXZhciBhcmdzID0gcmVhZEVtQXNtQXJncyhzaWdQdHIsIGFyZ2J1Zik7CgkJCQlyZXR1cm4gQVNNX0NPTlNUU1tjb2RlXS5hcHBseShudWxsLCBhcmdzKQoJCQl9CiAgCgkJCWZ1bmN0aW9uIF9lbXNjcmlwdGVuX2FzbV9jb25zdF9hc3luY19vbl9tYWluX3RocmVhZChjb2RlLCBzaWdQdHIsIGFyZ2J1ZikgewoJCQkJcmV0dXJuIHJ1bk1haW5UaHJlYWRFbUFzbShjb2RlLCBzaWdQdHIsIGFyZ2J1ZiwgMCkKCQkJfQogIAoJCQlmdW5jdGlvbiBydW5FbUFzbUZ1bmN0aW9uKGNvZGUsIHNpZ1B0ciwgYXJnYnVmKSB7CgkJCQl2YXIgYXJncyA9IHJlYWRFbUFzbUFyZ3Moc2lnUHRyLCBhcmdidWYpOwoJCQkJcmV0dXJuIEFTTV9DT05TVFNbY29kZV0uYXBwbHkobnVsbCwgYXJncykKCQkJfQogIAoJCQlmdW5jdGlvbiBfZW1zY3JpcHRlbl9hc21fY29uc3RfaW50KGNvZGUsIHNpZ1B0ciwgYXJnYnVmKSB7CgkJCQlyZXR1cm4gcnVuRW1Bc21GdW5jdGlvbihjb2RlLCBzaWdQdHIsIGFyZ2J1ZikKCQkJfQogIAoJCQlmdW5jdGlvbiBfZW1zY3JpcHRlbl9kYXRlX25vdygpIHsKCQkJCXJldHVybiBEYXRlLm5vdygpCgkJCX0KICAKCQkJZnVuY3Rpb24gZ2V0SGVhcE1heCgpIHsKCQkJCXJldHVybiAyMTQ3NDgzNjQ4CgkJCX0KICAKCQkJZnVuY3Rpb24gX2Vtc2NyaXB0ZW5fZ2V0X2hlYXBfbWF4KCkgewoJCQkJcmV0dXJuIGdldEhlYXBNYXgoKQoJCQl9CgkJCXZhciBfZW1zY3JpcHRlbl9nZXRfbm93OwoJCQlpZiAoRU5WSVJPTk1FTlRfSVNfTk9ERSkgewoJCQkJX2Vtc2NyaXB0ZW5fZ2V0X25vdyA9ICgpID0+IHsKCQkJCQl2YXIgdCA9IHByb2Nlc3MuaHJ0aW1lKCk7CgkJCQkJcmV0dXJuIHRbMF0gKiAxZTMgKyB0WzFdIC8gMWU2CgkJCQl9CgkJCX0gZWxzZSBfZW1zY3JpcHRlbl9nZXRfbm93ID0gKCkgPT4gcGVyZm9ybWFuY2Uubm93KCk7CiAgCgkJCWZ1bmN0aW9uIF9lbXNjcmlwdGVuX21lbWNweV9iaWcoZGVzdCwgc3JjLCBudW0pIHsKCQkJCUhFQVBVOC5jb3B5V2l0aGluKGRlc3QsIHNyYywgc3JjICsgbnVtKQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGVtc2NyaXB0ZW5fcmVhbGxvY19idWZmZXIoc2l6ZSkgewoJCQkJdmFyIGIgPSB3YXNtTWVtb3J5LmJ1ZmZlcjsKCQkJCXRyeSB7CgkJCQkJd2FzbU1lbW9yeS5ncm93KHNpemUgLSBiLmJ5dGVMZW5ndGggKyA2NTUzNSA+Pj4gMTYpOwoJCQkJCXVwZGF0ZU1lbW9yeVZpZXdzKCk7CgkJCQkJcmV0dXJuIDEKCQkJCX0gY2F0Y2ggKGUpIHt9CgkJCX0KICAKCQkJZnVuY3Rpb24gX2Vtc2NyaXB0ZW5fcmVzaXplX2hlYXAocmVxdWVzdGVkU2l6ZSkgewoJCQkJdmFyIG9sZFNpemUgPSBIRUFQVTgubGVuZ3RoOwoJCQkJcmVxdWVzdGVkU2l6ZSA9IHJlcXVlc3RlZFNpemUgPj4+IDA7CgkJCQl2YXIgbWF4SGVhcFNpemUgPSBnZXRIZWFwTWF4KCk7CgkJCQlpZiAocmVxdWVzdGVkU2l6ZSA+IG1heEhlYXBTaXplKSB7CgkJCQkJcmV0dXJuIGZhbHNlCgkJCQl9CgkJCQl2YXIgYWxpZ25VcCA9ICh4LCBtdWx0aXBsZSkgPT4geCArIChtdWx0aXBsZSAtIHggJSBtdWx0aXBsZSkgJSBtdWx0aXBsZTsKCQkJCWZvciAodmFyIGN1dERvd24gPSAxOyBjdXREb3duIDw9IDQ7IGN1dERvd24gKj0gMikgewoJCQkJCXZhciBvdmVyR3Jvd25IZWFwU2l6ZSA9IG9sZFNpemUgKiAoMSArIC4yIC8gY3V0RG93bik7CgkJCQkJb3Zlckdyb3duSGVhcFNpemUgPSBNYXRoLm1pbihvdmVyR3Jvd25IZWFwU2l6ZSwgcmVxdWVzdGVkU2l6ZSArIDEwMDY2MzI5Nik7CgkJCQkJdmFyIG5ld1NpemUgPSBNYXRoLm1pbihtYXhIZWFwU2l6ZSwgYWxpZ25VcChNYXRoLm1heChyZXF1ZXN0ZWRTaXplLCBvdmVyR3Jvd25IZWFwU2l6ZSksIDY1NTM2KSk7CgkJCQkJdmFyIHJlcGxhY2VtZW50ID0gZW1zY3JpcHRlbl9yZWFsbG9jX2J1ZmZlcihuZXdTaXplKTsKCQkJCQlpZiAocmVwbGFjZW1lbnQpIHsKCQkJCQkJcmV0dXJuIHRydWUKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gZmFsc2UKCQkJfQoJCQl2YXIgRU5WID0ge307CiAgCgkJCWZ1bmN0aW9uIGdldEV4ZWN1dGFibGVOYW1lKCkgewoJCQkJcmV0dXJuIHRoaXNQcm9ncmFtIHx8ICIuL3RoaXMucHJvZ3JhbSIKCQkJfQogIAoJCQlmdW5jdGlvbiBnZXRFbnZTdHJpbmdzKCkgewoJCQkJaWYgKCFnZXRFbnZTdHJpbmdzLnN0cmluZ3MpIHsKCQkJCQl2YXIgbGFuZyA9ICh0eXBlb2YgbmF2aWdhdG9yID09ICJvYmplY3QiICYmIG5hdmlnYXRvci5sYW5ndWFnZXMgJiYgbmF2aWdhdG9yLmxhbmd1YWdlc1swXSB8fCAiQyIpLnJlcGxhY2UoIi0iLCAiXyIpICsgIi5VVEYtOCI7CgkJCQkJdmFyIGVudiA9IHsKCQkJCQkJIlVTRVIiOiAid2ViX3VzZXIiLAoJCQkJCQkiTE9HTkFNRSI6ICJ3ZWJfdXNlciIsCgkJCQkJCSJQQVRIIjogIi8iLAoJCQkJCQkiUFdEIjogIi8iLAoJCQkJCQkiSE9NRSI6ICIvaG9tZS93ZWJfdXNlciIsCgkJCQkJCSJMQU5HIjogbGFuZywKCQkJCQkJIl8iOiBnZXRFeGVjdXRhYmxlTmFtZSgpCgkJCQkJfTsKCQkJCQlmb3IgKHZhciB4IGluIEVOVikgewoJCQkJCQlpZiAoRU5WW3hdID09PSB1bmRlZmluZWQpIGRlbGV0ZSBlbnZbeF07CgkJCQkJCWVsc2UgZW52W3hdID0gRU5WW3hdCgkJCQkJfQoJCQkJCXZhciBzdHJpbmdzID0gW107CgkJCQkJZm9yICh2YXIgeCBpbiBlbnYpIHsKCQkJCQkJc3RyaW5ncy5wdXNoKHggKyAiPSIgKyBlbnZbeF0pCgkJCQkJfQoJCQkJCWdldEVudlN0cmluZ3Muc3RyaW5ncyA9IHN0cmluZ3MKCQkJCX0KCQkJCXJldHVybiBnZXRFbnZTdHJpbmdzLnN0cmluZ3MKCQkJfQogIAoJCQlmdW5jdGlvbiBzdHJpbmdUb0FzY2lpKHN0ciwgYnVmZmVyKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewoJCQkJCUhFQVA4W2J1ZmZlcisrID4+IDBdID0gc3RyLmNoYXJDb2RlQXQoaSkKCQkJCX0KCQkJCUhFQVA4W2J1ZmZlciA+PiAwXSA9IDAKCQkJfQogIAoJCQlmdW5jdGlvbiBfZW52aXJvbl9nZXQoX19lbnZpcm9uLCBlbnZpcm9uX2J1ZikgewoJCQkJdmFyIGJ1ZlNpemUgPSAwOwoJCQkJZ2V0RW52U3RyaW5ncygpLmZvckVhY2goZnVuY3Rpb24oc3RyaW5nLCBpKSB7CgkJCQkJdmFyIHB0ciA9IGVudmlyb25fYnVmICsgYnVmU2l6ZTsKCQkJCQlIRUFQVTMyW19fZW52aXJvbiArIGkgKiA0ID4+IDJdID0gcHRyOwoJCQkJCXN0cmluZ1RvQXNjaWkoc3RyaW5nLCBwdHIpOwoJCQkJCWJ1ZlNpemUgKz0gc3RyaW5nLmxlbmd0aCArIDEKCQkJCX0pOwoJCQkJcmV0dXJuIDAKCQkJfQogIAoJCQlmdW5jdGlvbiBfZW52aXJvbl9zaXplc19nZXQocGVudmlyb25fY291bnQsIHBlbnZpcm9uX2J1Zl9zaXplKSB7CgkJCQl2YXIgc3RyaW5ncyA9IGdldEVudlN0cmluZ3MoKTsKCQkJCUhFQVBVMzJbcGVudmlyb25fY291bnQgPj4gMl0gPSBzdHJpbmdzLmxlbmd0aDsKCQkJCXZhciBidWZTaXplID0gMDsKCQkJCXN0cmluZ3MuZm9yRWFjaChmdW5jdGlvbihzdHJpbmcpIHsKCQkJCQlidWZTaXplICs9IHN0cmluZy5sZW5ndGggKyAxCgkJCQl9KTsKCQkJCUhFQVBVMzJbcGVudmlyb25fYnVmX3NpemUgPj4gMl0gPSBidWZTaXplOwoJCQkJcmV0dXJuIDAKCQkJfQogIAoJCQlmdW5jdGlvbiBfcHJvY19leGl0KGNvZGUpIHsKCQkJCUVYSVRTVEFUVVMgPSBjb2RlOwoJCQkJaWYgKCFrZWVwUnVudGltZUFsaXZlKCkpIHsKCQkJCQlpZiAoTW9kdWxlWyJvbkV4aXQiXSkgTW9kdWxlWyJvbkV4aXQiXShjb2RlKTsKCQkJCQlBQk9SVCA9IHRydWUKCQkJCX0KCQkJCXF1aXRfKGNvZGUsIG5ldyBFeGl0U3RhdHVzKGNvZGUpKQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGV4aXRKUyhzdGF0dXMsIGltcGxpY2l0KSB7CgkJCQlFWElUU1RBVFVTID0gc3RhdHVzOwoJCQkJX3Byb2NfZXhpdChzdGF0dXMpCgkJCX0KCQkJdmFyIF9leGl0ID0gZXhpdEpTOwogIAoJCQlmdW5jdGlvbiBfZmRfY2xvc2UoZmQpIHsKCQkJCXRyeSB7CgkJCQkJdmFyIHN0cmVhbSA9IFNZU0NBTExTLmdldFN0cmVhbUZyb21GRChmZCk7CgkJCQkJRlMuY2xvc2Uoc3RyZWFtKTsKCQkJCQlyZXR1cm4gMAoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCWlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CgkJCQkJcmV0dXJuIGUuZXJybm8KCQkJCX0KCQkJfQogIAoJCQlmdW5jdGlvbiBfZmRfZmRzdGF0X2dldChmZCwgcGJ1ZikgewoJCQkJdHJ5IHsKCQkJCQl2YXIgcmlnaHRzQmFzZSA9IDA7CgkJCQkJdmFyIHJpZ2h0c0luaGVyaXRpbmcgPSAwOwoJCQkJCXZhciBmbGFncyA9IDA7CgkJCQkJewoJCQkJCQl2YXIgc3RyZWFtID0gU1lTQ0FMTFMuZ2V0U3RyZWFtRnJvbUZEKGZkKTsKCQkJCQkJdmFyIHR5cGUgPSBzdHJlYW0udHR5ID8gMiA6IEZTLmlzRGlyKHN0cmVhbS5tb2RlKSA/IDMgOiBGUy5pc0xpbmsoc3RyZWFtLm1vZGUpID8gNyA6IDQKCQkJCQl9CgkJCQkJSEVBUDhbcGJ1ZiA+PiAwXSA9IHR5cGU7CgkJCQkJSEVBUDE2W3BidWYgKyAyID4+IDFdID0gZmxhZ3M7CgkJCQkJdGVtcEk2NCA9IFtyaWdodHNCYXNlID4+PiAwLCAodGVtcERvdWJsZSA9IHJpZ2h0c0Jhc2UsICtNYXRoLmFicyh0ZW1wRG91YmxlKSA+PSAxID8gdGVtcERvdWJsZSA+IDAgPyArTWF0aC5mbG9vcih0ZW1wRG91YmxlIC8gNDI5NDk2NzI5NikgPj4+IDAgOiB+fitNYXRoLmNlaWwoKHRlbXBEb3VibGUgLSArKH5+dGVtcERvdWJsZSA+Pj4gMCkpIC8gNDI5NDk2NzI5NikgPj4+IDAgOiAwKV0sIEhFQVAzMltwYnVmICsgOCA+PiAyXSA9IHRlbXBJNjRbMF0sIEhFQVAzMltwYnVmICsgMTIgPj4gMl0gPSB0ZW1wSTY0WzFdOwoJCQkJCXRlbXBJNjQgPSBbcmlnaHRzSW5oZXJpdGluZyA+Pj4gMCwgKHRlbXBEb3VibGUgPSByaWdodHNJbmhlcml0aW5nLCArTWF0aC5hYnModGVtcERvdWJsZSkgPj0gMSA/IHRlbXBEb3VibGUgPiAwID8gK01hdGguZmxvb3IodGVtcERvdWJsZSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogfn4rTWF0aC5jZWlsKCh0ZW1wRG91YmxlIC0gKyh+fnRlbXBEb3VibGUgPj4+IDApKSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogMCldLCBIRUFQMzJbcGJ1ZiArIDE2ID4+IDJdID0gdGVtcEk2NFswXSwgSEVBUDMyW3BidWYgKyAyMCA+PiAyXSA9IHRlbXBJNjRbMV07CgkJCQkJcmV0dXJuIDAKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwoJCQkJCXJldHVybiBlLmVycm5vCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gZG9SZWFkdihzdHJlYW0sIGlvdiwgaW92Y250LCBvZmZzZXQpIHsKCQkJCXZhciByZXQgPSAwOwoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBpb3ZjbnQ7IGkrKykgewoJCQkJCXZhciBwdHIgPSBIRUFQVTMyW2lvdiA+PiAyXTsKCQkJCQl2YXIgbGVuID0gSEVBUFUzMltpb3YgKyA0ID4+IDJdOwoJCQkJCWlvdiArPSA4OwoJCQkJCXZhciBjdXJyID0gRlMucmVhZChzdHJlYW0sIEhFQVA4LCBwdHIsIGxlbiwgb2Zmc2V0KTsKCQkJCQlpZiAoY3VyciA8IDApIHJldHVybiAtMTsKCQkJCQlyZXQgKz0gY3VycjsKCQkJCQlpZiAoY3VyciA8IGxlbikgYnJlYWs7CgkJCQkJaWYgKHR5cGVvZiBvZmZzZXQgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCW9mZnNldCArPSBjdXJyCgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHJldAoJCQl9CiAgCgkJCWZ1bmN0aW9uIF9mZF9yZWFkKGZkLCBpb3YsIGlvdmNudCwgcG51bSkgewoJCQkJdHJ5IHsKCQkJCQl2YXIgc3RyZWFtID0gU1lTQ0FMTFMuZ2V0U3RyZWFtRnJvbUZEKGZkKTsKCQkJCQl2YXIgbnVtID0gZG9SZWFkdihzdHJlYW0sIGlvdiwgaW92Y250KTsKCQkJCQlIRUFQVTMyW3BudW0gPj4gMl0gPSBudW07CgkJCQkJcmV0dXJuIDAKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwoJCQkJCXJldHVybiBlLmVycm5vCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gY29udmVydEkzMlBhaXJUb0k1M0NoZWNrZWQobG8sIGhpKSB7CgkJCQlyZXR1cm4gaGkgKyAyMDk3MTUyID4+PiAwIDwgNDE5NDMwNSAtICEhbG8gPyAobG8gPj4+IDApICsgaGkgKiA0Mjk0OTY3Mjk2IDogTmFOCgkJCX0KICAKCQkJZnVuY3Rpb24gX2ZkX3NlZWsoZmQsIG9mZnNldF9sb3csIG9mZnNldF9oaWdoLCB3aGVuY2UsIG5ld09mZnNldCkgewoJCQkJdHJ5IHsKCQkJCQl2YXIgb2Zmc2V0ID0gY29udmVydEkzMlBhaXJUb0k1M0NoZWNrZWQob2Zmc2V0X2xvdywgb2Zmc2V0X2hpZ2gpOwoJCQkJCWlmIChpc05hTihvZmZzZXQpKSByZXR1cm4gNjE7CgkJCQkJdmFyIHN0cmVhbSA9IFNZU0NBTExTLmdldFN0cmVhbUZyb21GRChmZCk7CgkJCQkJRlMubGxzZWVrKHN0cmVhbSwgb2Zmc2V0LCB3aGVuY2UpOwoJCQkJCXRlbXBJNjQgPSBbc3RyZWFtLnBvc2l0aW9uID4+PiAwLCAodGVtcERvdWJsZSA9IHN0cmVhbS5wb3NpdGlvbiwgK01hdGguYWJzKHRlbXBEb3VibGUpID49IDEgPyB0ZW1wRG91YmxlID4gMCA/ICtNYXRoLmZsb29yKHRlbXBEb3VibGUgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IH5+K01hdGguY2VpbCgodGVtcERvdWJsZSAtICsofn50ZW1wRG91YmxlID4+PiAwKSkgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IDApXSwgSEVBUDMyW25ld09mZnNldCA+PiAyXSA9IHRlbXBJNjRbMF0sIEhFQVAzMltuZXdPZmZzZXQgKyA0ID4+IDJdID0gdGVtcEk2NFsxXTsKCQkJCQlpZiAoc3RyZWFtLmdldGRlbnRzICYmIG9mZnNldCA9PT0gMCAmJiB3aGVuY2UgPT09IDApIHN0cmVhbS5nZXRkZW50cyA9IG51bGw7CgkJCQkJcmV0dXJuIDAKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwoJCQkJCXJldHVybiBlLmVycm5vCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gZG9Xcml0ZXYoc3RyZWFtLCBpb3YsIGlvdmNudCwgb2Zmc2V0KSB7CgkJCQl2YXIgcmV0ID0gMDsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgaW92Y250OyBpKyspIHsKCQkJCQl2YXIgcHRyID0gSEVBUFUzMltpb3YgPj4gMl07CgkJCQkJdmFyIGxlbiA9IEhFQVBVMzJbaW92ICsgNCA+PiAyXTsKCQkJCQlpb3YgKz0gODsKCQkJCQl2YXIgY3VyciA9IEZTLndyaXRlKHN0cmVhbSwgSEVBUDgsIHB0ciwgbGVuLCBvZmZzZXQpOwoJCQkJCWlmIChjdXJyIDwgMCkgcmV0dXJuIC0xOwoJCQkJCXJldCArPSBjdXJyOwoJCQkJCWlmICh0eXBlb2Ygb2Zmc2V0ICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlvZmZzZXQgKz0gY3VycgoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiByZXQKCQkJfQogIAoJCQlmdW5jdGlvbiBfZmRfd3JpdGUoZmQsIGlvdiwgaW92Y250LCBwbnVtKSB7CgkJCQl0cnkgewoJCQkJCXZhciBzdHJlYW0gPSBTWVNDQUxMUy5nZXRTdHJlYW1Gcm9tRkQoZmQpOwoJCQkJCXZhciBudW0gPSBkb1dyaXRldihzdHJlYW0sIGlvdiwgaW92Y250KTsKCQkJCQlIRUFQVTMyW3BudW0gPj4gMl0gPSBudW07CgkJCQkJcmV0dXJuIDAKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwoJCQkJCXJldHVybiBlLmVycm5vCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gYXJyYXlTdW0oYXJyYXksIGluZGV4KSB7CgkJCQl2YXIgc3VtID0gMDsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDw9IGluZGV4OyBzdW0gKz0gYXJyYXlbaSsrXSkge30KCQkJCXJldHVybiBzdW0KCQkJfQoJCQl2YXIgTU9OVEhfREFZU19MRUFQID0gWzMxLCAyOSwgMzEsIDMwLCAzMSwgMzAsIDMxLCAzMSwgMzAsIDMxLCAzMCwgMzFdOwoJCQl2YXIgTU9OVEhfREFZU19SRUdVTEFSID0gWzMxLCAyOCwgMzEsIDMwLCAzMSwgMzAsIDMxLCAzMSwgMzAsIDMxLCAzMCwgMzFdOwogIAoJCQlmdW5jdGlvbiBhZGREYXlzKGRhdGUsIGRheXMpIHsKCQkJCXZhciBuZXdEYXRlID0gbmV3IERhdGUoZGF0ZS5nZXRUaW1lKCkpOwoJCQkJd2hpbGUgKGRheXMgPiAwKSB7CgkJCQkJdmFyIGxlYXAgPSBpc0xlYXBZZWFyKG5ld0RhdGUuZ2V0RnVsbFllYXIoKSk7CgkJCQkJdmFyIGN1cnJlbnRNb250aCA9IG5ld0RhdGUuZ2V0TW9udGgoKTsKCQkJCQl2YXIgZGF5c0luQ3VycmVudE1vbnRoID0gKGxlYXAgPyBNT05USF9EQVlTX0xFQVAgOiBNT05USF9EQVlTX1JFR1VMQVIpW2N1cnJlbnRNb250aF07CgkJCQkJaWYgKGRheXMgPiBkYXlzSW5DdXJyZW50TW9udGggLSBuZXdEYXRlLmdldERhdGUoKSkgewoJCQkJCQlkYXlzIC09IGRheXNJbkN1cnJlbnRNb250aCAtIG5ld0RhdGUuZ2V0RGF0ZSgpICsgMTsKCQkJCQkJbmV3RGF0ZS5zZXREYXRlKDEpOwoJCQkJCQlpZiAoY3VycmVudE1vbnRoIDwgMTEpIHsKCQkJCQkJCW5ld0RhdGUuc2V0TW9udGgoY3VycmVudE1vbnRoICsgMSkKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCW5ld0RhdGUuc2V0TW9udGgoMCk7CgkJCQkJCQluZXdEYXRlLnNldEZ1bGxZZWFyKG5ld0RhdGUuZ2V0RnVsbFllYXIoKSArIDEpCgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQluZXdEYXRlLnNldERhdGUobmV3RGF0ZS5nZXREYXRlKCkgKyBkYXlzKTsKCQkJCQkJcmV0dXJuIG5ld0RhdGUKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gbmV3RGF0ZQoJCQl9CiAgCgkJCWZ1bmN0aW9uIHdyaXRlQXJyYXlUb01lbW9yeShhcnJheSwgYnVmZmVyKSB7CgkJCQlIRUFQOC5zZXQoYXJyYXksIGJ1ZmZlcikKCQkJfQogIAoJCQlmdW5jdGlvbiBfc3RyZnRpbWUocywgbWF4c2l6ZSwgZm9ybWF0LCB0bSkgewoJCQkJdmFyIHRtX3pvbmUgPSBIRUFQMzJbdG0gKyA0MCA+PiAyXTsKCQkJCXZhciBkYXRlID0gewoJCQkJCXRtX3NlYzogSEVBUDMyW3RtID4+IDJdLAoJCQkJCXRtX21pbjogSEVBUDMyW3RtICsgNCA+PiAyXSwKCQkJCQl0bV9ob3VyOiBIRUFQMzJbdG0gKyA4ID4+IDJdLAoJCQkJCXRtX21kYXk6IEhFQVAzMlt0bSArIDEyID4+IDJdLAoJCQkJCXRtX21vbjogSEVBUDMyW3RtICsgMTYgPj4gMl0sCgkJCQkJdG1feWVhcjogSEVBUDMyW3RtICsgMjAgPj4gMl0sCgkJCQkJdG1fd2RheTogSEVBUDMyW3RtICsgMjQgPj4gMl0sCgkJCQkJdG1feWRheTogSEVBUDMyW3RtICsgMjggPj4gMl0sCgkJCQkJdG1faXNkc3Q6IEhFQVAzMlt0bSArIDMyID4+IDJdLAoJCQkJCXRtX2dtdG9mZjogSEVBUDMyW3RtICsgMzYgPj4gMl0sCgkJCQkJdG1fem9uZTogdG1fem9uZSA/IFVURjhUb1N0cmluZyh0bV96b25lKSA6ICIiCgkJCQl9OwoJCQkJdmFyIHBhdHRlcm4gPSBVVEY4VG9TdHJpbmcoZm9ybWF0KTsKCQkJCXZhciBFWFBBTlNJT05fUlVMRVNfMSA9IHsKCQkJCQkiJWMiOiAiJWEgJWIgJWQgJUg6JU06JVMgJVkiLAoJCQkJCSIlRCI6ICIlbS8lZC8leSIsCgkJCQkJIiVGIjogIiVZLSVtLSVkIiwKCQkJCQkiJWgiOiAiJWIiLAoJCQkJCSIlciI6ICIlSTolTTolUyAlcCIsCgkJCQkJIiVSIjogIiVIOiVNIiwKCQkJCQkiJVQiOiAiJUg6JU06JVMiLAoJCQkJCSIleCI6ICIlbS8lZC8leSIsCgkJCQkJIiVYIjogIiVIOiVNOiVTIiwKCQkJCQkiJUVjIjogIiVjIiwKCQkJCQkiJUVDIjogIiVDIiwKCQkJCQkiJUV4IjogIiVtLyVkLyV5IiwKCQkJCQkiJUVYIjogIiVIOiVNOiVTIiwKCQkJCQkiJUV5IjogIiV5IiwKCQkJCQkiJUVZIjogIiVZIiwKCQkJCQkiJU9kIjogIiVkIiwKCQkJCQkiJU9lIjogIiVlIiwKCQkJCQkiJU9IIjogIiVIIiwKCQkJCQkiJU9JIjogIiVJIiwKCQkJCQkiJU9tIjogIiVtIiwKCQkJCQkiJU9NIjogIiVNIiwKCQkJCQkiJU9TIjogIiVTIiwKCQkJCQkiJU91IjogIiV1IiwKCQkJCQkiJU9VIjogIiVVIiwKCQkJCQkiJU9WIjogIiVWIiwKCQkJCQkiJU93IjogIiV3IiwKCQkJCQkiJU9XIjogIiVXIiwKCQkJCQkiJU95IjogIiV5IgoJCQkJfTsKCQkJCWZvciAodmFyIHJ1bGUgaW4gRVhQQU5TSU9OX1JVTEVTXzEpIHsKCQkJCQlwYXR0ZXJuID0gcGF0dGVybi5yZXBsYWNlKG5ldyBSZWdFeHAocnVsZSwgImciKSwgRVhQQU5TSU9OX1JVTEVTXzFbcnVsZV0pCgkJCQl9CgkJCQl2YXIgV0VFS0RBWVMgPSBbIlN1bmRheSIsICJNb25kYXkiLCAiVHVlc2RheSIsICJXZWRuZXNkYXkiLCAiVGh1cnNkYXkiLCAiRnJpZGF5IiwgIlNhdHVyZGF5Il07CgkJCQl2YXIgTU9OVEhTID0gWyJKYW51YXJ5IiwgIkZlYnJ1YXJ5IiwgIk1hcmNoIiwgIkFwcmlsIiwgIk1heSIsICJKdW5lIiwgIkp1bHkiLCAiQXVndXN0IiwgIlNlcHRlbWJlciIsICJPY3RvYmVyIiwgIk5vdmVtYmVyIiwgIkRlY2VtYmVyIl07CiAgCgkJCQlmdW5jdGlvbiBsZWFkaW5nU29tZXRoaW5nKHZhbHVlLCBkaWdpdHMsIGNoYXJhY3RlcikgewoJCQkJCXZhciBzdHIgPSB0eXBlb2YgdmFsdWUgPT0gIm51bWJlciIgPyB2YWx1ZS50b1N0cmluZygpIDogdmFsdWUgfHwgIiI7CgkJCQkJd2hpbGUgKHN0ci5sZW5ndGggPCBkaWdpdHMpIHsKCQkJCQkJc3RyID0gY2hhcmFjdGVyWzBdICsgc3RyCgkJCQkJfQoJCQkJCXJldHVybiBzdHIKCQkJCX0KICAKCQkJCWZ1bmN0aW9uIGxlYWRpbmdOdWxscyh2YWx1ZSwgZGlnaXRzKSB7CgkJCQkJcmV0dXJuIGxlYWRpbmdTb21ldGhpbmcodmFsdWUsIGRpZ2l0cywgIjAiKQoJCQkJfQogIAoJCQkJZnVuY3Rpb24gY29tcGFyZUJ5RGF5KGRhdGUxLCBkYXRlMikgewoJCQkJCWZ1bmN0aW9uIHNnbih2YWx1ZSkgewoJCQkJCQlyZXR1cm4gdmFsdWUgPCAwID8gLTEgOiB2YWx1ZSA+IDAgPyAxIDogMAoJCQkJCX0KCQkJCQl2YXIgY29tcGFyZTsKCQkJCQlpZiAoKGNvbXBhcmUgPSBzZ24oZGF0ZTEuZ2V0RnVsbFllYXIoKSAtIGRhdGUyLmdldEZ1bGxZZWFyKCkpKSA9PT0gMCkgewoJCQkJCQlpZiAoKGNvbXBhcmUgPSBzZ24oZGF0ZTEuZ2V0TW9udGgoKSAtIGRhdGUyLmdldE1vbnRoKCkpKSA9PT0gMCkgewoJCQkJCQkJY29tcGFyZSA9IHNnbihkYXRlMS5nZXREYXRlKCkgLSBkYXRlMi5nZXREYXRlKCkpCgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIGNvbXBhcmUKCQkJCX0KICAKCQkJCWZ1bmN0aW9uIGdldEZpcnN0V2Vla1N0YXJ0RGF0ZShqYW5Gb3VydGgpIHsKCQkJCQlzd2l0Y2ggKGphbkZvdXJ0aC5nZXREYXkoKSkgewoJCQkJCQljYXNlIDA6CgkJCQkJCQlyZXR1cm4gbmV3IERhdGUoamFuRm91cnRoLmdldEZ1bGxZZWFyKCkgLSAxLCAxMSwgMjkpOwoJCQkJCQljYXNlIDE6CgkJCQkJCQlyZXR1cm4gamFuRm91cnRoOwoJCQkJCQljYXNlIDI6CgkJCQkJCQlyZXR1cm4gbmV3IERhdGUoamFuRm91cnRoLmdldEZ1bGxZZWFyKCksIDAsIDMpOwoJCQkJCQljYXNlIDM6CgkJCQkJCQlyZXR1cm4gbmV3IERhdGUoamFuRm91cnRoLmdldEZ1bGxZZWFyKCksIDAsIDIpOwoJCQkJCQljYXNlIDQ6CgkJCQkJCQlyZXR1cm4gbmV3IERhdGUoamFuRm91cnRoLmdldEZ1bGxZZWFyKCksIDAsIDEpOwoJCQkJCQljYXNlIDU6CgkJCQkJCQlyZXR1cm4gbmV3IERhdGUoamFuRm91cnRoLmdldEZ1bGxZZWFyKCkgLSAxLCAxMSwgMzEpOwoJCQkJCQljYXNlIDY6CgkJCQkJCQlyZXR1cm4gbmV3IERhdGUoamFuRm91cnRoLmdldEZ1bGxZZWFyKCkgLSAxLCAxMSwgMzApCgkJCQkJfQoJCQkJfQogIAoJCQkJZnVuY3Rpb24gZ2V0V2Vla0Jhc2VkWWVhcihkYXRlKSB7CgkJCQkJdmFyIHRoaXNEYXRlID0gYWRkRGF5cyhuZXcgRGF0ZShkYXRlLnRtX3llYXIgKyAxOTAwLCAwLCAxKSwgZGF0ZS50bV95ZGF5KTsKCQkJCQl2YXIgamFuRm91cnRoVGhpc1llYXIgPSBuZXcgRGF0ZSh0aGlzRGF0ZS5nZXRGdWxsWWVhcigpLCAwLCA0KTsKCQkJCQl2YXIgamFuRm91cnRoTmV4dFllYXIgPSBuZXcgRGF0ZSh0aGlzRGF0ZS5nZXRGdWxsWWVhcigpICsgMSwgMCwgNCk7CgkJCQkJdmFyIGZpcnN0V2Vla1N0YXJ0VGhpc1llYXIgPSBnZXRGaXJzdFdlZWtTdGFydERhdGUoamFuRm91cnRoVGhpc1llYXIpOwoJCQkJCXZhciBmaXJzdFdlZWtTdGFydE5leHRZZWFyID0gZ2V0Rmlyc3RXZWVrU3RhcnREYXRlKGphbkZvdXJ0aE5leHRZZWFyKTsKCQkJCQlpZiAoY29tcGFyZUJ5RGF5KGZpcnN0V2Vla1N0YXJ0VGhpc1llYXIsIHRoaXNEYXRlKSA8PSAwKSB7CgkJCQkJCWlmIChjb21wYXJlQnlEYXkoZmlyc3RXZWVrU3RhcnROZXh0WWVhciwgdGhpc0RhdGUpIDw9IDApIHsKCQkJCQkJCXJldHVybiB0aGlzRGF0ZS5nZXRGdWxsWWVhcigpICsgMQoJCQkJCQl9CgkJCQkJCXJldHVybiB0aGlzRGF0ZS5nZXRGdWxsWWVhcigpCgkJCQkJfQoJCQkJCXJldHVybiB0aGlzRGF0ZS5nZXRGdWxsWWVhcigpIC0gMQoJCQkJfQoJCQkJdmFyIEVYUEFOU0lPTl9SVUxFU18yID0gewoJCQkJCSIlYSI6IGZ1bmN0aW9uKGRhdGUpIHsKCQkJCQkJcmV0dXJuIFdFRUtEQVlTW2RhdGUudG1fd2RheV0uc3Vic3RyaW5nKDAsIDMpCgkJCQkJfSwKCQkJCQkiJUEiOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCXJldHVybiBXRUVLREFZU1tkYXRlLnRtX3dkYXldCgkJCQkJfSwKCQkJCQkiJWIiOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCXJldHVybiBNT05USFNbZGF0ZS50bV9tb25dLnN1YnN0cmluZygwLCAzKQoJCQkJCX0sCgkJCQkJIiVCIjogZnVuY3Rpb24oZGF0ZSkgewoJCQkJCQlyZXR1cm4gTU9OVEhTW2RhdGUudG1fbW9uXQoJCQkJCX0sCgkJCQkJIiVDIjogZnVuY3Rpb24oZGF0ZSkgewoJCQkJCQl2YXIgeWVhciA9IGRhdGUudG1feWVhciArIDE5MDA7CgkJCQkJCXJldHVybiBsZWFkaW5nTnVsbHMoeWVhciAvIDEwMCB8IDAsIDIpCgkJCQkJfSwKCQkJCQkiJWQiOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCXJldHVybiBsZWFkaW5nTnVsbHMoZGF0ZS50bV9tZGF5LCAyKQoJCQkJCX0sCgkJCQkJIiVlIjogZnVuY3Rpb24oZGF0ZSkgewoJCQkJCQlyZXR1cm4gbGVhZGluZ1NvbWV0aGluZyhkYXRlLnRtX21kYXksIDIsICIgIikKCQkJCQl9LAoJCQkJCSIlZyI6IGZ1bmN0aW9uKGRhdGUpIHsKCQkJCQkJcmV0dXJuIGdldFdlZWtCYXNlZFllYXIoZGF0ZSkudG9TdHJpbmcoKS5zdWJzdHJpbmcoMikKCQkJCQl9LAoJCQkJCSIlRyI6IGZ1bmN0aW9uKGRhdGUpIHsKCQkJCQkJcmV0dXJuIGdldFdlZWtCYXNlZFllYXIoZGF0ZSkKCQkJCQl9LAoJCQkJCSIlSCI6IGZ1bmN0aW9uKGRhdGUpIHsKCQkJCQkJcmV0dXJuIGxlYWRpbmdOdWxscyhkYXRlLnRtX2hvdXIsIDIpCgkJCQkJfSwKCQkJCQkiJUkiOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCXZhciB0d2VsdmVIb3VyID0gZGF0ZS50bV9ob3VyOwoJCQkJCQlpZiAodHdlbHZlSG91ciA9PSAwKSB0d2VsdmVIb3VyID0gMTI7CgkJCQkJCWVsc2UgaWYgKHR3ZWx2ZUhvdXIgPiAxMikgdHdlbHZlSG91ciAtPSAxMjsKCQkJCQkJcmV0dXJuIGxlYWRpbmdOdWxscyh0d2VsdmVIb3VyLCAyKQoJCQkJCX0sCgkJCQkJIiVqIjogZnVuY3Rpb24oZGF0ZSkgewoJCQkJCQlyZXR1cm4gbGVhZGluZ051bGxzKGRhdGUudG1fbWRheSArIGFycmF5U3VtKGlzTGVhcFllYXIoZGF0ZS50bV95ZWFyICsgMTkwMCkgPyBNT05USF9EQVlTX0xFQVAgOiBNT05USF9EQVlTX1JFR1VMQVIsIGRhdGUudG1fbW9uIC0gMSksIDMpCgkJCQkJfSwKCQkJCQkiJW0iOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCXJldHVybiBsZWFkaW5nTnVsbHMoZGF0ZS50bV9tb24gKyAxLCAyKQoJCQkJCX0sCgkJCQkJIiVNIjogZnVuY3Rpb24oZGF0ZSkgewoJCQkJCQlyZXR1cm4gbGVhZGluZ051bGxzKGRhdGUudG1fbWluLCAyKQoJCQkJCX0sCgkJCQkJIiVuIjogZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiAiXG4iCgkJCQkJfSwKCQkJCQkiJXAiOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCWlmIChkYXRlLnRtX2hvdXIgPj0gMCAmJiBkYXRlLnRtX2hvdXIgPCAxMikgewoJCQkJCQkJcmV0dXJuICJBTSIKCQkJCQkJfQoJCQkJCQlyZXR1cm4gIlBNIgoJCQkJCX0sCgkJCQkJIiVTIjogZnVuY3Rpb24oZGF0ZSkgewoJCQkJCQlyZXR1cm4gbGVhZGluZ051bGxzKGRhdGUudG1fc2VjLCAyKQoJCQkJCX0sCgkJCQkJIiV0IjogZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiAiXHQiCgkJCQkJfSwKCQkJCQkiJXUiOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCXJldHVybiBkYXRlLnRtX3dkYXkgfHwgNwoJCQkJCX0sCgkJCQkJIiVVIjogZnVuY3Rpb24oZGF0ZSkgewoJCQkJCQl2YXIgZGF5cyA9IGRhdGUudG1feWRheSArIDcgLSBkYXRlLnRtX3dkYXk7CgkJCQkJCXJldHVybiBsZWFkaW5nTnVsbHMoTWF0aC5mbG9vcihkYXlzIC8gNyksIDIpCgkJCQkJfSwKCQkJCQkiJVYiOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCXZhciB2YWwgPSBNYXRoLmZsb29yKChkYXRlLnRtX3lkYXkgKyA3IC0gKGRhdGUudG1fd2RheSArIDYpICUgNykgLyA3KTsKCQkJCQkJaWYgKChkYXRlLnRtX3dkYXkgKyAzNzEgLSBkYXRlLnRtX3lkYXkgLSAyKSAlIDcgPD0gMikgewoJCQkJCQkJdmFsKysKCQkJCQkJfQoJCQkJCQlpZiAoIXZhbCkgewoJCQkJCQkJdmFsID0gNTI7CgkJCQkJCQl2YXIgZGVjMzEgPSAoZGF0ZS50bV93ZGF5ICsgNyAtIGRhdGUudG1feWRheSAtIDEpICUgNzsKCQkJCQkJCWlmIChkZWMzMSA9PSA0IHx8IGRlYzMxID09IDUgJiYgaXNMZWFwWWVhcihkYXRlLnRtX3llYXIgJSA0MDAgLSAxKSkgewoJCQkJCQkJCXZhbCsrCgkJCQkJCQl9CgkJCQkJCX0gZWxzZSBpZiAodmFsID09IDUzKSB7CgkJCQkJCQl2YXIgamFuMSA9IChkYXRlLnRtX3dkYXkgKyAzNzEgLSBkYXRlLnRtX3lkYXkpICUgNzsKCQkJCQkJCWlmIChqYW4xICE9IDQgJiYgKGphbjEgIT0gMyB8fCAhaXNMZWFwWWVhcihkYXRlLnRtX3llYXIpKSkgdmFsID0gMQoJCQkJCQl9CgkJCQkJCXJldHVybiBsZWFkaW5nTnVsbHModmFsLCAyKQoJCQkJCX0sCgkJCQkJIiV3IjogZnVuY3Rpb24oZGF0ZSkgewoJCQkJCQlyZXR1cm4gZGF0ZS50bV93ZGF5CgkJCQkJfSwKCQkJCQkiJVciOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCXZhciBkYXlzID0gZGF0ZS50bV95ZGF5ICsgNyAtIChkYXRlLnRtX3dkYXkgKyA2KSAlIDc7CgkJCQkJCXJldHVybiBsZWFkaW5nTnVsbHMoTWF0aC5mbG9vcihkYXlzIC8gNyksIDIpCgkJCQkJfSwKCQkJCQkiJXkiOiBmdW5jdGlvbihkYXRlKSB7CgkJCQkJCXJldHVybiAoZGF0ZS50bV95ZWFyICsgMTkwMCkudG9TdHJpbmcoKS5zdWJzdHJpbmcoMikKCQkJCQl9LAoJCQkJCSIlWSI6IGZ1bmN0aW9uKGRhdGUpIHsKCQkJCQkJcmV0dXJuIGRhdGUudG1feWVhciArIDE5MDAKCQkJCQl9LAoJCQkJCSIleiI6IGZ1bmN0aW9uKGRhdGUpIHsKCQkJCQkJdmFyIG9mZiA9IGRhdGUudG1fZ210b2ZmOwoJCQkJCQl2YXIgYWhlYWQgPSBvZmYgPj0gMDsKCQkJCQkJb2ZmID0gTWF0aC5hYnMob2ZmKSAvIDYwOwoJCQkJCQlvZmYgPSBvZmYgLyA2MCAqIDEwMCArIG9mZiAlIDYwOwoJCQkJCQlyZXR1cm4gKGFoZWFkID8gIisiIDogIi0iKSArIFN0cmluZygiMDAwMCIgKyBvZmYpLnNsaWNlKC00KQoJCQkJCX0sCgkJCQkJIiVaIjogZnVuY3Rpb24oZGF0ZSkgewoJCQkJCQlyZXR1cm4gZGF0ZS50bV96b25lCgkJCQkJfSwKCQkJCQkiJSUiOiBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuICIlIgoJCQkJCX0KCQkJCX07CgkJCQlwYXR0ZXJuID0gcGF0dGVybi5yZXBsYWNlKC8lJS9nLCAiXDBcMCIpOwoJCQkJZm9yICh2YXIgcnVsZSBpbiBFWFBBTlNJT05fUlVMRVNfMikgewoJCQkJCWlmIChwYXR0ZXJuLmluY2x1ZGVzKHJ1bGUpKSB7CgkJCQkJCXBhdHRlcm4gPSBwYXR0ZXJuLnJlcGxhY2UobmV3IFJlZ0V4cChydWxlLCAiZyIpLCBFWFBBTlNJT05fUlVMRVNfMltydWxlXShkYXRlKSkKCQkJCQl9CgkJCQl9CgkJCQlwYXR0ZXJuID0gcGF0dGVybi5yZXBsYWNlKC9cMFwwL2csICIlIik7CgkJCQl2YXIgYnl0ZXMgPSBpbnRBcnJheUZyb21TdHJpbmcocGF0dGVybiwgZmFsc2UpOwoJCQkJaWYgKGJ5dGVzLmxlbmd0aCA+IG1heHNpemUpIHsKCQkJCQlyZXR1cm4gMAoJCQkJfQoJCQkJd3JpdGVBcnJheVRvTWVtb3J5KGJ5dGVzLCBzKTsKCQkJCXJldHVybiBieXRlcy5sZW5ndGggLSAxCgkJCX0KICAKCQkJZnVuY3Rpb24gcnVuQW5kQWJvcnRJZkVycm9yKGZ1bmMpIHsKCQkJCXRyeSB7CgkJCQkJcmV0dXJuIGZ1bmMoKQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCWFib3J0KGUpCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gaGFuZGxlRXhjZXB0aW9uKGUpIHsKCQkJCWlmIChlIGluc3RhbmNlb2YgRXhpdFN0YXR1cyB8fCBlID09ICJ1bndpbmQiKSB7CgkJCQkJcmV0dXJuIEVYSVRTVEFUVVMKCQkJCX0KCQkJCXF1aXRfKDEsIGUpCgkJCX0KICAKCQkJZnVuY3Rpb24gbWF5YmVFeGl0KCkgewoJCQkJaWYgKCFrZWVwUnVudGltZUFsaXZlKCkpIHsKCQkJCQl0cnkgewoJCQkJCQlfZXhpdChFWElUU1RBVFVTKQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJaGFuZGxlRXhjZXB0aW9uKGUpCgkJCQkJfQoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGNhbGxVc2VyQ2FsbGJhY2soZnVuYykgewoJCQkJaWYgKEFCT1JUKSB7CgkJCQkJcmV0dXJuCgkJCQl9CgkJCQl0cnkgewoJCQkJCWZ1bmMoKTsKCQkJCQltYXliZUV4aXQoKQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCWhhbmRsZUV4Y2VwdGlvbihlKQoJCQkJfQoJCQl9CgkJCXZhciBBc3luY2lmeSA9IHsKCQkJCWluc3RydW1lbnRXYXNtSW1wb3J0czogZnVuY3Rpb24oaW1wb3J0cykgewoJCQkJCXZhciBpbXBvcnRQYXR0ZXJucyA9IFsvXmludm9rZV8uKiQvLCAvXmZkX3N5bmMkLywgL15fX3dhc2lfZmRfc3luYyQvLCAvXl9fYXN5bmNqc19fLiokLywgL15lbXNjcmlwdGVuX2lkYl9sb2FkJC8sIC9eZW1zY3JpcHRlbl9pZGJfc3RvcmUkLywgL15lbXNjcmlwdGVuX2lkYl9kZWxldGUkLywgL15lbXNjcmlwdGVuX2lkYl9leGlzdHMkLywgL15lbXNjcmlwdGVuX2lkYl9sb2FkX2Jsb2IkLywgL15lbXNjcmlwdGVuX2lkYl9zdG9yZV9ibG9iJC8sIC9eZW1zY3JpcHRlbl9zbGVlcCQvLCAvXmVtc2NyaXB0ZW5fd2dldCQvLCAvXmVtc2NyaXB0ZW5fd2dldF9kYXRhJC8sIC9eZW1zY3JpcHRlbl9zY2FuX3JlZ2lzdGVycyQvLCAvXmVtc2NyaXB0ZW5fbGF6eV9sb2FkX2NvZGUkLywgL15fbG9hZF9zZWNvbmRhcnlfbW9kdWxlJC8sIC9eZW1zY3JpcHRlbl9maWJlcl9zd2FwJC8sIC9eU0RMX0RlbGF5JC9dOwoJCQkJCWZvciAodmFyIHggaW4gaW1wb3J0cykgewoJCQkJCQkoZnVuY3Rpb24oeCkgewoJCQkJCQkJdmFyIG9yaWdpbmFsID0gaW1wb3J0c1t4XTsKCQkJCQkJCXZhciBzaWcgPSBvcmlnaW5hbC5zaWc7CgkJCQkJCQlpZiAodHlwZW9mIG9yaWdpbmFsID09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQl2YXIgaXNBc3luY2lmeUltcG9ydCA9IG9yaWdpbmFsLmlzQXN5bmMgfHwgaW1wb3J0UGF0dGVybnMuc29tZShwYXR0ZXJuID0+ICEheC5tYXRjaChwYXR0ZXJuKSkKCQkJCQkJCX0KCQkJCQkJfSkoeCkKCQkJCQl9CgkJCQl9LAoJCQkJaW5zdHJ1bWVudFdhc21FeHBvcnRzOiBmdW5jdGlvbihleHBvcnRzKSB7CgkJCQkJdmFyIHJldCA9IHt9OwoJCQkJCWZvciAodmFyIHggaW4gZXhwb3J0cykgewoJCQkJCQkoZnVuY3Rpb24oeCkgewoJCQkJCQkJdmFyIG9yaWdpbmFsID0gZXhwb3J0c1t4XTsKCQkJCQkJCWlmICh0eXBlb2Ygb3JpZ2luYWwgPT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldFt4XSA9IGZ1bmN0aW9uKCkgewoJCQkJCQkJCQlBc3luY2lmeS5leHBvcnRDYWxsU3RhY2sucHVzaCh4KTsKCQkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJCXJldHVybiBvcmlnaW5hbC5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCQkJCQkJCX0gZmluYWxseSB7CgkJCQkJCQkJCQlpZiAoIUFCT1JUKSB7CgkJCQkJCQkJCQkJdmFyIHkgPSBBc3luY2lmeS5leHBvcnRDYWxsU3RhY2sucG9wKCk7CgkJCQkJCQkJCQkJYXNzZXJ0KHkgPT09IHgpOwoJCQkJCQkJCQkJCUFzeW5jaWZ5Lm1heWJlU3RvcFVud2luZCgpCgkJCQkJCQkJCQl9CgkJCQkJCQkJCX0KCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXJldFt4XSA9IG9yaWdpbmFsCgkJCQkJCQl9CgkJCQkJCX0pKHgpCgkJCQkJfQoJCQkJCXJldHVybiByZXQKCQkJCX0sCgkJCQlTdGF0ZTogewoJCQkJCU5vcm1hbDogMCwKCQkJCQlVbndpbmRpbmc6IDEsCgkJCQkJUmV3aW5kaW5nOiAyLAoJCQkJCURpc2FibGVkOiAzCgkJCQl9LAoJCQkJc3RhdGU6IDAsCgkJCQlTdGFja1NpemU6IDQwOTYsCgkJCQljdXJyRGF0YTogbnVsbCwKCQkJCWhhbmRsZVNsZWVwUmV0dXJuVmFsdWU6IDAsCgkJCQlleHBvcnRDYWxsU3RhY2s6IFtdLAoJCQkJY2FsbFN0YWNrTmFtZVRvSWQ6IHt9LAoJCQkJY2FsbFN0YWNrSWRUb05hbWU6IHt9LAoJCQkJY2FsbFN0YWNrSWQ6IDAsCgkJCQlhc3luY1Byb21pc2VIYW5kbGVyczogbnVsbCwKCQkJCXNsZWVwQ2FsbGJhY2tzOiBbXSwKCQkJCWdldENhbGxTdGFja0lkOiBmdW5jdGlvbihmdW5jTmFtZSkgewoJCQkJCXZhciBpZCA9IEFzeW5jaWZ5LmNhbGxTdGFja05hbWVUb0lkW2Z1bmNOYW1lXTsKCQkJCQlpZiAoaWQgPT09IHVuZGVmaW5lZCkgewoJCQkJCQlpZCA9IEFzeW5jaWZ5LmNhbGxTdGFja0lkKys7CgkJCQkJCUFzeW5jaWZ5LmNhbGxTdGFja05hbWVUb0lkW2Z1bmNOYW1lXSA9IGlkOwoJCQkJCQlBc3luY2lmeS5jYWxsU3RhY2tJZFRvTmFtZVtpZF0gPSBmdW5jTmFtZQoJCQkJCX0KCQkJCQlyZXR1cm4gaWQKCQkJCX0sCgkJCQltYXliZVN0b3BVbndpbmQ6IGZ1bmN0aW9uKCkgewoJCQkJCWlmIChBc3luY2lmeS5jdXJyRGF0YSAmJiBBc3luY2lmeS5zdGF0ZSA9PT0gQXN5bmNpZnkuU3RhdGUuVW53aW5kaW5nICYmIEFzeW5jaWZ5LmV4cG9ydENhbGxTdGFjay5sZW5ndGggPT09IDApIHsKCQkJCQkJQXN5bmNpZnkuc3RhdGUgPSBBc3luY2lmeS5TdGF0ZS5Ob3JtYWw7CgkJCQkJCXJ1bkFuZEFib3J0SWZFcnJvcihfYXN5bmNpZnlfc3RvcF91bndpbmQpOwoJCQkJCQlpZiAodHlwZW9mIEZpYmVycyAhPSAidW5kZWZpbmVkIikgewoJCQkJCQkJRmliZXJzLnRyYW1wb2xpbmUoKQoJCQkJCQl9CgkJCQkJfQoJCQkJfSwKCQkJCXdoZW5Eb25lOiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJCQlBc3luY2lmeS5hc3luY1Byb21pc2VIYW5kbGVycyA9IHsKCQkJCQkJCXJlc29sdmU6IHJlc29sdmUsCgkJCQkJCQlyZWplY3Q6IHJlamVjdAoJCQkJCQl9CgkJCQkJfSkKCQkJCX0sCgkJCQlhbGxvY2F0ZURhdGE6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciBwdHIgPSBfbWFsbG9jKDEyICsgQXN5bmNpZnkuU3RhY2tTaXplKTsKCQkJCQlBc3luY2lmeS5zZXREYXRhSGVhZGVyKHB0ciwgcHRyICsgMTIsIEFzeW5jaWZ5LlN0YWNrU2l6ZSk7CgkJCQkJQXN5bmNpZnkuc2V0RGF0YVJld2luZEZ1bmMocHRyKTsKCQkJCQlyZXR1cm4gcHRyCgkJCQl9LAoJCQkJc2V0RGF0YUhlYWRlcjogZnVuY3Rpb24ocHRyLCBzdGFjaywgc3RhY2tTaXplKSB7CgkJCQkJSEVBUDMyW3B0ciA+PiAyXSA9IHN0YWNrOwoJCQkJCUhFQVAzMltwdHIgKyA0ID4+IDJdID0gc3RhY2sgKyBzdGFja1NpemUKCQkJCX0sCgkJCQlzZXREYXRhUmV3aW5kRnVuYzogZnVuY3Rpb24ocHRyKSB7CgkJCQkJdmFyIGJvdHRvbU9mQ2FsbFN0YWNrID0gQXN5bmNpZnkuZXhwb3J0Q2FsbFN0YWNrWzBdOwoJCQkJCXZhciByZXdpbmRJZCA9IEFzeW5jaWZ5LmdldENhbGxTdGFja0lkKGJvdHRvbU9mQ2FsbFN0YWNrKTsKCQkJCQlIRUFQMzJbcHRyICsgOCA+PiAyXSA9IHJld2luZElkCgkJCQl9LAoJCQkJZ2V0RGF0YVJld2luZEZ1bmM6IGZ1bmN0aW9uKHB0cikgewoJCQkJCXZhciBpZCA9IEhFQVAzMltwdHIgKyA4ID4+IDJdOwoJCQkJCXZhciBuYW1lID0gQXN5bmNpZnkuY2FsbFN0YWNrSWRUb05hbWVbaWRdOwoJCQkJCXZhciBmdW5jID0gTW9kdWxlWyJhc20iXVtuYW1lXTsKCQkJCQlyZXR1cm4gZnVuYwoJCQkJfSwKCQkJCWRvUmV3aW5kOiBmdW5jdGlvbihwdHIpIHsKCQkJCQl2YXIgc3RhcnQgPSBBc3luY2lmeS5nZXREYXRhUmV3aW5kRnVuYyhwdHIpOwoJCQkJCXJldHVybiBzdGFydCgpCgkJCQl9LAoJCQkJaGFuZGxlU2xlZXA6IGZ1bmN0aW9uKHN0YXJ0QXN5bmMpIHsKCQkJCQlpZiAoQUJPUlQpIHJldHVybjsKCQkJCQlpZiAoQXN5bmNpZnkuc3RhdGUgPT09IEFzeW5jaWZ5LlN0YXRlLk5vcm1hbCkgewoJCQkJCQl2YXIgcmVhY2hlZENhbGxiYWNrID0gZmFsc2U7CgkJCQkJCXZhciByZWFjaGVkQWZ0ZXJDYWxsYmFjayA9IGZhbHNlOwoJCQkJCQlzdGFydEFzeW5jKChoYW5kbGVTbGVlcFJldHVyblZhbHVlID0gMCkgPT4gewoJCQkJCQkJaWYgKEFCT1JUKSByZXR1cm47CgkJCQkJCQlBc3luY2lmeS5oYW5kbGVTbGVlcFJldHVyblZhbHVlID0gaGFuZGxlU2xlZXBSZXR1cm5WYWx1ZTsKCQkJCQkJCXJlYWNoZWRDYWxsYmFjayA9IHRydWU7CgkJCQkJCQlpZiAoIXJlYWNoZWRBZnRlckNhbGxiYWNrKSB7CgkJCQkJCQkJcmV0dXJuCgkJCQkJCQl9CgkJCQkJCQlBc3luY2lmeS5zdGF0ZSA9IEFzeW5jaWZ5LlN0YXRlLlJld2luZGluZzsKCQkJCQkJCXJ1bkFuZEFib3J0SWZFcnJvcigoKSA9PiBfYXN5bmNpZnlfc3RhcnRfcmV3aW5kKEFzeW5jaWZ5LmN1cnJEYXRhKSk7CgkJCQkJCQlpZiAodHlwZW9mIEJyb3dzZXIgIT0gInVuZGVmaW5lZCIgJiYgQnJvd3Nlci5tYWluTG9vcC5mdW5jKSB7CgkJCQkJCQkJQnJvd3Nlci5tYWluTG9vcC5yZXN1bWUoKQoJCQkJCQkJfQoJCQkJCQkJdmFyIGFzeW5jV2FzbVJldHVyblZhbHVlLCBpc0Vycm9yID0gZmFsc2U7CgkJCQkJCQl0cnkgewoJCQkJCQkJCWFzeW5jV2FzbVJldHVyblZhbHVlID0gQXN5bmNpZnkuZG9SZXdpbmQoQXN5bmNpZnkuY3VyckRhdGEpCgkJCQkJCQl9IGNhdGNoIChlcnIpIHsKCQkJCQkJCQlhc3luY1dhc21SZXR1cm5WYWx1ZSA9IGVycjsKCQkJCQkJCQlpc0Vycm9yID0gdHJ1ZQoJCQkJCQkJfQoJCQkJCQkJdmFyIGhhbmRsZWQgPSBmYWxzZTsKCQkJCQkJCWlmICghQXN5bmNpZnkuY3VyckRhdGEpIHsKCQkJCQkJCQl2YXIgYXN5bmNQcm9taXNlSGFuZGxlcnMgPSBBc3luY2lmeS5hc3luY1Byb21pc2VIYW5kbGVyczsKCQkJCQkJCQlpZiAoYXN5bmNQcm9taXNlSGFuZGxlcnMpIHsKCQkJCQkJCQkJQXN5bmNpZnkuYXN5bmNQcm9taXNlSGFuZGxlcnMgPSBudWxsOwoJCQkJCQkJCQkoaXNFcnJvciA/IGFzeW5jUHJvbWlzZUhhbmRsZXJzLnJlamVjdCA6IGFzeW5jUHJvbWlzZUhhbmRsZXJzLnJlc29sdmUpKGFzeW5jV2FzbVJldHVyblZhbHVlKTsKCQkJCQkJCQkJaGFuZGxlZCA9IHRydWUKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCQlpZiAoaXNFcnJvciAmJiAhaGFuZGxlZCkgewoJCQkJCQkJCXRocm93IGFzeW5jV2FzbVJldHVyblZhbHVlCgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlyZWFjaGVkQWZ0ZXJDYWxsYmFjayA9IHRydWU7CgkJCQkJCWlmICghcmVhY2hlZENhbGxiYWNrKSB7CgkJCQkJCQlBc3luY2lmeS5zdGF0ZSA9IEFzeW5jaWZ5LlN0YXRlLlVud2luZGluZzsKCQkJCQkJCUFzeW5jaWZ5LmN1cnJEYXRhID0gQXN5bmNpZnkuYWxsb2NhdGVEYXRhKCk7CgkJCQkJCQlpZiAodHlwZW9mIEJyb3dzZXIgIT0gInVuZGVmaW5lZCIgJiYgQnJvd3Nlci5tYWluTG9vcC5mdW5jKSB7CgkJCQkJCQkJQnJvd3Nlci5tYWluTG9vcC5wYXVzZSgpCgkJCQkJCQl9CgkJCQkJCQlydW5BbmRBYm9ydElmRXJyb3IoKCkgPT4gX2FzeW5jaWZ5X3N0YXJ0X3Vud2luZChBc3luY2lmeS5jdXJyRGF0YSkpCgkJCQkJCX0KCQkJCQl9IGVsc2UgaWYgKEFzeW5jaWZ5LnN0YXRlID09PSBBc3luY2lmeS5TdGF0ZS5SZXdpbmRpbmcpIHsKCQkJCQkJQXN5bmNpZnkuc3RhdGUgPSBBc3luY2lmeS5TdGF0ZS5Ob3JtYWw7CgkJCQkJCXJ1bkFuZEFib3J0SWZFcnJvcihfYXN5bmNpZnlfc3RvcF9yZXdpbmQpOwoJCQkJCQlfZnJlZShBc3luY2lmeS5jdXJyRGF0YSk7CgkJCQkJCUFzeW5jaWZ5LmN1cnJEYXRhID0gbnVsbDsKCQkJCQkJQXN5bmNpZnkuc2xlZXBDYWxsYmFja3MuZm9yRWFjaChmdW5jID0+IGNhbGxVc2VyQ2FsbGJhY2soZnVuYykpCgkJCQkJfSBlbHNlIHsKCQkJCQkJYWJvcnQoImludmFsaWQgc3RhdGU6ICIgKyBBc3luY2lmeS5zdGF0ZSkKCQkJCQl9CgkJCQkJcmV0dXJuIEFzeW5jaWZ5LmhhbmRsZVNsZWVwUmV0dXJuVmFsdWUKCQkJCX0sCgkJCQloYW5kbGVBc3luYzogZnVuY3Rpb24oc3RhcnRBc3luYykgewoJCQkJCXJldHVybiBBc3luY2lmeS5oYW5kbGVTbGVlcCh3YWtlVXAgPT4gewoJCQkJCQlzdGFydEFzeW5jKCkudGhlbih3YWtlVXApCgkJCQkJfSkKCQkJCX0KCQkJfTsKCQkJdmFyIEFMTE9DX05PUk1BTCA9IDA7CgkJCXZhciBBTExPQ19TVEFDSyA9IDE7CiAgCgkJCWZ1bmN0aW9uIGFsbG9jYXRlKHNsYWIsIGFsbG9jYXRvcikgewoJCQkJdmFyIHJldDsKCQkJCWlmIChhbGxvY2F0b3IgPT0gQUxMT0NfU1RBQ0spIHsKCQkJCQlyZXQgPSBzdGFja0FsbG9jKHNsYWIubGVuZ3RoKQoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBfbWFsbG9jKHNsYWIubGVuZ3RoKQoJCQkJfQoJCQkJaWYgKCFzbGFiLnN1YmFycmF5ICYmICFzbGFiLnNsaWNlKSB7CgkJCQkJc2xhYiA9IG5ldyBVaW50OEFycmF5KHNsYWIpCgkJCQl9CgkJCQlIRUFQVTguc2V0KHNsYWIsIHJldCk7CgkJCQlyZXR1cm4gcmV0CgkJCX0KCQkJdmFyIEZTTm9kZSA9IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSwgbW9kZSwgcmRldikgewoJCQkJaWYgKCFwYXJlbnQpIHsKCQkJCQlwYXJlbnQgPSB0aGlzCgkJCQl9CgkJCQl0aGlzLnBhcmVudCA9IHBhcmVudDsKCQkJCXRoaXMubW91bnQgPSBwYXJlbnQubW91bnQ7CgkJCQl0aGlzLm1vdW50ZWQgPSBudWxsOwoJCQkJdGhpcy5pZCA9IEZTLm5leHRJbm9kZSsrOwoJCQkJdGhpcy5uYW1lID0gbmFtZTsKCQkJCXRoaXMubW9kZSA9IG1vZGU7CgkJCQl0aGlzLm5vZGVfb3BzID0ge307CgkJCQl0aGlzLnN0cmVhbV9vcHMgPSB7fTsKCQkJCXRoaXMucmRldiA9IHJkZXYKCQkJfTsKCQkJdmFyIHJlYWRNb2RlID0gMjkyIHwgNzM7CgkJCXZhciB3cml0ZU1vZGUgPSAxNDY7CgkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEZTTm9kZS5wcm90b3R5cGUsIHsKCQkJCXJlYWQ6IHsKCQkJCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gKHRoaXMubW9kZSAmIHJlYWRNb2RlKSA9PT0gcmVhZE1vZGUKCQkJCQl9LAoJCQkJCXNldDogZnVuY3Rpb24odmFsKSB7CgkJCQkJCXZhbCA/IHRoaXMubW9kZSB8PSByZWFkTW9kZSA6IHRoaXMubW9kZSAmPSB+cmVhZE1vZGUKCQkJCQl9CgkJCQl9LAoJCQkJd3JpdGU6IHsKCQkJCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gKHRoaXMubW9kZSAmIHdyaXRlTW9kZSkgPT09IHdyaXRlTW9kZQoJCQkJCX0sCgkJCQkJc2V0OiBmdW5jdGlvbih2YWwpIHsKCQkJCQkJdmFsID8gdGhpcy5tb2RlIHw9IHdyaXRlTW9kZSA6IHRoaXMubW9kZSAmPSB+d3JpdGVNb2RlCgkJCQkJfQoJCQkJfSwKCQkJCWlzRm9sZGVyOiB7CgkJCQkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIEZTLmlzRGlyKHRoaXMubW9kZSkKCQkJCQl9CgkJCQl9LAoJCQkJaXNEZXZpY2U6IHsKCQkJCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gRlMuaXNDaHJkZXYodGhpcy5tb2RlKQoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJCUZTLkZTTm9kZSA9IEZTTm9kZTsKCQkJRlMuY3JlYXRlUHJlbG9hZGVkRmlsZSA9IEZTX2NyZWF0ZVByZWxvYWRlZEZpbGU7CgkJCUZTLnN0YXRpY0luaXQoKTsKCQkJTW9kdWxlWyJGU19jcmVhdGVEYXRhRmlsZSJdID0gRlMuY3JlYXRlRGF0YUZpbGU7CgkJCU1vZHVsZVsiRlNfY3JlYXRlUGF0aCJdID0gRlMuY3JlYXRlUGF0aDsKCQkJTW9kdWxlWyJGU19jcmVhdGVEYXRhRmlsZSJdID0gRlMuY3JlYXRlRGF0YUZpbGU7CgkJCU1vZHVsZVsiRlNfY3JlYXRlUHJlbG9hZGVkRmlsZSJdID0gRlMuY3JlYXRlUHJlbG9hZGVkRmlsZTsKCQkJTW9kdWxlWyJGU191bmxpbmsiXSA9IEZTLnVubGluazsKCQkJTW9kdWxlWyJGU19jcmVhdGVMYXp5RmlsZSJdID0gRlMuY3JlYXRlTGF6eUZpbGU7CgkJCU1vZHVsZVsiRlNfY3JlYXRlRGV2aWNlIl0gPSBGUy5jcmVhdGVEZXZpY2U7CgkJCUVSUk5PX0NPREVTID0gewoJCQkJIkVQRVJNIjogNjMsCgkJCQkiRU5PRU5UIjogNDQsCgkJCQkiRVNSQ0giOiA3MSwKCQkJCSJFSU5UUiI6IDI3LAoJCQkJIkVJTyI6IDI5LAoJCQkJIkVOWElPIjogNjAsCgkJCQkiRTJCSUciOiAxLAoJCQkJIkVOT0VYRUMiOiA0NSwKCQkJCSJFQkFERiI6IDgsCgkJCQkiRUNISUxEIjogMTIsCgkJCQkiRUFHQUlOIjogNiwKCQkJCSJFV09VTERCTE9DSyI6IDYsCgkJCQkiRU5PTUVNIjogNDgsCgkJCQkiRUFDQ0VTIjogMiwKCQkJCSJFRkFVTFQiOiAyMSwKCQkJCSJFTk9UQkxLIjogMTA1LAoJCQkJIkVCVVNZIjogMTAsCgkJCQkiRUVYSVNUIjogMjAsCgkJCQkiRVhERVYiOiA3NSwKCQkJCSJFTk9ERVYiOiA0MywKCQkJCSJFTk9URElSIjogNTQsCgkJCQkiRUlTRElSIjogMzEsCgkJCQkiRUlOVkFMIjogMjgsCgkJCQkiRU5GSUxFIjogNDEsCgkJCQkiRU1GSUxFIjogMzMsCgkJCQkiRU5PVFRZIjogNTksCgkJCQkiRVRYVEJTWSI6IDc0LAoJCQkJIkVGQklHIjogMjIsCgkJCQkiRU5PU1BDIjogNTEsCgkJCQkiRVNQSVBFIjogNzAsCgkJCQkiRVJPRlMiOiA2OSwKCQkJCSJFTUxJTksiOiAzNCwKCQkJCSJFUElQRSI6IDY0LAoJCQkJIkVET00iOiAxOCwKCQkJCSJFUkFOR0UiOiA2OCwKCQkJCSJFTk9NU0ciOiA0OSwKCQkJCSJFSURSTSI6IDI0LAoJCQkJIkVDSFJORyI6IDEwNiwKCQkJCSJFTDJOU1lOQyI6IDE1NiwKCQkJCSJFTDNITFQiOiAxMDcsCgkJCQkiRUwzUlNUIjogMTA4LAoJCQkJIkVMTlJORyI6IDEwOSwKCQkJCSJFVU5BVENIIjogMTEwLAoJCQkJIkVOT0NTSSI6IDExMSwKCQkJCSJFTDJITFQiOiAxMTIsCgkJCQkiRURFQURMSyI6IDE2LAoJCQkJIkVOT0xDSyI6IDQ2LAoJCQkJIkVCQURFIjogMTEzLAoJCQkJIkVCQURSIjogMTE0LAoJCQkJIkVYRlVMTCI6IDExNSwKCQkJCSJFTk9BTk8iOiAxMDQsCgkJCQkiRUJBRFJRQyI6IDEwMywKCQkJCSJFQkFEU0xUIjogMTAyLAoJCQkJIkVERUFETE9DSyI6IDE2LAoJCQkJIkVCRk9OVCI6IDEwMSwKCQkJCSJFTk9TVFIiOiAxMDAsCgkJCQkiRU5PREFUQSI6IDExNiwKCQkJCSJFVElNRSI6IDExNywKCQkJCSJFTk9TUiI6IDExOCwKCQkJCSJFTk9ORVQiOiAxMTksCgkJCQkiRU5PUEtHIjogMTIwLAoJCQkJIkVSRU1PVEUiOiAxMjEsCgkJCQkiRU5PTElOSyI6IDQ3LAoJCQkJIkVBRFYiOiAxMjIsCgkJCQkiRVNSTU5UIjogMTIzLAoJCQkJIkVDT01NIjogMTI0LAoJCQkJIkVQUk9UTyI6IDY1LAoJCQkJIkVNVUxUSUhPUCI6IDM2LAoJCQkJIkVET1RET1QiOiAxMjUsCgkJCQkiRUJBRE1TRyI6IDksCgkJCQkiRU5PVFVOSVEiOiAxMjYsCgkJCQkiRUJBREZEIjogMTI3LAoJCQkJIkVSRU1DSEciOiAxMjgsCgkJCQkiRUxJQkFDQyI6IDEyOSwKCQkJCSJFTElCQkFEIjogMTMwLAoJCQkJIkVMSUJTQ04iOiAxMzEsCgkJCQkiRUxJQk1BWCI6IDEzMiwKCQkJCSJFTElCRVhFQyI6IDEzMywKCQkJCSJFTk9TWVMiOiA1MiwKCQkJCSJFTk9URU1QVFkiOiA1NSwKCQkJCSJFTkFNRVRPT0xPTkciOiAzNywKCQkJCSJFTE9PUCI6IDMyLAoJCQkJIkVPUE5PVFNVUFAiOiAxMzgsCgkJCQkiRVBGTk9TVVBQT1JUIjogMTM5LAoJCQkJIkVDT05OUkVTRVQiOiAxNSwKCQkJCSJFTk9CVUZTIjogNDIsCgkJCQkiRUFGTk9TVVBQT1JUIjogNSwKCQkJCSJFUFJPVE9UWVBFIjogNjcsCgkJCQkiRU5PVFNPQ0siOiA1NywKCQkJCSJFTk9QUk9UT09QVCI6IDUwLAoJCQkJIkVTSFVURE9XTiI6IDE0MCwKCQkJCSJFQ09OTlJFRlVTRUQiOiAxNCwKCQkJCSJFQUREUklOVVNFIjogMywKCQkJCSJFQ09OTkFCT1JURUQiOiAxMywKCQkJCSJFTkVUVU5SRUFDSCI6IDQwLAoJCQkJIkVORVRET1dOIjogMzgsCgkJCQkiRVRJTUVET1VUIjogNzMsCgkJCQkiRUhPU1RET1dOIjogMTQyLAoJCQkJIkVIT1NUVU5SRUFDSCI6IDIzLAoJCQkJIkVJTlBST0dSRVNTIjogMjYsCgkJCQkiRUFMUkVBRFkiOiA3LAoJCQkJIkVERVNUQUREUlJFUSI6IDE3LAoJCQkJIkVNU0dTSVpFIjogMzUsCgkJCQkiRVBST1RPTk9TVVBQT1JUIjogNjYsCgkJCQkiRVNPQ0tUTk9TVVBQT1JUIjogMTM3LAoJCQkJIkVBRERSTk9UQVZBSUwiOiA0LAoJCQkJIkVORVRSRVNFVCI6IDM5LAoJCQkJIkVJU0NPTk4iOiAzMCwKCQkJCSJFTk9UQ09OTiI6IDUzLAoJCQkJIkVUT09NQU5ZUkVGUyI6IDE0MSwKCQkJCSJFVVNFUlMiOiAxMzYsCgkJCQkiRURRVU9UIjogMTksCgkJCQkiRVNUQUxFIjogNzIsCgkJCQkiRU5PVFNVUCI6IDEzOCwKCQkJCSJFTk9NRURJVU0iOiAxNDgsCgkJCQkiRUlMU0VRIjogMjUsCgkJCQkiRU9WRVJGTE9XIjogNjEsCgkJCQkiRUNBTkNFTEVEIjogMTEsCgkJCQkiRU5PVFJFQ09WRVJBQkxFIjogNTYsCgkJCQkiRU9XTkVSREVBRCI6IDYyLAoJCQkJIkVTVFJQSVBFIjogMTM1CgkJCX07CgkJCXZhciB3YXNtSW1wb3J0cyA9IHsKCQkJCSJDIjogX19hc3luY2pzX193YWl0Rm9yUmVhZFJlc3VsdEFzeW5jLAoJCQkJIm0iOiBfX19jeGFfdGhyb3csCgkJCQkiRCI6IF9fX3N5c2NhbGxfX25ld3NlbGVjdCwKCQkJCSJTIjogX19fc3lzY2FsbF9mYWNjZXNzYXQsCgkJCQkicCI6IF9fX3N5c2NhbGxfZmNudGw2NCwKCQkJCSJQIjogX19fc3lzY2FsbF9mc3RhdDY0LAoJCQkJIkYiOiBfX19zeXNjYWxsX2dldGRlbnRzNjQsCgkJCQkidSI6IF9fX3N5c2NhbGxfaW9jdGwsCgkJCQkiTSI6IF9fX3N5c2NhbGxfbHN0YXQ2NCwKCQkJCSJOIjogX19fc3lzY2FsbF9uZXdmc3RhdGF0LAoJCQkJInMiOiBfX19zeXNjYWxsX29wZW5hdCwKCQkJCSJFIjogX19fc3lzY2FsbF9yZW5hbWVhdCwKCQkJCSJxIjogX19fc3lzY2FsbF9ybWRpciwKCQkJCSJPIjogX19fc3lzY2FsbF9zdGF0NjQsCgkJCQkiciI6IF9fX3N5c2NhbGxfdW5saW5rYXQsCgkJCQkiUSI6IF9fZW1zY3JpcHRlbl9nZXRfbm93X2lzX21vbm90b25pYywKCQkJCSJ5IjogX19lbXNjcmlwdGVuX3Rocm93X2xvbmdqbXAsCgkJCQkiRyI6IF9fZ210aW1lX2pzLAoJCQkJIkgiOiBfX2xvY2FsdGltZV9qcywKCQkJCSJJIjogX19ta3RpbWVfanMsCgkJCQkiQSI6IF9fdHpzZXRfanMsCgkJCQkiYSI6IF9hYm9ydCwKCQkJCSJpIjogX2Vtc2NyaXB0ZW5fYXNtX2NvbnN0X2FzeW5jX29uX21haW5fdGhyZWFkLAoJCQkJImUiOiBfZW1zY3JpcHRlbl9hc21fY29uc3RfaW50LAoJCQkJImgiOiBfZW1zY3JpcHRlbl9kYXRlX25vdywKCQkJCSJCIjogX2Vtc2NyaXB0ZW5fZ2V0X2hlYXBfbWF4LAoJCQkJIm4iOiBfZW1zY3JpcHRlbl9nZXRfbm93LAoJCQkJIlIiOiBfZW1zY3JpcHRlbl9tZW1jcHlfYmlnLAoJCQkJInoiOiBfZW1zY3JpcHRlbl9yZXNpemVfaGVhcCwKCQkJCSJLIjogX2Vudmlyb25fZ2V0LAoJCQkJIkwiOiBfZW52aXJvbl9zaXplc19nZXQsCgkJCQkiYyI6IF9leGl0LAoJCQkJImoiOiBfZmRfY2xvc2UsCgkJCQkiSiI6IF9mZF9mZHN0YXRfZ2V0LAoJCQkJInQiOiBfZmRfcmVhZCwKCQkJCSJ2IjogX2ZkX3NlZWssCgkJCQkibyI6IF9mZF93cml0ZSwKCQkJCSJVIjogaW52b2tlX2ksCgkJCQkiVCI6IGludm9rZV9paSwKCQkJCSJiIjogaW52b2tlX2lpaSwKCQkJCSJsIjogaW52b2tlX2lpaWlpaWlpaSwKCQkJCSJ4IjogaW52b2tlX2lpaWlqaiwKCQkJCSJnIjogaW52b2tlX3ZpLAoJCQkJImYiOiBpbnZva2VfdmlpLAoJCQkJImQiOiBpbnZva2VfdmlpaWksCgkJCQkidyI6IGludm9rZV92aWpqamlkLAoJCQkJImsiOiBfc3RyZnRpbWUKCQkJfTsKCQkJdmFyIGFzbSA9IGNyZWF0ZVdhc20oKTsKCQkJdmFyIF9fX3dhc21fY2FsbF9jdG9ycyA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfX193YXNtX2NhbGxfY3RvcnMgPSBNb2R1bGVbImFzbSJdWyJXIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9fX2Vycm5vX2xvY2F0aW9uID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9fX2Vycm5vX2xvY2F0aW9uID0gTW9kdWxlWyJhc20iXVsiWSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfZnJlZSA9IE1vZHVsZVsiX2ZyZWUiXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfZnJlZSA9IE1vZHVsZVsiX2ZyZWUiXSA9IE1vZHVsZVsiYXNtIl1bIloiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX21hbGxvYyA9IE1vZHVsZVsiX21hbGxvYyJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9tYWxsb2MgPSBNb2R1bGVbIl9tYWxsb2MiXSA9IE1vZHVsZVsiYXNtIl1bIl8iXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX2NyZWF0ZUNMSUZpbGVIYW5kbGUgPSBNb2R1bGVbIl9jcmVhdGVDTElGaWxlSGFuZGxlIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX2NyZWF0ZUNMSUZpbGVIYW5kbGUgPSBNb2R1bGVbIl9jcmVhdGVDTElGaWxlSGFuZGxlIl0gPSBNb2R1bGVbImFzbSJdWyIkIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9yZW9wZW5DTElGaWxlSGFuZGxlID0gTW9kdWxlWyJfcmVvcGVuQ0xJRmlsZUhhbmRsZSJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9yZW9wZW5DTElGaWxlSGFuZGxlID0gTW9kdWxlWyJfcmVvcGVuQ0xJRmlsZUhhbmRsZSJdID0gTW9kdWxlWyJhc20iXVsiYWEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX3JlcG9ydENMSVByb2dyZXNzID0gTW9kdWxlWyJfcmVwb3J0Q0xJUHJvZ3Jlc3MiXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfcmVwb3J0Q0xJUHJvZ3Jlc3MgPSBNb2R1bGVbIl9yZXBvcnRDTElQcm9ncmVzcyJdID0gTW9kdWxlWyJhc20iXVsiYmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX3JlZGlyZWN0Q0xJT3V0cHV0ID0gTW9kdWxlWyJfcmVkaXJlY3RDTElPdXRwdXQiXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfcmVkaXJlY3RDTElPdXRwdXQgPSBNb2R1bGVbIl9yZWRpcmVjdENMSU91dHB1dCJdID0gTW9kdWxlWyJhc20iXVsiY2EiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX2RlbGl2ZXJGaWxlSGFuZGxlUmVhZFJlc3VsdCA9IE1vZHVsZVsiX2RlbGl2ZXJGaWxlSGFuZGxlUmVhZFJlc3VsdCJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9kZWxpdmVyRmlsZUhhbmRsZVJlYWRSZXN1bHQgPSBNb2R1bGVbIl9kZWxpdmVyRmlsZUhhbmRsZVJlYWRSZXN1bHQiXSA9IE1vZHVsZVsiYXNtIl1bImRhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9mZm1wZWdjbWRfYmcgPSBNb2R1bGVbIl9mZm1wZWdjbWRfYmciXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfZmZtcGVnY21kX2JnID0gTW9kdWxlWyJfZmZtcGVnY21kX2JnIl0gPSBNb2R1bGVbImFzbSJdWyJlYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfZ2V0RkZBdWRpb0RhdGEgPSBNb2R1bGVbIl9nZXRGRkF1ZGlvRGF0YSJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9nZXRGRkF1ZGlvRGF0YSA9IE1vZHVsZVsiX2dldEZGQXVkaW9EYXRhIl0gPSBNb2R1bGVbImFzbSJdWyJmYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfc3RhcnRGRlZpZGVvRGVjb2RlciA9IE1vZHVsZVsiX3N0YXJ0RkZWaWRlb0RlY29kZXIiXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfc3RhcnRGRlZpZGVvRGVjb2RlciA9IE1vZHVsZVsiX3N0YXJ0RkZWaWRlb0RlY29kZXIiXSA9IE1vZHVsZVsiYXNtIl1bImdhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9nZXRGRlZpZGVvRGVjb2RlckZyYW1lV2lkdGggPSBNb2R1bGVbIl9nZXRGRlZpZGVvRGVjb2RlckZyYW1lV2lkdGgiXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZVdpZHRoID0gTW9kdWxlWyJfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZVdpZHRoIl0gPSBNb2R1bGVbImFzbSJdWyJoYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZUhlaWdodCA9IE1vZHVsZVsiX2dldEZGVmlkZW9EZWNvZGVyRnJhbWVIZWlnaHQiXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZUhlaWdodCA9IE1vZHVsZVsiX2dldEZGVmlkZW9EZWNvZGVyRnJhbWVIZWlnaHQiXSA9IE1vZHVsZVsiYXNtIl1bImlhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9nZXRGRlZpZGVvRGVjb2RlckZyYW1lUm90YXRpb24gPSBNb2R1bGVbIl9nZXRGRlZpZGVvRGVjb2RlckZyYW1lUm90YXRpb24iXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZVJvdGF0aW9uID0gTW9kdWxlWyJfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZVJvdGF0aW9uIl0gPSBNb2R1bGVbImFzbSJdWyJqYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfZ2V0RkZWaWRlb0RlY29kZXJEdXJhdGlvbiA9IE1vZHVsZVsiX2dldEZGVmlkZW9EZWNvZGVyRHVyYXRpb24iXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfZ2V0RkZWaWRlb0RlY29kZXJEdXJhdGlvbiA9IE1vZHVsZVsiX2dldEZGVmlkZW9EZWNvZGVyRHVyYXRpb24iXSA9IE1vZHVsZVsiYXNtIl1bImthIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9nZXRGRlZpZGVvRGVjb2RlckZyYW1lID0gTW9kdWxlWyJfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZSJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9nZXRGRlZpZGVvRGVjb2RlckZyYW1lID0gTW9kdWxlWyJfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZSJdID0gTW9kdWxlWyJhc20iXVsibGEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX2Nsb3NlRkZWaWRlb0RlY29kZXIgPSBNb2R1bGVbIl9jbG9zZUZGVmlkZW9EZWNvZGVyIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX2Nsb3NlRkZWaWRlb0RlY29kZXIgPSBNb2R1bGVbIl9jbG9zZUZGVmlkZW9EZWNvZGVyIl0gPSBNb2R1bGVbImFzbSJdWyJtYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfZmlsZUhhc1ZpZGVvID0gTW9kdWxlWyJfZmlsZUhhc1ZpZGVvIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX2ZpbGVIYXNWaWRlbyA9IE1vZHVsZVsiX2ZpbGVIYXNWaWRlbyJdID0gTW9kdWxlWyJhc20iXVsibmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX2ZpbGVIYXNBdWRpbyA9IE1vZHVsZVsiX2ZpbGVIYXNBdWRpbyJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9maWxlSGFzQXVkaW8gPSBNb2R1bGVbIl9maWxlSGFzQXVkaW8iXSA9IE1vZHVsZVsiYXNtIl1bIm9hIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9kaXNhYmxlTG9nZ2luZyA9IE1vZHVsZVsiX2Rpc2FibGVMb2dnaW5nIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX2Rpc2FibGVMb2dnaW5nID0gTW9kdWxlWyJfZGlzYWJsZUxvZ2dpbmciXSA9IE1vZHVsZVsiYXNtIl1bInBhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9vcGVuRmlsZSA9IE1vZHVsZVsiX29wZW5GaWxlIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX29wZW5GaWxlID0gTW9kdWxlWyJfb3BlbkZpbGUiXSA9IE1vZHVsZVsiYXNtIl1bInFhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9zZXRSZWFkeVRvUmVjZWl2ZVByb3h5RnJhbWVzID0gTW9kdWxlWyJfc2V0UmVhZHlUb1JlY2VpdmVQcm94eUZyYW1lcyJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9zZXRSZWFkeVRvUmVjZWl2ZVByb3h5RnJhbWVzID0gTW9kdWxlWyJfc2V0UmVhZHlUb1JlY2VpdmVQcm94eUZyYW1lcyJdID0gTW9kdWxlWyJhc20iXVsicmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX2NhbmNlbFByb3h5R2VuID0gTW9kdWxlWyJfY2FuY2VsUHJveHlHZW4iXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfY2FuY2VsUHJveHlHZW4gPSBNb2R1bGVbIl9jYW5jZWxQcm94eUdlbiJdID0gTW9kdWxlWyJhc20iXVsic2EiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX3N0YXJ0UHJveHlHZW4gPSBNb2R1bGVbIl9zdGFydFByb3h5R2VuIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX3N0YXJ0UHJveHlHZW4gPSBNb2R1bGVbIl9zdGFydFByb3h5R2VuIl0gPSBNb2R1bGVbImFzbSJdWyJ0YSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfc3BsaXRBdWRpbyA9IE1vZHVsZVsiX3NwbGl0QXVkaW8iXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfc3BsaXRBdWRpbyA9IE1vZHVsZVsiX3NwbGl0QXVkaW8iXSA9IE1vZHVsZVsiYXNtIl1bInVhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9mZm1wZWdjbWQgPSBNb2R1bGVbIl9mZm1wZWdjbWQiXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfZmZtcGVnY21kID0gTW9kdWxlWyJfZmZtcGVnY21kIl0gPSBNb2R1bGVbImFzbSJdWyJ2YSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfc3RhcnRfdmlkZW9fd3JpdGUgPSBNb2R1bGVbIl9zdGFydF92aWRlb193cml0ZSJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9zdGFydF92aWRlb193cml0ZSA9IE1vZHVsZVsiX3N0YXJ0X3ZpZGVvX3dyaXRlIl0gPSBNb2R1bGVbImFzbSJdWyJ3YSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfY2FuX2FjY2VwdF92aWRlb2J1ZmZlciA9IE1vZHVsZVsiX2Nhbl9hY2NlcHRfdmlkZW9idWZmZXIiXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfY2FuX2FjY2VwdF92aWRlb2J1ZmZlciA9IE1vZHVsZVsiX2Nhbl9hY2NlcHRfdmlkZW9idWZmZXIiXSA9IE1vZHVsZVsiYXNtIl1bInhhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9zZXRfaDI2NF9yYXdfY29sb3JzcGFjZSA9IE1vZHVsZVsiX3NldF9oMjY0X3Jhd19jb2xvcnNwYWNlIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX3NldF9oMjY0X3Jhd19jb2xvcnNwYWNlID0gTW9kdWxlWyJfc2V0X2gyNjRfcmF3X2NvbG9yc3BhY2UiXSA9IE1vZHVsZVsiYXNtIl1bInlhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF93cml0ZV92aWRlb19yYXdfcGFja2V0ID0gTW9kdWxlWyJfd3JpdGVfdmlkZW9fcmF3X3BhY2tldCJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF93cml0ZV92aWRlb19yYXdfcGFja2V0ID0gTW9kdWxlWyJfd3JpdGVfdmlkZW9fcmF3X3BhY2tldCJdID0gTW9kdWxlWyJhc20iXVsiemEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX2Nhbl9hY2NlcHRfYXVkaW9idWZmZXIgPSBNb2R1bGVbIl9jYW5fYWNjZXB0X2F1ZGlvYnVmZmVyIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX2Nhbl9hY2NlcHRfYXVkaW9idWZmZXIgPSBNb2R1bGVbIl9jYW5fYWNjZXB0X2F1ZGlvYnVmZmVyIl0gPSBNb2R1bGVbImFzbSJdWyJBYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfZ2VuZXJhdGVUZXN0VmlkZW9CdWZmZXIgPSBNb2R1bGVbIl9nZW5lcmF0ZVRlc3RWaWRlb0J1ZmZlciJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9nZW5lcmF0ZVRlc3RWaWRlb0J1ZmZlciA9IE1vZHVsZVsiX2dlbmVyYXRlVGVzdFZpZGVvQnVmZmVyIl0gPSBNb2R1bGVbImFzbSJdWyJCYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfZ2VuZXJhdGVUZXN0QXVkaW9CdWZmZXIgPSBNb2R1bGVbIl9nZW5lcmF0ZVRlc3RBdWRpb0J1ZmZlciJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9nZW5lcmF0ZVRlc3RBdWRpb0J1ZmZlciA9IE1vZHVsZVsiX2dlbmVyYXRlVGVzdEF1ZGlvQnVmZmVyIl0gPSBNb2R1bGVbImFzbSJdWyJDYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfc3RhcnRfYmdfZW5jb2RlID0gTW9kdWxlWyJfc3RhcnRfYmdfZW5jb2RlIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX3N0YXJ0X2JnX2VuY29kZSA9IE1vZHVsZVsiX3N0YXJ0X2JnX2VuY29kZSJdID0gTW9kdWxlWyJhc20iXVsiRGEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX3N0YXJ0X2JnX2VuY29kZTIgPSBNb2R1bGVbIl9zdGFydF9iZ19lbmNvZGUyIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX3N0YXJ0X2JnX2VuY29kZTIgPSBNb2R1bGVbIl9zdGFydF9iZ19lbmNvZGUyIl0gPSBNb2R1bGVbImFzbSJdWyJFYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfc3RhcnRfdmlkZW9fZnJhbWVfZW5jb2RlID0gTW9kdWxlWyJfc3RhcnRfdmlkZW9fZnJhbWVfZW5jb2RlIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX3N0YXJ0X3ZpZGVvX2ZyYW1lX2VuY29kZSA9IE1vZHVsZVsiX3N0YXJ0X3ZpZGVvX2ZyYW1lX2VuY29kZSJdID0gTW9kdWxlWyJhc20iXVsiRmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX3F1ZXVlX3ZpZGVvX3BhY2tldF9tdXggPSBNb2R1bGVbIl9xdWV1ZV92aWRlb19wYWNrZXRfbXV4Il0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX3F1ZXVlX3ZpZGVvX3BhY2tldF9tdXggPSBNb2R1bGVbIl9xdWV1ZV92aWRlb19wYWNrZXRfbXV4Il0gPSBNb2R1bGVbImFzbSJdWyJHYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfc3RhcnRfYXVkaW9fZnJhbWVfZW5jb2RlID0gTW9kdWxlWyJfc3RhcnRfYXVkaW9fZnJhbWVfZW5jb2RlIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX3N0YXJ0X2F1ZGlvX2ZyYW1lX2VuY29kZSA9IE1vZHVsZVsiX3N0YXJ0X2F1ZGlvX2ZyYW1lX2VuY29kZSJdID0gTW9kdWxlWyJhc20iXVsiSGEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX2ZpbmlzaF9iZ19lbmNvZGUgPSBNb2R1bGVbIl9maW5pc2hfYmdfZW5jb2RlIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX2ZpbmlzaF9iZ19lbmNvZGUgPSBNb2R1bGVbIl9maW5pc2hfYmdfZW5jb2RlIl0gPSBNb2R1bGVbImFzbSJdWyJJYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfcmVtdXggPSBNb2R1bGVbIl9yZW11eCJdID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9yZW11eCA9IE1vZHVsZVsiX3JlbXV4Il0gPSBNb2R1bGVbImFzbSJdWyJKYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfZW1zY3JpcHRlbl9idWlsdGluX21lbWFsaWduID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9lbXNjcmlwdGVuX2J1aWx0aW5fbWVtYWxpZ24gPSBNb2R1bGVbImFzbSJdWyJLYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfc2V0VGhyZXcgPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX3NldFRocmV3ID0gTW9kdWxlWyJhc20iXVsiTGEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX2Vtc2NyaXB0ZW5fc3RhY2tfc2V0X2xpbWl0cyA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfZW1zY3JpcHRlbl9zdGFja19zZXRfbGltaXRzID0gTW9kdWxlWyJhc20iXVsiZW1zY3JpcHRlbl9zdGFja19zZXRfbGltaXRzIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9lbXNjcmlwdGVuX3N0YWNrX2dldF9iYXNlID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9lbXNjcmlwdGVuX3N0YWNrX2dldF9iYXNlID0gTW9kdWxlWyJhc20iXVsiZW1zY3JpcHRlbl9zdGFja19nZXRfYmFzZSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfZW1zY3JpcHRlbl9zdGFja19nZXRfZW5kID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9lbXNjcmlwdGVuX3N0YWNrX2dldF9lbmQgPSBNb2R1bGVbImFzbSJdWyJlbXNjcmlwdGVuX3N0YWNrX2dldF9lbmQiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgc3RhY2tTYXZlID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKHN0YWNrU2F2ZSA9IE1vZHVsZVsiYXNtIl1bIk1hIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIHN0YWNrUmVzdG9yZSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChzdGFja1Jlc3RvcmUgPSBNb2R1bGVbImFzbSJdWyJOYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBzdGFja0FsbG9jID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKHN0YWNrQWxsb2MgPSBNb2R1bGVbImFzbSJdWyJPYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfX19jeGFfaXNfcG9pbnRlcl90eXBlID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9fX2N4YV9pc19wb2ludGVyX3R5cGUgPSBNb2R1bGVbImFzbSJdWyJQYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBkeW5DYWxsX2lpID0gTW9kdWxlWyJkeW5DYWxsX2lpIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoZHluQ2FsbF9paSA9IE1vZHVsZVsiZHluQ2FsbF9paSJdID0gTW9kdWxlWyJhc20iXVsiUWEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgZHluQ2FsbF9paWkgPSBNb2R1bGVbImR5bkNhbGxfaWlpIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoZHluQ2FsbF9paWkgPSBNb2R1bGVbImR5bkNhbGxfaWlpIl0gPSBNb2R1bGVbImFzbSJdWyJSYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBkeW5DYWxsX3ZpID0gTW9kdWxlWyJkeW5DYWxsX3ZpIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoZHluQ2FsbF92aSA9IE1vZHVsZVsiZHluQ2FsbF92aSJdID0gTW9kdWxlWyJhc20iXVsiU2EiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgZHluQ2FsbF92aWkgPSBNb2R1bGVbImR5bkNhbGxfdmlpIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoZHluQ2FsbF92aWkgPSBNb2R1bGVbImR5bkNhbGxfdmlpIl0gPSBNb2R1bGVbImFzbSJdWyJUYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBkeW5DYWxsX3ZpaWlpID0gTW9kdWxlWyJkeW5DYWxsX3ZpaWlpIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoZHluQ2FsbF92aWlpaSA9IE1vZHVsZVsiZHluQ2FsbF92aWlpaSJdID0gTW9kdWxlWyJhc20iXVsiVWEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgZHluQ2FsbF9paWlpamogPSBNb2R1bGVbImR5bkNhbGxfaWlpaWpqIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoZHluQ2FsbF9paWlpamogPSBNb2R1bGVbImR5bkNhbGxfaWlpaWpqIl0gPSBNb2R1bGVbImFzbSJdWyJWYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBkeW5DYWxsX2lpaWlpaWlpaSA9IE1vZHVsZVsiZHluQ2FsbF9paWlpaWlpaWkiXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChkeW5DYWxsX2lpaWlpaWlpaSA9IE1vZHVsZVsiZHluQ2FsbF9paWlpaWlpaWkiXSA9IE1vZHVsZVsiYXNtIl1bIldhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIGR5bkNhbGxfdmlqamppZCA9IE1vZHVsZVsiZHluQ2FsbF92aWpqamlkIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoZHluQ2FsbF92aWpqamlkID0gTW9kdWxlWyJkeW5DYWxsX3ZpampqaWQiXSA9IE1vZHVsZVsiYXNtIl1bIlhhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIGR5bkNhbGxfaSA9IE1vZHVsZVsiZHluQ2FsbF9pIl0gPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoZHluQ2FsbF9pID0gTW9kdWxlWyJkeW5DYWxsX2kiXSA9IE1vZHVsZVsiYXNtIl1bIllhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9hc3luY2lmeV9zdGFydF91bndpbmQgPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX2FzeW5jaWZ5X3N0YXJ0X3Vud2luZCA9IE1vZHVsZVsiYXNtIl1bIlphIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKCQkJfTsKCQkJdmFyIF9hc3luY2lmeV9zdG9wX3Vud2luZCA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIChfYXN5bmNpZnlfc3RvcF91bndpbmQgPSBNb2R1bGVbImFzbSJdWyJfYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfYXN5bmNpZnlfc3RhcnRfcmV3aW5kID0gZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKF9hc3luY2lmeV9zdGFydF9yZXdpbmQgPSBNb2R1bGVbImFzbSJdWyIkYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCgkJCX07CgkJCXZhciBfYXN5bmNpZnlfc3RvcF9yZXdpbmQgPSBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoX2FzeW5jaWZ5X3N0b3BfcmV3aW5kID0gTW9kdWxlWyJhc20iXVsiYWIiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQoJCQl9OwoJCQl2YXIgX2ZmX2gyNjRfY2FiYWNfdGFibGVzID0gTW9kdWxlWyJfZmZfaDI2NF9jYWJhY190YWJsZXMiXSA9IDMzNTM2ODsKCQkJdmFyIF9fX3N0YXJ0X2VtX2pzID0gTW9kdWxlWyJfX19zdGFydF9lbV9qcyJdID0gODYzNzA4OwoJCQl2YXIgX19fc3RvcF9lbV9qcyA9IE1vZHVsZVsiX19fc3RvcF9lbV9qcyJdID0gODYzODU1OwogIAoJCQlmdW5jdGlvbiBpbnZva2VfdmlpKGluZGV4LCBhMSwgYTIpIHsKCQkJCXZhciBzcCA9IHN0YWNrU2F2ZSgpOwoJCQkJdHJ5IHsKCQkJCQlkeW5DYWxsX3ZpaShpbmRleCwgYTEsIGEyKQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXN0YWNrUmVzdG9yZShzcCk7CgkJCQkJaWYgKGUgIT09IGUgKyAwKSB0aHJvdyBlOwoJCQkJCV9zZXRUaHJldygxLCAwKQoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGludm9rZV9paWkoaW5kZXgsIGExLCBhMikgewoJCQkJdmFyIHNwID0gc3RhY2tTYXZlKCk7CgkJCQl0cnkgewoJCQkJCXJldHVybiBkeW5DYWxsX2lpaShpbmRleCwgYTEsIGEyKQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXN0YWNrUmVzdG9yZShzcCk7CgkJCQkJaWYgKGUgIT09IGUgKyAwKSB0aHJvdyBlOwoJCQkJCV9zZXRUaHJldygxLCAwKQoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGludm9rZV9paWlpaWlpaWkoaW5kZXgsIGExLCBhMiwgYTMsIGE0LCBhNSwgYTYsIGE3LCBhOCkgewoJCQkJdmFyIHNwID0gc3RhY2tTYXZlKCk7CgkJCQl0cnkgewoJCQkJCXJldHVybiBkeW5DYWxsX2lpaWlpaWlpaShpbmRleCwgYTEsIGEyLCBhMywgYTQsIGE1LCBhNiwgYTcsIGE4KQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXN0YWNrUmVzdG9yZShzcCk7CgkJCQkJaWYgKGUgIT09IGUgKyAwKSB0aHJvdyBlOwoJCQkJCV9zZXRUaHJldygxLCAwKQoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGludm9rZV92aShpbmRleCwgYTEpIHsKCQkJCXZhciBzcCA9IHN0YWNrU2F2ZSgpOwoJCQkJdHJ5IHsKCQkJCQlkeW5DYWxsX3ZpKGluZGV4LCBhMSkKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlzdGFja1Jlc3RvcmUoc3ApOwoJCQkJCWlmIChlICE9PSBlICsgMCkgdGhyb3cgZTsKCQkJCQlfc2V0VGhyZXcoMSwgMCkKCQkJCX0KCQkJfQogIAoJCQlmdW5jdGlvbiBpbnZva2VfdmlpaWkoaW5kZXgsIGExLCBhMiwgYTMsIGE0KSB7CgkJCQl2YXIgc3AgPSBzdGFja1NhdmUoKTsKCQkJCXRyeSB7CgkJCQkJZHluQ2FsbF92aWlpaShpbmRleCwgYTEsIGEyLCBhMywgYTQpCgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJc3RhY2tSZXN0b3JlKHNwKTsKCQkJCQlpZiAoZSAhPT0gZSArIDApIHRocm93IGU7CgkJCQkJX3NldFRocmV3KDEsIDApCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gaW52b2tlX2koaW5kZXgpIHsKCQkJCXZhciBzcCA9IHN0YWNrU2F2ZSgpOwoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4gZHluQ2FsbF9pKGluZGV4KQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXN0YWNrUmVzdG9yZShzcCk7CgkJCQkJaWYgKGUgIT09IGUgKyAwKSB0aHJvdyBlOwoJCQkJCV9zZXRUaHJldygxLCAwKQoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGludm9rZV9paShpbmRleCwgYTEpIHsKCQkJCXZhciBzcCA9IHN0YWNrU2F2ZSgpOwoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4gZHluQ2FsbF9paShpbmRleCwgYTEpCgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJc3RhY2tSZXN0b3JlKHNwKTsKCQkJCQlpZiAoZSAhPT0gZSArIDApIHRocm93IGU7CgkJCQkJX3NldFRocmV3KDEsIDApCgkJCQl9CgkJCX0KICAKCQkJZnVuY3Rpb24gaW52b2tlX2lpaWlqaihpbmRleCwgYTEsIGEyLCBhMywgYTQsIGE1LCBhNiwgYTcpIHsKCQkJCXZhciBzcCA9IHN0YWNrU2F2ZSgpOwoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4gZHluQ2FsbF9paWlpamooaW5kZXgsIGExLCBhMiwgYTMsIGE0LCBhNSwgYTYsIGE3KQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXN0YWNrUmVzdG9yZShzcCk7CgkJCQkJaWYgKGUgIT09IGUgKyAwKSB0aHJvdyBlOwoJCQkJCV9zZXRUaHJldygxLCAwKQoJCQkJfQoJCQl9CiAgCgkJCWZ1bmN0aW9uIGludm9rZV92aWpqamlkKGluZGV4LCBhMSwgYTIsIGEzLCBhNCwgYTUsIGE2LCBhNywgYTgsIGE5KSB7CgkJCQl2YXIgc3AgPSBzdGFja1NhdmUoKTsKCQkJCXRyeSB7CgkJCQkJZHluQ2FsbF92aWpqamlkKGluZGV4LCBhMSwgYTIsIGEzLCBhNCwgYTUsIGE2LCBhNywgYTgsIGE5KQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXN0YWNrUmVzdG9yZShzcCk7CgkJCQkJaWYgKGUgIT09IGUgKyAwKSB0aHJvdyBlOwoJCQkJCV9zZXRUaHJldygxLCAwKQoJCQkJfQoJCQl9CgkJCU1vZHVsZVsiYWRkUnVuRGVwZW5kZW5jeSJdID0gYWRkUnVuRGVwZW5kZW5jeTsKCQkJTW9kdWxlWyJyZW1vdmVSdW5EZXBlbmRlbmN5Il0gPSByZW1vdmVSdW5EZXBlbmRlbmN5OwoJCQlNb2R1bGVbIkZTX2NyZWF0ZVBhdGgiXSA9IEZTLmNyZWF0ZVBhdGg7CgkJCU1vZHVsZVsiRlNfY3JlYXRlRGF0YUZpbGUiXSA9IEZTLmNyZWF0ZURhdGFGaWxlOwoJCQlNb2R1bGVbIkZTX2NyZWF0ZUxhenlGaWxlIl0gPSBGUy5jcmVhdGVMYXp5RmlsZTsKCQkJTW9kdWxlWyJGU19jcmVhdGVEZXZpY2UiXSA9IEZTLmNyZWF0ZURldmljZTsKCQkJTW9kdWxlWyJGU191bmxpbmsiXSA9IEZTLnVubGluazsKCQkJTW9kdWxlWyJVVEY4VG9TdHJpbmciXSA9IFVURjhUb1N0cmluZzsKCQkJTW9kdWxlWyJpbnRBcnJheUZyb21TdHJpbmciXSA9IGludEFycmF5RnJvbVN0cmluZzsKCQkJTW9kdWxlWyJGU19jcmVhdGVQcmVsb2FkZWRGaWxlIl0gPSBGUy5jcmVhdGVQcmVsb2FkZWRGaWxlOwoJCQlNb2R1bGVbIkZTIl0gPSBGUzsKCQkJTW9kdWxlWyJBTExPQ19OT1JNQUwiXSA9IEFMTE9DX05PUk1BTDsKCQkJTW9kdWxlWyJhbGxvY2F0ZSJdID0gYWxsb2NhdGU7CgkJCXZhciBjYWxsZWRSdW47CgkJCWRlcGVuZGVuY2llc0Z1bGZpbGxlZCA9IGZ1bmN0aW9uIHJ1bkNhbGxlcigpIHsKCQkJCWlmICghY2FsbGVkUnVuKSBydW4oKTsKCQkJCWlmICghY2FsbGVkUnVuKSBkZXBlbmRlbmNpZXNGdWxmaWxsZWQgPSBydW5DYWxsZXIKCQkJfTsKICAKCQkJZnVuY3Rpb24gcnVuKCkgewoJCQkJaWYgKHJ1bkRlcGVuZGVuY2llcyA+IDApIHsKCQkJCQlyZXR1cm4KCQkJCX0KCQkJCXByZVJ1bigpOwoJCQkJaWYgKHJ1bkRlcGVuZGVuY2llcyA+IDApIHsKCQkJCQlyZXR1cm4KCQkJCX0KICAKCQkJCWZ1bmN0aW9uIGRvUnVuKCkgewoJCQkJCWlmIChjYWxsZWRSdW4pIHJldHVybjsKCQkJCQljYWxsZWRSdW4gPSB0cnVlOwoJCQkJCU1vZHVsZVsiY2FsbGVkUnVuIl0gPSB0cnVlOwoJCQkJCWlmIChBQk9SVCkgcmV0dXJuOwoJCQkJCWluaXRSdW50aW1lKCk7CgkJCQkJcmVhZHlQcm9taXNlUmVzb2x2ZShNb2R1bGUpOwoJCQkJCWlmIChNb2R1bGVbIm9uUnVudGltZUluaXRpYWxpemVkIl0pIE1vZHVsZVsib25SdW50aW1lSW5pdGlhbGl6ZWQiXSgpOwoJCQkJCXBvc3RSdW4oKQoJCQkJfQoJCQkJaWYgKE1vZHVsZVsic2V0U3RhdHVzIl0pIHsKCQkJCQlNb2R1bGVbInNldFN0YXR1cyJdKCJSdW5uaW5nLi4uIik7CgkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJCU1vZHVsZVsic2V0U3RhdHVzIl0oIiIpCgkJCQkJCX0sIDEpOwoJCQkJCQlkb1J1bigpCgkJCQkJfSwgMSkKCQkJCX0gZWxzZSB7CgkJCQkJZG9SdW4oKQoJCQkJfQoJCQl9CgkJCWlmIChNb2R1bGVbInByZUluaXQiXSkgewoJCQkJaWYgKHR5cGVvZiBNb2R1bGVbInByZUluaXQiXSA9PSAiZnVuY3Rpb24iKSBNb2R1bGVbInByZUluaXQiXSA9IFtNb2R1bGVbInByZUluaXQiXV07CgkJCQl3aGlsZSAoTW9kdWxlWyJwcmVJbml0Il0ubGVuZ3RoID4gMCkgewoJCQkJCU1vZHVsZVsicHJlSW5pdCJdLnBvcCgpKCkKCQkJCX0KCQkJfQoJCQlydW4oKTsKICAKICAKCQkJcmV0dXJuIEZGbXBlZ01vZHVsZUNyZWF0ZS5yZWFkeQoJCX0KICAKCSk7CiAgfSkoKTsKICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnKQoJbW9kdWxlLmV4cG9ydHMgPSBGRm1wZWdNb2R1bGVDcmVhdGU7CiAgZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmVbJ2FtZCddKQoJZGVmaW5lKFtdLCBmdW5jdGlvbigpIHsKCQlyZXR1cm4gRkZtcGVnTW9kdWxlQ3JlYXRlOwoJfSk7CiAgZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKQoJZXhwb3J0c1siRkZtcGVnTW9kdWxlQ3JlYXRlIl0gPSBGRm1wZWdNb2R1bGVDcmVhdGU7CnZhciBGRm1wZWdNb2R1bGVDcmVhdGUgPSAoKCkgPT4gewogIHZhciBfc2NyaXB0RGlyID0gdHlwZW9mIGRvY3VtZW50ICE9PSAndW5kZWZpbmVkJyAmJiBkb2N1bWVudC5jdXJyZW50U2NyaXB0ID8gZG9jdW1lbnQuY3VycmVudFNjcmlwdC5zcmMgOiB1bmRlZmluZWQ7CiAgaWYgKHR5cGVvZiBfX2ZpbGVuYW1lICE9PSAndW5kZWZpbmVkJykgX3NjcmlwdERpciA9IF9zY3JpcHREaXIgfHwgX19maWxlbmFtZTsKICByZXR1cm4gKAogICAgICBmdW5jdGlvbihGRm1wZWdNb2R1bGVDcmVhdGUgPSB7fSkgewoKICAgICAgICAgIHZhciBNb2R1bGUgPSB0eXBlb2YgRkZtcGVnTW9kdWxlQ3JlYXRlICE9ICJ1bmRlZmluZWQiID8gRkZtcGVnTW9kdWxlQ3JlYXRlIDoge307CiAgICAgICAgICB2YXIgcmVhZHlQcm9taXNlUmVzb2x2ZSwgcmVhZHlQcm9taXNlUmVqZWN0OwogICAgICAgICAgTW9kdWxlWyJyZWFkeSJdID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgICAgIHJlYWR5UHJvbWlzZVJlc29sdmUgPSByZXNvbHZlOwogICAgICAgICAgICAgIHJlYWR5UHJvbWlzZVJlamVjdCA9IHJlamVjdAogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgbW9kdWxlT3ZlcnJpZGVzID0gT2JqZWN0LmFzc2lnbih7fSwgTW9kdWxlKTsKICAgICAgICAgIHZhciBhcmd1bWVudHNfID0gW107CiAgICAgICAgICB2YXIgdGhpc1Byb2dyYW0gPSAiLi90aGlzLnByb2dyYW0iOwogICAgICAgICAgdmFyIHF1aXRfID0gKHN0YXR1cywgdG9UaHJvdykgPT4gewogICAgICAgICAgICAgIHRocm93IHRvVGhyb3cKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgRU5WSVJPTk1FTlRfSVNfV0VCID0gdHlwZW9mIHdpbmRvdyA9PSAib2JqZWN0IjsKICAgICAgICAgIHZhciBFTlZJUk9OTUVOVF9JU19XT1JLRVIgPSB0eXBlb2YgaW1wb3J0U2NyaXB0cyA9PSAiZnVuY3Rpb24iOwogICAgICAgICAgdmFyIEVOVklST05NRU5UX0lTX05PREUgPSB0eXBlb2YgcHJvY2VzcyA9PSAib2JqZWN0IiAmJiB0eXBlb2YgcHJvY2Vzcy52ZXJzaW9ucyA9PSAib2JqZWN0IiAmJiB0eXBlb2YgcHJvY2Vzcy52ZXJzaW9ucy5ub2RlID09ICJzdHJpbmciOwogICAgICAgICAgdmFyIHNjcmlwdERpcmVjdG9yeSA9ICIiOwoKICAgICAgICAgIGZ1bmN0aW9uIGxvY2F0ZUZpbGUocGF0aCkgewogICAgICAgICAgICAgIGlmIChNb2R1bGVbImxvY2F0ZUZpbGUiXSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gTW9kdWxlWyJsb2NhdGVGaWxlIl0ocGF0aCwgc2NyaXB0RGlyZWN0b3J5KQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gc2NyaXB0RGlyZWN0b3J5ICsgcGF0aAogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlYWRfLCByZWFkQXN5bmMsIHJlYWRCaW5hcnksIHNldFdpbmRvd1RpdGxlOwogICAgICAgICAgaWYgKEVOVklST05NRU5UX0lTX05PREUpIHsKICAgICAgICAgICAgICB2YXIgZnMgPSByZXF1aXJlKCJmcyIpOwogICAgICAgICAgICAgIHZhciBub2RlUGF0aCA9IHJlcXVpcmUoInBhdGgiKTsKICAgICAgICAgICAgICBpZiAoRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CiAgICAgICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IG5vZGVQYXRoLmRpcm5hbWUoc2NyaXB0RGlyZWN0b3J5KSArICIvIgogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IF9fZGlybmFtZSArICIvIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWFkXyA9IChmaWxlbmFtZSwgYmluYXJ5KSA9PiB7CiAgICAgICAgICAgICAgICAgIGZpbGVuYW1lID0gaXNGaWxlVVJJKGZpbGVuYW1lKSA/IG5ldyBVUkwoZmlsZW5hbWUpIDogbm9kZVBhdGgubm9ybWFsaXplKGZpbGVuYW1lKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhmaWxlbmFtZSwgYmluYXJ5ID8gdW5kZWZpbmVkIDogInV0ZjgiKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgcmVhZEJpbmFyeSA9IGZpbGVuYW1lID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IHJlYWRfKGZpbGVuYW1lLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgaWYgKCFyZXQuYnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXQgPSBuZXcgVWludDhBcnJheShyZXQpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgcmVhZEFzeW5jID0gKGZpbGVuYW1lLCBvbmxvYWQsIG9uZXJyb3IsIGJpbmFyeSA9IHRydWUpID0+IHsKICAgICAgICAgICAgICAgICAgZmlsZW5hbWUgPSBpc0ZpbGVVUkkoZmlsZW5hbWUpID8gbmV3IFVSTChmaWxlbmFtZSkgOiBub2RlUGF0aC5ub3JtYWxpemUoZmlsZW5hbWUpOwogICAgICAgICAgICAgICAgICBmcy5yZWFkRmlsZShmaWxlbmFtZSwgYmluYXJ5ID8gdW5kZWZpbmVkIDogInV0ZjgiLCAoZXJyLCBkYXRhKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSBvbmVycm9yKGVycik7CiAgICAgICAgICAgICAgICAgICAgICBlbHNlIG9ubG9hZChiaW5hcnkgPyBkYXRhLmJ1ZmZlciA6IGRhdGEpCiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAoIU1vZHVsZVsidGhpc1Byb2dyYW0iXSAmJiBwcm9jZXNzLmFyZ3YubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICB0aGlzUHJvZ3JhbSA9IHByb2Nlc3MuYXJndlsxXS5yZXBsYWNlKC9cXC9nLCAiLyIpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFyZ3VtZW50c18gPSBwcm9jZXNzLmFyZ3Yuc2xpY2UoMik7CiAgICAgICAgICAgICAgcXVpdF8gPSAoc3RhdHVzLCB0b1Rocm93KSA9PiB7CiAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdENvZGUgPSBzdGF0dXM7CiAgICAgICAgICAgICAgICAgIHRocm93IHRvVGhyb3cKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE1vZHVsZVsiaW5zcGVjdCJdID0gKCkgPT4gIltFbXNjcmlwdGVuIE1vZHVsZSBvYmplY3RdIgogICAgICAgICAgfSBlbHNlIGlmIChFTlZJUk9OTUVOVF9JU19XRUIgfHwgRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CiAgICAgICAgICAgICAgaWYgKEVOVklST05NRU5UX0lTX1dPUktFUikgewogICAgICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSBzZWxmLmxvY2F0aW9uLmhyZWYKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudCAhPSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudC5jdXJyZW50U2NyaXB0KSB7CiAgICAgICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IGRvY3VtZW50LmN1cnJlbnRTY3JpcHQuc3JjCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChfc2NyaXB0RGlyKSB7CiAgICAgICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IF9zY3JpcHREaXIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNjcmlwdERpcmVjdG9yeS5pbmRleE9mKCJibG9iOiIpICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IHNjcmlwdERpcmVjdG9yeS5zdWJzdHIoMCwgc2NyaXB0RGlyZWN0b3J5LnJlcGxhY2UoL1s/I10uKi8sICIiKS5sYXN0SW5kZXhPZigiLyIpICsgMSkKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSAiIgogICAgICAgICAgICAgIH0gewogICAgICAgICAgICAgICAgICByZWFkXyA9IHVybCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0OwogICAgICAgICAgICAgICAgICAgICAgeGhyLm9wZW4oIkdFVCIsIHVybCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgeGhyLnNlbmQobnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geGhyLnJlc3BvbnNlVGV4dAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpZiAoRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CiAgICAgICAgICAgICAgICAgICAgICByZWFkQmluYXJ5ID0gdXJsID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0OwogICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5vcGVuKCJHRVQiLCB1cmwsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIuc2VuZChudWxsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoeGhyLnJlc3BvbnNlKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlYWRBc3luYyA9ICh1cmwsIG9ubG9hZCwgb25lcnJvcikgPT4gewogICAgICAgICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdDsKICAgICAgICAgICAgICAgICAgICAgIHhoci5vcGVuKCJHRVQiLCB1cmwsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CiAgICAgICAgICAgICAgICAgICAgICB4aHIub25sb2FkID0gKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09IDIwMCB8fCB4aHIuc3RhdHVzID09IDAgJiYgeGhyLnJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubG9hZCh4aHIucmVzcG9uc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgb25lcnJvcigpCiAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgeGhyLm9uZXJyb3IgPSBvbmVycm9yOwogICAgICAgICAgICAgICAgICAgICAgeGhyLnNlbmQobnVsbCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXRXaW5kb3dUaXRsZSA9IHRpdGxlID0+IGRvY3VtZW50LnRpdGxlID0gdGl0bGUKICAgICAgICAgIH0gZWxzZSB7fQogICAgICAgICAgdmFyIG91dCA9IE1vZHVsZVsicHJpbnQiXSB8fCBjb25zb2xlLmxvZy5iaW5kKGNvbnNvbGUpOwogICAgICAgICAgdmFyIGVyciA9IE1vZHVsZVsicHJpbnRFcnIiXSB8fCBjb25zb2xlLndhcm4uYmluZChjb25zb2xlKTsKICAgICAgICAgIE9iamVjdC5hc3NpZ24oTW9kdWxlLCBtb2R1bGVPdmVycmlkZXMpOwogICAgICAgICAgbW9kdWxlT3ZlcnJpZGVzID0gbnVsbDsKICAgICAgICAgIGlmIChNb2R1bGVbImFyZ3VtZW50cyJdKSBhcmd1bWVudHNfID0gTW9kdWxlWyJhcmd1bWVudHMiXTsKICAgICAgICAgIGlmIChNb2R1bGVbInRoaXNQcm9ncmFtIl0pIHRoaXNQcm9ncmFtID0gTW9kdWxlWyJ0aGlzUHJvZ3JhbSJdOwogICAgICAgICAgaWYgKE1vZHVsZVsicXVpdCJdKSBxdWl0XyA9IE1vZHVsZVsicXVpdCJdOwogICAgICAgICAgdmFyIHdhc21CaW5hcnk7CiAgICAgICAgICBpZiAoTW9kdWxlWyJ3YXNtQmluYXJ5Il0pIHdhc21CaW5hcnkgPSBNb2R1bGVbIndhc21CaW5hcnkiXTsKICAgICAgICAgIHZhciBub0V4aXRSdW50aW1lID0gTW9kdWxlWyJub0V4aXRSdW50aW1lIl0gfHwgdHJ1ZTsKICAgICAgICAgIGlmICh0eXBlb2YgV2ViQXNzZW1ibHkgIT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBhYm9ydCgibm8gbmF0aXZlIHdhc20gc3VwcG9ydCBkZXRlY3RlZCIpCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzbU1lbW9yeTsKICAgICAgICAgIHZhciBBQk9SVCA9IGZhbHNlOwogICAgICAgICAgdmFyIEVYSVRTVEFUVVM7CgogICAgICAgICAgZnVuY3Rpb24gYXNzZXJ0KGNvbmRpdGlvbiwgdGV4dCkgewogICAgICAgICAgICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgICAgICAgICAgICAgIGFib3J0KHRleHQpCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIEhFQVA4LCBIRUFQVTgsIEhFQVAxNiwgSEVBUFUxNiwgSEVBUDMyLCBIRUFQVTMyLCBIRUFQRjMyLCBIRUFQRjY0OwoKICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW9yeVZpZXdzKCkgewogICAgICAgICAgICAgIHZhciBiID0gd2FzbU1lbW9yeS5idWZmZXI7CiAgICAgICAgICAgICAgTW9kdWxlWyJIRUFQOCJdID0gSEVBUDggPSBuZXcgSW50OEFycmF5KGIpOwogICAgICAgICAgICAgIE1vZHVsZVsiSEVBUDE2Il0gPSBIRUFQMTYgPSBuZXcgSW50MTZBcnJheShiKTsKICAgICAgICAgICAgICBNb2R1bGVbIkhFQVAzMiJdID0gSEVBUDMyID0gbmV3IEludDMyQXJyYXkoYik7CiAgICAgICAgICAgICAgTW9kdWxlWyJIRUFQVTgiXSA9IEhFQVBVOCA9IG5ldyBVaW50OEFycmF5KGIpOwogICAgICAgICAgICAgIE1vZHVsZVsiSEVBUFUxNiJdID0gSEVBUFUxNiA9IG5ldyBVaW50MTZBcnJheShiKTsKICAgICAgICAgICAgICBNb2R1bGVbIkhFQVBVMzIiXSA9IEhFQVBVMzIgPSBuZXcgVWludDMyQXJyYXkoYik7CiAgICAgICAgICAgICAgTW9kdWxlWyJIRUFQRjMyIl0gPSBIRUFQRjMyID0gbmV3IEZsb2F0MzJBcnJheShiKTsKICAgICAgICAgICAgICBNb2R1bGVbIkhFQVBGNjQiXSA9IEhFQVBGNjQgPSBuZXcgRmxvYXQ2NEFycmF5KGIpCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzbVRhYmxlOwogICAgICAgICAgdmFyIF9fQVRQUkVSVU5fXyA9IFtdOwogICAgICAgICAgdmFyIF9fQVRJTklUX18gPSBbXTsKICAgICAgICAgIHZhciBfX0FUUE9TVFJVTl9fID0gW107CiAgICAgICAgICB2YXIgcnVudGltZUluaXRpYWxpemVkID0gZmFsc2U7CiAgICAgICAgICB2YXIgcnVudGltZUtlZXBhbGl2ZUNvdW50ZXIgPSAwOwoKICAgICAgICAgIGZ1bmN0aW9uIGtlZXBSdW50aW1lQWxpdmUoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vRXhpdFJ1bnRpbWUgfHwgcnVudGltZUtlZXBhbGl2ZUNvdW50ZXIgPiAwCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gcHJlUnVuKCkgewogICAgICAgICAgICAgIGlmIChNb2R1bGVbInByZVJ1biJdKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgTW9kdWxlWyJwcmVSdW4iXSA9PSAiZnVuY3Rpb24iKSBNb2R1bGVbInByZVJ1biJdID0gW01vZHVsZVsicHJlUnVuIl1dOwogICAgICAgICAgICAgICAgICB3aGlsZSAoTW9kdWxlWyJwcmVSdW4iXS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZE9uUHJlUnVuKE1vZHVsZVsicHJlUnVuIl0uc2hpZnQoKSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYWxsUnVudGltZUNhbGxiYWNrcyhfX0FUUFJFUlVOX18pCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gaW5pdFJ1bnRpbWUoKSB7CiAgICAgICAgICAgICAgcnVudGltZUluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAoIU1vZHVsZVsibm9GU0luaXQiXSAmJiAhRlMuaW5pdC5pbml0aWFsaXplZCkgRlMuaW5pdCgpOwogICAgICAgICAgICAgIEZTLmlnbm9yZVBlcm1pc3Npb25zID0gZmFsc2U7CiAgICAgICAgICAgICAgVFRZLmluaXQoKTsKICAgICAgICAgICAgICBjYWxsUnVudGltZUNhbGxiYWNrcyhfX0FUSU5JVF9fKQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIHBvc3RSdW4oKSB7CiAgICAgICAgICAgICAgaWYgKE1vZHVsZVsicG9zdFJ1biJdKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgTW9kdWxlWyJwb3N0UnVuIl0gPT0gImZ1bmN0aW9uIikgTW9kdWxlWyJwb3N0UnVuIl0gPSBbTW9kdWxlWyJwb3N0UnVuIl1dOwogICAgICAgICAgICAgICAgICB3aGlsZSAoTW9kdWxlWyJwb3N0UnVuIl0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICBhZGRPblBvc3RSdW4oTW9kdWxlWyJwb3N0UnVuIl0uc2hpZnQoKSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYWxsUnVudGltZUNhbGxiYWNrcyhfX0FUUE9TVFJVTl9fKQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGFkZE9uUHJlUnVuKGNiKSB7CiAgICAgICAgICAgICAgX19BVFBSRVJVTl9fLnVuc2hpZnQoY2IpCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gYWRkT25Jbml0KGNiKSB7CiAgICAgICAgICAgICAgX19BVElOSVRfXy51bnNoaWZ0KGNiKQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGFkZE9uUG9zdFJ1bihjYikgewogICAgICAgICAgICAgIF9fQVRQT1NUUlVOX18udW5zaGlmdChjYikKICAgICAgICAgIH0KICAgICAgICAgIHZhciBydW5EZXBlbmRlbmNpZXMgPSAwOwogICAgICAgICAgdmFyIHJ1bkRlcGVuZGVuY3lXYXRjaGVyID0gbnVsbDsKICAgICAgICAgIHZhciBkZXBlbmRlbmNpZXNGdWxmaWxsZWQgPSBudWxsOwoKICAgICAgICAgIGZ1bmN0aW9uIGdldFVuaXF1ZVJ1bkRlcGVuZGVuY3koaWQpIHsKICAgICAgICAgICAgICByZXR1cm4gaWQKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBhZGRSdW5EZXBlbmRlbmN5KGlkKSB7CiAgICAgICAgICAgICAgcnVuRGVwZW5kZW5jaWVzKys7CiAgICAgICAgICAgICAgaWYgKE1vZHVsZVsibW9uaXRvclJ1bkRlcGVuZGVuY2llcyJdKSB7CiAgICAgICAgICAgICAgICAgIE1vZHVsZVsibW9uaXRvclJ1bkRlcGVuZGVuY2llcyJdKHJ1bkRlcGVuZGVuY2llcykKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlUnVuRGVwZW5kZW5jeShpZCkgewogICAgICAgICAgICAgIHJ1bkRlcGVuZGVuY2llcy0tOwogICAgICAgICAgICAgIGlmIChNb2R1bGVbIm1vbml0b3JSdW5EZXBlbmRlbmNpZXMiXSkgewogICAgICAgICAgICAgICAgICBNb2R1bGVbIm1vbml0b3JSdW5EZXBlbmRlbmNpZXMiXShydW5EZXBlbmRlbmNpZXMpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChydW5EZXBlbmRlbmNpZXMgPT0gMCkgewogICAgICAgICAgICAgICAgICBpZiAocnVuRGVwZW5kZW5jeVdhdGNoZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocnVuRGVwZW5kZW5jeVdhdGNoZXIpOwogICAgICAgICAgICAgICAgICAgICAgcnVuRGVwZW5kZW5jeVdhdGNoZXIgPSBudWxsCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGRlcGVuZGVuY2llc0Z1bGZpbGxlZCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZGVwZW5kZW5jaWVzRnVsZmlsbGVkOwogICAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzRnVsZmlsbGVkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBhYm9ydCh3aGF0KSB7CiAgICAgICAgICAgICAgaWYgKE1vZHVsZVsib25BYm9ydCJdKSB7CiAgICAgICAgICAgICAgICAgIE1vZHVsZVsib25BYm9ydCJdKHdoYXQpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoYXQgPSAiQWJvcnRlZCgiICsgd2hhdCArICIpIjsKICAgICAgICAgICAgICBlcnIod2hhdCk7CiAgICAgICAgICAgICAgQUJPUlQgPSB0cnVlOwogICAgICAgICAgICAgIEVYSVRTVEFUVVMgPSAxOwogICAgICAgICAgICAgIHdoYXQgKz0gIi4gQnVpbGQgd2l0aCAtc0FTU0VSVElPTlMgZm9yIG1vcmUgaW5mby4iOwogICAgICAgICAgICAgIHZhciBlID0gbmV3IFdlYkFzc2VtYmx5LlJ1bnRpbWVFcnJvcih3aGF0KTsKICAgICAgICAgICAgICByZWFkeVByb21pc2VSZWplY3QoZSk7CiAgICAgICAgICAgICAgdGhyb3cgZQogICAgICAgICAgfQogICAgICAgICAgdmFyIGRhdGFVUklQcmVmaXggPSAiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCI7CgogICAgICAgICAgZnVuY3Rpb24gaXNEYXRhVVJJKGZpbGVuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZpbGVuYW1lLnN0YXJ0c1dpdGgoZGF0YVVSSVByZWZpeCkKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBpc0ZpbGVVUkkoZmlsZW5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZmlsZW5hbWUuc3RhcnRzV2l0aCgiZmlsZTovLyIpCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzbUJpbmFyeUZpbGU7CiAgICAgICAgICB3YXNtQmluYXJ5RmlsZSA9ICJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvZ2gvamFja2IwYmFjay9zdHJlYW1pbmdBc3NldHNAbWFpbi9WaWRtaXgvZmZtcGVnLXNpbWQtbm9zYWItMTY5OTk4NTE3Mi53YXNtIjsKICAgICAgICAgIGlmICghaXNEYXRhVVJJKHdhc21CaW5hcnlGaWxlKSkgewogICAgICAgICAgICAgIHdhc21CaW5hcnlGaWxlID0gbG9jYXRlRmlsZSh3YXNtQmluYXJ5RmlsZSkKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBnZXRCaW5hcnkoZmlsZSkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmIChmaWxlID09IHdhc21CaW5hcnlGaWxlICYmIHdhc21CaW5hcnkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheSh3YXNtQmluYXJ5KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChyZWFkQmluYXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVhZEJpbmFyeShmaWxlKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHRocm93ICJib3RoIGFzeW5jIGFuZCBzeW5jIGZldGNoaW5nIG9mIHRoZSB3YXNtIGZhaWxlZCIKICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgICAgYWJvcnQoZXJyKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBnZXRCaW5hcnlQcm9taXNlKGJpbmFyeUZpbGUpIHsKICAgICAgICAgICAgICBpZiAoIXdhc21CaW5hcnkgJiYgKEVOVklST05NRU5UX0lTX1dFQiB8fCBFTlZJUk9OTUVOVF9JU19XT1JLRVIpKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZmV0Y2ggPT0gImZ1bmN0aW9uIiAmJiAhaXNGaWxlVVJJKGJpbmFyeUZpbGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmV0Y2goImh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9naC9qYWNrYjBiYWNrL3N0cmVhbWluZ0Fzc2V0c0BtYWluL1ZpZG1peC8iKyBiaW5hcnlGaWxlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlZGVudGlhbHM6ICJzYW1lLW9yaWdpbiIKICAgICAgICAgICAgICAgICAgICAgIH0pLnRoZW4ocmVzcG9uc2UgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2VbIm9rIl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgImZhaWxlZCB0byBsb2FkIHdhc20gYmluYXJ5IGZpbGUgYXQgJyIgKyBiaW5hcnlGaWxlICsgIiciCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZVsiYXJyYXlCdWZmZXIiXSgpCiAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaCgoKSA9PiBnZXRCaW5hcnkoYmluYXJ5RmlsZSkpCiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocmVhZEFzeW5jKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZEFzeW5jKGJpbmFyeUZpbGUsIHJlc3BvbnNlID0+IHJlc29sdmUobmV3IFVpbnQ4QXJyYXkocmVzcG9uc2UpKSwgcmVqZWN0KQogICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZ2V0QmluYXJ5KGJpbmFyeUZpbGUpKQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGluc3RhbnRpYXRlQXJyYXlCdWZmZXIoYmluYXJ5RmlsZSwgaW1wb3J0cywgcmVjZWl2ZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0QmluYXJ5UHJvbWlzZShiaW5hcnlGaWxlKS50aGVuKGJpbmFyeSA9PiB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZShiaW5hcnksIGltcG9ydHMpCiAgICAgICAgICAgICAgfSkudGhlbihpbnN0YW5jZSA9PiB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZQogICAgICAgICAgICAgIH0pLnRoZW4ocmVjZWl2ZXIsIHJlYXNvbiA9PiB7CiAgICAgICAgICAgICAgICAgIGVycigiZmFpbGVkIHRvIGFzeW5jaHJvbm91c2x5IHByZXBhcmUgd2FzbTogIiArIHJlYXNvbik7CiAgICAgICAgICAgICAgICAgIGFib3J0KHJlYXNvbikKICAgICAgICAgICAgICB9KQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGluc3RhbnRpYXRlQXN5bmMoYmluYXJ5LCBiaW5hcnlGaWxlLCBpbXBvcnRzLCBjYWxsYmFjaykgewogICAgICAgICAgICAgIGlmICghYmluYXJ5ICYmIHR5cGVvZiBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyA9PSAiZnVuY3Rpb24iICYmICFpc0RhdGFVUkkoYmluYXJ5RmlsZSkgJiYgIWlzRmlsZVVSSShiaW5hcnlGaWxlKSAmJiAhRU5WSVJPTk1FTlRfSVNfTk9ERSAmJiB0eXBlb2YgZmV0Y2ggPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmV0Y2goYmluYXJ5RmlsZSwgewogICAgICAgICAgICAgICAgICAgICAgY3JlZGVudGlhbHM6ICJzYW1lLW9yaWdpbiIKICAgICAgICAgICAgICAgICAgfSkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmcocmVzcG9uc2UsIGltcG9ydHMpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC50aGVuKGNhbGxiYWNrLCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBlcnIoIndhc20gc3RyZWFtaW5nIGNvbXBpbGUgZmFpbGVkOiAiICsgcmVhc29uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBlcnIoImZhbGxpbmcgYmFjayB0byBBcnJheUJ1ZmZlciBpbnN0YW50aWF0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbnRpYXRlQXJyYXlCdWZmZXIoYmluYXJ5RmlsZSwgaW1wb3J0cywgY2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW50aWF0ZUFycmF5QnVmZmVyKGJpbmFyeUZpbGUsIGltcG9ydHMsIGNhbGxiYWNrKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVXYXNtKCkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gewogICAgICAgICAgICAgICAgICAiYSI6IHdhc21JbXBvcnRzCiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVjZWl2ZUluc3RhbmNlKGluc3RhbmNlLCBtb2R1bGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cG9ydHMgPSBpbnN0YW5jZS5leHBvcnRzOwogICAgICAgICAgICAgICAgICBleHBvcnRzID0gQXN5bmNpZnkuaW5zdHJ1bWVudFdhc21FeHBvcnRzKGV4cG9ydHMpOwogICAgICAgICAgICAgICAgICBNb2R1bGVbImFzbSJdID0gZXhwb3J0czsKICAgICAgICAgICAgICAgICAgd2FzbU1lbW9yeSA9IE1vZHVsZVsiYXNtIl1bIlYiXTsKICAgICAgICAgICAgICAgICAgdXBkYXRlTWVtb3J5Vmlld3MoKTsKICAgICAgICAgICAgICAgICAgd2FzbVRhYmxlID0gTW9kdWxlWyJhc20iXVsiWCJdOwogICAgICAgICAgICAgICAgICBhZGRPbkluaXQoTW9kdWxlWyJhc20iXVsiVyJdKTsKICAgICAgICAgICAgICAgICAgcmVtb3ZlUnVuRGVwZW5kZW5jeSgid2FzbS1pbnN0YW50aWF0ZSIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0cwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhZGRSdW5EZXBlbmRlbmN5KCJ3YXNtLWluc3RhbnRpYXRlIik7CgogICAgICAgICAgICAgIGZ1bmN0aW9uIHJlY2VpdmVJbnN0YW50aWF0aW9uUmVzdWx0KHJlc3VsdCkgewogICAgICAgICAgICAgICAgICByZWNlaXZlSW5zdGFuY2UocmVzdWx0WyJpbnN0YW5jZSJdKQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoTW9kdWxlWyJpbnN0YW50aWF0ZVdhc20iXSkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1vZHVsZVsiaW5zdGFudGlhdGVXYXNtIl0oaW5mbywgcmVjZWl2ZUluc3RhbmNlKQogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnIoIk1vZHVsZS5pbnN0YW50aWF0ZVdhc20gY2FsbGJhY2sgZmFpbGVkIHdpdGggZXJyb3I6ICIgKyBlKTsKICAgICAgICAgICAgICAgICAgICAgIHJlYWR5UHJvbWlzZVJlamVjdChlKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGluc3RhbnRpYXRlQXN5bmMod2FzbUJpbmFyeSwgd2FzbUJpbmFyeUZpbGUsIGluZm8sIHJlY2VpdmVJbnN0YW50aWF0aW9uUmVzdWx0KS5jYXRjaChyZWFkeVByb21pc2VSZWplY3QpOwogICAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgICAgfQogICAgICAgICAgdmFyIHRlbXBEb3VibGU7CiAgICAgICAgICB2YXIgdGVtcEk2NDsKICAgICAgICAgIHZhciBBU01fQ09OU1RTID0gewogICAgICAgICAgICAgIDg2MTc4MDogJDAgPT4gewogICAgICAgICAgICAgICAgICBsZXQgcyA9IEZGbXBlZ01vZHVsZS5VVEY4VG9TdHJpbmcoJDApOwogICAgICAgICAgICAgICAgICBpZiAod2luZG93LmZmUHJvZ3Jlc3NSZXBvcnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5mZlByb2dyZXNzUmVwb3J0KHMpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgRkZtcGVnTW9kdWxlLl9mcmVlKCQwKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgODYxOTA4OiAoJDAsICQxKSA9PiB7CiAgICAgICAgICAgICAgICAgIHdpbmRvdy5mZkNvbnNvbGVPdXRwdXQoJDEsIFVURjhUb1N0cmluZygkMCkpOwogICAgICAgICAgICAgICAgICBGRm1wZWdNb2R1bGUuX2ZyZWUoJDApCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjE5ODE6ICgkMCwgJDEsICQyLCAkMywgJDQpID0+IHsKICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAiY21kIjogImZpbGVyZWFkcmVxIiwKICAgICAgICAgICAgICAgICAgICAgICJhcmdzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJyZXFJRCI6ICQwLAogICAgICAgICAgICAgICAgICAgICAgICAgICJmaWxlSGFuZGxlSUQiOiAkMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAib2Zmc2V0X2wiOiAkMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAib2Zmc2V0X2giOiAkMywKICAgICAgICAgICAgICAgICAgICAgICAgICAicmVhZGxlbmd0aCI6ICQ0CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjIxMjg6ICgkMCwgJDEsICQyLCAkMywgJDQsICQ1KSA9PiB7CiAgICAgICAgICAgICAgICAgIGxldCByZXNidWZmID0gRkZtcGVnTW9kdWxlLkhFQVBVOC5idWZmZXIuc2xpY2UoJDMsICQzICsgJDQgKiAkNSAqIDMgLyAyKTsKICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAiY21kIjogImdldEZGVmlkZW9EZWNvZGVyRnJhbWUiLAogICAgICAgICAgICAgICAgICAgICAgInJlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidmlkIjogJDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcUlEIjogJDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRzIjogJDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImJ1ZmYiOiByZXNidWZmLAogICAgICAgICAgICAgICAgICAgICAgICAgICJ3aWR0aCI6ICQ0LAogICAgICAgICAgICAgICAgICAgICAgICAgICJoZWlnaHQiOiAkNQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LCBbcmVzYnVmZl0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjIzNjU6ICQwID0+IHsKICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAiY21kIjogIm9wZW5maWxlIiwKICAgICAgICAgICAgICAgICAgICAgICJhcmdzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJidWZmIjogbmV3IFVpbnQ4QXJyYXkoMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlZiI6ICQwCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjI0NjE6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgZmZtcGVnY21kX2JnX2ZpbmlzaGVkKCkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIDg2MjQ5MDogKCQwLCAkMSwgJDIsICQzKSA9PiB7CiAgICAgICAgICAgICAgICAgIGxldCByZXNidWZmID0gRkZtcGVnTW9kdWxlLkhFQVBVOC5idWZmZXIuc2xpY2UoJDIsICQyICsgJDMpOwogICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgICJjbWQiOiAiZ2V0RkZBdWRpb0RhdGEiLAogICAgICAgICAgICAgICAgICAgICAgInJlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidmlkIjogJDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcUlEIjogJDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImJ1ZmYiOiByZXNidWZmCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sIFtyZXNidWZmXSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIDg2MjY2NzogKCQwLCAkMSkgPT4gewogICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgICJjbWQiOiAib3BlbmZpbGUtcHJvZ3Jlc3MiLAogICAgICAgICAgICAgICAgICAgICAgImFyZ3MiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInByb2dyZXNzIjogJDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlZiI6ICQxCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjI3NjI6ICgkMCwgJDEsICQyKSA9PiB7CiAgICAgICAgICAgICAgICAgIGxldCBmZmJ1ZmYgPSBuZXcgVWludDhBcnJheSgkMSk7CiAgICAgICAgICAgICAgICAgIGZmYnVmZi5zZXQobmV3IFVpbnQ4QXJyYXkoRkZtcGVnTW9kdWxlLkhFQVBVOC5idWZmZXIsICQwLCAkMSksIDApOwogICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgICJjbWQiOiAib3BlbmZpbGUiLAogICAgICAgICAgICAgICAgICAgICAgInJlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAiYnVmZiI6IGZmYnVmZiwKICAgICAgICAgICAgICAgICAgICAgICAgICAicmVmIjogJDIKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIDg2Mjk0NjogKCQwLCAkMSwgJDIsICQzLCAkNCwgJDUsICQ2LCAkNywgJDgpID0+IHsKICAgICAgICAgICAgICAgICAgbGV0IGZmYnVmZiA9IG5ldyBVaW50OEFycmF5KEZGbXBlZ01vZHVsZS5IRUFQVTguYnVmZmVyLCAkMCwgJDEpOwogICAgICAgICAgICAgICAgICB2YXIgcHRyID0gd2luZG93Lk1vZHVsZS5fbWFsbG9jKCQxKTsKICAgICAgICAgICAgICAgICAgd2luZG93Lk1vZHVsZS5IRUFQVTguc2V0KGZmYnVmZiwgcHRyKTsKICAgICAgICAgICAgICAgICAgZmZTZXFGcmFtZVJlYWRSZXN1bHQocHRyLCAkMSwgJDYsICQ3LCAkMiwgJDMsICQ4LCAkNCwgJDUpOwogICAgICAgICAgICAgICAgICBGRm1wZWdNb2R1bGUuX2ZyZWUoJDApCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjMxNzM6ICgkMCwgJDEsICQyKSA9PiB7CiAgICAgICAgICAgICAgICAgIGxldCBiID0gRkZtcGVnTW9kdWxlLkhFQVBVOC5idWZmZXIuc2xpY2UoJDAsICQwICsgJDEpOwogICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgICJjbWQiOiAid3JpdGVUb1ZpZGVvT3V0cHV0RmlsZSIsCiAgICAgICAgICAgICAgICAgICAgICAiYnVmZiI6IGIsCiAgICAgICAgICAgICAgICAgICAgICAiZmhpZCI6ICQyCiAgICAgICAgICAgICAgICAgIH0sIFtiXSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIDg2MzMxMTogKCQwLCAkMSwgJDIsICQzKSA9PiB7CiAgICAgICAgICAgICAgICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgICAgImNtZCI6ICJzZWVrVmlkZW9PdXRwdXRGaWxlIiwKICAgICAgICAgICAgICAgICAgICAgICJvZmZzZXRfaCI6ICQwLAogICAgICAgICAgICAgICAgICAgICAgIm9mZnNldF9sIjogJDEsCiAgICAgICAgICAgICAgICAgICAgICAid2hlbmNlIjogJDIsCiAgICAgICAgICAgICAgICAgICAgICAiZmhpZCI6ICQzCiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjM0MTk6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAiY21kIjogInJlYWR5Rm9yVmlkZW9CdWZmZXIiCiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjM0NzM6ICQwID0+IHsKICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAiY21kIjogImZmbXBlZ0RvbmVBdWRpb0ZyYW1lQ2FsbGJhY2siLAogICAgICAgICAgICAgICAgICAgICAgImFyZ3MiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInJpZCI6ICQwCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjM1NTQ6ICQwID0+IHsKICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAiY21kIjogImZmbXBlZ0RvbmVBdWRpb0ZyYW1lQ2FsbGJhY2siLAogICAgICAgICAgICAgICAgICAgICAgImFyZ3MiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInJpZCI6ICQwCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICA4NjM2MzU6ICQwID0+IHsKICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAiY21kIjogImZmbXBlZ091dHB1dERvd25sb2FkIiwKICAgICAgICAgICAgICAgICAgICAgICJhcmdzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJyaWQiOiAkMAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgZnVuY3Rpb24gX19hc3luY2pzX193YWl0Rm9yUmVhZFJlc3VsdEFzeW5jKCkgewogICAgICAgICAgICAgIHJldHVybiBBc3luY2lmeS5oYW5kbGVBc3luYyhhc3luYyAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGF3YWl0ICgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5maWxlcmVhZHJlc29sdmUgPSByZXNvbHZlCiAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICB9KSgpCiAgICAgICAgICAgICAgfSkKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBFeGl0U3RhdHVzKHN0YXR1cykgewogICAgICAgICAgICAgIHRoaXMubmFtZSA9ICJFeGl0U3RhdHVzIjsKICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2UgPSAiUHJvZ3JhbSB0ZXJtaW5hdGVkIHdpdGggZXhpdCgiICsgc3RhdHVzICsgIikiOwogICAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gY2FsbFJ1bnRpbWVDYWxsYmFja3MoY2FsbGJhY2tzKSB7CiAgICAgICAgICAgICAgd2hpbGUgKGNhbGxiYWNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5zaGlmdCgpKE1vZHVsZSkKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gRXhjZXB0aW9uSW5mbyhleGNQdHIpIHsKICAgICAgICAgICAgICB0aGlzLmV4Y1B0ciA9IGV4Y1B0cjsKICAgICAgICAgICAgICB0aGlzLnB0ciA9IGV4Y1B0ciAtIDI0OwogICAgICAgICAgICAgIHRoaXMuc2V0X3R5cGUgPSBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICAgICAgICAgIEhFQVBVMzJbdGhpcy5wdHIgKyA0ID4+IDJdID0gdHlwZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdGhpcy5nZXRfdHlwZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUFUzMlt0aGlzLnB0ciArIDQgPj4gMl0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHRoaXMuc2V0X2Rlc3RydWN0b3IgPSBmdW5jdGlvbihkZXN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAgIEhFQVBVMzJbdGhpcy5wdHIgKyA4ID4+IDJdID0gZGVzdHJ1Y3RvcgogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdGhpcy5nZXRfZGVzdHJ1Y3RvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUFUzMlt0aGlzLnB0ciArIDggPj4gMl0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHRoaXMuc2V0X2NhdWdodCA9IGZ1bmN0aW9uKGNhdWdodCkgewogICAgICAgICAgICAgICAgICBjYXVnaHQgPSBjYXVnaHQgPyAxIDogMDsKICAgICAgICAgICAgICAgICAgSEVBUDhbdGhpcy5wdHIgKyAxMiA+PiAwXSA9IGNhdWdodAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdGhpcy5nZXRfY2F1Z2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQOFt0aGlzLnB0ciArIDEyID4+IDBdICE9IDAKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHRoaXMuc2V0X3JldGhyb3duID0gZnVuY3Rpb24ocmV0aHJvd24pIHsKICAgICAgICAgICAgICAgICAgcmV0aHJvd24gPSByZXRocm93biA/IDEgOiAwOwogICAgICAgICAgICAgICAgICBIRUFQOFt0aGlzLnB0ciArIDEzID4+IDBdID0gcmV0aHJvd24KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHRoaXMuZ2V0X3JldGhyb3duID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQOFt0aGlzLnB0ciArIDEzID4+IDBdICE9IDAKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHRoaXMuaW5pdCA9IGZ1bmN0aW9uKHR5cGUsIGRlc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5zZXRfYWRqdXN0ZWRfcHRyKDApOwogICAgICAgICAgICAgICAgICB0aGlzLnNldF90eXBlKHR5cGUpOwogICAgICAgICAgICAgICAgICB0aGlzLnNldF9kZXN0cnVjdG9yKGRlc3RydWN0b3IpCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB0aGlzLnNldF9hZGp1c3RlZF9wdHIgPSBmdW5jdGlvbihhZGp1c3RlZFB0cikgewogICAgICAgICAgICAgICAgICBIRUFQVTMyW3RoaXMucHRyICsgMTYgPj4gMl0gPSBhZGp1c3RlZFB0cgogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdGhpcy5nZXRfYWRqdXN0ZWRfcHRyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQVTMyW3RoaXMucHRyICsgMTYgPj4gMl0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHRoaXMuZ2V0X2V4Y2VwdGlvbl9wdHIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdmFyIGlzUG9pbnRlciA9IF9fX2N4YV9pc19wb2ludGVyX3R5cGUodGhpcy5nZXRfdHlwZSgpKTsKICAgICAgICAgICAgICAgICAgaWYgKGlzUG9pbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQVBVMzJbdGhpcy5leGNQdHIgPj4gMl0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgYWRqdXN0ZWQgPSB0aGlzLmdldF9hZGp1c3RlZF9wdHIoKTsKICAgICAgICAgICAgICAgICAgaWYgKGFkanVzdGVkICE9PSAwKSByZXR1cm4gYWRqdXN0ZWQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV4Y1B0cgogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGNlcHRpb25MYXN0ID0gMDsKICAgICAgICAgIHZhciB1bmNhdWdodEV4Y2VwdGlvbkNvdW50ID0gMDsKCiAgICAgICAgICBmdW5jdGlvbiBfX19jeGFfdGhyb3cocHRyLCB0eXBlLCBkZXN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSBuZXcgRXhjZXB0aW9uSW5mbyhwdHIpOwogICAgICAgICAgICAgIGluZm8uaW5pdCh0eXBlLCBkZXN0cnVjdG9yKTsKICAgICAgICAgICAgICBleGNlcHRpb25MYXN0ID0gcHRyOwogICAgICAgICAgICAgIHVuY2F1Z2h0RXhjZXB0aW9uQ291bnQrKzsKICAgICAgICAgICAgICB0aHJvdyBleGNlcHRpb25MYXN0CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgUEFUSCA9IHsKICAgICAgICAgICAgICBpc0FiczogcGF0aCA9PiBwYXRoLmNoYXJBdCgwKSA9PT0gIi8iLAogICAgICAgICAgICAgIHNwbGl0UGF0aDogZmlsZW5hbWUgPT4gewogICAgICAgICAgICAgICAgICB2YXIgc3BsaXRQYXRoUmUgPSAvXihcLz98KShbXHNcU10qPykoKD86XC57MSwyfXxbXlwvXSs/fCkoXC5bXi5cL10qfCkpKD86W1wvXSopJC87CiAgICAgICAgICAgICAgICAgIHJldHVybiBzcGxpdFBhdGhSZS5leGVjKGZpbGVuYW1lKS5zbGljZSgxKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbm9ybWFsaXplQXJyYXk6IChwYXJ0cywgYWxsb3dBYm92ZVJvb3QpID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIHVwID0gMDsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHBhcnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdCA9IHBhcnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3QgPT09ICIuIikgewogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzLnNwbGljZShpLCAxKQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChsYXN0ID09PSAiLi4iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHVwKysKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdXAtLQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChhbGxvd0Fib3ZlUm9vdCkgewogICAgICAgICAgICAgICAgICAgICAgZm9yICg7IHVwOyB1cC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMudW5zaGlmdCgiLi4iKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0cwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbm9ybWFsaXplOiBwYXRoID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIGlzQWJzb2x1dGUgPSBQQVRILmlzQWJzKHBhdGgpLAogICAgICAgICAgICAgICAgICAgICAgdHJhaWxpbmdTbGFzaCA9IHBhdGguc3Vic3RyKC0xKSA9PT0gIi8iOwogICAgICAgICAgICAgICAgICBwYXRoID0gUEFUSC5ub3JtYWxpemVBcnJheShwYXRoLnNwbGl0KCIvIikuZmlsdGVyKHAgPT4gISFwKSwgIWlzQWJzb2x1dGUpLmpvaW4oIi8iKTsKICAgICAgICAgICAgICAgICAgaWYgKCFwYXRoICYmICFpc0Fic29sdXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICBwYXRoID0gIi4iCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHBhdGggJiYgdHJhaWxpbmdTbGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgcGF0aCArPSAiLyIKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gKGlzQWJzb2x1dGUgPyAiLyIgOiAiIikgKyBwYXRoCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkaXJuYW1lOiBwYXRoID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFBBVEguc3BsaXRQYXRoKHBhdGgpLAogICAgICAgICAgICAgICAgICAgICAgcm9vdCA9IHJlc3VsdFswXSwKICAgICAgICAgICAgICAgICAgICAgIGRpciA9IHJlc3VsdFsxXTsKICAgICAgICAgICAgICAgICAgaWYgKCFyb290ICYmICFkaXIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAiLiIKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZGlyKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaXIgPSBkaXIuc3Vic3RyKDAsIGRpci5sZW5ndGggLSAxKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiByb290ICsgZGlyCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBiYXNlbmFtZTogcGF0aCA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChwYXRoID09PSAiLyIpIHJldHVybiAiLyI7CiAgICAgICAgICAgICAgICAgIHBhdGggPSBQQVRILm5vcm1hbGl6ZShwYXRoKTsKICAgICAgICAgICAgICAgICAgcGF0aCA9IHBhdGgucmVwbGFjZSgvXC8kLywgIiIpOwogICAgICAgICAgICAgICAgICB2YXIgbGFzdFNsYXNoID0gcGF0aC5sYXN0SW5kZXhPZigiLyIpOwogICAgICAgICAgICAgICAgICBpZiAobGFzdFNsYXNoID09PSAtMSkgcmV0dXJuIHBhdGg7CiAgICAgICAgICAgICAgICAgIHJldHVybiBwYXRoLnN1YnN0cihsYXN0U2xhc2ggKyAxKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgam9pbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXRocyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBQQVRILm5vcm1hbGl6ZShwYXRocy5qb2luKCIvIikpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBqb2luMjogKGwsIHIpID0+IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFBBVEgubm9ybWFsaXplKGwgKyAiLyIgKyByKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgZnVuY3Rpb24gaW5pdFJhbmRvbUZpbGwoKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjcnlwdG8gPT0gIm9iamVjdCIgJiYgdHlwZW9mIGNyeXB0b1siZ2V0UmFuZG9tVmFsdWVzIl0gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICByZXR1cm4gdmlldyA9PiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKHZpZXcpCiAgICAgICAgICAgICAgfSBlbHNlIGlmIChFTlZJUk9OTUVOVF9JU19OT0RFKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgY3J5cHRvX21vZHVsZSA9IHJlcXVpcmUoImNyeXB0byIpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmRvbUZpbGxTeW5jID0gY3J5cHRvX21vZHVsZVsicmFuZG9tRmlsbFN5bmMiXTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChyYW5kb21GaWxsU3luYykgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2aWV3ID0+IGNyeXB0b19tb2R1bGVbInJhbmRvbUZpbGxTeW5jIl0odmlldykKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHZhciByYW5kb21CeXRlcyA9IGNyeXB0b19tb2R1bGVbInJhbmRvbUJ5dGVzIl07CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmlldyA9PiAodmlldy5zZXQocmFuZG9tQnl0ZXModmlldy5ieXRlTGVuZ3RoKSksIHZpZXcpCiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFib3J0KCJpbml0UmFuZG9tRGV2aWNlIikKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiByYW5kb21GaWxsKHZpZXcpIHsKICAgICAgICAgICAgICByZXR1cm4gKHJhbmRvbUZpbGwgPSBpbml0UmFuZG9tRmlsbCgpKSh2aWV3KQogICAgICAgICAgfQogICAgICAgICAgdmFyIFBBVEhfRlMgPSB7CiAgICAgICAgICAgICAgcmVzb2x2ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZFBhdGggPSAiIiwKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkQWJzb2x1dGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGFyZ3VtZW50cy5sZW5ndGggLSAxOyBpID49IC0xICYmICFyZXNvbHZlZEFic29sdXRlOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0gaSA+PSAwID8gYXJndW1lbnRzW2ldIDogRlMuY3dkKCk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhdGggIT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJBcmd1bWVudHMgdG8gcGF0aC5yZXNvbHZlIG11c3QgYmUgc3RyaW5ncyIpCiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFwYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFBhdGggPSBwYXRoICsgIi8iICsgcmVzb2x2ZWRQYXRoOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRBYnNvbHV0ZSA9IFBBVEguaXNBYnMocGF0aCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXNvbHZlZFBhdGggPSBQQVRILm5vcm1hbGl6ZUFycmF5KHJlc29sdmVkUGF0aC5zcGxpdCgiLyIpLmZpbHRlcihwID0+ICEhcCksICFyZXNvbHZlZEFic29sdXRlKS5qb2luKCIvIik7CiAgICAgICAgICAgICAgICAgIHJldHVybiAocmVzb2x2ZWRBYnNvbHV0ZSA/ICIvIiA6ICIiKSArIHJlc29sdmVkUGF0aCB8fCAiLiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHJlbGF0aXZlOiAoZnJvbSwgdG8pID0+IHsKICAgICAgICAgICAgICAgICAgZnJvbSA9IFBBVEhfRlMucmVzb2x2ZShmcm9tKS5zdWJzdHIoMSk7CiAgICAgICAgICAgICAgICAgIHRvID0gUEFUSF9GUy5yZXNvbHZlKHRvKS5zdWJzdHIoMSk7CgogICAgICAgICAgICAgICAgICBmdW5jdGlvbiB0cmltKGFycikgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gMDsKICAgICAgICAgICAgICAgICAgICAgIGZvciAoOyBzdGFydCA8IGFyci5sZW5ndGg7IHN0YXJ0KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJyW3N0YXJ0XSAhPT0gIiIpIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZW5kID0gYXJyLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICAgICAgICBmb3IgKDsgZW5kID49IDA7IGVuZC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFycltlbmRdICE9PSAiIikgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGFydCA+IGVuZCkgcmV0dXJuIFtdOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyci5zbGljZShzdGFydCwgZW5kIC0gc3RhcnQgKyAxKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBmcm9tUGFydHMgPSB0cmltKGZyb20uc3BsaXQoIi8iKSk7CiAgICAgICAgICAgICAgICAgIHZhciB0b1BhcnRzID0gdHJpbSh0by5zcGxpdCgiLyIpKTsKICAgICAgICAgICAgICAgICAgdmFyIGxlbmd0aCA9IE1hdGgubWluKGZyb21QYXJ0cy5sZW5ndGgsIHRvUGFydHMubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgdmFyIHNhbWVQYXJ0c0xlbmd0aCA9IGxlbmd0aDsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGZyb21QYXJ0c1tpXSAhPT0gdG9QYXJ0c1tpXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHNhbWVQYXJ0c0xlbmd0aCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgb3V0cHV0UGFydHMgPSBbXTsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHNhbWVQYXJ0c0xlbmd0aDsgaSA8IGZyb21QYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgb3V0cHV0UGFydHMucHVzaCgiLi4iKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG91dHB1dFBhcnRzID0gb3V0cHV0UGFydHMuY29uY2F0KHRvUGFydHMuc2xpY2Uoc2FtZVBhcnRzTGVuZ3RoKSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXRQYXJ0cy5qb2luKCIvIikKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIGZ1bmN0aW9uIGxlbmd0aEJ5dGVzVVRGOChzdHIpIHsKICAgICAgICAgICAgICB2YXIgbGVuID0gMDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICB2YXIgYyA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgICAgICBpZiAoYyA8PSAxMjcpIHsKICAgICAgICAgICAgICAgICAgICAgIGxlbisrCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYyA8PSAyMDQ3KSB7CiAgICAgICAgICAgICAgICAgICAgICBsZW4gKz0gMgogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGMgPj0gNTUyOTYgJiYgYyA8PSA1NzM0MykgewogICAgICAgICAgICAgICAgICAgICAgbGVuICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgICArK2kKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGxlbiArPSAzCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGxlbgogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIHN0cmluZ1RvVVRGOEFycmF5KHN0ciwgaGVhcCwgb3V0SWR4LCBtYXhCeXRlc1RvV3JpdGUpIHsKICAgICAgICAgICAgICBpZiAoIShtYXhCeXRlc1RvV3JpdGUgPiAwKSkgcmV0dXJuIDA7CiAgICAgICAgICAgICAgdmFyIHN0YXJ0SWR4ID0gb3V0SWR4OwogICAgICAgICAgICAgIHZhciBlbmRJZHggPSBvdXRJZHggKyBtYXhCeXRlc1RvV3JpdGUgLSAxOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgIHZhciB1ID0gc3RyLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgICAgICAgIGlmICh1ID49IDU1Mjk2ICYmIHUgPD0gNTczNDMpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciB1MSA9IHN0ci5jaGFyQ29kZUF0KCsraSk7CiAgICAgICAgICAgICAgICAgICAgICB1ID0gNjU1MzYgKyAoKHUgJiAxMDIzKSA8PCAxMCkgfCB1MSAmIDEwMjMKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodSA8PSAxMjcpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChvdXRJZHggPj0gZW5kSWR4KSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gdQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHUgPD0gMjA0NykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG91dElkeCArIDEgPj0gZW5kSWR4KSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTkyIHwgdSA+PiA2OwogICAgICAgICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1ICYgNjMKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1IDw9IDY1NTM1KSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAob3V0SWR4ICsgMiA+PSBlbmRJZHgpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAyMjQgfCB1ID4+IDEyOwogICAgICAgICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1ID4+IDYgJiA2MzsKICAgICAgICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gMTI4IHwgdSAmIDYzCiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAob3V0SWR4ICsgMyA+PSBlbmRJZHgpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAyNDAgfCB1ID4+IDE4OwogICAgICAgICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1ID4+IDEyICYgNjM7CiAgICAgICAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IDEyOCB8IHUgPj4gNiAmIDYzOwogICAgICAgICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1ICYgNjMKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBoZWFwW291dElkeF0gPSAwOwogICAgICAgICAgICAgIHJldHVybiBvdXRJZHggLSBzdGFydElkeAogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGludEFycmF5RnJvbVN0cmluZyhzdHJpbmd5LCBkb250QWRkTnVsbCwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIGxlbiA9IGxlbmd0aCA+IDAgPyBsZW5ndGggOiBsZW5ndGhCeXRlc1VURjgoc3RyaW5neSkgKyAxOwogICAgICAgICAgICAgIHZhciB1OGFycmF5ID0gbmV3IEFycmF5KGxlbik7CiAgICAgICAgICAgICAgdmFyIG51bUJ5dGVzV3JpdHRlbiA9IHN0cmluZ1RvVVRGOEFycmF5KHN0cmluZ3ksIHU4YXJyYXksIDAsIHU4YXJyYXkubGVuZ3RoKTsKICAgICAgICAgICAgICBpZiAoZG9udEFkZE51bGwpIHU4YXJyYXkubGVuZ3RoID0gbnVtQnl0ZXNXcml0dGVuOwogICAgICAgICAgICAgIHJldHVybiB1OGFycmF5CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgVVRGOERlY29kZXIgPSB0eXBlb2YgVGV4dERlY29kZXIgIT0gInVuZGVmaW5lZCIgPyBuZXcgVGV4dERlY29kZXIoInV0ZjgiKSA6IHVuZGVmaW5lZDsKCiAgICAgICAgICBmdW5jdGlvbiBVVEY4QXJyYXlUb1N0cmluZyhoZWFwT3JBcnJheSwgaWR4LCBtYXhCeXRlc1RvUmVhZCkgewogICAgICAgICAgICAgIHZhciBlbmRJZHggPSBpZHggKyBtYXhCeXRlc1RvUmVhZDsKICAgICAgICAgICAgICB2YXIgZW5kUHRyID0gaWR4OwogICAgICAgICAgICAgIHdoaWxlIChoZWFwT3JBcnJheVtlbmRQdHJdICYmICEoZW5kUHRyID49IGVuZElkeCkpICsrZW5kUHRyOwogICAgICAgICAgICAgIGlmIChlbmRQdHIgLSBpZHggPiAxNiAmJiBoZWFwT3JBcnJheS5idWZmZXIgJiYgVVRGOERlY29kZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFVURjhEZWNvZGVyLmRlY29kZShoZWFwT3JBcnJheS5zdWJhcnJheShpZHgsIGVuZFB0cikpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHIgPSAiIjsKICAgICAgICAgICAgICB3aGlsZSAoaWR4IDwgZW5kUHRyKSB7CiAgICAgICAgICAgICAgICAgIHZhciB1MCA9IGhlYXBPckFycmF5W2lkeCsrXTsKICAgICAgICAgICAgICAgICAgaWYgKCEodTAgJiAxMjgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSh1MCk7CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciB1MSA9IGhlYXBPckFycmF5W2lkeCsrXSAmIDYzOwogICAgICAgICAgICAgICAgICBpZiAoKHUwICYgMjI0KSA9PSAxOTIpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCh1MCAmIDMxKSA8PCA2IHwgdTEpOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgdTIgPSBoZWFwT3JBcnJheVtpZHgrK10gJiA2MzsKICAgICAgICAgICAgICAgICAgaWYgKCh1MCAmIDI0MCkgPT0gMjI0KSB7CiAgICAgICAgICAgICAgICAgICAgICB1MCA9ICh1MCAmIDE1KSA8PCAxMiB8IHUxIDw8IDYgfCB1MgogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdTAgPSAodTAgJiA3KSA8PCAxOCB8IHUxIDw8IDEyIHwgdTIgPDwgNiB8IGhlYXBPckFycmF5W2lkeCsrXSAmIDYzCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHUwIDwgNjU1MzYpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHUwKQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGNoID0gdTAgLSA2NTUzNjsKICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDU1Mjk2IHwgY2ggPj4gMTAsIDU2MzIwIHwgY2ggJiAxMDIzKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzdHIKICAgICAgICAgIH0KICAgICAgICAgIHZhciBUVFkgPSB7CiAgICAgICAgICAgICAgdHR5czogW10sCiAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgICBzaHV0ZG93bjogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgICByZWdpc3RlcjogZnVuY3Rpb24oZGV2LCBvcHMpIHsKICAgICAgICAgICAgICAgICAgVFRZLnR0eXNbZGV2XSA9IHsKICAgICAgICAgICAgICAgICAgICAgIGlucHV0OiBbXSwKICAgICAgICAgICAgICAgICAgICAgIG91dHB1dDogW10sCiAgICAgICAgICAgICAgICAgICAgICBvcHM6IG9wcwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBGUy5yZWdpc3RlckRldmljZShkZXYsIFRUWS5zdHJlYW1fb3BzKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc3RyZWFtX29wczogewogICAgICAgICAgICAgICAgICBvcGVuOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciB0dHkgPSBUVFkudHR5c1tzdHJlYW0ubm9kZS5yZGV2XTsKICAgICAgICAgICAgICAgICAgICAgIGlmICghdHR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDMpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0udHR5ID0gdHR5OwogICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLnNlZWthYmxlID0gZmFsc2UKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLnR0eS5vcHMuZnN5bmMoc3RyZWFtLnR0eSkKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgZnN5bmM6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLnR0eS5vcHMuZnN5bmMoc3RyZWFtLnR0eSkKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgcmVhZDogZnVuY3Rpb24oc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3MpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RyZWFtLnR0eSB8fCAhc3RyZWFtLnR0eS5vcHMuZ2V0X2NoYXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig2MCkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHZhciBieXRlc1JlYWQgPSAwOwogICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gc3RyZWFtLnR0eS5vcHMuZ2V0X2NoYXIoc3RyZWFtLnR0eSkKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI5KQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQgJiYgYnl0ZXNSZWFkID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IG51bGwgfHwgcmVzdWx0ID09PSB1bmRlZmluZWQpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzUmVhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcltvZmZzZXQgKyBpXSA9IHJlc3VsdAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGJ5dGVzUmVhZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbS5ub2RlLnRpbWVzdGFtcCA9IERhdGUubm93KCkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBieXRlc1JlYWQKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgd3JpdGU6IGZ1bmN0aW9uKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0cmVhbS50dHkgfHwgIXN0cmVhbS50dHkub3BzLnB1dF9jaGFyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNjApCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLnR0eS5vcHMucHV0X2NoYXIoc3RyZWFtLnR0eSwgYnVmZmVyW29mZnNldCArIGldKQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChsZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0ubm9kZS50aW1lc3RhbXAgPSBEYXRlLm5vdygpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkZWZhdWx0X3R0eV9vcHM6IHsKICAgICAgICAgICAgICAgICAgZ2V0X2NoYXI6IGZ1bmN0aW9uKHR0eSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF0dHkuaW5wdXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEVOVklST05NRU5UX0lTX05PREUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIEJVRlNJWkUgPSAyNTY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidWYgPSBCdWZmZXIuYWxsb2MoQlVGU0laRSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBieXRlc1JlYWQgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXNSZWFkID0gZnMucmVhZFN5bmMocHJvY2Vzcy5zdGRpbi5mZCwgYnVmLCAwLCBCVUZTSVpFLCAtMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUudG9TdHJpbmcoKS5pbmNsdWRlcygiRU9GIikpIGJ5dGVzUmVhZCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHRocm93IGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnl0ZXNSZWFkID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gYnVmLnNsaWNlKDAsIGJ5dGVzUmVhZCkudG9TdHJpbmcoInV0Zi04IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHdpbmRvdyAhPSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LnByb21wdCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHdpbmRvdy5wcm9tcHQoIklucHV0OiAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9ICJcbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlYWRsaW5lID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gcmVhZGxpbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9ICJcbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB0dHkuaW5wdXQgPSBpbnRBcnJheUZyb21TdHJpbmcocmVzdWx0LCB0cnVlKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR0eS5pbnB1dC5zaGlmdCgpCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHB1dF9jaGFyOiBmdW5jdGlvbih0dHksIHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gbnVsbCB8fCB2YWwgPT09IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0KFVURjhBcnJheVRvU3RyaW5nKHR0eS5vdXRwdXQsIDApKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0dHkub3V0cHV0ID0gW10KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCAhPSAwKSB0dHkub3V0cHV0LnB1c2godmFsKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBmc3luYzogZnVuY3Rpb24odHR5KSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodHR5Lm91dHB1dCAmJiB0dHkub3V0cHV0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBvdXQoVVRGOEFycmF5VG9TdHJpbmcodHR5Lm91dHB1dCwgMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHR0eS5vdXRwdXQgPSBbXQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkZWZhdWx0X3R0eTFfb3BzOiB7CiAgICAgICAgICAgICAgICAgIHB1dF9jaGFyOiBmdW5jdGlvbih0dHksIHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gbnVsbCB8fCB2YWwgPT09IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyKFVURjhBcnJheVRvU3RyaW5nKHR0eS5vdXRwdXQsIDApKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0dHkub3V0cHV0ID0gW10KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCAhPSAwKSB0dHkub3V0cHV0LnB1c2godmFsKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBmc3luYzogZnVuY3Rpb24odHR5KSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodHR5Lm91dHB1dCAmJiB0dHkub3V0cHV0Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBlcnIoVVRGOEFycmF5VG9TdHJpbmcodHR5Lm91dHB1dCwgMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHR0eS5vdXRwdXQgPSBbXQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBmdW5jdGlvbiB6ZXJvTWVtb3J5KGFkZHJlc3MsIHNpemUpIHsKICAgICAgICAgICAgICBIRUFQVTguZmlsbCgwLCBhZGRyZXNzLCBhZGRyZXNzICsgc2l6ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3MKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBhbGlnbk1lbW9yeShzaXplLCBhbGlnbm1lbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHNpemUgLyBhbGlnbm1lbnQpICogYWxpZ25tZW50CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gbW1hcEFsbG9jKHNpemUpIHsKICAgICAgICAgICAgICBzaXplID0gYWxpZ25NZW1vcnkoc2l6ZSwgNjU1MzYpOwogICAgICAgICAgICAgIHZhciBwdHIgPSBfZW1zY3JpcHRlbl9idWlsdGluX21lbWFsaWduKDY1NTM2LCBzaXplKTsKICAgICAgICAgICAgICBpZiAoIXB0cikgcmV0dXJuIDA7CiAgICAgICAgICAgICAgcmV0dXJuIHplcm9NZW1vcnkocHRyLCBzaXplKQogICAgICAgICAgfQogICAgICAgICAgdmFyIE1FTUZTID0gewogICAgICAgICAgICAgIG9wc190YWJsZTogbnVsbCwKICAgICAgICAgICAgICBtb3VudDogZnVuY3Rpb24obW91bnQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIE1FTUZTLmNyZWF0ZU5vZGUobnVsbCwgIi8iLCAxNjM4NCB8IDUxMSwgMCkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNyZWF0ZU5vZGU6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSwgbW9kZSwgZGV2KSB7CiAgICAgICAgICAgICAgICAgIGlmIChGUy5pc0Jsa2Rldihtb2RlKSB8fCBGUy5pc0ZJRk8obW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYzKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghTUVNRlMub3BzX3RhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICBNRU1GUy5vcHNfdGFibGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldGF0dHI6IE1FTUZTLm5vZGVfb3BzLmdldGF0dHIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRhdHRyOiBNRU1GUy5ub2RlX29wcy5zZXRhdHRyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9va3VwOiBNRU1GUy5ub2RlX29wcy5sb29rdXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBta25vZDogTUVNRlMubm9kZV9vcHMubWtub2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5hbWU6IE1FTUZTLm5vZGVfb3BzLnJlbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVubGluazogTUVNRlMubm9kZV9vcHMudW5saW5rLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm1kaXI6IE1FTUZTLm5vZGVfb3BzLnJtZGlyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZGRpcjogTUVNRlMubm9kZV9vcHMucmVhZGRpciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN5bWxpbms6IE1FTUZTLm5vZGVfb3BzLnN5bWxpbmsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsbHNlZWs6IE1FTUZTLnN0cmVhbV9vcHMubGxzZWVrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0YXR0cjogTUVNRlMubm9kZV9vcHMuZ2V0YXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldGF0dHI6IE1FTUZTLm5vZGVfb3BzLnNldGF0dHIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsbHNlZWs6IE1FTUZTLnN0cmVhbV9vcHMubGxzZWVrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZDogTUVNRlMuc3RyZWFtX29wcy5yZWFkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGU6IE1FTUZTLnN0cmVhbV9vcHMud3JpdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvY2F0ZTogTUVNRlMuc3RyZWFtX29wcy5hbGxvY2F0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1tYXA6IE1FTUZTLnN0cmVhbV9vcHMubW1hcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zeW5jOiBNRU1GUy5zdHJlYW1fb3BzLm1zeW5jCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIGxpbms6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0YXR0cjogTUVNRlMubm9kZV9vcHMuZ2V0YXR0ciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldGF0dHI6IE1FTUZTLm5vZGVfb3BzLnNldGF0dHIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFkbGluazogTUVNRlMubm9kZV9vcHMucmVhZGxpbmsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyZGV2OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldGF0dHI6IE1FTUZTLm5vZGVfb3BzLmdldGF0dHIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRhdHRyOiBNRU1GUy5ub2RlX29wcy5zZXRhdHRyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbTogRlMuY2hyZGV2X3N0cmVhbV9vcHMKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBGUy5jcmVhdGVOb2RlKHBhcmVudCwgbmFtZSwgbW9kZSwgZGV2KTsKICAgICAgICAgICAgICAgICAgaWYgKEZTLmlzRGlyKG5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUubm9kZV9vcHMgPSBNRU1GUy5vcHNfdGFibGUuZGlyLm5vZGU7CiAgICAgICAgICAgICAgICAgICAgICBub2RlLnN0cmVhbV9vcHMgPSBNRU1GUy5vcHNfdGFibGUuZGlyLnN0cmVhbTsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudHMgPSB7fQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEZTLmlzRmlsZShub2RlLm1vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICBub2RlLm5vZGVfb3BzID0gTUVNRlMub3BzX3RhYmxlLmZpbGUubm9kZTsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc3RyZWFtX29wcyA9IE1FTUZTLm9wc190YWJsZS5maWxlLnN0cmVhbTsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUudXNlZEJ5dGVzID0gMDsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudHMgPSBudWxsCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoRlMuaXNMaW5rKG5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUubm9kZV9vcHMgPSBNRU1GUy5vcHNfdGFibGUubGluay5ub2RlOwogICAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHJlYW1fb3BzID0gTUVNRlMub3BzX3RhYmxlLmxpbmsuc3RyZWFtCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoRlMuaXNDaHJkZXYobm9kZS5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgbm9kZS5ub2RlX29wcyA9IE1FTUZTLm9wc190YWJsZS5jaHJkZXYubm9kZTsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc3RyZWFtX29wcyA9IE1FTUZTLm9wc190YWJsZS5jaHJkZXYuc3RyZWFtCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbm9kZS50aW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuY29udGVudHNbbmFtZV0gPSBub2RlOwogICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnRpbWVzdGFtcCA9IG5vZGUudGltZXN0YW1wCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGdldEZpbGVEYXRhQXNUeXBlZEFycmF5OiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICAgIGlmICghbm9kZS5jb250ZW50cykgcmV0dXJuIG5ldyBVaW50OEFycmF5KDApOwogICAgICAgICAgICAgICAgICBpZiAobm9kZS5jb250ZW50cy5zdWJhcnJheSkgcmV0dXJuIG5vZGUuY29udGVudHMuc3ViYXJyYXkoMCwgbm9kZS51c2VkQnl0ZXMpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkobm9kZS5jb250ZW50cykKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGV4cGFuZEZpbGVTdG9yYWdlOiBmdW5jdGlvbihub2RlLCBuZXdDYXBhY2l0eSkgewogICAgICAgICAgICAgICAgICB2YXIgcHJldkNhcGFjaXR5ID0gbm9kZS5jb250ZW50cyA/IG5vZGUuY29udGVudHMubGVuZ3RoIDogMDsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZDYXBhY2l0eSA+PSBuZXdDYXBhY2l0eSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICB2YXIgQ0FQQUNJVFlfRE9VQkxJTkdfTUFYID0gMTAyNCAqIDEwMjQ7CiAgICAgICAgICAgICAgICAgIG5ld0NhcGFjaXR5ID0gTWF0aC5tYXgobmV3Q2FwYWNpdHksIHByZXZDYXBhY2l0eSAqIChwcmV2Q2FwYWNpdHkgPCBDQVBBQ0lUWV9ET1VCTElOR19NQVggPyAyIDogMS4xMjUpID4+PiAwKTsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZDYXBhY2l0eSAhPSAwKSBuZXdDYXBhY2l0eSA9IE1hdGgubWF4KG5ld0NhcGFjaXR5LCAyNTYpOwogICAgICAgICAgICAgICAgICB2YXIgb2xkQ29udGVudHMgPSBub2RlLmNvbnRlbnRzOwogICAgICAgICAgICAgICAgICBub2RlLmNvbnRlbnRzID0gbmV3IFVpbnQ4QXJyYXkobmV3Q2FwYWNpdHkpOwogICAgICAgICAgICAgICAgICBpZiAobm9kZS51c2VkQnl0ZXMgPiAwKSBub2RlLmNvbnRlbnRzLnNldChvbGRDb250ZW50cy5zdWJhcnJheSgwLCBub2RlLnVzZWRCeXRlcyksIDApCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICByZXNpemVGaWxlU3RvcmFnZTogZnVuY3Rpb24obm9kZSwgbmV3U2l6ZSkgewogICAgICAgICAgICAgICAgICBpZiAobm9kZS51c2VkQnl0ZXMgPT0gbmV3U2l6ZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICBpZiAobmV3U2l6ZSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBub2RlLmNvbnRlbnRzID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUudXNlZEJ5dGVzID0gMAogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZENvbnRlbnRzID0gbm9kZS5jb250ZW50czsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudHMgPSBuZXcgVWludDhBcnJheShuZXdTaXplKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRDb250ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudHMuc2V0KG9sZENvbnRlbnRzLnN1YmFycmF5KDAsIE1hdGgubWluKG5ld1NpemUsIG5vZGUudXNlZEJ5dGVzKSkpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBub2RlLnVzZWRCeXRlcyA9IG5ld1NpemUKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbm9kZV9vcHM6IHsKICAgICAgICAgICAgICAgICAgZ2V0YXR0cjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHIgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgIGF0dHIuZGV2ID0gRlMuaXNDaHJkZXYobm9kZS5tb2RlKSA/IG5vZGUuaWQgOiAxOwogICAgICAgICAgICAgICAgICAgICAgYXR0ci5pbm8gPSBub2RlLmlkOwogICAgICAgICAgICAgICAgICAgICAgYXR0ci5tb2RlID0gbm9kZS5tb2RlOwogICAgICAgICAgICAgICAgICAgICAgYXR0ci5ubGluayA9IDE7CiAgICAgICAgICAgICAgICAgICAgICBhdHRyLnVpZCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICBhdHRyLmdpZCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICBhdHRyLnJkZXYgPSBub2RlLnJkZXY7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoRlMuaXNEaXIobm9kZS5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuc2l6ZSA9IDQwOTYKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoRlMuaXNGaWxlKG5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyLnNpemUgPSBub2RlLnVzZWRCeXRlcwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChGUy5pc0xpbmsobm9kZS5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuc2l6ZSA9IG5vZGUubGluay5sZW5ndGgKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci5zaXplID0gMAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYXR0ci5hdGltZSA9IG5ldyBEYXRlKG5vZGUudGltZXN0YW1wKTsKICAgICAgICAgICAgICAgICAgICAgIGF0dHIubXRpbWUgPSBuZXcgRGF0ZShub2RlLnRpbWVzdGFtcCk7CiAgICAgICAgICAgICAgICAgICAgICBhdHRyLmN0aW1lID0gbmV3IERhdGUobm9kZS50aW1lc3RhbXApOwogICAgICAgICAgICAgICAgICAgICAgYXR0ci5ibGtzaXplID0gNDA5NjsKICAgICAgICAgICAgICAgICAgICAgIGF0dHIuYmxvY2tzID0gTWF0aC5jZWlsKGF0dHIuc2l6ZSAvIGF0dHIuYmxrc2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXR0cgogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBzZXRhdHRyOiBmdW5jdGlvbihub2RlLCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ci5tb2RlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1vZGUgPSBhdHRyLm1vZGUKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyLnRpbWVzdGFtcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS50aW1lc3RhbXAgPSBhdHRyLnRpbWVzdGFtcAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHIuc2l6ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgTUVNRlMucmVzaXplRmlsZVN0b3JhZ2Uobm9kZSwgYXR0ci5zaXplKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBsb29rdXA6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRlMuZ2VuZXJpY0Vycm9yc1s0NF0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgbWtub2Q6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSwgbW9kZSwgZGV2KSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gTUVNRlMuY3JlYXRlTm9kZShwYXJlbnQsIG5hbWUsIG1vZGUsIGRldikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgcmVuYW1lOiBmdW5jdGlvbihvbGRfbm9kZSwgbmV3X2RpciwgbmV3X25hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChGUy5pc0RpcihvbGRfbm9kZS5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdfbm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdfbm9kZSA9IEZTLmxvb2t1cE5vZGUobmV3X2RpciwgbmV3X25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3X25vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBuZXdfbm9kZS5jb250ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNTUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb2xkX25vZGUucGFyZW50LmNvbnRlbnRzW29sZF9ub2RlLm5hbWVdOwogICAgICAgICAgICAgICAgICAgICAgb2xkX25vZGUucGFyZW50LnRpbWVzdGFtcCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgICBvbGRfbm9kZS5uYW1lID0gbmV3X25hbWU7CiAgICAgICAgICAgICAgICAgICAgICBuZXdfZGlyLmNvbnRlbnRzW25ld19uYW1lXSA9IG9sZF9ub2RlOwogICAgICAgICAgICAgICAgICAgICAgbmV3X2Rpci50aW1lc3RhbXAgPSBvbGRfbm9kZS5wYXJlbnQudGltZXN0YW1wOwogICAgICAgICAgICAgICAgICAgICAgb2xkX25vZGUucGFyZW50ID0gbmV3X2RpcgogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB1bmxpbms6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHBhcmVudC5jb250ZW50c1tuYW1lXTsKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC50aW1lc3RhbXAgPSBEYXRlLm5vdygpCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHJtZGlyOiBmdW5jdGlvbihwYXJlbnQsIG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gRlMubG9va3VwTm9kZShwYXJlbnQsIG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBub2RlLmNvbnRlbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNTUpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgcGFyZW50LmNvbnRlbnRzW25hbWVdOwogICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnRpbWVzdGFtcCA9IERhdGUubm93KCkKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgcmVhZGRpcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGVudHJpZXMgPSBbIi4iLCAiLi4iXTsKICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBub2RlLmNvbnRlbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFub2RlLmNvbnRlbnRzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgZW50cmllcy5wdXNoKGtleSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbnRyaWVzCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHN5bWxpbms6IGZ1bmN0aW9uKHBhcmVudCwgbmV3bmFtZSwgb2xkcGF0aCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBNRU1GUy5jcmVhdGVOb2RlKHBhcmVudCwgbmV3bmFtZSwgNTExIHwgNDA5NjAsIDApOwogICAgICAgICAgICAgICAgICAgICAgbm9kZS5saW5rID0gb2xkcGF0aDsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHJlYWRsaW5rOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIUZTLmlzTGluayhub2RlLm1vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjgpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5saW5rCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHN0cmVhbV9vcHM6IHsKICAgICAgICAgICAgICAgICAgcmVhZDogZnVuY3Rpb24oc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRlbnRzID0gc3RyZWFtLm5vZGUuY29udGVudHM7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zaXRpb24gPj0gc3RyZWFtLm5vZGUudXNlZEJ5dGVzKSByZXR1cm4gMDsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzaXplID0gTWF0aC5taW4oc3RyZWFtLm5vZGUudXNlZEJ5dGVzIC0gcG9zaXRpb24sIGxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc2l6ZSA+IDggJiYgY29udGVudHMuc3ViYXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIuc2V0KGNvbnRlbnRzLnN1YmFycmF5KHBvc2l0aW9uLCBwb3NpdGlvbiArIHNpemUpLCBvZmZzZXQpCiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSBidWZmZXJbb2Zmc2V0ICsgaV0gPSBjb250ZW50c1twb3NpdGlvbiArIGldCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2l6ZQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB3cml0ZTogZnVuY3Rpb24oc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbiwgY2FuT3duKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYnVmZmVyLmJ1ZmZlciA9PT0gSEVBUDguYnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuT3duID0gZmFsc2UKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmICghbGVuZ3RoKSByZXR1cm4gMDsKICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gc3RyZWFtLm5vZGU7CiAgICAgICAgICAgICAgICAgICAgICBub2RlLnRpbWVzdGFtcCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYnVmZmVyLnN1YmFycmF5ICYmICghbm9kZS5jb250ZW50cyB8fCBub2RlLmNvbnRlbnRzLnN1YmFycmF5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYW5Pd24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jb250ZW50cyA9IGJ1ZmZlci5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIGxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUudXNlZEJ5dGVzID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnVzZWRCeXRlcyA9PT0gMCAmJiBwb3NpdGlvbiA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmNvbnRlbnRzID0gYnVmZmVyLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgbGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS51c2VkQnl0ZXMgPSBsZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsZW5ndGgKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBvc2l0aW9uICsgbGVuZ3RoIDw9IG5vZGUudXNlZEJ5dGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudHMuc2V0KGJ1ZmZlci5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIGxlbmd0aCksIHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlbmd0aAogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIE1FTUZTLmV4cGFuZEZpbGVTdG9yYWdlKG5vZGUsIHBvc2l0aW9uICsgbGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmNvbnRlbnRzLnN1YmFycmF5ICYmIGJ1ZmZlci5zdWJhcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudHMuc2V0KGJ1ZmZlci5zdWJhcnJheShvZmZzZXQsIG9mZnNldCArIGxlbmd0aCksIHBvc2l0aW9uKQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudHNbcG9zaXRpb24gKyBpXSA9IGJ1ZmZlcltvZmZzZXQgKyBpXQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIG5vZGUudXNlZEJ5dGVzID0gTWF0aC5tYXgobm9kZS51c2VkQnl0ZXMsIHBvc2l0aW9uICsgbGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsZW5ndGgKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgbGxzZWVrOiBmdW5jdGlvbihzdHJlYW0sIG9mZnNldCwgd2hlbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBvZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgICBpZiAod2hlbmNlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gc3RyZWFtLnBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHdoZW5jZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChGUy5pc0ZpbGUoc3RyZWFtLm5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gc3RyZWFtLm5vZGUudXNlZEJ5dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9uIDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGFsbG9jYXRlOiBmdW5jdGlvbihzdHJlYW0sIG9mZnNldCwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICBNRU1GUy5leHBhbmRGaWxlU3RvcmFnZShzdHJlYW0ubm9kZSwgb2Zmc2V0ICsgbGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbS5ub2RlLnVzZWRCeXRlcyA9IE1hdGgubWF4KHN0cmVhbS5ub2RlLnVzZWRCeXRlcywgb2Zmc2V0ICsgbGVuZ3RoKQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBtbWFwOiBmdW5jdGlvbihzdHJlYW0sIGxlbmd0aCwgcG9zaXRpb24sIHByb3QsIGZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIUZTLmlzRmlsZShzdHJlYW0ubm9kZS5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQzKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgdmFyIHB0cjsKICAgICAgICAgICAgICAgICAgICAgIHZhciBhbGxvY2F0ZWQ7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGVudHMgPSBzdHJlYW0ubm9kZS5jb250ZW50czsKICAgICAgICAgICAgICAgICAgICAgIGlmICghKGZsYWdzICYgMikgJiYgY29udGVudHMuYnVmZmVyID09PSBIRUFQOC5idWZmZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvY2F0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwdHIgPSBjb250ZW50cy5ieXRlT2Zmc2V0CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NpdGlvbiA+IDAgfHwgcG9zaXRpb24gKyBsZW5ndGggPCBjb250ZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRzLnN1YmFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50cyA9IGNvbnRlbnRzLnN1YmFycmF5KHBvc2l0aW9uLCBwb3NpdGlvbiArIGxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnRzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoY29udGVudHMsIHBvc2l0aW9uLCBwb3NpdGlvbiArIGxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvY2F0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHB0ciA9IG1tYXBBbGxvYyhsZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQ4KQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBIRUFQOC5zZXQoY29udGVudHMsIHB0cikKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcHRyOiBwdHIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsb2NhdGVkOiBhbGxvY2F0ZWQKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgbXN5bmM6IGZ1bmN0aW9uKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgbW1hcEZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBNRU1GUy5zdHJlYW1fb3BzLndyaXRlKHN0cmVhbSwgYnVmZmVyLCAwLCBsZW5ndGgsIG9mZnNldCwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgZnVuY3Rpb24gYXN5bmNMb2FkKHVybCwgb25sb2FkLCBvbmVycm9yLCBub1J1bkRlcCkgewogICAgICAgICAgICAgIHZhciBkZXAgPSAhbm9SdW5EZXAgPyBnZXRVbmlxdWVSdW5EZXBlbmRlbmN5KCJhbCAiICsgdXJsKSA6ICIiOwogICAgICAgICAgICAgIHJlYWRBc3luYyh1cmwsIGFycmF5QnVmZmVyID0+IHsKICAgICAgICAgICAgICAgICAgYXNzZXJ0KGFycmF5QnVmZmVyLCBgTG9hZGluZyBkYXRhIGZpbGUgIiR7dXJsfSIgZmFpbGVkIChubyBhcnJheUJ1ZmZlcikuYCk7CiAgICAgICAgICAgICAgICAgIG9ubG9hZChuZXcgVWludDhBcnJheShhcnJheUJ1ZmZlcikpOwogICAgICAgICAgICAgICAgICBpZiAoZGVwKSByZW1vdmVSdW5EZXBlbmRlbmN5KGRlcCkKICAgICAgICAgICAgICB9LCBldmVudCA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChvbmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICBvbmVycm9yKCkKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IGBMb2FkaW5nIGRhdGEgZmlsZSAiJHt1cmx9IiBmYWlsZWQuYAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKGRlcCkgYWRkUnVuRGVwZW5kZW5jeShkZXApCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJlbG9hZFBsdWdpbnMgPSBNb2R1bGVbInByZWxvYWRQbHVnaW5zIl0gfHwgW107CgogICAgICAgICAgZnVuY3Rpb24gRlNfaGFuZGxlZEJ5UHJlbG9hZFBsdWdpbihieXRlQXJyYXksIGZ1bGxuYW1lLCBmaW5pc2gsIG9uZXJyb3IpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIEJyb3dzZXIgIT0gInVuZGVmaW5lZCIpIEJyb3dzZXIuaW5pdCgpOwogICAgICAgICAgICAgIHZhciBoYW5kbGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgcHJlbG9hZFBsdWdpbnMuZm9yRWFjaChmdW5jdGlvbihwbHVnaW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZWQpIHJldHVybjsKICAgICAgICAgICAgICAgICAgaWYgKHBsdWdpblsiY2FuSGFuZGxlIl0oZnVsbG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICBwbHVnaW5bImhhbmRsZSJdKGJ5dGVBcnJheSwgZnVsbG5hbWUsIGZpbmlzaCwgb25lcnJvcik7CiAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVkID0gdHJ1ZQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZWQKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBGU19jcmVhdGVQcmVsb2FkZWRGaWxlKHBhcmVudCwgbmFtZSwgdXJsLCBjYW5SZWFkLCBjYW5Xcml0ZSwgb25sb2FkLCBvbmVycm9yLCBkb250Q3JlYXRlRmlsZSwgY2FuT3duLCBwcmVGaW5pc2gpIHsKICAgICAgICAgICAgICB2YXIgZnVsbG5hbWUgPSBuYW1lID8gUEFUSF9GUy5yZXNvbHZlKFBBVEguam9pbjIocGFyZW50LCBuYW1lKSkgOiBwYXJlbnQ7CiAgICAgICAgICAgICAgdmFyIGRlcCA9IGdldFVuaXF1ZVJ1bkRlcGVuZGVuY3koImNwICIgKyBmdWxsbmFtZSk7CgogICAgICAgICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NEYXRhKGJ5dGVBcnJheSkgewogICAgICAgICAgICAgICAgICBmdW5jdGlvbiBmaW5pc2goYnl0ZUFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocHJlRmluaXNoKSBwcmVGaW5pc2goKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICghZG9udENyZWF0ZUZpbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBGUy5jcmVhdGVEYXRhRmlsZShwYXJlbnQsIG5hbWUsIGJ5dGVBcnJheSwgY2FuUmVhZCwgY2FuV3JpdGUsIGNhbk93bikKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChvbmxvYWQpIG9ubG9hZCgpOwogICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlUnVuRGVwZW5kZW5jeShkZXApCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKEZTX2hhbmRsZWRCeVByZWxvYWRQbHVnaW4oYnl0ZUFycmF5LCBmdWxsbmFtZSwgZmluaXNoLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9uZXJyb3IpIG9uZXJyb3IoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVSdW5EZXBlbmRlbmN5KGRlcCkKICAgICAgICAgICAgICAgICAgICAgIH0pKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmaW5pc2goYnl0ZUFycmF5KQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhZGRSdW5EZXBlbmRlbmN5KGRlcCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB1cmwgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgYXN5bmNMb2FkKHVybCwgYnl0ZUFycmF5ID0+IHByb2Nlc3NEYXRhKGJ5dGVBcnJheSksIG9uZXJyb3IpCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJvY2Vzc0RhdGEodXJsKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBGU19tb2RlU3RyaW5nVG9GbGFncyhzdHIpIHsKICAgICAgICAgICAgICB2YXIgZmxhZ01vZGVzID0gewogICAgICAgICAgICAgICAgICAiciI6IDAsCiAgICAgICAgICAgICAgICAgICJyKyI6IDIsCiAgICAgICAgICAgICAgICAgICJ3IjogNTEyIHwgNjQgfCAxLAogICAgICAgICAgICAgICAgICAidysiOiA1MTIgfCA2NCB8IDIsCiAgICAgICAgICAgICAgICAgICJhIjogMTAyNCB8IDY0IHwgMSwKICAgICAgICAgICAgICAgICAgImErIjogMTAyNCB8IDY0IHwgMgogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdmFyIGZsYWdzID0gZmxhZ01vZGVzW3N0cl07CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbGFncyA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZmlsZSBvcGVuIG1vZGU6ICIgKyBzdHIpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmbGFncwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIEZTX2dldE1vZGUoY2FuUmVhZCwgY2FuV3JpdGUpIHsKICAgICAgICAgICAgICB2YXIgbW9kZSA9IDA7CiAgICAgICAgICAgICAgaWYgKGNhblJlYWQpIG1vZGUgfD0gMjkyIHwgNzM7CiAgICAgICAgICAgICAgaWYgKGNhbldyaXRlKSBtb2RlIHw9IDE0NjsKICAgICAgICAgICAgICByZXR1cm4gbW9kZQogICAgICAgICAgfQogICAgICAgICAgdmFyIEVSUk5PX0NPREVTID0ge307CiAgICAgICAgICB2YXIgUFJPWFlGUyA9IHsKICAgICAgICAgICAgICBtb3VudDogZnVuY3Rpb24obW91bnQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFBST1hZRlMuY3JlYXRlTm9kZShudWxsLCAiLyIsIG1vdW50Lm9wdHMuZnMubHN0YXQobW91bnQub3B0cy5yb290KS5tb2RlLCAwKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY3JlYXRlTm9kZTogZnVuY3Rpb24ocGFyZW50LCBuYW1lLCBtb2RlLCBkZXYpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFGUy5pc0Rpcihtb2RlKSAmJiAhRlMuaXNGaWxlKG1vZGUpICYmICFGUy5pc0xpbmsobW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTLkVJTlZBTCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IEZTLmNyZWF0ZU5vZGUocGFyZW50LCBuYW1lLCBtb2RlKTsKICAgICAgICAgICAgICAgICAgbm9kZS5ub2RlX29wcyA9IFBST1hZRlMubm9kZV9vcHM7CiAgICAgICAgICAgICAgICAgIG5vZGUuc3RyZWFtX29wcyA9IFBST1hZRlMuc3RyZWFtX29wczsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHJlYWxQYXRoOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgICAgICAgICAgICB3aGlsZSAobm9kZS5wYXJlbnQgIT09IG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2gobm9kZS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2gobm9kZS5tb3VudC5vcHRzLnJvb3QpOwogICAgICAgICAgICAgICAgICBwYXJ0cy5yZXZlcnNlKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBQQVRILmpvaW4uYXBwbHkobnVsbCwgcGFydHMpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBub2RlX29wczogewogICAgICAgICAgICAgICAgICBnZXRhdHRyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IFBST1hZRlMucmVhbFBhdGgobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdDsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdCA9IG5vZGUubW91bnQub3B0cy5mcy5sc3RhdChwYXRoKQogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZS5jb2RlKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAgIGRldjogc3RhdC5kZXYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5vOiBzdGF0LmlubywKICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlOiBzdGF0Lm1vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmxpbms6IHN0YXQubmxpbmssCiAgICAgICAgICAgICAgICAgICAgICAgICAgdWlkOiBzdGF0LnVpZCwKICAgICAgICAgICAgICAgICAgICAgICAgICBnaWQ6IHN0YXQuZ2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgIHJkZXY6IHN0YXQucmRldiwKICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplOiBzdGF0LnNpemUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXRpbWU6IHN0YXQuYXRpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbXRpbWU6IHN0YXQubXRpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgY3RpbWU6IHN0YXQuY3RpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYmxrc2l6ZTogc3RhdC5ibGtzaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2Nrczogc3RhdC5ibG9ja3MKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgc2V0YXR0cjogZnVuY3Rpb24obm9kZSwgYXR0cikgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHBhdGggPSBQUk9YWUZTLnJlYWxQYXRoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ci5tb2RlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5tb3VudC5vcHRzLmZzLmNobW9kKHBhdGgsIGF0dHIubW9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubW9kZSA9IGF0dHIubW9kZQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ci50aW1lc3RhbXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKGF0dHIudGltZXN0YW1wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5tb3VudC5vcHRzLmZzLnV0aW1lKHBhdGgsIGRhdGUsIGRhdGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyLnNpemUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1vdW50Lm9wdHMuZnMudHJ1bmNhdGUocGF0aCwgYXR0ci5zaXplKQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWUuY29kZSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihFUlJOT19DT0RFU1tlLmNvZGVdKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBsb29rdXA6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IFBBVEguam9pbjIoUFJPWFlGUy5yZWFsUGF0aChwYXJlbnQpLCBuYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kZSA9IHBhcmVudC5tb3VudC5vcHRzLmZzLmxzdGF0KHBhdGgpLm1vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBQUk9YWUZTLmNyZWF0ZU5vZGUocGFyZW50LCBuYW1lLCBtb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZQogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZS5jb2RlKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIG1rbm9kOiBmdW5jdGlvbihwYXJlbnQsIG5hbWUsIG1vZGUsIGRldikgewogICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBQUk9YWUZTLmNyZWF0ZU5vZGUocGFyZW50LCBuYW1lLCBtb2RlLCBkZXYpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHBhdGggPSBQUk9YWUZTLnJlYWxQYXRoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoRlMuaXNEaXIobm9kZS5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1vdW50Lm9wdHMuZnMubWtkaXIocGF0aCwgbm9kZS5tb2RlKQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubW91bnQub3B0cy5mcy53cml0ZUZpbGUocGF0aCwgIiIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGU6IG5vZGUubW9kZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWUuY29kZSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihFUlJOT19DT0RFU1tlLmNvZGVdKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgcmVuYW1lOiBmdW5jdGlvbihvbGROb2RlLCBuZXdEaXIsIG5ld05hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRQYXRoID0gUFJPWFlGUy5yZWFsUGF0aChvbGROb2RlKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdQYXRoID0gUEFUSC5qb2luMihQUk9YWUZTLnJlYWxQYXRoKG5ld0RpciksIG5ld05hbWUpOwogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBvbGROb2RlLm1vdW50Lm9wdHMuZnMucmVuYW1lKG9sZFBhdGgsIG5ld1BhdGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIG9sZE5vZGUubmFtZSA9IG5ld05hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkTm9kZS5wYXJlbnQgPSBuZXdEaXIKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWUuY29kZSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihFUlJOT19DT0RFU1tlLmNvZGVdKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICB1bmxpbms6IGZ1bmN0aW9uKHBhcmVudCwgbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHBhdGggPSBQQVRILmpvaW4yKFBST1hZRlMucmVhbFBhdGgocGFyZW50KSwgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5tb3VudC5vcHRzLmZzLnVubGluayhwYXRoKQogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZS5jb2RlKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHJtZGlyOiBmdW5jdGlvbihwYXJlbnQsIG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0gUEFUSC5qb2luMihQUk9YWUZTLnJlYWxQYXRoKHBhcmVudCksIG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQubW91bnQub3B0cy5mcy5ybWRpcihwYXRoKQogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZS5jb2RlKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHJlYWRkaXI6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXRoID0gUFJPWFlGUy5yZWFsUGF0aChub2RlKTsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubW91bnQub3B0cy5mcy5yZWFkZGlyKHBhdGgpCiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlLmNvZGUpIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoRVJSTk9fQ09ERVNbZS5jb2RlXSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgc3ltbGluazogZnVuY3Rpb24ocGFyZW50LCBuZXdOYW1lLCBvbGRQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3UGF0aCA9IFBBVEguam9pbjIoUFJPWFlGUy5yZWFsUGF0aChwYXJlbnQpLCBuZXdOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lm1vdW50Lm9wdHMuZnMuc3ltbGluayhvbGRQYXRoLCBuZXdQYXRoKQogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZS5jb2RlKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHJlYWRsaW5rOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IFBST1hZRlMucmVhbFBhdGgobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLm1vdW50Lm9wdHMuZnMucmVhZGxpbmsocGF0aCkKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWUuY29kZSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihFUlJOT19DT0RFU1tlLmNvZGVdKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzdHJlYW1fb3BzOiB7CiAgICAgICAgICAgICAgICAgIG9wZW46IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHBhdGggPSBQUk9YWUZTLnJlYWxQYXRoKHN0cmVhbS5ub2RlKTsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLm5mZCA9IHN0cmVhbS5ub2RlLm1vdW50Lm9wdHMuZnMub3BlbihwYXRoLCBzdHJlYW0uZmxhZ3MpCiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlLmNvZGUpIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoRVJSTk9fQ09ERVNbZS5jb2RlXSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0ubm9kZS5tb3VudC5vcHRzLmZzLmNsb3NlKHN0cmVhbS5uZmQpCiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlLmNvZGUpIHRocm93IGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoRVJSTk9fQ09ERVNbZS5jb2RlXSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgcmVhZDogZnVuY3Rpb24oc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtLm5vZGUubW91bnQub3B0cy5mcy5yZWFkKHN0cmVhbS5uZmQsIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKQogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZS5jb2RlKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHdyaXRlOiBmdW5jdGlvbihzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHJlYW0ubm9kZS5tb3VudC5vcHRzLmZzLndyaXRlKHN0cmVhbS5uZmQsIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKQogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZS5jb2RlKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGxsc2VlazogZnVuY3Rpb24oc3RyZWFtLCBvZmZzZXQsIHdoZW5jZSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gb2Zmc2V0OwogICAgICAgICAgICAgICAgICAgICAgaWYgKHdoZW5jZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IHN0cmVhbS5wb3NpdGlvbgogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh3aGVuY2UgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoRlMuaXNGaWxlKHN0cmVhbS5ub2RlLm1vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdCA9IHN0cmVhbS5ub2RlLm5vZGVfb3BzLmdldGF0dHIoc3RyZWFtLm5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gc3RhdC5zaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKEVSUk5PX0NPREVTW2UuY29kZV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zaXRpb24gPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoRVJSTk9fQ09ERVMuRUlOVkFMKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIEZTID0gewogICAgICAgICAgICAgIHJvb3Q6IG51bGwsCiAgICAgICAgICAgICAgbW91bnRzOiBbXSwKICAgICAgICAgICAgICBkZXZpY2VzOiB7fSwKICAgICAgICAgICAgICBzdHJlYW1zOiBbXSwKICAgICAgICAgICAgICBuZXh0SW5vZGU6IDEsCiAgICAgICAgICAgICAgbmFtZVRhYmxlOiBudWxsLAogICAgICAgICAgICAgIGN1cnJlbnRQYXRoOiAiLyIsCiAgICAgICAgICAgICAgaW5pdGlhbGl6ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGlnbm9yZVBlcm1pc3Npb25zOiB0cnVlLAogICAgICAgICAgICAgIEVycm5vRXJyb3I6IG51bGwsCiAgICAgICAgICAgICAgZ2VuZXJpY0Vycm9yczoge30sCiAgICAgICAgICAgICAgZmlsZXN5c3RlbXM6IG51bGwsCiAgICAgICAgICAgICAgc3luY0ZTUmVxdWVzdHM6IDAsCiAgICAgICAgICAgICAgbG9va3VwUGF0aDogKHBhdGgsIG9wdHMgPSB7fSkgPT4gewogICAgICAgICAgICAgICAgICBwYXRoID0gUEFUSF9GUy5yZXNvbHZlKHBhdGgpOwogICAgICAgICAgICAgICAgICBpZiAoIXBhdGgpIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICBwYXRoOiAiIiwKICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgICAgICAgICAgICAgICAgZm9sbG93X21vdW50OiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzZV9jb3VudDogMAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBvcHRzID0gT2JqZWN0LmFzc2lnbihkZWZhdWx0cywgb3B0cyk7CiAgICAgICAgICAgICAgICAgIGlmIChvcHRzLnJlY3Vyc2VfY291bnQgPiA4KSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigzMikKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIvIikuZmlsdGVyKHAgPT4gISFwKTsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBGUy5yb290OwogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudF9wYXRoID0gIi8iOwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNsYXN0ID0gaSA9PT0gcGFydHMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc2xhc3QgJiYgb3B0cy5wYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IEZTLmxvb2t1cE5vZGUoY3VycmVudCwgcGFydHNbaV0pOwogICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9wYXRoID0gUEFUSC5qb2luMihjdXJyZW50X3BhdGgsIHBhcnRzW2ldKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChGUy5pc01vdW50cG9pbnQoY3VycmVudCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzbGFzdCB8fCBpc2xhc3QgJiYgb3B0cy5mb2xsb3dfbW91bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQubW91bnRlZC5yb290CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc2xhc3QgfHwgb3B0cy5mb2xsb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChGUy5pc0xpbmsoY3VycmVudC5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGluayA9IEZTLnJlYWRsaW5rKGN1cnJlbnRfcGF0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfcGF0aCA9IFBBVEhfRlMucmVzb2x2ZShQQVRILmRpcm5hbWUoY3VycmVudF9wYXRoKSwgbGluayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKGN1cnJlbnRfcGF0aCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjdXJzZV9jb3VudDogb3B0cy5yZWN1cnNlX2NvdW50ICsgMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGxvb2t1cC5ub2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY291bnQrKyA+IDQwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigzMikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgcGF0aDogY3VycmVudF9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgbm9kZTogY3VycmVudAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBnZXRQYXRoOiBub2RlID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhdGg7CiAgICAgICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoRlMuaXNSb290KG5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vdW50ID0gbm9kZS5tb3VudC5tb3VudHBvaW50OwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcGF0aCkgcmV0dXJuIG1vdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFttb3VudC5sZW5ndGggLSAxXSAhPT0gIi8iID8gbW91bnQgKyAiLyIgKyBwYXRoIDogbW91bnQgKyBwYXRoCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBwYXRoID0gcGF0aCA/IG5vZGUubmFtZSArICIvIiArIHBhdGggOiBub2RlLm5hbWU7CiAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnQKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgaGFzaE5hbWU6IChwYXJlbnRpZCwgbmFtZSkgPT4gewogICAgICAgICAgICAgICAgICB2YXIgaGFzaCA9IDA7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmFtZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgaGFzaCA9IChoYXNoIDw8IDUpIC0gaGFzaCArIG5hbWUuY2hhckNvZGVBdChpKSB8IDAKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gKHBhcmVudGlkICsgaGFzaCA+Pj4gMCkgJSBGUy5uYW1lVGFibGUubGVuZ3RoCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBoYXNoQWRkTm9kZTogbm9kZSA9PiB7CiAgICAgICAgICAgICAgICAgIHZhciBoYXNoID0gRlMuaGFzaE5hbWUobm9kZS5wYXJlbnQuaWQsIG5vZGUubmFtZSk7CiAgICAgICAgICAgICAgICAgIG5vZGUubmFtZV9uZXh0ID0gRlMubmFtZVRhYmxlW2hhc2hdOwogICAgICAgICAgICAgICAgICBGUy5uYW1lVGFibGVbaGFzaF0gPSBub2RlCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBoYXNoUmVtb3ZlTm9kZTogbm9kZSA9PiB7CiAgICAgICAgICAgICAgICAgIHZhciBoYXNoID0gRlMuaGFzaE5hbWUobm9kZS5wYXJlbnQuaWQsIG5vZGUubmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmIChGUy5uYW1lVGFibGVbaGFzaF0gPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIEZTLm5hbWVUYWJsZVtoYXNoXSA9IG5vZGUubmFtZV9uZXh0CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IEZTLm5hbWVUYWJsZVtoYXNoXTsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChjdXJyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQubmFtZV9uZXh0ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQubmFtZV9uZXh0ID0gbm9kZS5uYW1lX25leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50Lm5hbWVfbmV4dAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBsb29rdXBOb2RlOiAocGFyZW50LCBuYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgIHZhciBlcnJDb2RlID0gRlMubWF5TG9va3VwKHBhcmVudCk7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJDb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihlcnJDb2RlLCBwYXJlbnQpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIGhhc2ggPSBGUy5oYXNoTmFtZShwYXJlbnQuaWQsIG5hbWUpOwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBub2RlID0gRlMubmFtZVRhYmxlW2hhc2hdOyBub2RlOyBub2RlID0gbm9kZS5uYW1lX25leHQpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlTmFtZSA9IG5vZGUubmFtZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnBhcmVudC5pZCA9PT0gcGFyZW50LmlkICYmIG5vZGVOYW1lID09PSBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gRlMubG9va3VwKHBhcmVudCwgbmFtZSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNyZWF0ZU5vZGU6IChwYXJlbnQsIG5hbWUsIG1vZGUsIHJkZXYpID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBuZXcgRlMuRlNOb2RlKHBhcmVudCwgbmFtZSwgbW9kZSwgcmRldik7CiAgICAgICAgICAgICAgICAgIEZTLmhhc2hBZGROb2RlKG5vZGUpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGVzdHJveU5vZGU6IG5vZGUgPT4gewogICAgICAgICAgICAgICAgICBGUy5oYXNoUmVtb3ZlTm9kZShub2RlKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgaXNSb290OiBub2RlID0+IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUgPT09IG5vZGUucGFyZW50CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBpc01vdW50cG9pbnQ6IG5vZGUgPT4gewogICAgICAgICAgICAgICAgICByZXR1cm4gISFub2RlLm1vdW50ZWQKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGlzRmlsZTogbW9kZSA9PiB7CiAgICAgICAgICAgICAgICAgIHJldHVybiAobW9kZSAmIDYxNDQwKSA9PT0gMzI3NjgKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGlzRGlyOiBtb2RlID0+IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIChtb2RlICYgNjE0NDApID09PSAxNjM4NAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgaXNMaW5rOiBtb2RlID0+IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIChtb2RlICYgNjE0NDApID09PSA0MDk2MAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgaXNDaHJkZXY6IG1vZGUgPT4gewogICAgICAgICAgICAgICAgICByZXR1cm4gKG1vZGUgJiA2MTQ0MCkgPT09IDgxOTIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGlzQmxrZGV2OiBtb2RlID0+IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIChtb2RlICYgNjE0NDApID09PSAyNDU3NgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgaXNGSUZPOiBtb2RlID0+IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIChtb2RlICYgNjE0NDApID09PSA0MDk2CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBpc1NvY2tldDogbW9kZSA9PiB7CiAgICAgICAgICAgICAgICAgIHJldHVybiAobW9kZSAmIDQ5MTUyKSA9PT0gNDkxNTIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZsYWdzVG9QZXJtaXNzaW9uU3RyaW5nOiBmbGFnID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIHBlcm1zID0gWyJyIiwgInciLCAicnciXVtmbGFnICYgM107CiAgICAgICAgICAgICAgICAgIGlmIChmbGFnICYgNTEyKSB7CiAgICAgICAgICAgICAgICAgICAgICBwZXJtcyArPSAidyIKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gcGVybXMKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG5vZGVQZXJtaXNzaW9uczogKG5vZGUsIHBlcm1zKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChGUy5pZ25vcmVQZXJtaXNzaW9ucykgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocGVybXMuaW5jbHVkZXMoInIiKSAmJiAhKG5vZGUubW9kZSAmIDI5MikpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocGVybXMuaW5jbHVkZXMoInciKSAmJiAhKG5vZGUubW9kZSAmIDE0NikpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocGVybXMuaW5jbHVkZXMoIngiKSAmJiAhKG5vZGUubW9kZSAmIDczKSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbWF5TG9va3VwOiBkaXIgPT4gewogICAgICAgICAgICAgICAgICB2YXIgZXJyQ29kZSA9IEZTLm5vZGVQZXJtaXNzaW9ucyhkaXIsICJ4Iik7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJDb2RlKSByZXR1cm4gZXJyQ29kZTsKICAgICAgICAgICAgICAgICAgaWYgKCFkaXIubm9kZV9vcHMubG9va3VwKSByZXR1cm4gMjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1heUNyZWF0ZTogKGRpciwgbmFtZSkgPT4gewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBGUy5sb29rdXBOb2RlKGRpciwgbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMjAKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICAgICAgcmV0dXJuIEZTLm5vZGVQZXJtaXNzaW9ucyhkaXIsICJ3eCIpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBtYXlEZWxldGU6IChkaXIsIG5hbWUsIGlzZGlyKSA9PiB7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IEZTLmxvb2t1cE5vZGUoZGlyLCBuYW1lKQogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZS5lcnJubwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBlcnJDb2RlID0gRlMubm9kZVBlcm1pc3Npb25zKGRpciwgInd4Iik7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJDb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXJyQ29kZQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChpc2RpcikgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCFGUy5pc0Rpcihub2RlLm1vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDU0CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoRlMuaXNSb290KG5vZGUpIHx8IEZTLmdldFBhdGgobm9kZSkgPT09IEZTLmN3ZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEwCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoRlMuaXNEaXIobm9kZS5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAzMQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBtYXlPcGVuOiAobm9kZSwgZmxhZ3MpID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gNDQKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoRlMuaXNMaW5rKG5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAzMgogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEZTLmlzRGlyKG5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChGUy5mbGFnc1RvUGVybWlzc2lvblN0cmluZyhmbGFncykgIT09ICJyIiB8fCBmbGFncyAmIDUxMikgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAzMQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBGUy5ub2RlUGVybWlzc2lvbnMobm9kZSwgRlMuZmxhZ3NUb1Blcm1pc3Npb25TdHJpbmcoZmxhZ3MpKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgTUFYX09QRU5fRkRTOiA0MDk2LAogICAgICAgICAgICAgIG5leHRmZDogKGZkX3N0YXJ0ID0gMCwgZmRfZW5kID0gRlMuTUFYX09QRU5fRkRTKSA9PiB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGZkID0gZmRfc3RhcnQ7IGZkIDw9IGZkX2VuZDsgZmQrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCFGUy5zdHJlYW1zW2ZkXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmZAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDMzKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZ2V0U3RyZWFtOiBmZCA9PiBGUy5zdHJlYW1zW2ZkXSwKICAgICAgICAgICAgICBjcmVhdGVTdHJlYW06IChzdHJlYW0sIGZkX3N0YXJ0LCBmZF9lbmQpID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKCFGUy5GU1N0cmVhbSkgewogICAgICAgICAgICAgICAgICAgICAgRlMuRlNTdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNoYXJlZCA9IHt9CiAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgRlMuRlNTdHJlYW0ucHJvdG90eXBlID0ge307CiAgICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhGUy5GU1N0cmVhbS5wcm90b3R5cGUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3Q6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5vZGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubm9kZSA9IHZhbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICBpc1JlYWQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5mbGFncyAmIDIwOTcxNTUpICE9PSAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIGlzV3JpdGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5mbGFncyAmIDIwOTcxNTUpICE9PSAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIGlzQXBwZW5kOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mbGFncyAmIDEwMjQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhZ3M6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNoYXJlZC5mbGFncwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaGFyZWQuZmxhZ3MgPSB2YWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNoYXJlZC5wb3NpdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaGFyZWQucG9zaXRpb24gPSB2YWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RyZWFtID0gT2JqZWN0LmFzc2lnbihuZXcgRlMuRlNTdHJlYW0sIHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgIHZhciBmZCA9IEZTLm5leHRmZChmZF9zdGFydCwgZmRfZW5kKTsKICAgICAgICAgICAgICAgICAgc3RyZWFtLmZkID0gZmQ7CiAgICAgICAgICAgICAgICAgIEZTLnN0cmVhbXNbZmRdID0gc3RyZWFtOwogICAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjbG9zZVN0cmVhbTogZmQgPT4gewogICAgICAgICAgICAgICAgICBGUy5zdHJlYW1zW2ZkXSA9IG51bGwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNocmRldl9zdHJlYW1fb3BzOiB7CiAgICAgICAgICAgICAgICAgIG9wZW46IHN0cmVhbSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZGV2aWNlID0gRlMuZ2V0RGV2aWNlKHN0cmVhbS5ub2RlLnJkZXYpOwogICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLnN0cmVhbV9vcHMgPSBkZXZpY2Uuc3RyZWFtX29wczsKICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0uc3RyZWFtX29wcy5vcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLnN0cmVhbV9vcHMub3BlbihzdHJlYW0pCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGxsc2VlazogKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNzApCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1ham9yOiBkZXYgPT4gZGV2ID4+IDgsCiAgICAgICAgICAgICAgbWlub3I6IGRldiA9PiBkZXYgJiAyNTUsCiAgICAgICAgICAgICAgbWFrZWRldjogKG1hLCBtaSkgPT4gbWEgPDwgOCB8IG1pLAogICAgICAgICAgICAgIHJlZ2lzdGVyRGV2aWNlOiAoZGV2LCBvcHMpID0+IHsKICAgICAgICAgICAgICAgICAgRlMuZGV2aWNlc1tkZXZdID0gewogICAgICAgICAgICAgICAgICAgICAgc3RyZWFtX29wczogb3BzCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGdldERldmljZTogZGV2ID0+IEZTLmRldmljZXNbZGV2XSwKICAgICAgICAgICAgICBnZXRNb3VudHM6IG1vdW50ID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIG1vdW50cyA9IFtdOwogICAgICAgICAgICAgICAgICB2YXIgY2hlY2sgPSBbbW91bnRdOwogICAgICAgICAgICAgICAgICB3aGlsZSAoY2hlY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IGNoZWNrLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgbW91bnRzLnB1c2gobSk7CiAgICAgICAgICAgICAgICAgICAgICBjaGVjay5wdXNoLmFwcGx5KGNoZWNrLCBtLm1vdW50cykKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRzCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzeW5jZnM6IChwb3B1bGF0ZSwgY2FsbGJhY2spID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwb3B1bGF0ZSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IHBvcHVsYXRlOwogICAgICAgICAgICAgICAgICAgICAgcG9wdWxhdGUgPSBmYWxzZQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIEZTLnN5bmNGU1JlcXVlc3RzKys7CiAgICAgICAgICAgICAgICAgIGlmIChGUy5zeW5jRlNSZXF1ZXN0cyA+IDEpIHsKICAgICAgICAgICAgICAgICAgICAgIGVycigid2FybmluZzogIiArIEZTLnN5bmNGU1JlcXVlc3RzICsgIiBGUy5zeW5jZnMgb3BlcmF0aW9ucyBpbiBmbGlnaHQgYXQgb25jZSwgcHJvYmFibHkganVzdCBkb2luZyBleHRyYSB3b3JrIikKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbW91bnRzID0gRlMuZ2V0TW91bnRzKEZTLnJvb3QubW91bnQpOwogICAgICAgICAgICAgICAgICB2YXIgY29tcGxldGVkID0gMDsKCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRvQ2FsbGJhY2soZXJyQ29kZSkgewogICAgICAgICAgICAgICAgICAgICAgRlMuc3luY0ZTUmVxdWVzdHMtLTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJDb2RlKQogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBmdW5jdGlvbiBkb25lKGVyckNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJDb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb25lLmVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZS5lcnJvcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvQ2FsbGJhY2soZXJyQ29kZSkKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoKytjb21wbGV0ZWQgPj0gbW91bnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGRvQ2FsbGJhY2sobnVsbCkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBtb3VudHMuZm9yRWFjaChtb3VudCA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIW1vdW50LnR5cGUuc3luY2ZzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUobnVsbCkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIG1vdW50LnR5cGUuc3luY2ZzKG1vdW50LCBwb3B1bGF0ZSwgZG9uZSkKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1vdW50OiAodHlwZSwgb3B0cywgbW91bnRwb2ludCkgPT4gewogICAgICAgICAgICAgICAgICB2YXIgcm9vdCA9IG1vdW50cG9pbnQgPT09ICIvIjsKICAgICAgICAgICAgICAgICAgdmFyIHBzZXVkbyA9ICFtb3VudHBvaW50OwogICAgICAgICAgICAgICAgICB2YXIgbm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHJvb3QgJiYgRlMucm9vdCkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMTApCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXJvb3QgJiYgIXBzZXVkbykgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgobW91bnRwb2ludCwgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvbGxvd19tb3VudDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgbW91bnRwb2ludCA9IGxvb2t1cC5wYXRoOwogICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGxvb2t1cC5ub2RlOwogICAgICAgICAgICAgICAgICAgICAgaWYgKEZTLmlzTW91bnRwb2ludChub2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDEwKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKCFGUy5pc0Rpcihub2RlLm1vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNTQpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG1vdW50ID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgICAgICAgICAgICAgIG9wdHM6IG9wdHMsCiAgICAgICAgICAgICAgICAgICAgICBtb3VudHBvaW50OiBtb3VudHBvaW50LAogICAgICAgICAgICAgICAgICAgICAgbW91bnRzOiBbXQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICB2YXIgbW91bnRSb290ID0gdHlwZS5tb3VudChtb3VudCk7CiAgICAgICAgICAgICAgICAgIG1vdW50Um9vdC5tb3VudCA9IG1vdW50OwogICAgICAgICAgICAgICAgICBtb3VudC5yb290ID0gbW91bnRSb290OwogICAgICAgICAgICAgICAgICBpZiAocm9vdCkgewogICAgICAgICAgICAgICAgICAgICAgRlMucm9vdCA9IG1vdW50Um9vdAogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUubW91bnRlZCA9IG1vdW50OwogICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubW91bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm1vdW50Lm1vdW50cy5wdXNoKG1vdW50KQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJvb3QKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHVubW91bnQ6IG1vdW50cG9pbnQgPT4gewogICAgICAgICAgICAgICAgICB2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChtb3VudHBvaW50LCB7CiAgICAgICAgICAgICAgICAgICAgICBmb2xsb3dfbW91bnQ6IGZhbHNlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICBpZiAoIUZTLmlzTW91bnRwb2ludChsb29rdXAubm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gbG9va3VwLm5vZGU7CiAgICAgICAgICAgICAgICAgIHZhciBtb3VudCA9IG5vZGUubW91bnRlZDsKICAgICAgICAgICAgICAgICAgdmFyIG1vdW50cyA9IEZTLmdldE1vdW50cyhtb3VudCk7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKEZTLm5hbWVUYWJsZSkuZm9yRWFjaChoYXNoID0+IHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gRlMubmFtZVRhYmxlW2hhc2hdOwogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IGN1cnJlbnQubmFtZV9uZXh0OwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb3VudHMuaW5jbHVkZXMoY3VycmVudC5tb3VudCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlMuZGVzdHJveU5vZGUoY3VycmVudCkKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG5leHQKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIG5vZGUubW91bnRlZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHZhciBpZHggPSBub2RlLm1vdW50Lm1vdW50cy5pbmRleE9mKG1vdW50KTsKICAgICAgICAgICAgICAgICAgbm9kZS5tb3VudC5tb3VudHMuc3BsaWNlKGlkeCwgMSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGxvb2t1cDogKHBhcmVudCwgbmFtZSkgPT4gewogICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Lm5vZGVfb3BzLmxvb2t1cChwYXJlbnQsIG5hbWUpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBta25vZDogKHBhdGgsIG1vZGUsIGRldikgPT4gewogICAgICAgICAgICAgICAgICB2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBsb29rdXAubm9kZTsKICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBQQVRILmJhc2VuYW1lKHBhdGgpOwogICAgICAgICAgICAgICAgICBpZiAoIW5hbWUgfHwgbmFtZSA9PT0gIi4iIHx8IG5hbWUgPT09ICIuLiIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBlcnJDb2RlID0gRlMubWF5Q3JlYXRlKHBhcmVudCwgbmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJDb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihlcnJDb2RlKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghcGFyZW50Lm5vZGVfb3BzLm1rbm9kKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig2MykKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Lm5vZGVfb3BzLm1rbm9kKHBhcmVudCwgbmFtZSwgbW9kZSwgZGV2KQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY3JlYXRlOiAocGF0aCwgbW9kZSkgPT4gewogICAgICAgICAgICAgICAgICBtb2RlID0gbW9kZSAhPT0gdW5kZWZpbmVkID8gbW9kZSA6IDQzODsKICAgICAgICAgICAgICAgICAgbW9kZSAmPSA0MDk1OwogICAgICAgICAgICAgICAgICBtb2RlIHw9IDMyNzY4OwogICAgICAgICAgICAgICAgICByZXR1cm4gRlMubWtub2QocGF0aCwgbW9kZSwgMCkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1rZGlyOiAocGF0aCwgbW9kZSkgPT4gewogICAgICAgICAgICAgICAgICBtb2RlID0gbW9kZSAhPT0gdW5kZWZpbmVkID8gbW9kZSA6IDUxMTsKICAgICAgICAgICAgICAgICAgbW9kZSAmPSA1MTEgfCA1MTI7CiAgICAgICAgICAgICAgICAgIG1vZGUgfD0gMTYzODQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiBGUy5ta25vZChwYXRoLCBtb2RlLCAwKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbWtkaXJUcmVlOiAocGF0aCwgbW9kZSkgPT4gewogICAgICAgICAgICAgICAgICB2YXIgZGlycyA9IHBhdGguc3BsaXQoIi8iKTsKICAgICAgICAgICAgICAgICAgdmFyIGQgPSAiIjsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXJzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRpcnNbaV0pIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgZCArPSAiLyIgKyBkaXJzW2ldOwogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBGUy5ta2RpcihkLCBtb2RlKQogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLmVycm5vICE9IDIwKSB0aHJvdyBlCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG1rZGV2OiAocGF0aCwgbW9kZSwgZGV2KSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGV2ID09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICBkZXYgPSBtb2RlOwogICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IDQzOAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG1vZGUgfD0gODE5MjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEZTLm1rbm9kKHBhdGgsIG1vZGUsIGRldikKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHN5bWxpbms6IChvbGRwYXRoLCBuZXdwYXRoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmICghUEFUSF9GUy5yZXNvbHZlKG9sZHBhdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig0NCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChuZXdwYXRoLCB7CiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBsb29rdXAubm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKCFwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQ0KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBuZXduYW1lID0gUEFUSC5iYXNlbmFtZShuZXdwYXRoKTsKICAgICAgICAgICAgICAgICAgdmFyIGVyckNvZGUgPSBGUy5tYXlDcmVhdGUocGFyZW50LCBuZXduYW1lKTsKICAgICAgICAgICAgICAgICAgaWYgKGVyckNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKGVyckNvZGUpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFwYXJlbnQubm9kZV9vcHMuc3ltbGluaykgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNjMpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudC5ub2RlX29wcy5zeW1saW5rKHBhcmVudCwgbmV3bmFtZSwgb2xkcGF0aCkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHJlbmFtZTogKG9sZF9wYXRoLCBuZXdfcGF0aCkgPT4gewogICAgICAgICAgICAgICAgICB2YXIgb2xkX2Rpcm5hbWUgPSBQQVRILmRpcm5hbWUob2xkX3BhdGgpOwogICAgICAgICAgICAgICAgICB2YXIgbmV3X2Rpcm5hbWUgPSBQQVRILmRpcm5hbWUobmV3X3BhdGgpOwogICAgICAgICAgICAgICAgICB2YXIgb2xkX25hbWUgPSBQQVRILmJhc2VuYW1lKG9sZF9wYXRoKTsKICAgICAgICAgICAgICAgICAgdmFyIG5ld19uYW1lID0gUEFUSC5iYXNlbmFtZShuZXdfcGF0aCk7CiAgICAgICAgICAgICAgICAgIHZhciBsb29rdXAsIG9sZF9kaXIsIG5ld19kaXI7CiAgICAgICAgICAgICAgICAgIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgob2xkX3BhdGgsIHsKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgb2xkX2RpciA9IGxvb2t1cC5ub2RlOwogICAgICAgICAgICAgICAgICBsb29rdXAgPSBGUy5sb29rdXBQYXRoKG5ld19wYXRoLCB7CiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIG5ld19kaXIgPSBsb29rdXAubm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKCFvbGRfZGlyIHx8ICFuZXdfZGlyKSB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig0NCk7CiAgICAgICAgICAgICAgICAgIGlmIChvbGRfZGlyLm1vdW50ICE9PSBuZXdfZGlyLm1vdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig3NSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgb2xkX25vZGUgPSBGUy5sb29rdXBOb2RlKG9sZF9kaXIsIG9sZF9uYW1lKTsKICAgICAgICAgICAgICAgICAgdmFyIHJlbGF0aXZlID0gUEFUSF9GUy5yZWxhdGl2ZShvbGRfcGF0aCwgbmV3X2Rpcm5hbWUpOwogICAgICAgICAgICAgICAgICBpZiAocmVsYXRpdmUuY2hhckF0KDApICE9PSAiLiIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlbGF0aXZlID0gUEFUSF9GUy5yZWxhdGl2ZShuZXdfcGF0aCwgb2xkX2Rpcm5hbWUpOwogICAgICAgICAgICAgICAgICBpZiAocmVsYXRpdmUuY2hhckF0KDApICE9PSAiLiIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDU1KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBuZXdfbm9kZTsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIG5ld19ub2RlID0gRlMubG9va3VwTm9kZShuZXdfZGlyLCBuZXdfbmFtZSkKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICAgICAgaWYgKG9sZF9ub2RlID09PSBuZXdfbm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIGlzZGlyID0gRlMuaXNEaXIob2xkX25vZGUubW9kZSk7CiAgICAgICAgICAgICAgICAgIHZhciBlcnJDb2RlID0gRlMubWF5RGVsZXRlKG9sZF9kaXIsIG9sZF9uYW1lLCBpc2Rpcik7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJDb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihlcnJDb2RlKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVyckNvZGUgPSBuZXdfbm9kZSA/IEZTLm1heURlbGV0ZShuZXdfZGlyLCBuZXdfbmFtZSwgaXNkaXIpIDogRlMubWF5Q3JlYXRlKG5ld19kaXIsIG5ld19uYW1lKTsKICAgICAgICAgICAgICAgICAgaWYgKGVyckNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKGVyckNvZGUpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFvbGRfZGlyLm5vZGVfb3BzLnJlbmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNjMpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKEZTLmlzTW91bnRwb2ludChvbGRfbm9kZSkgfHwgbmV3X25vZGUgJiYgRlMuaXNNb3VudHBvaW50KG5ld19ub2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMTApCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG5ld19kaXIgIT09IG9sZF9kaXIpIHsKICAgICAgICAgICAgICAgICAgICAgIGVyckNvZGUgPSBGUy5ub2RlUGVybWlzc2lvbnMob2xkX2RpciwgInciKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJDb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoZXJyQ29kZSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBGUy5oYXNoUmVtb3ZlTm9kZShvbGRfbm9kZSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBvbGRfZGlyLm5vZGVfb3BzLnJlbmFtZShvbGRfbm9kZSwgbmV3X2RpciwgbmV3X25hbWUpCiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IGUKICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIEZTLmhhc2hBZGROb2RlKG9sZF9ub2RlKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBybWRpcjogcGF0aCA9PiB7CiAgICAgICAgICAgICAgICAgIHZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgsIHsKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGxvb2t1cC5ub2RlOwogICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IFBBVEguYmFzZW5hbWUocGF0aCk7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gRlMubG9va3VwTm9kZShwYXJlbnQsIG5hbWUpOwogICAgICAgICAgICAgICAgICB2YXIgZXJyQ29kZSA9IEZTLm1heURlbGV0ZShwYXJlbnQsIG5hbWUsIHRydWUpOwogICAgICAgICAgICAgICAgICBpZiAoZXJyQ29kZSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoZXJyQ29kZSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIXBhcmVudC5ub2RlX29wcy5ybWRpcikgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNjMpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKEZTLmlzTW91bnRwb2ludChub2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMTApCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcGFyZW50Lm5vZGVfb3BzLnJtZGlyKHBhcmVudCwgbmFtZSk7CiAgICAgICAgICAgICAgICAgIEZTLmRlc3Ryb3lOb2RlKG5vZGUpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICByZWFkZGlyOiBwYXRoID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewogICAgICAgICAgICAgICAgICAgICAgZm9sbG93OiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IGxvb2t1cC5ub2RlOwogICAgICAgICAgICAgICAgICBpZiAoIW5vZGUubm9kZV9vcHMucmVhZGRpcikgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNTQpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubm9kZV9vcHMucmVhZGRpcihub2RlKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdW5saW5rOiBwYXRoID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewogICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gbG9va3VwLm5vZGU7CiAgICAgICAgICAgICAgICAgIGlmICghcGFyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig0NCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IFBBVEguYmFzZW5hbWUocGF0aCk7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gRlMubG9va3VwTm9kZShwYXJlbnQsIG5hbWUpOwogICAgICAgICAgICAgICAgICB2YXIgZXJyQ29kZSA9IEZTLm1heURlbGV0ZShwYXJlbnQsIG5hbWUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgaWYgKGVyckNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKGVyckNvZGUpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFwYXJlbnQubm9kZV9vcHMudW5saW5rKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig2MykKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoRlMuaXNNb3VudHBvaW50KG5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigxMCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBwYXJlbnQubm9kZV9vcHMudW5saW5rKHBhcmVudCwgbmFtZSk7CiAgICAgICAgICAgICAgICAgIEZTLmRlc3Ryb3lOb2RlKG5vZGUpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICByZWFkbGluazogcGF0aCA9PiB7CiAgICAgICAgICAgICAgICAgIHZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgpOwogICAgICAgICAgICAgICAgICB2YXIgbGluayA9IGxvb2t1cC5ub2RlOwogICAgICAgICAgICAgICAgICBpZiAoIWxpbmspIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQ0KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghbGluay5ub2RlX29wcy5yZWFkbGluaykgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjgpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIFBBVEhfRlMucmVzb2x2ZShGUy5nZXRQYXRoKGxpbmsucGFyZW50KSwgbGluay5ub2RlX29wcy5yZWFkbGluayhsaW5rKSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHN0YXQ6IChwYXRoLCBkb250Rm9sbG93KSA9PiB7CiAgICAgICAgICAgICAgICAgIHZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgsIHsKICAgICAgICAgICAgICAgICAgICAgIGZvbGxvdzogIWRvbnRGb2xsb3cKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gbG9va3VwLm5vZGU7CiAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDQpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFub2RlLm5vZGVfb3BzLmdldGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYzKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLm5vZGVfb3BzLmdldGF0dHIobm9kZSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGxzdGF0OiBwYXRoID0+IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEZTLnN0YXQocGF0aCwgdHJ1ZSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNobW9kOiAocGF0aCwgbW9kZSwgZG9udEZvbGxvdykgPT4gewogICAgICAgICAgICAgICAgICB2YXIgbm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXRoID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9sbG93OiAhZG9udEZvbGxvdwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbG9va3VwLm5vZGUKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBwYXRoCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFub2RlLm5vZGVfb3BzLnNldGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYzKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG5vZGUubm9kZV9vcHMuc2V0YXR0cihub2RlLCB7CiAgICAgICAgICAgICAgICAgICAgICBtb2RlOiBtb2RlICYgNDA5NSB8IG5vZGUubW9kZSAmIH40MDk1LAogICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpCiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBsY2htb2Q6IChwYXRoLCBtb2RlKSA9PiB7CiAgICAgICAgICAgICAgICAgIEZTLmNobW9kKHBhdGgsIG1vZGUsIHRydWUpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmY2htb2Q6IChmZCwgbW9kZSkgPT4gewogICAgICAgICAgICAgICAgICB2YXIgc3RyZWFtID0gRlMuZ2V0U3RyZWFtKGZkKTsKICAgICAgICAgICAgICAgICAgaWYgKCFzdHJlYW0pIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgRlMuY2htb2Qoc3RyZWFtLm5vZGUsIG1vZGUpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjaG93bjogKHBhdGgsIHVpZCwgZ2lkLCBkb250Rm9sbG93KSA9PiB7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlOwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhdGggPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb2xsb3c6ICFkb250Rm9sbG93CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBsb29rdXAubm9kZQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHBhdGgKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIW5vZGUubm9kZV9vcHMuc2V0YXR0cikgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNjMpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgbm9kZS5ub2RlX29wcy5zZXRhdHRyKG5vZGUsIHsKICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKQogICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbGNob3duOiAocGF0aCwgdWlkLCBnaWQpID0+IHsKICAgICAgICAgICAgICAgICAgRlMuY2hvd24ocGF0aCwgdWlkLCBnaWQsIHRydWUpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmY2hvd246IChmZCwgdWlkLCBnaWQpID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IEZTLmdldFN0cmVhbShmZCk7CiAgICAgICAgICAgICAgICAgIGlmICghc3RyZWFtKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIEZTLmNob3duKHN0cmVhbS5ub2RlLCB1aWQsIGdpZCkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHRydW5jYXRlOiAocGF0aCwgbGVuKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChsZW4gPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXRoID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9sbG93OiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBsb29rdXAubm9kZQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHBhdGgKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIW5vZGUubm9kZV9vcHMuc2V0YXR0cikgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNjMpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKEZTLmlzRGlyKG5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDMxKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghRlMuaXNGaWxlKG5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBlcnJDb2RlID0gRlMubm9kZVBlcm1pc3Npb25zKG5vZGUsICJ3Iik7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJDb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcihlcnJDb2RlKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG5vZGUubm9kZV9vcHMuc2V0YXR0cihub2RlLCB7CiAgICAgICAgICAgICAgICAgICAgICBzaXplOiBsZW4sCiAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCkKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ0cnVuY2F0ZTogKGZkLCBsZW4pID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IEZTLmdldFN0cmVhbShmZCk7CiAgICAgICAgICAgICAgICAgIGlmICghc3RyZWFtKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICgoc3RyZWFtLmZsYWdzICYgMjA5NzE1NSkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIEZTLnRydW5jYXRlKHN0cmVhbS5ub2RlLCBsZW4pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB1dGltZTogKHBhdGgsIGF0aW1lLCBtdGltZSkgPT4gewogICAgICAgICAgICAgICAgICB2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CiAgICAgICAgICAgICAgICAgICAgICBmb2xsb3c6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gbG9va3VwLm5vZGU7CiAgICAgICAgICAgICAgICAgIG5vZGUubm9kZV9vcHMuc2V0YXR0cihub2RlLCB7CiAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IE1hdGgubWF4KGF0aW1lLCBtdGltZSkKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG9wZW46IChwYXRoLCBmbGFncywgbW9kZSkgPT4gewogICAgICAgICAgICAgICAgICBpZiAocGF0aCA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQ0KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZsYWdzID0gdHlwZW9mIGZsYWdzID09ICJzdHJpbmciID8gRlNfbW9kZVN0cmluZ1RvRmxhZ3MoZmxhZ3MpIDogZmxhZ3M7CiAgICAgICAgICAgICAgICAgIG1vZGUgPSB0eXBlb2YgbW9kZSA9PSAidW5kZWZpbmVkIiA/IDQzOCA6IG1vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIDY0KSB7CiAgICAgICAgICAgICAgICAgICAgICBtb2RlID0gbW9kZSAmIDQwOTUgfCAzMjc2OAogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgbW9kZSA9IDAKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXRoID09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICBub2RlID0gcGF0aAogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcGF0aCA9IFBBVEgubm9ybWFsaXplKHBhdGgpOwogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbGxvdzogIShmbGFncyAmIDEzMTA3MikKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbG9va3VwLm5vZGUKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgNjQpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgMTI4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDIwKQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IEZTLm1rbm9kKHBhdGgsIG1vZGUsIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWQgPSB0cnVlCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig0NCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoRlMuaXNDaHJkZXYobm9kZS5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgZmxhZ3MgJj0gfjUxMgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIDY1NTM2ICYmICFGUy5pc0Rpcihub2RlLm1vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig1NCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIWNyZWF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBlcnJDb2RlID0gRlMubWF5T3Blbihub2RlLCBmbGFncyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyQ29kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKGVyckNvZGUpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgNTEyICYmICFjcmVhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICBGUy50cnVuY2F0ZShub2RlLCAwKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZsYWdzICY9IH4oMTI4IHwgNTEyIHwgMTMxMDcyKTsKICAgICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IEZTLmNyZWF0ZVN0cmVhbSh7CiAgICAgICAgICAgICAgICAgICAgICBub2RlOiBub2RlLAogICAgICAgICAgICAgICAgICAgICAgcGF0aDogRlMuZ2V0UGF0aChub2RlKSwKICAgICAgICAgICAgICAgICAgICAgIGZsYWdzOiBmbGFncywKICAgICAgICAgICAgICAgICAgICAgIHNlZWthYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IDAsCiAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1fb3BzOiBub2RlLnN0cmVhbV9vcHMsCiAgICAgICAgICAgICAgICAgICAgICB1bmdvdHRlbjogW10sCiAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZmFsc2UKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0uc3RyZWFtX29wcy5vcGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0uc3RyZWFtX29wcy5vcGVuKHN0cmVhbSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoTW9kdWxlWyJsb2dSZWFkRmlsZXMiXSAmJiAhKGZsYWdzICYgMSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghRlMucmVhZEZpbGVzKSBGUy5yZWFkRmlsZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgIGlmICghKHBhdGggaW4gRlMucmVhZEZpbGVzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIEZTLnJlYWRGaWxlc1twYXRoXSA9IDEKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjbG9zZTogc3RyZWFtID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKEZTLmlzQ2xvc2VkKHN0cmVhbSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHN0cmVhbS5nZXRkZW50cykgc3RyZWFtLmdldGRlbnRzID0gbnVsbDsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0uc3RyZWFtX29wcy5jbG9zZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbS5zdHJlYW1fb3BzLmNsb3NlKHN0cmVhbSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZQogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgRlMuY2xvc2VTdHJlYW0oc3RyZWFtLmZkKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0cmVhbS5mZCA9IG51bGwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGlzQ2xvc2VkOiBzdHJlYW0gPT4gewogICAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtLmZkID09PSBudWxsCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBsbHNlZWs6IChzdHJlYW0sIG9mZnNldCwgd2hlbmNlKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChGUy5pc0Nsb3NlZChzdHJlYW0pKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghc3RyZWFtLnNlZWthYmxlIHx8ICFzdHJlYW0uc3RyZWFtX29wcy5sbHNlZWspIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDcwKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh3aGVuY2UgIT0gMCAmJiB3aGVuY2UgIT0gMSAmJiB3aGVuY2UgIT0gMikgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjgpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RyZWFtLnBvc2l0aW9uID0gc3RyZWFtLnN0cmVhbV9vcHMubGxzZWVrKHN0cmVhbSwgb2Zmc2V0LCB3aGVuY2UpOwogICAgICAgICAgICAgICAgICBzdHJlYW0udW5nb3R0ZW4gPSBbXTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0cmVhbS5wb3NpdGlvbgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgcmVhZDogKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zaXRpb24pID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKGxlbmd0aCA8IDAgfHwgcG9zaXRpb24gPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoRlMuaXNDbG9zZWQoc3RyZWFtKSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoOCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoKHN0cmVhbS5mbGFncyAmIDIwOTcxNTUpID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChGUy5pc0RpcihzdHJlYW0ubm9kZS5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMzEpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFzdHJlYW0uc3RyZWFtX29wcy5yZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgc2Vla2luZyA9IHR5cGVvZiBwb3NpdGlvbiAhPSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgICAgICAgaWYgKCFzZWVraW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHN0cmVhbS5wb3NpdGlvbgogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFzdHJlYW0uc2Vla2FibGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDcwKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBieXRlc1JlYWQgPSBzdHJlYW0uc3RyZWFtX29wcy5yZWFkKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zaXRpb24pOwogICAgICAgICAgICAgICAgICBpZiAoIXNlZWtpbmcpIHN0cmVhbS5wb3NpdGlvbiArPSBieXRlc1JlYWQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiBieXRlc1JlYWQKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHdyaXRlOiAoc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbiwgY2FuT3duKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChsZW5ndGggPCAwIHx8IHBvc2l0aW9uIDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjgpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKEZTLmlzQ2xvc2VkKHN0cmVhbSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKChzdHJlYW0uZmxhZ3MgJiAyMDk3MTU1KSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoOCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoRlMuaXNEaXIoc3RyZWFtLm5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDMxKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghc3RyZWFtLnN0cmVhbV9vcHMud3JpdGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0uc2Vla2FibGUgJiYgc3RyZWFtLmZsYWdzICYgMTAyNCkgewogICAgICAgICAgICAgICAgICAgICAgRlMubGxzZWVrKHN0cmVhbSwgMCwgMikKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgc2Vla2luZyA9IHR5cGVvZiBwb3NpdGlvbiAhPSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgICAgICAgaWYgKCFzZWVraW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHN0cmVhbS5wb3NpdGlvbgogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFzdHJlYW0uc2Vla2FibGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDcwKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBieXRlc1dyaXR0ZW4gPSBzdHJlYW0uc3RyZWFtX29wcy53cml0ZShzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uLCBjYW5Pd24pOwogICAgICAgICAgICAgICAgICBpZiAoIXNlZWtpbmcpIHN0cmVhbS5wb3NpdGlvbiArPSBieXRlc1dyaXR0ZW47CiAgICAgICAgICAgICAgICAgIHJldHVybiBieXRlc1dyaXR0ZW4KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGFsbG9jYXRlOiAoc3RyZWFtLCBvZmZzZXQsIGxlbmd0aCkgPT4gewogICAgICAgICAgICAgICAgICBpZiAoRlMuaXNDbG9zZWQoc3RyZWFtKSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoOCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAob2Zmc2V0IDwgMCB8fCBsZW5ndGggPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjgpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKChzdHJlYW0uZmxhZ3MgJiAyMDk3MTU1KSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoOCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIUZTLmlzRmlsZShzdHJlYW0ubm9kZS5tb2RlKSAmJiAhRlMuaXNEaXIoc3RyZWFtLm5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQzKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghc3RyZWFtLnN0cmVhbV9vcHMuYWxsb2NhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDEzOCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdHJlYW0uc3RyZWFtX29wcy5hbGxvY2F0ZShzdHJlYW0sIG9mZnNldCwgbGVuZ3RoKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbW1hcDogKHN0cmVhbSwgbGVuZ3RoLCBwb3NpdGlvbiwgcHJvdCwgZmxhZ3MpID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKChwcm90ICYgMikgIT09IDAgJiYgKGZsYWdzICYgMikgPT09IDAgJiYgKHN0cmVhbS5mbGFncyAmIDIwOTcxNTUpICE9PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICgoc3RyZWFtLmZsYWdzICYgMjA5NzE1NSkgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDIpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFzdHJlYW0uc3RyZWFtX29wcy5tbWFwKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcig0MykKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtLnN0cmVhbV9vcHMubW1hcChzdHJlYW0sIGxlbmd0aCwgcG9zaXRpb24sIHByb3QsIGZsYWdzKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbXN5bmM6IChzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIG1tYXBGbGFncykgPT4gewogICAgICAgICAgICAgICAgICBpZiAoIXN0cmVhbS5zdHJlYW1fb3BzLm1zeW5jKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdHJlYW0uc3RyZWFtX29wcy5tc3luYyhzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIG1tYXBGbGFncykKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG11bm1hcDogc3RyZWFtID0+IDAsCiAgICAgICAgICAgICAgaW9jdGw6IChzdHJlYW0sIGNtZCwgYXJnKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmICghc3RyZWFtLnN0cmVhbV9vcHMuaW9jdGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDU5KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdHJlYW0uc3RyZWFtX29wcy5pb2N0bChzdHJlYW0sIGNtZCwgYXJnKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgcmVhZEZpbGU6IChwYXRoLCBvcHRzID0ge30pID0+IHsKICAgICAgICAgICAgICAgICAgb3B0cy5mbGFncyA9IG9wdHMuZmxhZ3MgfHwgMDsKICAgICAgICAgICAgICAgICAgb3B0cy5lbmNvZGluZyA9IG9wdHMuZW5jb2RpbmcgfHwgImJpbmFyeSI7CiAgICAgICAgICAgICAgICAgIGlmIChvcHRzLmVuY29kaW5nICE9PSAidXRmOCIgJiYgb3B0cy5lbmNvZGluZyAhPT0gImJpbmFyeSIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBlbmNvZGluZyB0eXBlICInICsgb3B0cy5lbmNvZGluZyArICciJykKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgcmV0OwogICAgICAgICAgICAgICAgICB2YXIgc3RyZWFtID0gRlMub3BlbihwYXRoLCBvcHRzLmZsYWdzKTsKICAgICAgICAgICAgICAgICAgdmFyIHN0YXQgPSBGUy5zdGF0KHBhdGgpOwogICAgICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gc3RhdC5zaXplOwogICAgICAgICAgICAgICAgICB2YXIgYnVmID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgRlMucmVhZChzdHJlYW0sIGJ1ZiwgMCwgbGVuZ3RoLCAwKTsKICAgICAgICAgICAgICAgICAgaWYgKG9wdHMuZW5jb2RpbmcgPT09ICJ1dGY4IikgewogICAgICAgICAgICAgICAgICAgICAgcmV0ID0gVVRGOEFycmF5VG9TdHJpbmcoYnVmLCAwKQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdHMuZW5jb2RpbmcgPT09ICJiaW5hcnkiKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXQgPSBidWYKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBGUy5jbG9zZShzdHJlYW0pOwogICAgICAgICAgICAgICAgICByZXR1cm4gcmV0CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB3cml0ZUZpbGU6IChwYXRoLCBkYXRhLCBvcHRzID0ge30pID0+IHsKICAgICAgICAgICAgICAgICAgb3B0cy5mbGFncyA9IG9wdHMuZmxhZ3MgfHwgNTc3OwogICAgICAgICAgICAgICAgICB2YXIgc3RyZWFtID0gRlMub3BlbihwYXRoLCBvcHRzLmZsYWdzLCBvcHRzLm1vZGUpOwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBidWYgPSBuZXcgVWludDhBcnJheShsZW5ndGhCeXRlc1VURjgoZGF0YSkgKyAxKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3R1YWxOdW1CeXRlcyA9IHN0cmluZ1RvVVRGOEFycmF5KGRhdGEsIGJ1ZiwgMCwgYnVmLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICBGUy53cml0ZShzdHJlYW0sIGJ1ZiwgMCwgYWN0dWFsTnVtQnl0ZXMsIHVuZGVmaW5lZCwgb3B0cy5jYW5Pd24pCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgICBGUy53cml0ZShzdHJlYW0sIGRhdGEsIDAsIGRhdGEuYnl0ZUxlbmd0aCwgdW5kZWZpbmVkLCBvcHRzLmNhbk93bikKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgZGF0YSB0eXBlIikKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBGUy5jbG9zZShzdHJlYW0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjd2Q6ICgpID0+IEZTLmN1cnJlbnRQYXRoLAogICAgICAgICAgICAgIGNoZGlyOiBwYXRoID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewogICAgICAgICAgICAgICAgICAgICAgZm9sbG93OiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICBpZiAobG9va3VwLm5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQ0KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghRlMuaXNEaXIobG9va3VwLm5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDU0KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBlcnJDb2RlID0gRlMubm9kZVBlcm1pc3Npb25zKGxvb2t1cC5ub2RlLCAieCIpOwogICAgICAgICAgICAgICAgICBpZiAoZXJyQ29kZSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoZXJyQ29kZSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBGUy5jdXJyZW50UGF0aCA9IGxvb2t1cC5wYXRoCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjcmVhdGVEZWZhdWx0RGlyZWN0b3JpZXM6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgRlMubWtkaXIoIi90bXAiKTsKICAgICAgICAgICAgICAgICAgRlMubWtkaXIoIi9ob21lIik7CiAgICAgICAgICAgICAgICAgIEZTLm1rZGlyKCIvaG9tZS93ZWJfdXNlciIpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjcmVhdGVEZWZhdWx0RGV2aWNlczogKCkgPT4gewogICAgICAgICAgICAgICAgICBGUy5ta2RpcigiL2RldiIpOwogICAgICAgICAgICAgICAgICBGUy5yZWdpc3RlckRldmljZShGUy5tYWtlZGV2KDEsIDMpLCB7CiAgICAgICAgICAgICAgICAgICAgICByZWFkOiAoKSA9PiAwLAogICAgICAgICAgICAgICAgICAgICAgd3JpdGU6IChzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvcykgPT4gbGVuZ3RoCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICBGUy5ta2RldigiL2Rldi9udWxsIiwgRlMubWFrZWRldigxLCAzKSk7CiAgICAgICAgICAgICAgICAgIFRUWS5yZWdpc3RlcihGUy5tYWtlZGV2KDUsIDApLCBUVFkuZGVmYXVsdF90dHlfb3BzKTsKICAgICAgICAgICAgICAgICAgVFRZLnJlZ2lzdGVyKEZTLm1ha2VkZXYoNiwgMCksIFRUWS5kZWZhdWx0X3R0eTFfb3BzKTsKICAgICAgICAgICAgICAgICAgRlMubWtkZXYoIi9kZXYvdHR5IiwgRlMubWFrZWRldig1LCAwKSk7CiAgICAgICAgICAgICAgICAgIEZTLm1rZGV2KCIvZGV2L3R0eTEiLCBGUy5tYWtlZGV2KDYsIDApKTsKICAgICAgICAgICAgICAgICAgdmFyIHJhbmRvbUJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KDEwMjQpLAogICAgICAgICAgICAgICAgICAgICAgcmFuZG9tTGVmdCA9IDA7CiAgICAgICAgICAgICAgICAgIHZhciByYW5kb21CeXRlID0gKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmRvbUxlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByYW5kb21MZWZ0ID0gcmFuZG9tRmlsbChyYW5kb21CdWZmZXIpLmJ5dGVMZW5ndGgKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByYW5kb21CdWZmZXJbLS1yYW5kb21MZWZ0XQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBGUy5jcmVhdGVEZXZpY2UoIi9kZXYiLCAicmFuZG9tIiwgcmFuZG9tQnl0ZSk7CiAgICAgICAgICAgICAgICAgIEZTLmNyZWF0ZURldmljZSgiL2RldiIsICJ1cmFuZG9tIiwgcmFuZG9tQnl0ZSk7CiAgICAgICAgICAgICAgICAgIEZTLm1rZGlyKCIvZGV2L3NobSIpOwogICAgICAgICAgICAgICAgICBGUy5ta2RpcigiL2Rldi9zaG0vdG1wIikKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNyZWF0ZVNwZWNpYWxEaXJlY3RvcmllczogKCkgPT4gewogICAgICAgICAgICAgICAgICBGUy5ta2RpcigiL3Byb2MiKTsKICAgICAgICAgICAgICAgICAgdmFyIHByb2Nfc2VsZiA9IEZTLm1rZGlyKCIvcHJvYy9zZWxmIik7CiAgICAgICAgICAgICAgICAgIEZTLm1rZGlyKCIvcHJvYy9zZWxmL2ZkIik7CiAgICAgICAgICAgICAgICAgIEZTLm1vdW50KHsKICAgICAgICAgICAgICAgICAgICAgIG1vdW50OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBGUy5jcmVhdGVOb2RlKHByb2Nfc2VsZiwgImZkIiwgMTYzODQgfCA1MTEsIDczKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLm5vZGVfb3BzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29rdXA6IChwYXJlbnQsIG5hbWUpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmZCA9ICtuYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IEZTLmdldFN0cmVhbShmZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0cmVhbSkgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoOCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3VudDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3VudHBvaW50OiAiZmFrZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVfb3BzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRsaW5rOiAoKSA9PiBzdHJlYW0ucGF0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQucGFyZW50ID0gcmV0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LCB7fSwgIi9wcm9jL3NlbGYvZmQiKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY3JlYXRlU3RhbmRhcmRTdHJlYW1zOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChNb2R1bGVbInN0ZGluIl0pIHsKICAgICAgICAgICAgICAgICAgICAgIEZTLmNyZWF0ZURldmljZSgiL2RldiIsICJzdGRpbiIsIE1vZHVsZVsic3RkaW4iXSkKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIEZTLnN5bWxpbmsoIi9kZXYvdHR5IiwgIi9kZXYvc3RkaW4iKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChNb2R1bGVbInN0ZG91dCJdKSB7CiAgICAgICAgICAgICAgICAgICAgICBGUy5jcmVhdGVEZXZpY2UoIi9kZXYiLCAic3Rkb3V0IiwgbnVsbCwgTW9kdWxlWyJzdGRvdXQiXSkKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIEZTLnN5bWxpbmsoIi9kZXYvdHR5IiwgIi9kZXYvc3Rkb3V0IikKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoTW9kdWxlWyJzdGRlcnIiXSkgewogICAgICAgICAgICAgICAgICAgICAgRlMuY3JlYXRlRGV2aWNlKCIvZGV2IiwgInN0ZGVyciIsIG51bGwsIE1vZHVsZVsic3RkZXJyIl0pCiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBGUy5zeW1saW5rKCIvZGV2L3R0eTEiLCAiL2Rldi9zdGRlcnIiKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzdGRpbiA9IEZTLm9wZW4oIi9kZXYvc3RkaW4iLCAwKTsKICAgICAgICAgICAgICAgICAgdmFyIHN0ZG91dCA9IEZTLm9wZW4oIi9kZXYvc3Rkb3V0IiwgMSk7CiAgICAgICAgICAgICAgICAgIHZhciBzdGRlcnIgPSBGUy5vcGVuKCIvZGV2L3N0ZGVyciIsIDEpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBlbnN1cmVFcnJub0Vycm9yOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChGUy5FcnJub0Vycm9yKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIEZTLkVycm5vRXJyb3IgPSBmdW5jdGlvbiBFcnJub0Vycm9yKGVycm5vLCBub2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hbWUgPSAiRXJybm9FcnJvciI7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5vZGUgPSBub2RlOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFcnJubyA9IGZ1bmN0aW9uKGVycm5vKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnJubyA9IGVycm5vCiAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFcnJubyhlcnJubyk7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2UgPSAiRlMgZXJyb3IiCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIEZTLkVycm5vRXJyb3IucHJvdG90eXBlID0gbmV3IEVycm9yOwogICAgICAgICAgICAgICAgICBGUy5FcnJub0Vycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEZTLkVycm5vRXJyb3I7CiAgICAgICAgICAgICAgICAgIFs0NF0uZm9yRWFjaChjb2RlID0+IHsKICAgICAgICAgICAgICAgICAgICAgIEZTLmdlbmVyaWNFcnJvcnNbY29kZV0gPSBuZXcgRlMuRXJybm9FcnJvcihjb2RlKTsKICAgICAgICAgICAgICAgICAgICAgIEZTLmdlbmVyaWNFcnJvcnNbY29kZV0uc3RhY2sgPSAiPGdlbmVyaWMgZXJyb3IsIG5vIHN0YWNrPiIKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHN0YXRpY0luaXQ6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgRlMuZW5zdXJlRXJybm9FcnJvcigpOwogICAgICAgICAgICAgICAgICBGUy5uYW1lVGFibGUgPSBuZXcgQXJyYXkoNDA5Nik7CiAgICAgICAgICAgICAgICAgIEZTLm1vdW50KE1FTUZTLCB7fSwgIi8iKTsKICAgICAgICAgICAgICAgICAgRlMuY3JlYXRlRGVmYXVsdERpcmVjdG9yaWVzKCk7CiAgICAgICAgICAgICAgICAgIEZTLmNyZWF0ZURlZmF1bHREZXZpY2VzKCk7CiAgICAgICAgICAgICAgICAgIEZTLmNyZWF0ZVNwZWNpYWxEaXJlY3RvcmllcygpOwogICAgICAgICAgICAgICAgICBGUy5maWxlc3lzdGVtcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICJNRU1GUyI6IE1FTUZTLAogICAgICAgICAgICAgICAgICAgICAgIlBST1hZRlMiOiBQUk9YWUZTCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGluaXQ6IChpbnB1dCwgb3V0cHV0LCBlcnJvcikgPT4gewogICAgICAgICAgICAgICAgICBGUy5pbml0LmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgRlMuZW5zdXJlRXJybm9FcnJvcigpOwogICAgICAgICAgICAgICAgICBNb2R1bGVbInN0ZGluIl0gPSBpbnB1dCB8fCBNb2R1bGVbInN0ZGluIl07CiAgICAgICAgICAgICAgICAgIE1vZHVsZVsic3Rkb3V0Il0gPSBvdXRwdXQgfHwgTW9kdWxlWyJzdGRvdXQiXTsKICAgICAgICAgICAgICAgICAgTW9kdWxlWyJzdGRlcnIiXSA9IGVycm9yIHx8IE1vZHVsZVsic3RkZXJyIl07CiAgICAgICAgICAgICAgICAgIEZTLmNyZWF0ZVN0YW5kYXJkU3RyZWFtcygpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBxdWl0OiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIEZTLmluaXQuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBGUy5zdHJlYW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RyZWFtID0gRlMuc3RyZWFtc1tpXTsKICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RyZWFtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIEZTLmNsb3NlKHN0cmVhbSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZmluZE9iamVjdDogKHBhdGgsIGRvbnRSZXNvbHZlTGFzdExpbmspID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IEZTLmFuYWx5emVQYXRoKHBhdGgsIGRvbnRSZXNvbHZlTGFzdExpbmspOwogICAgICAgICAgICAgICAgICBpZiAoIXJldC5leGlzdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldC5vYmplY3QKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGFuYWx5emVQYXRoOiAocGF0aCwgZG9udFJlc29sdmVMYXN0TGluaykgPT4gewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvbGxvdzogIWRvbnRSZXNvbHZlTGFzdExpbmsKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgcGF0aCA9IGxvb2t1cC5wYXRoCiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgICAgICAgIHZhciByZXQgPSB7CiAgICAgICAgICAgICAgICAgICAgICBpc1Jvb3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgZXhpc3RzOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAwLAogICAgICAgICAgICAgICAgICAgICAgbmFtZTogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgIHBhdGg6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICBvYmplY3Q6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRFeGlzdHM6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50UGF0aDogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudE9iamVjdDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGxvb2t1cCA9IEZTLmxvb2t1cFBhdGgocGF0aCwgewogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICByZXQucGFyZW50RXhpc3RzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIHJldC5wYXJlbnRQYXRoID0gbG9va3VwLnBhdGg7CiAgICAgICAgICAgICAgICAgICAgICByZXQucGFyZW50T2JqZWN0ID0gbG9va3VwLm5vZGU7CiAgICAgICAgICAgICAgICAgICAgICByZXQubmFtZSA9IFBBVEguYmFzZW5hbWUocGF0aCk7CiAgICAgICAgICAgICAgICAgICAgICBsb29rdXAgPSBGUy5sb29rdXBQYXRoKHBhdGgsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb2xsb3c6ICFkb250UmVzb2x2ZUxhc3RMaW5rCiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIHJldC5leGlzdHMgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgcmV0LnBhdGggPSBsb29rdXAucGF0aDsKICAgICAgICAgICAgICAgICAgICAgIHJldC5vYmplY3QgPSBsb29rdXAubm9kZTsKICAgICAgICAgICAgICAgICAgICAgIHJldC5uYW1lID0gbG9va3VwLm5vZGUubmFtZTsKICAgICAgICAgICAgICAgICAgICAgIHJldC5pc1Jvb3QgPSBsb29rdXAucGF0aCA9PT0gIi8iCiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldC5lcnJvciA9IGUuZXJybm8KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gcmV0CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjcmVhdGVQYXRoOiAocGFyZW50LCBwYXRoLCBjYW5SZWFkLCBjYW5Xcml0ZSkgPT4gewogICAgICAgICAgICAgICAgICBwYXJlbnQgPSB0eXBlb2YgcGFyZW50ID09ICJzdHJpbmciID8gcGFyZW50IDogRlMuZ2V0UGF0aChwYXJlbnQpOwogICAgICAgICAgICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIvIikucmV2ZXJzZSgpOwogICAgICAgICAgICAgICAgICB3aGlsZSAocGFydHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFydCA9IHBhcnRzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJ0KSBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gUEFUSC5qb2luMihwYXJlbnQsIHBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBGUy5ta2RpcihjdXJyZW50KQogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IGN1cnJlbnQKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY3JlYXRlRmlsZTogKHBhcmVudCwgbmFtZSwgcHJvcGVydGllcywgY2FuUmVhZCwgY2FuV3JpdGUpID0+IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhdGggPSBQQVRILmpvaW4yKHR5cGVvZiBwYXJlbnQgPT0gInN0cmluZyIgPyBwYXJlbnQgOiBGUy5nZXRQYXRoKHBhcmVudCksIG5hbWUpOwogICAgICAgICAgICAgICAgICB2YXIgbW9kZSA9IEZTX2dldE1vZGUoY2FuUmVhZCwgY2FuV3JpdGUpOwogICAgICAgICAgICAgICAgICByZXR1cm4gRlMuY3JlYXRlKHBhdGgsIG1vZGUpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjcmVhdGVEYXRhRmlsZTogKHBhcmVudCwgbmFtZSwgZGF0YSwgY2FuUmVhZCwgY2FuV3JpdGUsIGNhbk93bikgPT4gewogICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IG5hbWU7CiAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IHR5cGVvZiBwYXJlbnQgPT0gInN0cmluZyIgPyBwYXJlbnQgOiBGUy5nZXRQYXRoKHBhcmVudCk7CiAgICAgICAgICAgICAgICAgICAgICBwYXRoID0gbmFtZSA/IFBBVEguam9pbjIocGFyZW50LCBuYW1lKSA6IHBhcmVudAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBtb2RlID0gRlNfZ2V0TW9kZShjYW5SZWFkLCBjYW5Xcml0ZSk7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gRlMuY3JlYXRlKHBhdGgsIG1vZGUpOwogICAgICAgICAgICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyciA9IG5ldyBBcnJheShkYXRhLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGRhdGEubGVuZ3RoOyBpIDwgbGVuOyArK2kpIGFycltpXSA9IGRhdGEuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gYXJyCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBGUy5jaG1vZChub2RlLCBtb2RlIHwgMTQ2KTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHJlYW0gPSBGUy5vcGVuKG5vZGUsIDU3Nyk7CiAgICAgICAgICAgICAgICAgICAgICBGUy53cml0ZShzdHJlYW0sIGRhdGEsIDAsIGRhdGEubGVuZ3RoLCAwLCBjYW5Pd24pOwogICAgICAgICAgICAgICAgICAgICAgRlMuY2xvc2Uoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICAgIEZTLmNobW9kKG5vZGUsIG1vZGUpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNyZWF0ZURldmljZTogKHBhcmVudCwgbmFtZSwgaW5wdXQsIG91dHB1dCkgPT4gewogICAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IFBBVEguam9pbjIodHlwZW9mIHBhcmVudCA9PSAic3RyaW5nIiA/IHBhcmVudCA6IEZTLmdldFBhdGgocGFyZW50KSwgbmFtZSk7CiAgICAgICAgICAgICAgICAgIHZhciBtb2RlID0gRlNfZ2V0TW9kZSghIWlucHV0LCAhIW91dHB1dCk7CiAgICAgICAgICAgICAgICAgIGlmICghRlMuY3JlYXRlRGV2aWNlLm1ham9yKSBGUy5jcmVhdGVEZXZpY2UubWFqb3IgPSA2NDsKICAgICAgICAgICAgICAgICAgdmFyIGRldiA9IEZTLm1ha2VkZXYoRlMuY3JlYXRlRGV2aWNlLm1ham9yKyssIDApOwogICAgICAgICAgICAgICAgICBGUy5yZWdpc3RlckRldmljZShkZXYsIHsKICAgICAgICAgICAgICAgICAgICAgIG9wZW46IHN0cmVhbSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLnNlZWthYmxlID0gZmFsc2UKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICBjbG9zZTogc3RyZWFtID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3V0cHV0ICYmIG91dHB1dC5idWZmZXIgJiYgb3V0cHV0LmJ1ZmZlci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0KDEwKQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICByZWFkOiAoc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3MpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYnl0ZXNSZWFkID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBpbnB1dCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDI5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCAmJiBieXRlc1JlYWQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHVuZGVmaW5lZCkgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5dGVzUmVhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXJbb2Zmc2V0ICsgaV0gPSByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ5dGVzUmVhZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0ubm9kZS50aW1lc3RhbXAgPSBEYXRlLm5vdygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBieXRlc1JlYWQKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICB3cml0ZTogKHN0cmVhbSwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0KGJ1ZmZlcltvZmZzZXQgKyBpXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoMjkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0ubm9kZS50aW1lc3RhbXAgPSBEYXRlLm5vdygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICByZXR1cm4gRlMubWtkZXYocGF0aCwgbW9kZSwgZGV2KQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZm9yY2VMb2FkRmlsZTogb2JqID0+IHsKICAgICAgICAgICAgICAgICAgaWYgKG9iai5pc0RldmljZSB8fCBvYmouaXNGb2xkZXIgfHwgb2JqLmxpbmsgfHwgb2JqLmNvbnRlbnRzKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBYTUxIdHRwUmVxdWVzdCAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJMYXp5IGxvYWRpbmcgc2hvdWxkIGhhdmUgYmVlbiBwZXJmb3JtZWQgKGNvbnRlbnRzIHNldCkgaW4gY3JlYXRlTGF6eUZpbGUsIGJ1dCBpdCB3YXMgbm90LiBMYXp5IGxvYWRpbmcgb25seSB3b3JrcyBpbiB3ZWIgd29ya2Vycy4gVXNlIC0tZW1iZWQtZmlsZSBvciAtLXByZWxvYWQtZmlsZSBpbiBlbWNjIG9uIHRoZSBtYWluIHRocmVhZC4iKQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlYWRfKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5jb250ZW50cyA9IGludEFycmF5RnJvbVN0cmluZyhyZWFkXyhvYmoudXJsKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnVzZWRCeXRlcyA9IG9iai5jb250ZW50cy5sZW5ndGgKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRlMuRXJybm9FcnJvcigyOSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGxvYWQgd2l0aG91dCByZWFkKCkgb3IgWE1MSHR0cFJlcXVlc3QuIikKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY3JlYXRlTGF6eUZpbGU6IChwYXJlbnQsIG5hbWUsIHVybCwgY2FuUmVhZCwgY2FuV3JpdGUpID0+IHsKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gTGF6eVVpbnQ4QXJyYXkoKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aEtub3duID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNodW5rcyA9IFtdCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgTGF6eVVpbnQ4QXJyYXkucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIExhenlVaW50OEFycmF5X2dldChpZHgpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpZHggPiB0aGlzLmxlbmd0aCAtIDEgfHwgaWR4IDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHZhciBjaHVua09mZnNldCA9IGlkeCAlIHRoaXMuY2h1bmtTaXplOwogICAgICAgICAgICAgICAgICAgICAgdmFyIGNodW5rTnVtID0gaWR4IC8gdGhpcy5jaHVua1NpemUgfCAwOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0dGVyKGNodW5rTnVtKVtjaHVua09mZnNldF0KICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgTGF6eVVpbnQ4QXJyYXkucHJvdG90eXBlLnNldERhdGFHZXR0ZXIgPSBmdW5jdGlvbiBMYXp5VWludDhBcnJheV9zZXREYXRhR2V0dGVyKGdldHRlcikgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXR0ZXIgPSBnZXR0ZXIKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgTGF6eVVpbnQ4QXJyYXkucHJvdG90eXBlLmNhY2hlTGVuZ3RoID0gZnVuY3Rpb24gTGF6eVVpbnQ4QXJyYXlfY2FjaGVMZW5ndGgoKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0OwogICAgICAgICAgICAgICAgICAgICAgeGhyLm9wZW4oIkhFQUQiLCB1cmwsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgIHhoci5zZW5kKG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCEoeGhyLnN0YXR1cyA+PSAyMDAgJiYgeGhyLnN0YXR1cyA8IDMwMCB8fCB4aHIuc3RhdHVzID09PSAzMDQpKSB0aHJvdyBuZXcgRXJyb3IoIkNvdWxkbid0IGxvYWQgIiArIHVybCArICIuIFN0YXR1czogIiArIHhoci5zdGF0dXMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGFsZW5ndGggPSBOdW1iZXIoeGhyLmdldFJlc3BvbnNlSGVhZGVyKCJDb250ZW50LWxlbmd0aCIpKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBoZWFkZXI7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFzQnl0ZVNlcnZpbmcgPSAoaGVhZGVyID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKCJBY2NlcHQtUmFuZ2VzIikpICYmIGhlYWRlciA9PT0gImJ5dGVzIjsKICAgICAgICAgICAgICAgICAgICAgIHZhciB1c2VzR3ppcCA9IChoZWFkZXIgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtRW5jb2RpbmciKSkgJiYgaGVhZGVyID09PSAiZ3ppcCI7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgY2h1bmtTaXplID0gMTAyNCAqIDEwMjQ7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIWhhc0J5dGVTZXJ2aW5nKSBjaHVua1NpemUgPSBkYXRhbGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgdmFyIGRvWEhSID0gKGZyb20sIHRvKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZyb20gPiB0bykgdGhyb3cgbmV3IEVycm9yKCJpbnZhbGlkIHJhbmdlICgiICsgZnJvbSArICIsICIgKyB0byArICIpIG9yIG5vIGJ5dGVzIHJlcXVlc3RlZCEiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG8gPiBkYXRhbGVuZ3RoIC0gMSkgdGhyb3cgbmV3IEVycm9yKCJvbmx5ICIgKyBkYXRhbGVuZ3RoICsgIiBieXRlcyBhdmFpbGFibGUhIHByb2dyYW1tZXIgZXJyb3IhIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdDsKICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIub3BlbigiR0VUIiwgdXJsLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFsZW5ndGggIT09IGNodW5rU2l6ZSkgeGhyLnNldFJlcXVlc3RIZWFkZXIoIlJhbmdlIiwgImJ5dGVzPSIgKyBmcm9tICsgIi0iICsgdG8pOwogICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAiYXJyYXlidWZmZXIiOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh4aHIub3ZlcnJpZGVNaW1lVHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIub3ZlcnJpZGVNaW1lVHlwZSgidGV4dC9wbGFpbjsgY2hhcnNldD14LXVzZXItZGVmaW5lZCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5zZW5kKG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKHhoci5zdGF0dXMgPj0gMjAwICYmIHhoci5zdGF0dXMgPCAzMDAgfHwgeGhyLnN0YXR1cyA9PT0gMzA0KSkgdGhyb3cgbmV3IEVycm9yKCJDb3VsZG4ndCBsb2FkICIgKyB1cmwgKyAiLiBTdGF0dXM6ICIgKyB4aHIuc3RhdHVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeGhyLnJlc3BvbnNlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHhoci5yZXNwb25zZSB8fCBbXSkKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludEFycmF5RnJvbVN0cmluZyh4aHIucmVzcG9uc2VUZXh0IHx8ICIiLCB0cnVlKQogICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBsYXp5QXJyYXkgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgICAgbGF6eUFycmF5LnNldERhdGFHZXR0ZXIoY2h1bmtOdW0gPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IGNodW5rTnVtICogY2h1bmtTaXplOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbmQgPSAoY2h1bmtOdW0gKyAxKSAqIGNodW5rU2l6ZSAtIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gTWF0aC5taW4oZW5kLCBkYXRhbGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsYXp5QXJyYXkuY2h1bmtzW2NodW5rTnVtXSA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXp5QXJyYXkuY2h1bmtzW2NodW5rTnVtXSA9IGRvWEhSKHN0YXJ0LCBlbmQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbGF6eUFycmF5LmNodW5rc1tjaHVua051bV0gPT0gInVuZGVmaW5lZCIpIHRocm93IG5ldyBFcnJvcigiZG9YSFIgZmFpbGVkISIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsYXp5QXJyYXkuY2h1bmtzW2NodW5rTnVtXQogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodXNlc0d6aXAgfHwgIWRhdGFsZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjaHVua1NpemUgPSBkYXRhbGVuZ3RoID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhbGVuZ3RoID0gdGhpcy5nZXR0ZXIoMCkubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgIGNodW5rU2l6ZSA9IGRhdGFsZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0KCJMYXp5RmlsZXMgb24gZ3ppcCBmb3JjZXMgZG93bmxvYWQgb2YgdGhlIHdob2xlIGZpbGUgd2hlbiBsZW5ndGggaXMgYWNjZXNzZWQiKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbGVuZ3RoID0gZGF0YWxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NodW5rU2l6ZSA9IGNodW5rU2l6ZTsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoS25vd24gPSB0cnVlCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgWE1MSHR0cFJlcXVlc3QgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB0aHJvdyAiQ2Fubm90IGRvIHN5bmNocm9ub3VzIGJpbmFyeSBYSFJzIG91dHNpZGUgd2Vid29ya2VycyBpbiBtb2Rlcm4gYnJvd3NlcnMuIFVzZSAtLWVtYmVkLWZpbGUgb3IgLS1wcmVsb2FkLWZpbGUgaW4gZW1jYyI7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbGF6eUFycmF5ID0gbmV3IExhenlVaW50OEFycmF5OwogICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMobGF6eUFycmF5LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMubGVuZ3RoS25vd24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlTGVuZ3RoKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9sZW5ndGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2h1bmtTaXplOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMubGVuZ3RoS25vd24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlTGVuZ3RoKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9jaHVua1NpemUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaXNEZXZpY2U6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnRzOiBsYXp5QXJyYXkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0aWVzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgIGlzRGV2aWNlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHVybAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gRlMuY3JlYXRlRmlsZShwYXJlbnQsIG5hbWUsIHByb3BlcnRpZXMsIGNhblJlYWQsIGNhbldyaXRlKTsKICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMuY29udGVudHMpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudHMgPSBwcm9wZXJ0aWVzLmNvbnRlbnRzCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcGVydGllcy51cmwpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUuY29udGVudHMgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgbm9kZS51cmwgPSBwcm9wZXJ0aWVzLnVybAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKG5vZGUsIHsKICAgICAgICAgICAgICAgICAgICAgIHVzZWRCeXRlczogewogICAgICAgICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnRzLmxlbmd0aAogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBzdHJlYW1fb3BzID0ge307CiAgICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMobm9kZS5zdHJlYW1fb3BzKTsKICAgICAgICAgICAgICAgICAga2V5cy5mb3JFYWNoKGtleSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSBub2RlLnN0cmVhbV9vcHNba2V5XTsKICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbV9vcHNba2V5XSA9IGZ1bmN0aW9uIGZvcmNlTG9hZExhenlGaWxlKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIEZTLmZvcmNlTG9hZEZpbGUobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICBmdW5jdGlvbiB3cml0ZUNodW5rcyhzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGVudHMgPSBzdHJlYW0ubm9kZS5jb250ZW50czsKICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NpdGlvbiA+PSBjb250ZW50cy5sZW5ndGgpIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHNpemUgPSBNYXRoLm1pbihjb250ZW50cy5sZW5ndGggLSBwb3NpdGlvbiwgbGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZW50cy5zbGljZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcltvZmZzZXQgKyBpXSA9IGNvbnRlbnRzW3Bvc2l0aW9uICsgaV0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcltvZmZzZXQgKyBpXSA9IGNvbnRlbnRzLmdldChwb3NpdGlvbiArIGkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNpemUKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdHJlYW1fb3BzLnJlYWQgPSAoc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbikgPT4gewogICAgICAgICAgICAgICAgICAgICAgRlMuZm9yY2VMb2FkRmlsZShub2RlKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3cml0ZUNodW5rcyhzdHJlYW0sIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBzdHJlYW1fb3BzLm1tYXAgPSAoc3RyZWFtLCBsZW5ndGgsIHBvc2l0aW9uLCBwcm90LCBmbGFncykgPT4gewogICAgICAgICAgICAgICAgICAgICAgRlMuZm9yY2VMb2FkRmlsZShub2RlKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwdHIgPSBtbWFwQWxsb2MobGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICghcHRyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDgpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB3cml0ZUNodW5rcyhzdHJlYW0sIEhFQVA4LCBwdHIsIGxlbmd0aCwgcG9zaXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBwdHI6IHB0ciwKICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvY2F0ZWQ6IHRydWUKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbm9kZS5zdHJlYW1fb3BzID0gc3RyZWFtX29wczsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIGZ1bmN0aW9uIFVURjhUb1N0cmluZyhwdHIsIG1heEJ5dGVzVG9SZWFkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHB0ciA/IFVURjhBcnJheVRvU3RyaW5nKEhFQVBVOCwgcHRyLCBtYXhCeXRlc1RvUmVhZCkgOiAiIgogICAgICAgICAgfQogICAgICAgICAgdmFyIFNZU0NBTExTID0gewogICAgICAgICAgICAgIERFRkFVTFRfUE9MTE1BU0s6IDUsCiAgICAgICAgICAgICAgY2FsY3VsYXRlQXQ6IGZ1bmN0aW9uKGRpcmZkLCBwYXRoLCBhbGxvd0VtcHR5KSB7CiAgICAgICAgICAgICAgICAgIGlmIChQQVRILmlzQWJzKHBhdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGF0aAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBkaXI7CiAgICAgICAgICAgICAgICAgIGlmIChkaXJmZCA9PT0gLTEwMCkgewogICAgICAgICAgICAgICAgICAgICAgZGlyID0gRlMuY3dkKCkKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXJzdHJlYW0gPSBTWVNDQUxMUy5nZXRTdHJlYW1Gcm9tRkQoZGlyZmQpOwogICAgICAgICAgICAgICAgICAgICAgZGlyID0gZGlyc3RyZWFtLnBhdGgKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocGF0aC5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCFhbGxvd0VtcHR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEZTLkVycm5vRXJyb3IoNDQpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGlyCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIFBBVEguam9pbjIoZGlyLCBwYXRoKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZG9TdGF0OiBmdW5jdGlvbihmdW5jLCBwYXRoLCBidWYpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ID0gZnVuYyhwYXRoKQogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZSAmJiBlLm5vZGUgJiYgUEFUSC5ub3JtYWxpemUocGF0aCkgIT09IFBBVEgubm9ybWFsaXplKEZTLmdldFBhdGgoZS5ub2RlKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTU0CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgSEVBUDMyW2J1ZiA+PiAyXSA9IHN0YXQuZGV2OwogICAgICAgICAgICAgICAgICBIRUFQMzJbYnVmICsgOCA+PiAyXSA9IHN0YXQuaW5vOwogICAgICAgICAgICAgICAgICBIRUFQMzJbYnVmICsgMTIgPj4gMl0gPSBzdGF0Lm1vZGU7CiAgICAgICAgICAgICAgICAgIEhFQVBVMzJbYnVmICsgMTYgPj4gMl0gPSBzdGF0Lm5saW5rOwogICAgICAgICAgICAgICAgICBIRUFQMzJbYnVmICsgMjAgPj4gMl0gPSBzdGF0LnVpZDsKICAgICAgICAgICAgICAgICAgSEVBUDMyW2J1ZiArIDI0ID4+IDJdID0gc3RhdC5naWQ7CiAgICAgICAgICAgICAgICAgIEhFQVAzMltidWYgKyAyOCA+PiAyXSA9IHN0YXQucmRldjsKICAgICAgICAgICAgICAgICAgdGVtcEk2NCA9IFtzdGF0LnNpemUgPj4+IDAsICh0ZW1wRG91YmxlID0gc3RhdC5zaXplLCArTWF0aC5hYnModGVtcERvdWJsZSkgPj0gMSA/IHRlbXBEb3VibGUgPiAwID8gK01hdGguZmxvb3IodGVtcERvdWJsZSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogfn4rTWF0aC5jZWlsKCh0ZW1wRG91YmxlIC0gKyh+fnRlbXBEb3VibGUgPj4+IDApKSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogMCldLCBIRUFQMzJbYnVmICsgNDAgPj4gMl0gPSB0ZW1wSTY0WzBdLCBIRUFQMzJbYnVmICsgNDQgPj4gMl0gPSB0ZW1wSTY0WzFdOwogICAgICAgICAgICAgICAgICBIRUFQMzJbYnVmICsgNDggPj4gMl0gPSA0MDk2OwogICAgICAgICAgICAgICAgICBIRUFQMzJbYnVmICsgNTIgPj4gMl0gPSBzdGF0LmJsb2NrczsKICAgICAgICAgICAgICAgICAgdmFyIGF0aW1lID0gc3RhdC5hdGltZS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBtdGltZSA9IHN0YXQubXRpbWUuZ2V0VGltZSgpOwogICAgICAgICAgICAgICAgICB2YXIgY3RpbWUgPSBzdGF0LmN0aW1lLmdldFRpbWUoKTsKICAgICAgICAgICAgICAgICAgdGVtcEk2NCA9IFtNYXRoLmZsb29yKGF0aW1lIC8gMWUzKSA+Pj4gMCwgKHRlbXBEb3VibGUgPSBNYXRoLmZsb29yKGF0aW1lIC8gMWUzKSwgK01hdGguYWJzKHRlbXBEb3VibGUpID49IDEgPyB0ZW1wRG91YmxlID4gMCA/ICtNYXRoLmZsb29yKHRlbXBEb3VibGUgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IH5+K01hdGguY2VpbCgodGVtcERvdWJsZSAtICsofn50ZW1wRG91YmxlID4+PiAwKSkgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IDApXSwgSEVBUDMyW2J1ZiArIDU2ID4+IDJdID0gdGVtcEk2NFswXSwgSEVBUDMyW2J1ZiArIDYwID4+IDJdID0gdGVtcEk2NFsxXTsKICAgICAgICAgICAgICAgICAgSEVBUFUzMltidWYgKyA2NCA+PiAyXSA9IGF0aW1lICUgMWUzICogMWUzOwogICAgICAgICAgICAgICAgICB0ZW1wSTY0ID0gW01hdGguZmxvb3IobXRpbWUgLyAxZTMpID4+PiAwLCAodGVtcERvdWJsZSA9IE1hdGguZmxvb3IobXRpbWUgLyAxZTMpLCArTWF0aC5hYnModGVtcERvdWJsZSkgPj0gMSA/IHRlbXBEb3VibGUgPiAwID8gK01hdGguZmxvb3IodGVtcERvdWJsZSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogfn4rTWF0aC5jZWlsKCh0ZW1wRG91YmxlIC0gKyh+fnRlbXBEb3VibGUgPj4+IDApKSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogMCldLCBIRUFQMzJbYnVmICsgNzIgPj4gMl0gPSB0ZW1wSTY0WzBdLCBIRUFQMzJbYnVmICsgNzYgPj4gMl0gPSB0ZW1wSTY0WzFdOwogICAgICAgICAgICAgICAgICBIRUFQVTMyW2J1ZiArIDgwID4+IDJdID0gbXRpbWUgJSAxZTMgKiAxZTM7CiAgICAgICAgICAgICAgICAgIHRlbXBJNjQgPSBbTWF0aC5mbG9vcihjdGltZSAvIDFlMykgPj4+IDAsICh0ZW1wRG91YmxlID0gTWF0aC5mbG9vcihjdGltZSAvIDFlMyksICtNYXRoLmFicyh0ZW1wRG91YmxlKSA+PSAxID8gdGVtcERvdWJsZSA+IDAgPyArTWF0aC5mbG9vcih0ZW1wRG91YmxlIC8gNDI5NDk2NzI5NikgPj4+IDAgOiB+fitNYXRoLmNlaWwoKHRlbXBEb3VibGUgLSArKH5+dGVtcERvdWJsZSA+Pj4gMCkpIC8gNDI5NDk2NzI5NikgPj4+IDAgOiAwKV0sIEhFQVAzMltidWYgKyA4OCA+PiAyXSA9IHRlbXBJNjRbMF0sIEhFQVAzMltidWYgKyA5MiA+PiAyXSA9IHRlbXBJNjRbMV07CiAgICAgICAgICAgICAgICAgIEhFQVBVMzJbYnVmICsgOTYgPj4gMl0gPSBjdGltZSAlIDFlMyAqIDFlMzsKICAgICAgICAgICAgICAgICAgdGVtcEk2NCA9IFtzdGF0LmlubyA+Pj4gMCwgKHRlbXBEb3VibGUgPSBzdGF0LmlubywgK01hdGguYWJzKHRlbXBEb3VibGUpID49IDEgPyB0ZW1wRG91YmxlID4gMCA/ICtNYXRoLmZsb29yKHRlbXBEb3VibGUgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IH5+K01hdGguY2VpbCgodGVtcERvdWJsZSAtICsofn50ZW1wRG91YmxlID4+PiAwKSkgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IDApXSwgSEVBUDMyW2J1ZiArIDEwNCA+PiAyXSA9IHRlbXBJNjRbMF0sIEhFQVAzMltidWYgKyAxMDggPj4gMl0gPSB0ZW1wSTY0WzFdOwogICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZG9Nc3luYzogZnVuY3Rpb24oYWRkciwgc3RyZWFtLCBsZW4sIGZsYWdzLCBvZmZzZXQpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFGUy5pc0ZpbGUoc3RyZWFtLm5vZGUubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDQzKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIDIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIGJ1ZmZlciA9IEhFQVBVOC5zbGljZShhZGRyLCBhZGRyICsgbGVuKTsKICAgICAgICAgICAgICAgICAgRlMubXN5bmMoc3RyZWFtLCBidWZmZXIsIG9mZnNldCwgbGVuLCBmbGFncykKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHZhcmFyZ3M6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBTWVNDQUxMUy52YXJhcmdzICs9IDQ7CiAgICAgICAgICAgICAgICAgIHZhciByZXQgPSBIRUFQMzJbU1lTQ0FMTFMudmFyYXJncyAtIDQgPj4gMl07CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXQKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGdldFN0cjogZnVuY3Rpb24ocHRyKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXQgPSBVVEY4VG9TdHJpbmcocHRyKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZ2V0U3RyZWFtRnJvbUZEOiBmdW5jdGlvbihmZCkgewogICAgICAgICAgICAgICAgICB2YXIgc3RyZWFtID0gRlMuZ2V0U3RyZWFtKGZkKTsKICAgICAgICAgICAgICAgICAgaWYgKCFzdHJlYW0pIHRocm93IG5ldyBGUy5FcnJub0Vycm9yKDgpOwogICAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtCiAgICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBmdW5jdGlvbiBfX19zeXNjYWxsX19uZXdzZWxlY3QobmZkcywgcmVhZGZkcywgd3JpdGVmZHMsIGV4Y2VwdGZkcywgdGltZW91dCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHZhciB0b3RhbCA9IDA7CiAgICAgICAgICAgICAgICAgIHZhciBzcmNSZWFkTG93ID0gcmVhZGZkcyA/IEhFQVAzMltyZWFkZmRzID4+IDJdIDogMCwKICAgICAgICAgICAgICAgICAgICAgIHNyY1JlYWRIaWdoID0gcmVhZGZkcyA/IEhFQVAzMltyZWFkZmRzICsgNCA+PiAyXSA6IDA7CiAgICAgICAgICAgICAgICAgIHZhciBzcmNXcml0ZUxvdyA9IHdyaXRlZmRzID8gSEVBUDMyW3dyaXRlZmRzID4+IDJdIDogMCwKICAgICAgICAgICAgICAgICAgICAgIHNyY1dyaXRlSGlnaCA9IHdyaXRlZmRzID8gSEVBUDMyW3dyaXRlZmRzICsgNCA+PiAyXSA6IDA7CiAgICAgICAgICAgICAgICAgIHZhciBzcmNFeGNlcHRMb3cgPSBleGNlcHRmZHMgPyBIRUFQMzJbZXhjZXB0ZmRzID4+IDJdIDogMCwKICAgICAgICAgICAgICAgICAgICAgIHNyY0V4Y2VwdEhpZ2ggPSBleGNlcHRmZHMgPyBIRUFQMzJbZXhjZXB0ZmRzICsgNCA+PiAyXSA6IDA7CiAgICAgICAgICAgICAgICAgIHZhciBkc3RSZWFkTG93ID0gMCwKICAgICAgICAgICAgICAgICAgICAgIGRzdFJlYWRIaWdoID0gMDsKICAgICAgICAgICAgICAgICAgdmFyIGRzdFdyaXRlTG93ID0gMCwKICAgICAgICAgICAgICAgICAgICAgIGRzdFdyaXRlSGlnaCA9IDA7CiAgICAgICAgICAgICAgICAgIHZhciBkc3RFeGNlcHRMb3cgPSAwLAogICAgICAgICAgICAgICAgICAgICAgZHN0RXhjZXB0SGlnaCA9IDA7CiAgICAgICAgICAgICAgICAgIHZhciBhbGxMb3cgPSAocmVhZGZkcyA/IEhFQVAzMltyZWFkZmRzID4+IDJdIDogMCkgfCAod3JpdGVmZHMgPyBIRUFQMzJbd3JpdGVmZHMgPj4gMl0gOiAwKSB8IChleGNlcHRmZHMgPyBIRUFQMzJbZXhjZXB0ZmRzID4+IDJdIDogMCk7CiAgICAgICAgICAgICAgICAgIHZhciBhbGxIaWdoID0gKHJlYWRmZHMgPyBIRUFQMzJbcmVhZGZkcyArIDQgPj4gMl0gOiAwKSB8ICh3cml0ZWZkcyA/IEhFQVAzMlt3cml0ZWZkcyArIDQgPj4gMl0gOiAwKSB8IChleGNlcHRmZHMgPyBIRUFQMzJbZXhjZXB0ZmRzICsgNCA+PiAyXSA6IDApOwogICAgICAgICAgICAgICAgICB2YXIgY2hlY2sgPSBmdW5jdGlvbihmZCwgbG93LCBoaWdoLCB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmZCA8IDMyID8gbG93ICYgdmFsIDogaGlnaCAmIHZhbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBmZCA9IDA7IGZkIDwgbmZkczsgZmQrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFyIG1hc2sgPSAxIDw8IGZkICUgMzI7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNoZWNrKGZkLCBhbGxMb3csIGFsbEhpZ2gsIG1hc2spKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHJlYW0gPSBTWVNDQUxMUy5nZXRTdHJlYW1Gcm9tRkQoZmQpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIGZsYWdzID0gU1lTQ0FMTFMuREVGQVVMVF9QT0xMTUFTSzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0uc3RyZWFtX29wcy5wb2xsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhZ3MgPSBzdHJlYW0uc3RyZWFtX29wcy5wb2xsKHN0cmVhbSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIDEgJiYgY2hlY2soZmQsIHNyY1JlYWRMb3csIHNyY1JlYWRIaWdoLCBtYXNrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZkIDwgMzIgPyBkc3RSZWFkTG93ID0gZHN0UmVhZExvdyB8IG1hc2sgOiBkc3RSZWFkSGlnaCA9IGRzdFJlYWRIaWdoIHwgbWFzazsKICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbCsrCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiA0ICYmIGNoZWNrKGZkLCBzcmNXcml0ZUxvdywgc3JjV3JpdGVIaWdoLCBtYXNrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZkIDwgMzIgPyBkc3RXcml0ZUxvdyA9IGRzdFdyaXRlTG93IHwgbWFzayA6IGRzdFdyaXRlSGlnaCA9IGRzdFdyaXRlSGlnaCB8IG1hc2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWwrKwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgMiAmJiBjaGVjayhmZCwgc3JjRXhjZXB0TG93LCBzcmNFeGNlcHRIaWdoLCBtYXNrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZkIDwgMzIgPyBkc3RFeGNlcHRMb3cgPSBkc3RFeGNlcHRMb3cgfCBtYXNrIDogZHN0RXhjZXB0SGlnaCA9IGRzdEV4Y2VwdEhpZ2ggfCBtYXNrOwogICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsKysKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocmVhZGZkcykgewogICAgICAgICAgICAgICAgICAgICAgSEVBUDMyW3JlYWRmZHMgPj4gMl0gPSBkc3RSZWFkTG93OwogICAgICAgICAgICAgICAgICAgICAgSEVBUDMyW3JlYWRmZHMgKyA0ID4+IDJdID0gZHN0UmVhZEhpZ2gKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAod3JpdGVmZHMpIHsKICAgICAgICAgICAgICAgICAgICAgIEhFQVAzMlt3cml0ZWZkcyA+PiAyXSA9IGRzdFdyaXRlTG93OwogICAgICAgICAgICAgICAgICAgICAgSEVBUDMyW3dyaXRlZmRzICsgNCA+PiAyXSA9IGRzdFdyaXRlSGlnaAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChleGNlcHRmZHMpIHsKICAgICAgICAgICAgICAgICAgICAgIEhFQVAzMltleGNlcHRmZHMgPj4gMl0gPSBkc3RFeGNlcHRMb3c7CiAgICAgICAgICAgICAgICAgICAgICBIRUFQMzJbZXhjZXB0ZmRzICsgNCA+PiAyXSA9IGRzdEV4Y2VwdEhpZ2gKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gdG90YWwKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIHJldHVybiAtZS5lcnJubwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfX19zeXNjYWxsX2ZhY2Nlc3NhdChkaXJmZCwgcGF0aCwgYW1vZGUsIGZsYWdzKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcGF0aCA9IFNZU0NBTExTLmdldFN0cihwYXRoKTsKICAgICAgICAgICAgICAgICAgcGF0aCA9IFNZU0NBTExTLmNhbGN1bGF0ZUF0KGRpcmZkLCBwYXRoKTsKICAgICAgICAgICAgICAgICAgaWYgKGFtb2RlICYgfjcpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAtMjgKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChwYXRoLCB7CiAgICAgICAgICAgICAgICAgICAgICBmb2xsb3c6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gbG9va3VwLm5vZGU7CiAgICAgICAgICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC00NAogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwZXJtcyA9ICIiOwogICAgICAgICAgICAgICAgICBpZiAoYW1vZGUgJiA0KSBwZXJtcyArPSAiciI7CiAgICAgICAgICAgICAgICAgIGlmIChhbW9kZSAmIDIpIHBlcm1zICs9ICJ3IjsKICAgICAgICAgICAgICAgICAgaWYgKGFtb2RlICYgMSkgcGVybXMgKz0gIngiOwogICAgICAgICAgICAgICAgICBpZiAocGVybXMgJiYgRlMubm9kZVBlcm1pc3Npb25zKG5vZGUsIHBlcm1zKSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0yCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIHJldHVybiAtZS5lcnJubwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBzZXRFcnJObyh2YWx1ZSkgewogICAgICAgICAgICAgIEhFQVAzMltfX19lcnJub19sb2NhdGlvbigpID4+IDJdID0gdmFsdWU7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX19fc3lzY2FsbF9mY250bDY0KGZkLCBjbWQsIHZhcmFyZ3MpIHsKICAgICAgICAgICAgICBTWVNDQUxMUy52YXJhcmdzID0gdmFyYXJnczsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgc3RyZWFtID0gU1lTQ0FMTFMuZ2V0U3RyZWFtRnJvbUZEKGZkKTsKICAgICAgICAgICAgICAgICAgc3dpdGNoIChjbWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDogewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmcgPSBTWVNDQUxMUy5nZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJnIDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTI4CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXdTdHJlYW07CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U3RyZWFtID0gRlMuY3JlYXRlU3RyZWFtKHN0cmVhbSwgYXJnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3U3RyZWFtLmZkCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0cmVhbS5mbGFnczsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNDogewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmcgPSBTWVNDQUxMUy5nZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0uZmxhZ3MgfD0gYXJnOwogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJnID0gU1lTQ0FMTFMuZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNldCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgSEVBUDE2W2FyZyArIG9mZnNldCA+PiAxXSA9IDI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0yODsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRFcnJObygyOCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAtMjgKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIC1lLmVycm5vCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9fX3N5c2NhbGxfZnN0YXQ2NChmZCwgYnVmKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IFNZU0NBTExTLmdldFN0cmVhbUZyb21GRChmZCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBTWVNDQUxMUy5kb1N0YXQoRlMuc3RhdCwgc3RyZWFtLnBhdGgsIGJ1ZikKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIHJldHVybiAtZS5lcnJubwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBzdHJpbmdUb1VURjgoc3RyLCBvdXRQdHIsIG1heEJ5dGVzVG9Xcml0ZSkgewogICAgICAgICAgICAgIHJldHVybiBzdHJpbmdUb1VURjhBcnJheShzdHIsIEhFQVBVOCwgb3V0UHRyLCBtYXhCeXRlc1RvV3JpdGUpCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX19fc3lzY2FsbF9nZXRkZW50czY0KGZkLCBkaXJwLCBjb3VudCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHZhciBzdHJlYW0gPSBTWVNDQUxMUy5nZXRTdHJlYW1Gcm9tRkQoZmQpOwogICAgICAgICAgICAgICAgICBpZiAoIXN0cmVhbS5nZXRkZW50cykgewogICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLmdldGRlbnRzID0gRlMucmVhZGRpcihzdHJlYW0ucGF0aCkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgc3RydWN0X3NpemUgPSAyODA7CiAgICAgICAgICAgICAgICAgIHZhciBwb3MgPSAwOwogICAgICAgICAgICAgICAgICB2YXIgb2ZmID0gRlMubGxzZWVrKHN0cmVhbSwgMCwgMSk7CiAgICAgICAgICAgICAgICAgIHZhciBpZHggPSBNYXRoLmZsb29yKG9mZiAvIHN0cnVjdF9zaXplKTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGlkeCA8IHN0cmVhbS5nZXRkZW50cy5sZW5ndGggJiYgcG9zICsgc3RydWN0X3NpemUgPD0gY291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBpZDsKICAgICAgICAgICAgICAgICAgICAgIHZhciB0eXBlOwogICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBzdHJlYW0uZ2V0ZGVudHNbaWR4XTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lID09PSAiLiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZCA9IHN0cmVhbS5ub2RlLmlkOwogICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSA0CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgPT09ICIuLiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9va3VwID0gRlMubG9va3VwUGF0aChzdHJlYW0ucGF0aCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZCA9IGxvb2t1cC5ub2RlLmlkOwogICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSA0CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IEZTLmxvb2t1cE5vZGUoc3RyZWFtLm5vZGUsIG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlkID0gY2hpbGQuaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9IEZTLmlzQ2hyZGV2KGNoaWxkLm1vZGUpID8gMiA6IEZTLmlzRGlyKGNoaWxkLm1vZGUpID8gNCA6IEZTLmlzTGluayhjaGlsZC5tb2RlKSA/IDEwIDogOAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgdGVtcEk2NCA9IFtpZCA+Pj4gMCwgKHRlbXBEb3VibGUgPSBpZCwgK01hdGguYWJzKHRlbXBEb3VibGUpID49IDEgPyB0ZW1wRG91YmxlID4gMCA/ICtNYXRoLmZsb29yKHRlbXBEb3VibGUgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IH5+K01hdGguY2VpbCgodGVtcERvdWJsZSAtICsofn50ZW1wRG91YmxlID4+PiAwKSkgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IDApXSwgSEVBUDMyW2RpcnAgKyBwb3MgPj4gMl0gPSB0ZW1wSTY0WzBdLCBIRUFQMzJbZGlycCArIHBvcyArIDQgPj4gMl0gPSB0ZW1wSTY0WzFdOwogICAgICAgICAgICAgICAgICAgICAgdGVtcEk2NCA9IFsoaWR4ICsgMSkgKiBzdHJ1Y3Rfc2l6ZSA+Pj4gMCwgKHRlbXBEb3VibGUgPSAoaWR4ICsgMSkgKiBzdHJ1Y3Rfc2l6ZSwgK01hdGguYWJzKHRlbXBEb3VibGUpID49IDEgPyB0ZW1wRG91YmxlID4gMCA/ICtNYXRoLmZsb29yKHRlbXBEb3VibGUgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IH5+K01hdGguY2VpbCgodGVtcERvdWJsZSAtICsofn50ZW1wRG91YmxlID4+PiAwKSkgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IDApXSwgSEVBUDMyW2RpcnAgKyBwb3MgKyA4ID4+IDJdID0gdGVtcEk2NFswXSwgSEVBUDMyW2RpcnAgKyBwb3MgKyAxMiA+PiAyXSA9IHRlbXBJNjRbMV07CiAgICAgICAgICAgICAgICAgICAgICBIRUFQMTZbZGlycCArIHBvcyArIDE2ID4+IDFdID0gMjgwOwogICAgICAgICAgICAgICAgICAgICAgSEVBUDhbZGlycCArIHBvcyArIDE4ID4+IDBdID0gdHlwZTsKICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ1RvVVRGOChuYW1lLCBkaXJwICsgcG9zICsgMTksIDI1Nik7CiAgICAgICAgICAgICAgICAgICAgICBwb3MgKz0gc3RydWN0X3NpemU7CiAgICAgICAgICAgICAgICAgICAgICBpZHggKz0gMQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIEZTLmxsc2VlayhzdHJlYW0sIGlkeCAqIHN0cnVjdF9zaXplLCAwKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHBvcwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIC1lLmVycm5vCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9fX3N5c2NhbGxfaW9jdGwoZmQsIG9wLCB2YXJhcmdzKSB7CiAgICAgICAgICAgICAgU1lTQ0FMTFMudmFyYXJncyA9IHZhcmFyZ3M7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IFNZU0NBTExTLmdldFN0cmVhbUZyb21GRChmZCk7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAob3ApIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjE1MDk6CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDIxNTA1OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHJlYW0udHR5KSByZXR1cm4gLTU5OwogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDIxNTEwOgogICAgICAgICAgICAgICAgICAgICAgY2FzZSAyMTUxMToKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjE1MTI6CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDIxNTA2OgogICAgICAgICAgICAgICAgICAgICAgY2FzZSAyMTUwNzoKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjE1MDg6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0cmVhbS50dHkpIHJldHVybiAtNTk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjE1MTk6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0cmVhbS50dHkpIHJldHVybiAtNTk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3AgPSBTWVNDQUxMUy5nZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBIRUFQMzJbYXJncCA+PiAyXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjE1MjA6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0cmVhbS50dHkpIHJldHVybiAtNTk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0yOAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgY2FzZSAyMTUzMTogewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdwID0gU1lTQ0FMTFMuZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZTLmlvY3RsKHN0cmVhbSwgb3AsIGFyZ3ApCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDIxNTIzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHJlYW0udHR5KSByZXR1cm4gLTU5OwogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDIxNTI0OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHJlYW0udHR5KSByZXR1cm4gLTU5OwogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAtMjgKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIC1lLmVycm5vCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9fX3N5c2NhbGxfbHN0YXQ2NChwYXRoLCBidWYpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBwYXRoID0gU1lTQ0FMTFMuZ2V0U3RyKHBhdGgpOwogICAgICAgICAgICAgICAgICByZXR1cm4gU1lTQ0FMTFMuZG9TdGF0KEZTLmxzdGF0LCBwYXRoLCBidWYpCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICByZXR1cm4gLWUuZXJybm8KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX19fc3lzY2FsbF9uZXdmc3RhdGF0KGRpcmZkLCBwYXRoLCBidWYsIGZsYWdzKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcGF0aCA9IFNZU0NBTExTLmdldFN0cihwYXRoKTsKICAgICAgICAgICAgICAgICAgdmFyIG5vZm9sbG93ID0gZmxhZ3MgJiAyNTY7CiAgICAgICAgICAgICAgICAgIHZhciBhbGxvd0VtcHR5ID0gZmxhZ3MgJiA0MDk2OwogICAgICAgICAgICAgICAgICBmbGFncyA9IGZsYWdzICYgfjY0MDA7CiAgICAgICAgICAgICAgICAgIHBhdGggPSBTWVNDQUxMUy5jYWxjdWxhdGVBdChkaXJmZCwgcGF0aCwgYWxsb3dFbXB0eSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBTWVNDQUxMUy5kb1N0YXQobm9mb2xsb3cgPyBGUy5sc3RhdCA6IEZTLnN0YXQsIHBhdGgsIGJ1ZikKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIHJldHVybiAtZS5lcnJubwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfX19zeXNjYWxsX29wZW5hdChkaXJmZCwgcGF0aCwgZmxhZ3MsIHZhcmFyZ3MpIHsKICAgICAgICAgICAgICBTWVNDQUxMUy52YXJhcmdzID0gdmFyYXJnczsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBwYXRoID0gU1lTQ0FMTFMuZ2V0U3RyKHBhdGgpOwogICAgICAgICAgICAgICAgICBwYXRoID0gU1lTQ0FMTFMuY2FsY3VsYXRlQXQoZGlyZmQsIHBhdGgpOwogICAgICAgICAgICAgICAgICB2YXIgbW9kZSA9IHZhcmFyZ3MgPyBTWVNDQUxMUy5nZXQoKSA6IDA7CiAgICAgICAgICAgICAgICAgIHJldHVybiBGUy5vcGVuKHBhdGgsIGZsYWdzLCBtb2RlKS5mZAogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIC1lLmVycm5vCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9fX3N5c2NhbGxfcmVuYW1lYXQob2xkZGlyZmQsIG9sZHBhdGgsIG5ld2RpcmZkLCBuZXdwYXRoKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgb2xkcGF0aCA9IFNZU0NBTExTLmdldFN0cihvbGRwYXRoKTsKICAgICAgICAgICAgICAgICAgbmV3cGF0aCA9IFNZU0NBTExTLmdldFN0cihuZXdwYXRoKTsKICAgICAgICAgICAgICAgICAgb2xkcGF0aCA9IFNZU0NBTExTLmNhbGN1bGF0ZUF0KG9sZGRpcmZkLCBvbGRwYXRoKTsKICAgICAgICAgICAgICAgICAgbmV3cGF0aCA9IFNZU0NBTExTLmNhbGN1bGF0ZUF0KG5ld2RpcmZkLCBuZXdwYXRoKTsKICAgICAgICAgICAgICAgICAgRlMucmVuYW1lKG9sZHBhdGgsIG5ld3BhdGgpOwogICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIC1lLmVycm5vCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9fX3N5c2NhbGxfcm1kaXIocGF0aCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHBhdGggPSBTWVNDQUxMUy5nZXRTdHIocGF0aCk7CiAgICAgICAgICAgICAgICAgIEZTLnJtZGlyKHBhdGgpOwogICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIC1lLmVycm5vCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9fX3N5c2NhbGxfc3RhdDY0KHBhdGgsIGJ1ZikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHBhdGggPSBTWVNDQUxMUy5nZXRTdHIocGF0aCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBTWVNDQUxMUy5kb1N0YXQoRlMuc3RhdCwgcGF0aCwgYnVmKQogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIC1lLmVycm5vCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9fX3N5c2NhbGxfdW5saW5rYXQoZGlyZmQsIHBhdGgsIGZsYWdzKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcGF0aCA9IFNZU0NBTExTLmdldFN0cihwYXRoKTsKICAgICAgICAgICAgICAgICAgcGF0aCA9IFNZU0NBTExTLmNhbGN1bGF0ZUF0KGRpcmZkLCBwYXRoKTsKICAgICAgICAgICAgICAgICAgaWYgKGZsYWdzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBGUy51bmxpbmsocGF0aCkKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmbGFncyA9PT0gNTEyKSB7CiAgICAgICAgICAgICAgICAgICAgICBGUy5ybWRpcihwYXRoKQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgYWJvcnQoIkludmFsaWQgZmxhZ3MgcGFzc2VkIHRvIHVubGlua2F0IikKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIC1lLmVycm5vCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vd0lzTW9ub3RvbmljID0gdHJ1ZTsKCiAgICAgICAgICBmdW5jdGlvbiBfX2Vtc2NyaXB0ZW5fZ2V0X25vd19pc19tb25vdG9uaWMoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vd0lzTW9ub3RvbmljCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX19lbXNjcmlwdGVuX3Rocm93X2xvbmdqbXAoKSB7CiAgICAgICAgICAgICAgdGhyb3cgSW5maW5pdHkKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiByZWFkSTUzRnJvbUk2NChwdHIpIHsKICAgICAgICAgICAgICByZXR1cm4gSEVBUFUzMltwdHIgPj4gMl0gKyBIRUFQMzJbcHRyICsgNCA+PiAyXSAqIDQyOTQ5NjcyOTYKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfX2dtdGltZV9qcyh0aW1lLCB0bVB0cikgewogICAgICAgICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUocmVhZEk1M0Zyb21JNjQodGltZSkgKiAxZTMpOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciA+PiAyXSA9IGRhdGUuZ2V0VVRDU2Vjb25kcygpOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciArIDQgPj4gMl0gPSBkYXRlLmdldFVUQ01pbnV0ZXMoKTsKICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgKyA4ID4+IDJdID0gZGF0ZS5nZXRVVENIb3VycygpOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciArIDEyID4+IDJdID0gZGF0ZS5nZXRVVENEYXRlKCk7CiAgICAgICAgICAgICAgSEVBUDMyW3RtUHRyICsgMTYgPj4gMl0gPSBkYXRlLmdldFVUQ01vbnRoKCk7CiAgICAgICAgICAgICAgSEVBUDMyW3RtUHRyICsgMjAgPj4gMl0gPSBkYXRlLmdldFVUQ0Z1bGxZZWFyKCkgLSAxOTAwOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciArIDI0ID4+IDJdID0gZGF0ZS5nZXRVVENEYXkoKTsKICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBEYXRlLlVUQyhkYXRlLmdldFVUQ0Z1bGxZZWFyKCksIDAsIDEsIDAsIDAsIDAsIDApOwogICAgICAgICAgICAgIHZhciB5ZGF5ID0gKGRhdGUuZ2V0VGltZSgpIC0gc3RhcnQpIC8gKDFlMyAqIDYwICogNjAgKiAyNCkgfCAwOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciArIDI4ID4+IDJdID0geWRheQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGlzTGVhcFllYXIoeWVhcikgewogICAgICAgICAgICAgIHJldHVybiB5ZWFyICUgNCA9PT0gMCAmJiAoeWVhciAlIDEwMCAhPT0gMCB8fCB5ZWFyICUgNDAwID09PSAwKQogICAgICAgICAgfQogICAgICAgICAgdmFyIE1PTlRIX0RBWVNfTEVBUF9DVU1VTEFUSVZFID0gWzAsIDMxLCA2MCwgOTEsIDEyMSwgMTUyLCAxODIsIDIxMywgMjQ0LCAyNzQsIDMwNSwgMzM1XTsKICAgICAgICAgIHZhciBNT05USF9EQVlTX1JFR1VMQVJfQ1VNVUxBVElWRSA9IFswLCAzMSwgNTksIDkwLCAxMjAsIDE1MSwgMTgxLCAyMTIsIDI0MywgMjczLCAzMDQsIDMzNF07CgogICAgICAgICAgZnVuY3Rpb24geWRheUZyb21EYXRlKGRhdGUpIHsKICAgICAgICAgICAgICB2YXIgbGVhcCA9IGlzTGVhcFllYXIoZGF0ZS5nZXRGdWxsWWVhcigpKTsKICAgICAgICAgICAgICB2YXIgbW9udGhEYXlzQ3VtdWxhdGl2ZSA9IGxlYXAgPyBNT05USF9EQVlTX0xFQVBfQ1VNVUxBVElWRSA6IE1PTlRIX0RBWVNfUkVHVUxBUl9DVU1VTEFUSVZFOwogICAgICAgICAgICAgIHZhciB5ZGF5ID0gbW9udGhEYXlzQ3VtdWxhdGl2ZVtkYXRlLmdldE1vbnRoKCldICsgZGF0ZS5nZXREYXRlKCkgLSAxOwogICAgICAgICAgICAgIHJldHVybiB5ZGF5CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX19sb2NhbHRpbWVfanModGltZSwgdG1QdHIpIHsKICAgICAgICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKHJlYWRJNTNGcm9tSTY0KHRpbWUpICogMWUzKTsKICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgPj4gMl0gPSBkYXRlLmdldFNlY29uZHMoKTsKICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgKyA0ID4+IDJdID0gZGF0ZS5nZXRNaW51dGVzKCk7CiAgICAgICAgICAgICAgSEVBUDMyW3RtUHRyICsgOCA+PiAyXSA9IGRhdGUuZ2V0SG91cnMoKTsKICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgKyAxMiA+PiAyXSA9IGRhdGUuZ2V0RGF0ZSgpOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciArIDE2ID4+IDJdID0gZGF0ZS5nZXRNb250aCgpOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciArIDIwID4+IDJdID0gZGF0ZS5nZXRGdWxsWWVhcigpIC0gMTkwMDsKICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgKyAyNCA+PiAyXSA9IGRhdGUuZ2V0RGF5KCk7CiAgICAgICAgICAgICAgdmFyIHlkYXkgPSB5ZGF5RnJvbURhdGUoZGF0ZSkgfCAwOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciArIDI4ID4+IDJdID0geWRheTsKICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgKyAzNiA+PiAyXSA9IC0oZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpICogNjApOwogICAgICAgICAgICAgIHZhciBzdGFydCA9IG5ldyBEYXRlKGRhdGUuZ2V0RnVsbFllYXIoKSwgMCwgMSk7CiAgICAgICAgICAgICAgdmFyIHN1bW1lck9mZnNldCA9IG5ldyBEYXRlKGRhdGUuZ2V0RnVsbFllYXIoKSwgNiwgMSkuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICAgICAgICB2YXIgd2ludGVyT2Zmc2V0ID0gc3RhcnQuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICAgICAgICB2YXIgZHN0ID0gKHN1bW1lck9mZnNldCAhPSB3aW50ZXJPZmZzZXQgJiYgZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpID09IE1hdGgubWluKHdpbnRlck9mZnNldCwgc3VtbWVyT2Zmc2V0KSkgfCAwOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciArIDMyID4+IDJdID0gZHN0CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX19ta3RpbWVfanModG1QdHIpIHsKICAgICAgICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKEhFQVAzMlt0bVB0ciArIDIwID4+IDJdICsgMTkwMCwgSEVBUDMyW3RtUHRyICsgMTYgPj4gMl0sIEhFQVAzMlt0bVB0ciArIDEyID4+IDJdLCBIRUFQMzJbdG1QdHIgKyA4ID4+IDJdLCBIRUFQMzJbdG1QdHIgKyA0ID4+IDJdLCBIRUFQMzJbdG1QdHIgPj4gMl0sIDApOwogICAgICAgICAgICAgIHZhciBkc3QgPSBIRUFQMzJbdG1QdHIgKyAzMiA+PiAyXTsKICAgICAgICAgICAgICB2YXIgZ3Vlc3NlZE9mZnNldCA9IGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBuZXcgRGF0ZShkYXRlLmdldEZ1bGxZZWFyKCksIDAsIDEpOwogICAgICAgICAgICAgIHZhciBzdW1tZXJPZmZzZXQgPSBuZXcgRGF0ZShkYXRlLmdldEZ1bGxZZWFyKCksIDYsIDEpLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgICAgICAgICAgICAgdmFyIHdpbnRlck9mZnNldCA9IHN0YXJ0LmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgICAgICAgICAgICAgdmFyIGRzdE9mZnNldCA9IE1hdGgubWluKHdpbnRlck9mZnNldCwgc3VtbWVyT2Zmc2V0KTsKICAgICAgICAgICAgICBpZiAoZHN0IDwgMCkgewogICAgICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgKyAzMiA+PiAyXSA9IE51bWJlcihzdW1tZXJPZmZzZXQgIT0gd2ludGVyT2Zmc2V0ICYmIGRzdE9mZnNldCA9PSBndWVzc2VkT2Zmc2V0KQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZHN0ID4gMCAhPSAoZHN0T2Zmc2V0ID09IGd1ZXNzZWRPZmZzZXQpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBub25Ec3RPZmZzZXQgPSBNYXRoLm1heCh3aW50ZXJPZmZzZXQsIHN1bW1lck9mZnNldCk7CiAgICAgICAgICAgICAgICAgIHZhciB0cnVlT2Zmc2V0ID0gZHN0ID4gMCA/IGRzdE9mZnNldCA6IG5vbkRzdE9mZnNldDsKICAgICAgICAgICAgICAgICAgZGF0ZS5zZXRUaW1lKGRhdGUuZ2V0VGltZSgpICsgKHRydWVPZmZzZXQgLSBndWVzc2VkT2Zmc2V0KSAqIDZlNCkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgSEVBUDMyW3RtUHRyICsgMjQgPj4gMl0gPSBkYXRlLmdldERheSgpOwogICAgICAgICAgICAgIHZhciB5ZGF5ID0geWRheUZyb21EYXRlKGRhdGUpIHwgMDsKICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgKyAyOCA+PiAyXSA9IHlkYXk7CiAgICAgICAgICAgICAgSEVBUDMyW3RtUHRyID4+IDJdID0gZGF0ZS5nZXRTZWNvbmRzKCk7CiAgICAgICAgICAgICAgSEVBUDMyW3RtUHRyICsgNCA+PiAyXSA9IGRhdGUuZ2V0TWludXRlcygpOwogICAgICAgICAgICAgIEhFQVAzMlt0bVB0ciArIDggPj4gMl0gPSBkYXRlLmdldEhvdXJzKCk7CiAgICAgICAgICAgICAgSEVBUDMyW3RtUHRyICsgMTIgPj4gMl0gPSBkYXRlLmdldERhdGUoKTsKICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgKyAxNiA+PiAyXSA9IGRhdGUuZ2V0TW9udGgoKTsKICAgICAgICAgICAgICBIRUFQMzJbdG1QdHIgKyAyMCA+PiAyXSA9IGRhdGUuZ2V0WWVhcigpOwogICAgICAgICAgICAgIHJldHVybiBkYXRlLmdldFRpbWUoKSAvIDFlMyB8IDAKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBzdHJpbmdUb05ld1VURjgoc3RyKSB7CiAgICAgICAgICAgICAgdmFyIHNpemUgPSBsZW5ndGhCeXRlc1VURjgoc3RyKSArIDE7CiAgICAgICAgICAgICAgdmFyIHJldCA9IF9tYWxsb2Moc2l6ZSk7CiAgICAgICAgICAgICAgaWYgKHJldCkgc3RyaW5nVG9VVEY4KHN0ciwgcmV0LCBzaXplKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX190enNldF9qcyh0aW1lem9uZSwgZGF5bGlnaHQsIHR6bmFtZSkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50WWVhciA9IChuZXcgRGF0ZSkuZ2V0RnVsbFllYXIoKTsKICAgICAgICAgICAgICB2YXIgd2ludGVyID0gbmV3IERhdGUoY3VycmVudFllYXIsIDAsIDEpOwogICAgICAgICAgICAgIHZhciBzdW1tZXIgPSBuZXcgRGF0ZShjdXJyZW50WWVhciwgNiwgMSk7CiAgICAgICAgICAgICAgdmFyIHdpbnRlck9mZnNldCA9IHdpbnRlci5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgICAgICAgICAgIHZhciBzdW1tZXJPZmZzZXQgPSBzdW1tZXIuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgICAgICAgICAgICB2YXIgc3RkVGltZXpvbmVPZmZzZXQgPSBNYXRoLm1heCh3aW50ZXJPZmZzZXQsIHN1bW1lck9mZnNldCk7CiAgICAgICAgICAgICAgSEVBUFUzMlt0aW1lem9uZSA+PiAyXSA9IHN0ZFRpbWV6b25lT2Zmc2V0ICogNjA7CiAgICAgICAgICAgICAgSEVBUDMyW2RheWxpZ2h0ID4+IDJdID0gTnVtYmVyKHdpbnRlck9mZnNldCAhPSBzdW1tZXJPZmZzZXQpOwoKICAgICAgICAgICAgICBmdW5jdGlvbiBleHRyYWN0Wm9uZShkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGRhdGUudG9UaW1lU3RyaW5nKCkubWF0Y2goL1woKFtBLVphLXogXSspXCkkLyk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogIkdNVCIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdpbnRlck5hbWUgPSBleHRyYWN0Wm9uZSh3aW50ZXIpOwogICAgICAgICAgICAgIHZhciBzdW1tZXJOYW1lID0gZXh0cmFjdFpvbmUoc3VtbWVyKTsKICAgICAgICAgICAgICB2YXIgd2ludGVyTmFtZVB0ciA9IHN0cmluZ1RvTmV3VVRGOCh3aW50ZXJOYW1lKTsKICAgICAgICAgICAgICB2YXIgc3VtbWVyTmFtZVB0ciA9IHN0cmluZ1RvTmV3VVRGOChzdW1tZXJOYW1lKTsKICAgICAgICAgICAgICBpZiAoc3VtbWVyT2Zmc2V0IDwgd2ludGVyT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAgIEhFQVBVMzJbdHpuYW1lID4+IDJdID0gd2ludGVyTmFtZVB0cjsKICAgICAgICAgICAgICAgICAgSEVBUFUzMlt0em5hbWUgKyA0ID4+IDJdID0gc3VtbWVyTmFtZVB0cgogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIEhFQVBVMzJbdHpuYW1lID4+IDJdID0gc3VtbWVyTmFtZVB0cjsKICAgICAgICAgICAgICAgICAgSEVBUFUzMlt0em5hbWUgKyA0ID4+IDJdID0gd2ludGVyTmFtZVB0cgogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfYWJvcnQoKSB7CiAgICAgICAgICAgICAgYWJvcnQoIiIpCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVhZEVtQXNtQXJnc0FycmF5ID0gW107CgogICAgICAgICAgZnVuY3Rpb24gcmVhZEVtQXNtQXJncyhzaWdQdHIsIGJ1ZikgewogICAgICAgICAgICAgIHJlYWRFbUFzbUFyZ3NBcnJheS5sZW5ndGggPSAwOwogICAgICAgICAgICAgIHZhciBjaDsKICAgICAgICAgICAgICBidWYgPj49IDI7CiAgICAgICAgICAgICAgd2hpbGUgKGNoID0gSEVBUFU4W3NpZ1B0cisrXSkgewogICAgICAgICAgICAgICAgICBidWYgKz0gY2ggIT0gMTA1ICYgYnVmOwogICAgICAgICAgICAgICAgICByZWFkRW1Bc21BcmdzQXJyYXkucHVzaChjaCA9PSAxMDUgPyBIRUFQMzJbYnVmXSA6IEhFQVBGNjRbYnVmKysgPj4gMV0pOwogICAgICAgICAgICAgICAgICArK2J1ZgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVhZEVtQXNtQXJnc0FycmF5CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gcnVuTWFpblRocmVhZEVtQXNtKGNvZGUsIHNpZ1B0ciwgYXJnYnVmLCBzeW5jKSB7CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSByZWFkRW1Bc21BcmdzKHNpZ1B0ciwgYXJnYnVmKTsKICAgICAgICAgICAgICByZXR1cm4gQVNNX0NPTlNUU1tjb2RlXS5hcHBseShudWxsLCBhcmdzKQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9lbXNjcmlwdGVuX2FzbV9jb25zdF9hc3luY19vbl9tYWluX3RocmVhZChjb2RlLCBzaWdQdHIsIGFyZ2J1ZikgewogICAgICAgICAgICAgIHJldHVybiBydW5NYWluVGhyZWFkRW1Bc20oY29kZSwgc2lnUHRyLCBhcmdidWYsIDApCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gcnVuRW1Bc21GdW5jdGlvbihjb2RlLCBzaWdQdHIsIGFyZ2J1ZikgewogICAgICAgICAgICAgIHZhciBhcmdzID0gcmVhZEVtQXNtQXJncyhzaWdQdHIsIGFyZ2J1Zik7CiAgICAgICAgICAgICAgcmV0dXJuIEFTTV9DT05TVFNbY29kZV0uYXBwbHkobnVsbCwgYXJncykKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfZW1zY3JpcHRlbl9hc21fY29uc3RfaW50KGNvZGUsIHNpZ1B0ciwgYXJnYnVmKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJ1bkVtQXNtRnVuY3Rpb24oY29kZSwgc2lnUHRyLCBhcmdidWYpCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX2Vtc2NyaXB0ZW5fZGF0ZV9ub3coKSB7CiAgICAgICAgICAgICAgcmV0dXJuIERhdGUubm93KCkKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBnZXRIZWFwTWF4KCkgewogICAgICAgICAgICAgIHJldHVybiAyMTQ3NDgzNjQ4CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX2Vtc2NyaXB0ZW5fZ2V0X2hlYXBfbWF4KCkgewogICAgICAgICAgICAgIHJldHVybiBnZXRIZWFwTWF4KCkKICAgICAgICAgIH0KICAgICAgICAgIHZhciBfZW1zY3JpcHRlbl9nZXRfbm93OwogICAgICAgICAgaWYgKEVOVklST05NRU5UX0lTX05PREUpIHsKICAgICAgICAgICAgICBfZW1zY3JpcHRlbl9nZXRfbm93ID0gKCkgPT4gewogICAgICAgICAgICAgICAgICB2YXIgdCA9IHByb2Nlc3MuaHJ0aW1lKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0WzBdICogMWUzICsgdFsxXSAvIDFlNgogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBfZW1zY3JpcHRlbl9nZXRfbm93ID0gKCkgPT4gcGVyZm9ybWFuY2Uubm93KCk7CgogICAgICAgICAgZnVuY3Rpb24gX2Vtc2NyaXB0ZW5fbWVtY3B5X2JpZyhkZXN0LCBzcmMsIG51bSkgewogICAgICAgICAgICAgIEhFQVBVOC5jb3B5V2l0aGluKGRlc3QsIHNyYywgc3JjICsgbnVtKQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGVtc2NyaXB0ZW5fcmVhbGxvY19idWZmZXIoc2l6ZSkgewogICAgICAgICAgICAgIHZhciBiID0gd2FzbU1lbW9yeS5idWZmZXI7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgd2FzbU1lbW9yeS5ncm93KHNpemUgLSBiLmJ5dGVMZW5ndGggKyA2NTUzNSA+Pj4gMTYpOwogICAgICAgICAgICAgICAgICB1cGRhdGVNZW1vcnlWaWV3cygpOwogICAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX2Vtc2NyaXB0ZW5fcmVzaXplX2hlYXAocmVxdWVzdGVkU2l6ZSkgewogICAgICAgICAgICAgIHZhciBvbGRTaXplID0gSEVBUFU4Lmxlbmd0aDsKICAgICAgICAgICAgICByZXF1ZXN0ZWRTaXplID0gcmVxdWVzdGVkU2l6ZSA+Pj4gMDsKICAgICAgICAgICAgICB2YXIgbWF4SGVhcFNpemUgPSBnZXRIZWFwTWF4KCk7CiAgICAgICAgICAgICAgaWYgKHJlcXVlc3RlZFNpemUgPiBtYXhIZWFwU2l6ZSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGFsaWduVXAgPSAoeCwgbXVsdGlwbGUpID0+IHggKyAobXVsdGlwbGUgLSB4ICUgbXVsdGlwbGUpICUgbXVsdGlwbGU7CiAgICAgICAgICAgICAgZm9yICh2YXIgY3V0RG93biA9IDE7IGN1dERvd24gPD0gNDsgY3V0RG93biAqPSAyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvdmVyR3Jvd25IZWFwU2l6ZSA9IG9sZFNpemUgKiAoMSArIC4yIC8gY3V0RG93bik7CiAgICAgICAgICAgICAgICAgIG92ZXJHcm93bkhlYXBTaXplID0gTWF0aC5taW4ob3Zlckdyb3duSGVhcFNpemUsIHJlcXVlc3RlZFNpemUgKyAxMDA2NjMyOTYpOwogICAgICAgICAgICAgICAgICB2YXIgbmV3U2l6ZSA9IE1hdGgubWluKG1heEhlYXBTaXplLCBhbGlnblVwKE1hdGgubWF4KHJlcXVlc3RlZFNpemUsIG92ZXJHcm93bkhlYXBTaXplKSwgNjU1MzYpKTsKICAgICAgICAgICAgICAgICAgdmFyIHJlcGxhY2VtZW50ID0gZW1zY3JpcHRlbl9yZWFsbG9jX2J1ZmZlcihuZXdTaXplKTsKICAgICAgICAgICAgICAgICAgaWYgKHJlcGxhY2VtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgICAgfQogICAgICAgICAgdmFyIEVOViA9IHt9OwoKICAgICAgICAgIGZ1bmN0aW9uIGdldEV4ZWN1dGFibGVOYW1lKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzUHJvZ3JhbSB8fCAiLi90aGlzLnByb2dyYW0iCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gZ2V0RW52U3RyaW5ncygpIHsKICAgICAgICAgICAgICBpZiAoIWdldEVudlN0cmluZ3Muc3RyaW5ncykgewogICAgICAgICAgICAgICAgICB2YXIgbGFuZyA9ICh0eXBlb2YgbmF2aWdhdG9yID09ICJvYmplY3QiICYmIG5hdmlnYXRvci5sYW5ndWFnZXMgJiYgbmF2aWdhdG9yLmxhbmd1YWdlc1swXSB8fCAiQyIpLnJlcGxhY2UoIi0iLCAiXyIpICsgIi5VVEYtOCI7CiAgICAgICAgICAgICAgICAgIHZhciBlbnYgPSB7CiAgICAgICAgICAgICAgICAgICAgICAiVVNFUiI6ICJ3ZWJfdXNlciIsCiAgICAgICAgICAgICAgICAgICAgICAiTE9HTkFNRSI6ICJ3ZWJfdXNlciIsCiAgICAgICAgICAgICAgICAgICAgICAiUEFUSCI6ICIvIiwKICAgICAgICAgICAgICAgICAgICAgICJQV0QiOiAiLyIsCiAgICAgICAgICAgICAgICAgICAgICAiSE9NRSI6ICIvaG9tZS93ZWJfdXNlciIsCiAgICAgICAgICAgICAgICAgICAgICAiTEFORyI6IGxhbmcsCiAgICAgICAgICAgICAgICAgICAgICAiXyI6IGdldEV4ZWN1dGFibGVOYW1lKCkKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgeCBpbiBFTlYpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChFTlZbeF0gPT09IHVuZGVmaW5lZCkgZGVsZXRlIGVudlt4XTsKICAgICAgICAgICAgICAgICAgICAgIGVsc2UgZW52W3hdID0gRU5WW3hdCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHN0cmluZ3MgPSBbXTsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgeCBpbiBlbnYpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ3MucHVzaCh4ICsgIj0iICsgZW52W3hdKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGdldEVudlN0cmluZ3Muc3RyaW5ncyA9IHN0cmluZ3MKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGdldEVudlN0cmluZ3Muc3RyaW5ncwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIHN0cmluZ1RvQXNjaWkoc3RyLCBidWZmZXIpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICBIRUFQOFtidWZmZXIrKyA+PiAwXSA9IHN0ci5jaGFyQ29kZUF0KGkpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIEhFQVA4W2J1ZmZlciA+PiAwXSA9IDAKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfZW52aXJvbl9nZXQoX19lbnZpcm9uLCBlbnZpcm9uX2J1ZikgewogICAgICAgICAgICAgIHZhciBidWZTaXplID0gMDsKICAgICAgICAgICAgICBnZXRFbnZTdHJpbmdzKCkuZm9yRWFjaChmdW5jdGlvbihzdHJpbmcsIGkpIHsKICAgICAgICAgICAgICAgICAgdmFyIHB0ciA9IGVudmlyb25fYnVmICsgYnVmU2l6ZTsKICAgICAgICAgICAgICAgICAgSEVBUFUzMltfX2Vudmlyb24gKyBpICogNCA+PiAyXSA9IHB0cjsKICAgICAgICAgICAgICAgICAgc3RyaW5nVG9Bc2NpaShzdHJpbmcsIHB0cik7CiAgICAgICAgICAgICAgICAgIGJ1ZlNpemUgKz0gc3RyaW5nLmxlbmd0aCArIDEKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9lbnZpcm9uX3NpemVzX2dldChwZW52aXJvbl9jb3VudCwgcGVudmlyb25fYnVmX3NpemUpIHsKICAgICAgICAgICAgICB2YXIgc3RyaW5ncyA9IGdldEVudlN0cmluZ3MoKTsKICAgICAgICAgICAgICBIRUFQVTMyW3BlbnZpcm9uX2NvdW50ID4+IDJdID0gc3RyaW5ncy5sZW5ndGg7CiAgICAgICAgICAgICAgdmFyIGJ1ZlNpemUgPSAwOwogICAgICAgICAgICAgIHN0cmluZ3MuZm9yRWFjaChmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgYnVmU2l6ZSArPSBzdHJpbmcubGVuZ3RoICsgMQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIEhFQVBVMzJbcGVudmlyb25fYnVmX3NpemUgPj4gMl0gPSBidWZTaXplOwogICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gX3Byb2NfZXhpdChjb2RlKSB7CiAgICAgICAgICAgICAgRVhJVFNUQVRVUyA9IGNvZGU7CiAgICAgICAgICAgICAgaWYgKCFrZWVwUnVudGltZUFsaXZlKCkpIHsKICAgICAgICAgICAgICAgICAgaWYgKE1vZHVsZVsib25FeGl0Il0pIE1vZHVsZVsib25FeGl0Il0oY29kZSk7CiAgICAgICAgICAgICAgICAgIEFCT1JUID0gdHJ1ZQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWl0Xyhjb2RlLCBuZXcgRXhpdFN0YXR1cyhjb2RlKSkKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBleGl0SlMoc3RhdHVzLCBpbXBsaWNpdCkgewogICAgICAgICAgICAgIEVYSVRTVEFUVVMgPSBzdGF0dXM7CiAgICAgICAgICAgICAgX3Byb2NfZXhpdChzdGF0dXMpCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgX2V4aXQgPSBleGl0SlM7CgogICAgICAgICAgZnVuY3Rpb24gX2ZkX2Nsb3NlKGZkKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IFNZU0NBTExTLmdldFN0cmVhbUZyb21GRChmZCk7CiAgICAgICAgICAgICAgICAgIEZTLmNsb3NlKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICByZXR1cm4gZS5lcnJubwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfZmRfZmRzdGF0X2dldChmZCwgcGJ1ZikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHZhciByaWdodHNCYXNlID0gMDsKICAgICAgICAgICAgICAgICAgdmFyIHJpZ2h0c0luaGVyaXRpbmcgPSAwOwogICAgICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSAwOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RyZWFtID0gU1lTQ0FMTFMuZ2V0U3RyZWFtRnJvbUZEKGZkKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gc3RyZWFtLnR0eSA/IDIgOiBGUy5pc0RpcihzdHJlYW0ubW9kZSkgPyAzIDogRlMuaXNMaW5rKHN0cmVhbS5tb2RlKSA/IDcgOiA0CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgSEVBUDhbcGJ1ZiA+PiAwXSA9IHR5cGU7CiAgICAgICAgICAgICAgICAgIEhFQVAxNltwYnVmICsgMiA+PiAxXSA9IGZsYWdzOwogICAgICAgICAgICAgICAgICB0ZW1wSTY0ID0gW3JpZ2h0c0Jhc2UgPj4+IDAsICh0ZW1wRG91YmxlID0gcmlnaHRzQmFzZSwgK01hdGguYWJzKHRlbXBEb3VibGUpID49IDEgPyB0ZW1wRG91YmxlID4gMCA/ICtNYXRoLmZsb29yKHRlbXBEb3VibGUgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IH5+K01hdGguY2VpbCgodGVtcERvdWJsZSAtICsofn50ZW1wRG91YmxlID4+PiAwKSkgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCA6IDApXSwgSEVBUDMyW3BidWYgKyA4ID4+IDJdID0gdGVtcEk2NFswXSwgSEVBUDMyW3BidWYgKyAxMiA+PiAyXSA9IHRlbXBJNjRbMV07CiAgICAgICAgICAgICAgICAgIHRlbXBJNjQgPSBbcmlnaHRzSW5oZXJpdGluZyA+Pj4gMCwgKHRlbXBEb3VibGUgPSByaWdodHNJbmhlcml0aW5nLCArTWF0aC5hYnModGVtcERvdWJsZSkgPj0gMSA/IHRlbXBEb3VibGUgPiAwID8gK01hdGguZmxvb3IodGVtcERvdWJsZSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogfn4rTWF0aC5jZWlsKCh0ZW1wRG91YmxlIC0gKyh+fnRlbXBEb3VibGUgPj4+IDApKSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogMCldLCBIRUFQMzJbcGJ1ZiArIDE2ID4+IDJdID0gdGVtcEk2NFswXSwgSEVBUDMyW3BidWYgKyAyMCA+PiAyXSA9IHRlbXBJNjRbMV07CiAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICByZXR1cm4gZS5lcnJubwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBkb1JlYWR2KHN0cmVhbSwgaW92LCBpb3ZjbnQsIG9mZnNldCkgewogICAgICAgICAgICAgIHZhciByZXQgPSAwOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW92Y250OyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIHB0ciA9IEhFQVBVMzJbaW92ID4+IDJdOwogICAgICAgICAgICAgICAgICB2YXIgbGVuID0gSEVBUFUzMltpb3YgKyA0ID4+IDJdOwogICAgICAgICAgICAgICAgICBpb3YgKz0gODsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnIgPSBGUy5yZWFkKHN0cmVhbSwgSEVBUDgsIHB0ciwgbGVuLCBvZmZzZXQpOwogICAgICAgICAgICAgICAgICBpZiAoY3VyciA8IDApIHJldHVybiAtMTsKICAgICAgICAgICAgICAgICAgcmV0ICs9IGN1cnI7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyIDwgbGVuKSBicmVhazsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvZmZzZXQgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQgKz0gY3VycgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXQKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfZmRfcmVhZChmZCwgaW92LCBpb3ZjbnQsIHBudW0pIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgc3RyZWFtID0gU1lTQ0FMTFMuZ2V0U3RyZWFtRnJvbUZEKGZkKTsKICAgICAgICAgICAgICAgICAgdmFyIG51bSA9IGRvUmVhZHYoc3RyZWFtLCBpb3YsIGlvdmNudCk7CiAgICAgICAgICAgICAgICAgIEhFQVBVMzJbcG51bSA+PiAyXSA9IG51bTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgRlMgPT0gInVuZGVmaW5lZCIgfHwgIShlLm5hbWUgPT09ICJFcnJub0Vycm9yIikpIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBlLmVycm5vCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGNvbnZlcnRJMzJQYWlyVG9JNTNDaGVja2VkKGxvLCBoaSkgewogICAgICAgICAgICAgIHJldHVybiBoaSArIDIwOTcxNTIgPj4+IDAgPCA0MTk0MzA1IC0gISFsbyA/IChsbyA+Pj4gMCkgKyBoaSAqIDQyOTQ5NjcyOTYgOiBOYU4KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfZmRfc2VlayhmZCwgb2Zmc2V0X2xvdywgb2Zmc2V0X2hpZ2gsIHdoZW5jZSwgbmV3T2Zmc2V0KSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdmFyIG9mZnNldCA9IGNvbnZlcnRJMzJQYWlyVG9JNTNDaGVja2VkKG9mZnNldF9sb3csIG9mZnNldF9oaWdoKTsKICAgICAgICAgICAgICAgICAgaWYgKGlzTmFOKG9mZnNldCkpIHJldHVybiA2MTsKICAgICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IFNZU0NBTExTLmdldFN0cmVhbUZyb21GRChmZCk7CiAgICAgICAgICAgICAgICAgIEZTLmxsc2VlayhzdHJlYW0sIG9mZnNldCwgd2hlbmNlKTsKICAgICAgICAgICAgICAgICAgdGVtcEk2NCA9IFtzdHJlYW0ucG9zaXRpb24gPj4+IDAsICh0ZW1wRG91YmxlID0gc3RyZWFtLnBvc2l0aW9uLCArTWF0aC5hYnModGVtcERvdWJsZSkgPj0gMSA/IHRlbXBEb3VibGUgPiAwID8gK01hdGguZmxvb3IodGVtcERvdWJsZSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogfn4rTWF0aC5jZWlsKCh0ZW1wRG91YmxlIC0gKyh+fnRlbXBEb3VibGUgPj4+IDApKSAvIDQyOTQ5NjcyOTYpID4+PiAwIDogMCldLCBIRUFQMzJbbmV3T2Zmc2V0ID4+IDJdID0gdGVtcEk2NFswXSwgSEVBUDMyW25ld09mZnNldCArIDQgPj4gMl0gPSB0ZW1wSTY0WzFdOwogICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtLmdldGRlbnRzICYmIG9mZnNldCA9PT0gMCAmJiB3aGVuY2UgPT09IDApIHN0cmVhbS5nZXRkZW50cyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIEZTID09ICJ1bmRlZmluZWQiIHx8ICEoZS5uYW1lID09PSAiRXJybm9FcnJvciIpKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICByZXR1cm4gZS5lcnJubwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBkb1dyaXRldihzdHJlYW0sIGlvdiwgaW92Y250LCBvZmZzZXQpIHsKICAgICAgICAgICAgICB2YXIgcmV0ID0gMDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlvdmNudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwdHIgPSBIRUFQVTMyW2lvdiA+PiAyXTsKICAgICAgICAgICAgICAgICAgdmFyIGxlbiA9IEhFQVBVMzJbaW92ICsgNCA+PiAyXTsKICAgICAgICAgICAgICAgICAgaW92ICs9IDg7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyID0gRlMud3JpdGUoc3RyZWFtLCBIRUFQOCwgcHRyLCBsZW4sIG9mZnNldCk7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyIDwgMCkgcmV0dXJuIC0xOwogICAgICAgICAgICAgICAgICByZXQgKz0gY3VycjsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvZmZzZXQgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQgKz0gY3VycgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXQKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBfZmRfd3JpdGUoZmQsIGlvdiwgaW92Y250LCBwbnVtKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IFNZU0NBTExTLmdldFN0cmVhbUZyb21GRChmZCk7CiAgICAgICAgICAgICAgICAgIHZhciBudW0gPSBkb1dyaXRldihzdHJlYW0sIGlvdiwgaW92Y250KTsKICAgICAgICAgICAgICAgICAgSEVBUFUzMltwbnVtID4+IDJdID0gbnVtOwogICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGUyA9PSAidW5kZWZpbmVkIiB8fCAhKGUubmFtZSA9PT0gIkVycm5vRXJyb3IiKSkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGUuZXJybm8KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gYXJyYXlTdW0oYXJyYXksIGluZGV4KSB7CiAgICAgICAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gaW5kZXg7IHN1bSArPSBhcnJheVtpKytdKSB7fQogICAgICAgICAgICAgIHJldHVybiBzdW0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBNT05USF9EQVlTX0xFQVAgPSBbMzEsIDI5LCAzMSwgMzAsIDMxLCAzMCwgMzEsIDMxLCAzMCwgMzEsIDMwLCAzMV07CiAgICAgICAgICB2YXIgTU9OVEhfREFZU19SRUdVTEFSID0gWzMxLCAyOCwgMzEsIDMwLCAzMSwgMzAsIDMxLCAzMSwgMzAsIDMxLCAzMCwgMzFdOwoKICAgICAgICAgIGZ1bmN0aW9uIGFkZERheXMoZGF0ZSwgZGF5cykgewogICAgICAgICAgICAgIHZhciBuZXdEYXRlID0gbmV3IERhdGUoZGF0ZS5nZXRUaW1lKCkpOwogICAgICAgICAgICAgIHdoaWxlIChkYXlzID4gMCkgewogICAgICAgICAgICAgICAgICB2YXIgbGVhcCA9IGlzTGVhcFllYXIobmV3RGF0ZS5nZXRGdWxsWWVhcigpKTsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRNb250aCA9IG5ld0RhdGUuZ2V0TW9udGgoKTsKICAgICAgICAgICAgICAgICAgdmFyIGRheXNJbkN1cnJlbnRNb250aCA9IChsZWFwID8gTU9OVEhfREFZU19MRUFQIDogTU9OVEhfREFZU19SRUdVTEFSKVtjdXJyZW50TW9udGhdOwogICAgICAgICAgICAgICAgICBpZiAoZGF5cyA+IGRheXNJbkN1cnJlbnRNb250aCAtIG5ld0RhdGUuZ2V0RGF0ZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXlzIC09IGRheXNJbkN1cnJlbnRNb250aCAtIG5ld0RhdGUuZ2V0RGF0ZSgpICsgMTsKICAgICAgICAgICAgICAgICAgICAgIG5ld0RhdGUuc2V0RGF0ZSgxKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50TW9udGggPCAxMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0RhdGUuc2V0TW9udGgoY3VycmVudE1vbnRoICsgMSkKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGF0ZS5zZXRNb250aCgwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdEYXRlLnNldEZ1bGxZZWFyKG5ld0RhdGUuZ2V0RnVsbFllYXIoKSArIDEpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBuZXdEYXRlLnNldERhdGUobmV3RGF0ZS5nZXREYXRlKCkgKyBkYXlzKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXdEYXRlCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG5ld0RhdGUKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiB3cml0ZUFycmF5VG9NZW1vcnkoYXJyYXksIGJ1ZmZlcikgewogICAgICAgICAgICAgIEhFQVA4LnNldChhcnJheSwgYnVmZmVyKQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIF9zdHJmdGltZShzLCBtYXhzaXplLCBmb3JtYXQsIHRtKSB7CiAgICAgICAgICAgICAgdmFyIHRtX3pvbmUgPSBIRUFQMzJbdG0gKyA0MCA+PiAyXTsKICAgICAgICAgICAgICB2YXIgZGF0ZSA9IHsKICAgICAgICAgICAgICAgICAgdG1fc2VjOiBIRUFQMzJbdG0gPj4gMl0sCiAgICAgICAgICAgICAgICAgIHRtX21pbjogSEVBUDMyW3RtICsgNCA+PiAyXSwKICAgICAgICAgICAgICAgICAgdG1faG91cjogSEVBUDMyW3RtICsgOCA+PiAyXSwKICAgICAgICAgICAgICAgICAgdG1fbWRheTogSEVBUDMyW3RtICsgMTIgPj4gMl0sCiAgICAgICAgICAgICAgICAgIHRtX21vbjogSEVBUDMyW3RtICsgMTYgPj4gMl0sCiAgICAgICAgICAgICAgICAgIHRtX3llYXI6IEhFQVAzMlt0bSArIDIwID4+IDJdLAogICAgICAgICAgICAgICAgICB0bV93ZGF5OiBIRUFQMzJbdG0gKyAyNCA+PiAyXSwKICAgICAgICAgICAgICAgICAgdG1feWRheTogSEVBUDMyW3RtICsgMjggPj4gMl0sCiAgICAgICAgICAgICAgICAgIHRtX2lzZHN0OiBIRUFQMzJbdG0gKyAzMiA+PiAyXSwKICAgICAgICAgICAgICAgICAgdG1fZ210b2ZmOiBIRUFQMzJbdG0gKyAzNiA+PiAyXSwKICAgICAgICAgICAgICAgICAgdG1fem9uZTogdG1fem9uZSA/IFVURjhUb1N0cmluZyh0bV96b25lKSA6ICIiCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB2YXIgcGF0dGVybiA9IFVURjhUb1N0cmluZyhmb3JtYXQpOwogICAgICAgICAgICAgIHZhciBFWFBBTlNJT05fUlVMRVNfMSA9IHsKICAgICAgICAgICAgICAgICAgIiVjIjogIiVhICViICVkICVIOiVNOiVTICVZIiwKICAgICAgICAgICAgICAgICAgIiVEIjogIiVtLyVkLyV5IiwKICAgICAgICAgICAgICAgICAgIiVGIjogIiVZLSVtLSVkIiwKICAgICAgICAgICAgICAgICAgIiVoIjogIiViIiwKICAgICAgICAgICAgICAgICAgIiVyIjogIiVJOiVNOiVTICVwIiwKICAgICAgICAgICAgICAgICAgIiVSIjogIiVIOiVNIiwKICAgICAgICAgICAgICAgICAgIiVUIjogIiVIOiVNOiVTIiwKICAgICAgICAgICAgICAgICAgIiV4IjogIiVtLyVkLyV5IiwKICAgICAgICAgICAgICAgICAgIiVYIjogIiVIOiVNOiVTIiwKICAgICAgICAgICAgICAgICAgIiVFYyI6ICIlYyIsCiAgICAgICAgICAgICAgICAgICIlRUMiOiAiJUMiLAogICAgICAgICAgICAgICAgICAiJUV4IjogIiVtLyVkLyV5IiwKICAgICAgICAgICAgICAgICAgIiVFWCI6ICIlSDolTTolUyIsCiAgICAgICAgICAgICAgICAgICIlRXkiOiAiJXkiLAogICAgICAgICAgICAgICAgICAiJUVZIjogIiVZIiwKICAgICAgICAgICAgICAgICAgIiVPZCI6ICIlZCIsCiAgICAgICAgICAgICAgICAgICIlT2UiOiAiJWUiLAogICAgICAgICAgICAgICAgICAiJU9IIjogIiVIIiwKICAgICAgICAgICAgICAgICAgIiVPSSI6ICIlSSIsCiAgICAgICAgICAgICAgICAgICIlT20iOiAiJW0iLAogICAgICAgICAgICAgICAgICAiJU9NIjogIiVNIiwKICAgICAgICAgICAgICAgICAgIiVPUyI6ICIlUyIsCiAgICAgICAgICAgICAgICAgICIlT3UiOiAiJXUiLAogICAgICAgICAgICAgICAgICAiJU9VIjogIiVVIiwKICAgICAgICAgICAgICAgICAgIiVPViI6ICIlViIsCiAgICAgICAgICAgICAgICAgICIlT3ciOiAiJXciLAogICAgICAgICAgICAgICAgICAiJU9XIjogIiVXIiwKICAgICAgICAgICAgICAgICAgIiVPeSI6ICIleSIKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGZvciAodmFyIHJ1bGUgaW4gRVhQQU5TSU9OX1JVTEVTXzEpIHsKICAgICAgICAgICAgICAgICAgcGF0dGVybiA9IHBhdHRlcm4ucmVwbGFjZShuZXcgUmVnRXhwKHJ1bGUsICJnIiksIEVYUEFOU0lPTl9SVUxFU18xW3J1bGVdKQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgV0VFS0RBWVMgPSBbIlN1bmRheSIsICJNb25kYXkiLCAiVHVlc2RheSIsICJXZWRuZXNkYXkiLCAiVGh1cnNkYXkiLCAiRnJpZGF5IiwgIlNhdHVyZGF5Il07CiAgICAgICAgICAgICAgdmFyIE1PTlRIUyA9IFsiSmFudWFyeSIsICJGZWJydWFyeSIsICJNYXJjaCIsICJBcHJpbCIsICJNYXkiLCAiSnVuZSIsICJKdWx5IiwgIkF1Z3VzdCIsICJTZXB0ZW1iZXIiLCAiT2N0b2JlciIsICJOb3ZlbWJlciIsICJEZWNlbWJlciJdOwoKICAgICAgICAgICAgICBmdW5jdGlvbiBsZWFkaW5nU29tZXRoaW5nKHZhbHVlLCBkaWdpdHMsIGNoYXJhY3RlcikgewogICAgICAgICAgICAgICAgICB2YXIgc3RyID0gdHlwZW9mIHZhbHVlID09ICJudW1iZXIiID8gdmFsdWUudG9TdHJpbmcoKSA6IHZhbHVlIHx8ICIiOwogICAgICAgICAgICAgICAgICB3aGlsZSAoc3RyLmxlbmd0aCA8IGRpZ2l0cykgewogICAgICAgICAgICAgICAgICAgICAgc3RyID0gY2hhcmFjdGVyWzBdICsgc3RyCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0cgogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZnVuY3Rpb24gbGVhZGluZ051bGxzKHZhbHVlLCBkaWdpdHMpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlYWRpbmdTb21ldGhpbmcodmFsdWUsIGRpZ2l0cywgIjAiKQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZnVuY3Rpb24gY29tcGFyZUJ5RGF5KGRhdGUxLCBkYXRlMikgewogICAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZ24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA8IDAgPyAtMSA6IHZhbHVlID4gMCA/IDEgOiAwCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIGNvbXBhcmU7CiAgICAgICAgICAgICAgICAgIGlmICgoY29tcGFyZSA9IHNnbihkYXRlMS5nZXRGdWxsWWVhcigpIC0gZGF0ZTIuZ2V0RnVsbFllYXIoKSkpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoKGNvbXBhcmUgPSBzZ24oZGF0ZTEuZ2V0TW9udGgoKSAtIGRhdGUyLmdldE1vbnRoKCkpKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBhcmUgPSBzZ24oZGF0ZTEuZ2V0RGF0ZSgpIC0gZGF0ZTIuZ2V0RGF0ZSgpKQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb21wYXJlCiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRGaXJzdFdlZWtTdGFydERhdGUoamFuRm91cnRoKSB7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAoamFuRm91cnRoLmdldERheSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGphbkZvdXJ0aC5nZXRGdWxsWWVhcigpIC0gMSwgMTEsIDI5KTsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gamFuRm91cnRoOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShqYW5Gb3VydGguZ2V0RnVsbFllYXIoKSwgMCwgMyk7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGphbkZvdXJ0aC5nZXRGdWxsWWVhcigpLCAwLCAyKTsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoamFuRm91cnRoLmdldEZ1bGxZZWFyKCksIDAsIDEpOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShqYW5Gb3VydGguZ2V0RnVsbFllYXIoKSAtIDEsIDExLCAzMSk7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGphbkZvdXJ0aC5nZXRGdWxsWWVhcigpIC0gMSwgMTEsIDMwKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRXZWVrQmFzZWRZZWFyKGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIHRoaXNEYXRlID0gYWRkRGF5cyhuZXcgRGF0ZShkYXRlLnRtX3llYXIgKyAxOTAwLCAwLCAxKSwgZGF0ZS50bV95ZGF5KTsKICAgICAgICAgICAgICAgICAgdmFyIGphbkZvdXJ0aFRoaXNZZWFyID0gbmV3IERhdGUodGhpc0RhdGUuZ2V0RnVsbFllYXIoKSwgMCwgNCk7CiAgICAgICAgICAgICAgICAgIHZhciBqYW5Gb3VydGhOZXh0WWVhciA9IG5ldyBEYXRlKHRoaXNEYXRlLmdldEZ1bGxZZWFyKCkgKyAxLCAwLCA0KTsKICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0V2Vla1N0YXJ0VGhpc1llYXIgPSBnZXRGaXJzdFdlZWtTdGFydERhdGUoamFuRm91cnRoVGhpc1llYXIpOwogICAgICAgICAgICAgICAgICB2YXIgZmlyc3RXZWVrU3RhcnROZXh0WWVhciA9IGdldEZpcnN0V2Vla1N0YXJ0RGF0ZShqYW5Gb3VydGhOZXh0WWVhcik7CiAgICAgICAgICAgICAgICAgIGlmIChjb21wYXJlQnlEYXkoZmlyc3RXZWVrU3RhcnRUaGlzWWVhciwgdGhpc0RhdGUpIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wYXJlQnlEYXkoZmlyc3RXZWVrU3RhcnROZXh0WWVhciwgdGhpc0RhdGUpIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc0RhdGUuZ2V0RnVsbFllYXIoKSArIDEKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzRGF0ZS5nZXRGdWxsWWVhcigpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNEYXRlLmdldEZ1bGxZZWFyKCkgLSAxCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBFWFBBTlNJT05fUlVMRVNfMiA9IHsKICAgICAgICAgICAgICAgICAgIiVhIjogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFdFRUtEQVlTW2RhdGUudG1fd2RheV0uc3Vic3RyaW5nKDAsIDMpCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICIlQSI6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBXRUVLREFZU1tkYXRlLnRtX3dkYXldCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICIlYiI6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBNT05USFNbZGF0ZS50bV9tb25dLnN1YnN0cmluZygwLCAzKQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJUIiOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gTU9OVEhTW2RhdGUudG1fbW9uXQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJUMiOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgeWVhciA9IGRhdGUudG1feWVhciArIDE5MDA7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVhZGluZ051bGxzKHllYXIgLyAxMDAgfCAwLCAyKQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJWQiOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVhZGluZ051bGxzKGRhdGUudG1fbWRheSwgMikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiVlIjogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlYWRpbmdTb21ldGhpbmcoZGF0ZS50bV9tZGF5LCAyLCAiICIpCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICIlZyI6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRXZWVrQmFzZWRZZWFyKGRhdGUpLnRvU3RyaW5nKCkuc3Vic3RyaW5nKDIpCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICIlRyI6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRXZWVrQmFzZWRZZWFyKGRhdGUpCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICIlSCI6IGZ1bmN0aW9uKGRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWFkaW5nTnVsbHMoZGF0ZS50bV9ob3VyLCAyKQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJUkiOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgdHdlbHZlSG91ciA9IGRhdGUudG1faG91cjsKICAgICAgICAgICAgICAgICAgICAgIGlmICh0d2VsdmVIb3VyID09IDApIHR3ZWx2ZUhvdXIgPSAxMjsKICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHR3ZWx2ZUhvdXIgPiAxMikgdHdlbHZlSG91ciAtPSAxMjsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWFkaW5nTnVsbHModHdlbHZlSG91ciwgMikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiVqIjogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlYWRpbmdOdWxscyhkYXRlLnRtX21kYXkgKyBhcnJheVN1bShpc0xlYXBZZWFyKGRhdGUudG1feWVhciArIDE5MDApID8gTU9OVEhfREFZU19MRUFQIDogTU9OVEhfREFZU19SRUdVTEFSLCBkYXRlLnRtX21vbiAtIDEpLCAzKQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJW0iOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVhZGluZ051bGxzKGRhdGUudG1fbW9uICsgMSwgMikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiVNIjogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlYWRpbmdOdWxscyhkYXRlLnRtX21pbiwgMikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiVuIjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIlxuIgogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJXAiOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0ZS50bV9ob3VyID49IDAgJiYgZGF0ZS50bV9ob3VyIDwgMTIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIkFNIgogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJQTSIKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiVTIjogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlYWRpbmdOdWxscyhkYXRlLnRtX3NlYywgMikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiV0IjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIlx0IgogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJXUiOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZS50bV93ZGF5IHx8IDcKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiVVIjogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGRheXMgPSBkYXRlLnRtX3lkYXkgKyA3IC0gZGF0ZS50bV93ZGF5OwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlYWRpbmdOdWxscyhNYXRoLmZsb29yKGRheXMgLyA3KSwgMikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiVWIjogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IE1hdGguZmxvb3IoKGRhdGUudG1feWRheSArIDcgLSAoZGF0ZS50bV93ZGF5ICsgNikgJSA3KSAvIDcpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKChkYXRlLnRtX3dkYXkgKyAzNzEgLSBkYXRlLnRtX3lkYXkgLSAyKSAlIDcgPD0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCsrCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IDUyOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZWMzMSA9IChkYXRlLnRtX3dkYXkgKyA3IC0gZGF0ZS50bV95ZGF5IC0gMSkgJSA3OwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWMzMSA9PSA0IHx8IGRlYzMxID09IDUgJiYgaXNMZWFwWWVhcihkYXRlLnRtX3llYXIgJSA0MDAgLSAxKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwrKwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsID09IDUzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGphbjEgPSAoZGF0ZS50bV93ZGF5ICsgMzcxIC0gZGF0ZS50bV95ZGF5KSAlIDc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGphbjEgIT0gNCAmJiAoamFuMSAhPSAzIHx8ICFpc0xlYXBZZWFyKGRhdGUudG1feWVhcikpKSB2YWwgPSAxCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGVhZGluZ051bGxzKHZhbCwgMikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiV3IjogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUudG1fd2RheQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJVciOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF5cyA9IGRhdGUudG1feWRheSArIDcgLSAoZGF0ZS50bV93ZGF5ICsgNikgJSA3OwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlYWRpbmdOdWxscyhNYXRoLmZsb29yKGRheXMgLyA3KSwgMikKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgIiV5IjogZnVuY3Rpb24oZGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChkYXRlLnRtX3llYXIgKyAxOTAwKS50b1N0cmluZygpLnN1YnN0cmluZygyKQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJVkiOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZS50bV95ZWFyICsgMTkwMAogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJXoiOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgb2ZmID0gZGF0ZS50bV9nbXRvZmY7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYWhlYWQgPSBvZmYgPj0gMDsKICAgICAgICAgICAgICAgICAgICAgIG9mZiA9IE1hdGguYWJzKG9mZikgLyA2MDsKICAgICAgICAgICAgICAgICAgICAgIG9mZiA9IG9mZiAvIDYwICogMTAwICsgb2ZmICUgNjA7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGFoZWFkID8gIisiIDogIi0iKSArIFN0cmluZygiMDAwMCIgKyBvZmYpLnNsaWNlKC00KQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAiJVoiOiBmdW5jdGlvbihkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZS50bV96b25lCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICIlJSI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIlIgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBwYXR0ZXJuID0gcGF0dGVybi5yZXBsYWNlKC8lJS9nLCAiXDBcMCIpOwogICAgICAgICAgICAgIGZvciAodmFyIHJ1bGUgaW4gRVhQQU5TSU9OX1JVTEVTXzIpIHsKICAgICAgICAgICAgICAgICAgaWYgKHBhdHRlcm4uaW5jbHVkZXMocnVsZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBhdHRlcm4gPSBwYXR0ZXJuLnJlcGxhY2UobmV3IFJlZ0V4cChydWxlLCAiZyIpLCBFWFBBTlNJT05fUlVMRVNfMltydWxlXShkYXRlKSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXR0ZXJuID0gcGF0dGVybi5yZXBsYWNlKC9cMFwwL2csICIlIik7CiAgICAgICAgICAgICAgdmFyIGJ5dGVzID0gaW50QXJyYXlGcm9tU3RyaW5nKHBhdHRlcm4sIGZhbHNlKTsKICAgICAgICAgICAgICBpZiAoYnl0ZXMubGVuZ3RoID4gbWF4c2l6ZSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3cml0ZUFycmF5VG9NZW1vcnkoYnl0ZXMsIHMpOwogICAgICAgICAgICAgIHJldHVybiBieXRlcy5sZW5ndGggLSAxCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gcnVuQW5kQWJvcnRJZkVycm9yKGZ1bmMpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuYygpCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBhYm9ydChlKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVFeGNlcHRpb24oZSkgewogICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgRXhpdFN0YXR1cyB8fCBlID09ICJ1bndpbmQiKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBFWElUU1RBVFVTCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHF1aXRfKDEsIGUpCiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gbWF5YmVFeGl0KCkgewogICAgICAgICAgICAgIGlmICgha2VlcFJ1bnRpbWVBbGl2ZSgpKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpdChFWElUU1RBVFVTKQogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVFeGNlcHRpb24oZSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBjYWxsVXNlckNhbGxiYWNrKGZ1bmMpIHsKICAgICAgICAgICAgICBpZiAoQUJPUlQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGZ1bmMoKTsKICAgICAgICAgICAgICAgICAgbWF5YmVFeGl0KCkKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGhhbmRsZUV4Y2VwdGlvbihlKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBBc3luY2lmeSA9IHsKICAgICAgICAgICAgICBpbnN0cnVtZW50V2FzbUltcG9ydHM6IGZ1bmN0aW9uKGltcG9ydHMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGltcG9ydFBhdHRlcm5zID0gWy9eaW52b2tlXy4qJC8sIC9eZmRfc3luYyQvLCAvXl9fd2FzaV9mZF9zeW5jJC8sIC9eX19hc3luY2pzX18uKiQvLCAvXmVtc2NyaXB0ZW5faWRiX2xvYWQkLywgL15lbXNjcmlwdGVuX2lkYl9zdG9yZSQvLCAvXmVtc2NyaXB0ZW5faWRiX2RlbGV0ZSQvLCAvXmVtc2NyaXB0ZW5faWRiX2V4aXN0cyQvLCAvXmVtc2NyaXB0ZW5faWRiX2xvYWRfYmxvYiQvLCAvXmVtc2NyaXB0ZW5faWRiX3N0b3JlX2Jsb2IkLywgL15lbXNjcmlwdGVuX3NsZWVwJC8sIC9eZW1zY3JpcHRlbl93Z2V0JC8sIC9eZW1zY3JpcHRlbl93Z2V0X2RhdGEkLywgL15lbXNjcmlwdGVuX3NjYW5fcmVnaXN0ZXJzJC8sIC9eZW1zY3JpcHRlbl9sYXp5X2xvYWRfY29kZSQvLCAvXl9sb2FkX3NlY29uZGFyeV9tb2R1bGUkLywgL15lbXNjcmlwdGVuX2ZpYmVyX3N3YXAkLywgL15TRExfRGVsYXkkL107CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIHggaW4gaW1wb3J0cykgewogICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWwgPSBpbXBvcnRzW3hdOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaWcgPSBvcmlnaW5hbC5zaWc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcmlnaW5hbCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpc0FzeW5jaWZ5SW1wb3J0ID0gb3JpZ2luYWwuaXNBc3luYyB8fCBpbXBvcnRQYXR0ZXJucy5zb21lKHBhdHRlcm4gPT4gISF4Lm1hdGNoKHBhdHRlcm4pKQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0pKHgpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGluc3RydW1lbnRXYXNtRXhwb3J0czogZnVuY3Rpb24oZXhwb3J0cykgewogICAgICAgICAgICAgICAgICB2YXIgcmV0ID0ge307CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIHggaW4gZXhwb3J0cykgewogICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uKHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWwgPSBleHBvcnRzW3hdOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3JpZ2luYWwgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRbeF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFzeW5jaWZ5LmV4cG9ydENhbGxTdGFjay5wdXNoKHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFCT1JUKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB5ID0gQXN5bmNpZnkuZXhwb3J0Q2FsbFN0YWNrLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnQoeSA9PT0geCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFzeW5jaWZ5Lm1heWJlU3RvcFVud2luZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0W3hdID0gb3JpZ2luYWwKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9KSh4KQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXQKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIFN0YXRlOiB7CiAgICAgICAgICAgICAgICAgIE5vcm1hbDogMCwKICAgICAgICAgICAgICAgICAgVW53aW5kaW5nOiAxLAogICAgICAgICAgICAgICAgICBSZXdpbmRpbmc6IDIsCiAgICAgICAgICAgICAgICAgIERpc2FibGVkOiAzCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzdGF0ZTogMCwKICAgICAgICAgICAgICBTdGFja1NpemU6IDQwOTYsCiAgICAgICAgICAgICAgY3VyckRhdGE6IG51bGwsCiAgICAgICAgICAgICAgaGFuZGxlU2xlZXBSZXR1cm5WYWx1ZTogMCwKICAgICAgICAgICAgICBleHBvcnRDYWxsU3RhY2s6IFtdLAogICAgICAgICAgICAgIGNhbGxTdGFja05hbWVUb0lkOiB7fSwKICAgICAgICAgICAgICBjYWxsU3RhY2tJZFRvTmFtZToge30sCiAgICAgICAgICAgICAgY2FsbFN0YWNrSWQ6IDAsCiAgICAgICAgICAgICAgYXN5bmNQcm9taXNlSGFuZGxlcnM6IG51bGwsCiAgICAgICAgICAgICAgc2xlZXBDYWxsYmFja3M6IFtdLAogICAgICAgICAgICAgIGdldENhbGxTdGFja0lkOiBmdW5jdGlvbihmdW5jTmFtZSkgewogICAgICAgICAgICAgICAgICB2YXIgaWQgPSBBc3luY2lmeS5jYWxsU3RhY2tOYW1lVG9JZFtmdW5jTmFtZV07CiAgICAgICAgICAgICAgICAgIGlmIChpZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZCA9IEFzeW5jaWZ5LmNhbGxTdGFja0lkKys7CiAgICAgICAgICAgICAgICAgICAgICBBc3luY2lmeS5jYWxsU3RhY2tOYW1lVG9JZFtmdW5jTmFtZV0gPSBpZDsKICAgICAgICAgICAgICAgICAgICAgIEFzeW5jaWZ5LmNhbGxTdGFja0lkVG9OYW1lW2lkXSA9IGZ1bmNOYW1lCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGlkCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBtYXliZVN0b3BVbndpbmQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoQXN5bmNpZnkuY3VyckRhdGEgJiYgQXN5bmNpZnkuc3RhdGUgPT09IEFzeW5jaWZ5LlN0YXRlLlVud2luZGluZyAmJiBBc3luY2lmeS5leHBvcnRDYWxsU3RhY2subGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBBc3luY2lmeS5zdGF0ZSA9IEFzeW5jaWZ5LlN0YXRlLk5vcm1hbDsKICAgICAgICAgICAgICAgICAgICAgIHJ1bkFuZEFib3J0SWZFcnJvcihfYXN5bmNpZnlfc3RvcF91bndpbmQpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGaWJlcnMgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBGaWJlcnMudHJhbXBvbGluZSgpCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHdoZW5Eb25lOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIEFzeW5jaWZ5LmFzeW5jUHJvbWlzZUhhbmRsZXJzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmU6IHJlc29sdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0OiByZWplY3QKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGFsbG9jYXRlRGF0YTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwdHIgPSBfbWFsbG9jKDEyICsgQXN5bmNpZnkuU3RhY2tTaXplKTsKICAgICAgICAgICAgICAgICAgQXN5bmNpZnkuc2V0RGF0YUhlYWRlcihwdHIsIHB0ciArIDEyLCBBc3luY2lmeS5TdGFja1NpemUpOwogICAgICAgICAgICAgICAgICBBc3luY2lmeS5zZXREYXRhUmV3aW5kRnVuYyhwdHIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gcHRyCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzZXREYXRhSGVhZGVyOiBmdW5jdGlvbihwdHIsIHN0YWNrLCBzdGFja1NpemUpIHsKICAgICAgICAgICAgICAgICAgSEVBUDMyW3B0ciA+PiAyXSA9IHN0YWNrOwogICAgICAgICAgICAgICAgICBIRUFQMzJbcHRyICsgNCA+PiAyXSA9IHN0YWNrICsgc3RhY2tTaXplCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzZXREYXRhUmV3aW5kRnVuYzogZnVuY3Rpb24ocHRyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBib3R0b21PZkNhbGxTdGFjayA9IEFzeW5jaWZ5LmV4cG9ydENhbGxTdGFja1swXTsKICAgICAgICAgICAgICAgICAgdmFyIHJld2luZElkID0gQXN5bmNpZnkuZ2V0Q2FsbFN0YWNrSWQoYm90dG9tT2ZDYWxsU3RhY2spOwogICAgICAgICAgICAgICAgICBIRUFQMzJbcHRyICsgOCA+PiAyXSA9IHJld2luZElkCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBnZXREYXRhUmV3aW5kRnVuYzogZnVuY3Rpb24ocHRyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpZCA9IEhFQVAzMltwdHIgKyA4ID4+IDJdOwogICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IEFzeW5jaWZ5LmNhbGxTdGFja0lkVG9OYW1lW2lkXTsKICAgICAgICAgICAgICAgICAgdmFyIGZ1bmMgPSBNb2R1bGVbImFzbSJdW25hbWVdOwogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuYwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZG9SZXdpbmQ6IGZ1bmN0aW9uKHB0cikgewogICAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBBc3luY2lmeS5nZXREYXRhUmV3aW5kRnVuYyhwdHIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gc3RhcnQoKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgaGFuZGxlU2xlZXA6IGZ1bmN0aW9uKHN0YXJ0QXN5bmMpIHsKICAgICAgICAgICAgICAgICAgaWYgKEFCT1JUKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIGlmIChBc3luY2lmeS5zdGF0ZSA9PT0gQXN5bmNpZnkuU3RhdGUuTm9ybWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVhY2hlZENhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVhY2hlZEFmdGVyQ2FsbGJhY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0QXN5bmMoKGhhbmRsZVNsZWVwUmV0dXJuVmFsdWUgPSAwKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFCT1JUKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgQXN5bmNpZnkuaGFuZGxlU2xlZXBSZXR1cm5WYWx1ZSA9IGhhbmRsZVNsZWVwUmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhY2hlZENhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlYWNoZWRBZnRlckNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBBc3luY2lmeS5zdGF0ZSA9IEFzeW5jaWZ5LlN0YXRlLlJld2luZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgICBydW5BbmRBYm9ydElmRXJyb3IoKCkgPT4gX2FzeW5jaWZ5X3N0YXJ0X3Jld2luZChBc3luY2lmeS5jdXJyRGF0YSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgQnJvd3NlciAhPSAidW5kZWZpbmVkIiAmJiBCcm93c2VyLm1haW5Mb29wLmZ1bmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQnJvd3Nlci5tYWluTG9vcC5yZXN1bWUoKQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXN5bmNXYXNtUmV0dXJuVmFsdWUsIGlzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1dhc21SZXR1cm5WYWx1ZSA9IEFzeW5jaWZ5LmRvUmV3aW5kKEFzeW5jaWZ5LmN1cnJEYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luY1dhc21SZXR1cm5WYWx1ZSA9IGVycjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNFcnJvciA9IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhhbmRsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUFzeW5jaWZ5LmN1cnJEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhc3luY1Byb21pc2VIYW5kbGVycyA9IEFzeW5jaWZ5LmFzeW5jUHJvbWlzZUhhbmRsZXJzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXN5bmNQcm9taXNlSGFuZGxlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFzeW5jaWZ5LmFzeW5jUHJvbWlzZUhhbmRsZXJzID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChpc0Vycm9yID8gYXN5bmNQcm9taXNlSGFuZGxlcnMucmVqZWN0IDogYXN5bmNQcm9taXNlSGFuZGxlcnMucmVzb2x2ZSkoYXN5bmNXYXNtUmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlZCA9IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNFcnJvciAmJiAhaGFuZGxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBhc3luY1dhc21SZXR1cm5WYWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgcmVhY2hlZEFmdGVyQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZWFjaGVkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBBc3luY2lmeS5zdGF0ZSA9IEFzeW5jaWZ5LlN0YXRlLlVud2luZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgICBBc3luY2lmeS5jdXJyRGF0YSA9IEFzeW5jaWZ5LmFsbG9jYXRlRGF0YSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgQnJvd3NlciAhPSAidW5kZWZpbmVkIiAmJiBCcm93c2VyLm1haW5Mb29wLmZ1bmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQnJvd3Nlci5tYWluTG9vcC5wYXVzZSgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bkFuZEFib3J0SWZFcnJvcigoKSA9PiBfYXN5bmNpZnlfc3RhcnRfdW53aW5kKEFzeW5jaWZ5LmN1cnJEYXRhKSkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBc3luY2lmeS5zdGF0ZSA9PT0gQXN5bmNpZnkuU3RhdGUuUmV3aW5kaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICBBc3luY2lmeS5zdGF0ZSA9IEFzeW5jaWZ5LlN0YXRlLk5vcm1hbDsKICAgICAgICAgICAgICAgICAgICAgIHJ1bkFuZEFib3J0SWZFcnJvcihfYXN5bmNpZnlfc3RvcF9yZXdpbmQpOwogICAgICAgICAgICAgICAgICAgICAgX2ZyZWUoQXN5bmNpZnkuY3VyckRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgQXN5bmNpZnkuY3VyckRhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgQXN5bmNpZnkuc2xlZXBDYWxsYmFja3MuZm9yRWFjaChmdW5jID0+IGNhbGxVc2VyQ2FsbGJhY2soZnVuYykpCiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBhYm9ydCgiaW52YWxpZCBzdGF0ZTogIiArIEFzeW5jaWZ5LnN0YXRlKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBBc3luY2lmeS5oYW5kbGVTbGVlcFJldHVyblZhbHVlCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBoYW5kbGVBc3luYzogZnVuY3Rpb24oc3RhcnRBc3luYykgewogICAgICAgICAgICAgICAgICByZXR1cm4gQXN5bmNpZnkuaGFuZGxlU2xlZXAod2FrZVVwID0+IHsKICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0QXN5bmMoKS50aGVuKHdha2VVcCkKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIEFMTE9DX05PUk1BTCA9IDA7CiAgICAgICAgICB2YXIgQUxMT0NfU1RBQ0sgPSAxOwoKICAgICAgICAgIGZ1bmN0aW9uIGFsbG9jYXRlKHNsYWIsIGFsbG9jYXRvcikgewogICAgICAgICAgICAgIHZhciByZXQ7CiAgICAgICAgICAgICAgaWYgKGFsbG9jYXRvciA9PSBBTExPQ19TVEFDSykgewogICAgICAgICAgICAgICAgICByZXQgPSBzdGFja0FsbG9jKHNsYWIubGVuZ3RoKQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldCA9IF9tYWxsb2Moc2xhYi5sZW5ndGgpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghc2xhYi5zdWJhcnJheSAmJiAhc2xhYi5zbGljZSkgewogICAgICAgICAgICAgICAgICBzbGFiID0gbmV3IFVpbnQ4QXJyYXkoc2xhYikKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgSEVBUFU4LnNldChzbGFiLCByZXQpOwogICAgICAgICAgICAgIHJldHVybiByZXQKICAgICAgICAgIH0KICAgICAgICAgIHZhciBGU05vZGUgPSBmdW5jdGlvbihwYXJlbnQsIG5hbWUsIG1vZGUsIHJkZXYpIHsKICAgICAgICAgICAgICBpZiAoIXBhcmVudCkgewogICAgICAgICAgICAgICAgICBwYXJlbnQgPSB0aGlzCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICAgIHRoaXMubW91bnQgPSBwYXJlbnQubW91bnQ7CiAgICAgICAgICAgICAgdGhpcy5tb3VudGVkID0gbnVsbDsKICAgICAgICAgICAgICB0aGlzLmlkID0gRlMubmV4dElub2RlKys7CiAgICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgICB0aGlzLm1vZGUgPSBtb2RlOwogICAgICAgICAgICAgIHRoaXMubm9kZV9vcHMgPSB7fTsKICAgICAgICAgICAgICB0aGlzLnN0cmVhbV9vcHMgPSB7fTsKICAgICAgICAgICAgICB0aGlzLnJkZXYgPSByZGV2CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHJlYWRNb2RlID0gMjkyIHwgNzM7CiAgICAgICAgICB2YXIgd3JpdGVNb2RlID0gMTQ2OwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRlNOb2RlLnByb3RvdHlwZSwgewogICAgICAgICAgICAgIHJlYWQ6IHsKICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5tb2RlICYgcmVhZE1vZGUpID09PSByZWFkTW9kZQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFsID8gdGhpcy5tb2RlIHw9IHJlYWRNb2RlIDogdGhpcy5tb2RlICY9IH5yZWFkTW9kZQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB3cml0ZTogewogICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLm1vZGUgJiB3cml0ZU1vZGUpID09PSB3cml0ZU1vZGUKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbCA/IHRoaXMubW9kZSB8PSB3cml0ZU1vZGUgOiB0aGlzLm1vZGUgJj0gfndyaXRlTW9kZQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBpc0ZvbGRlcjogewogICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZTLmlzRGlyKHRoaXMubW9kZSkKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgaXNEZXZpY2U6IHsKICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGUy5pc0NocmRldih0aGlzLm1vZGUpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIEZTLkZTTm9kZSA9IEZTTm9kZTsKICAgICAgICAgIEZTLmNyZWF0ZVByZWxvYWRlZEZpbGUgPSBGU19jcmVhdGVQcmVsb2FkZWRGaWxlOwogICAgICAgICAgRlMuc3RhdGljSW5pdCgpOwogICAgICAgICAgTW9kdWxlWyJGU19jcmVhdGVEYXRhRmlsZSJdID0gRlMuY3JlYXRlRGF0YUZpbGU7CiAgICAgICAgICBNb2R1bGVbIkZTX2NyZWF0ZVBhdGgiXSA9IEZTLmNyZWF0ZVBhdGg7CiAgICAgICAgICBNb2R1bGVbIkZTX2NyZWF0ZURhdGFGaWxlIl0gPSBGUy5jcmVhdGVEYXRhRmlsZTsKICAgICAgICAgIE1vZHVsZVsiRlNfY3JlYXRlUHJlbG9hZGVkRmlsZSJdID0gRlMuY3JlYXRlUHJlbG9hZGVkRmlsZTsKICAgICAgICAgIE1vZHVsZVsiRlNfdW5saW5rIl0gPSBGUy51bmxpbms7CiAgICAgICAgICBNb2R1bGVbIkZTX2NyZWF0ZUxhenlGaWxlIl0gPSBGUy5jcmVhdGVMYXp5RmlsZTsKICAgICAgICAgIE1vZHVsZVsiRlNfY3JlYXRlRGV2aWNlIl0gPSBGUy5jcmVhdGVEZXZpY2U7CiAgICAgICAgICBFUlJOT19DT0RFUyA9IHsKICAgICAgICAgICAgICAiRVBFUk0iOiA2MywKICAgICAgICAgICAgICAiRU5PRU5UIjogNDQsCiAgICAgICAgICAgICAgIkVTUkNIIjogNzEsCiAgICAgICAgICAgICAgIkVJTlRSIjogMjcsCiAgICAgICAgICAgICAgIkVJTyI6IDI5LAogICAgICAgICAgICAgICJFTlhJTyI6IDYwLAogICAgICAgICAgICAgICJFMkJJRyI6IDEsCiAgICAgICAgICAgICAgIkVOT0VYRUMiOiA0NSwKICAgICAgICAgICAgICAiRUJBREYiOiA4LAogICAgICAgICAgICAgICJFQ0hJTEQiOiAxMiwKICAgICAgICAgICAgICAiRUFHQUlOIjogNiwKICAgICAgICAgICAgICAiRVdPVUxEQkxPQ0siOiA2LAogICAgICAgICAgICAgICJFTk9NRU0iOiA0OCwKICAgICAgICAgICAgICAiRUFDQ0VTIjogMiwKICAgICAgICAgICAgICAiRUZBVUxUIjogMjEsCiAgICAgICAgICAgICAgIkVOT1RCTEsiOiAxMDUsCiAgICAgICAgICAgICAgIkVCVVNZIjogMTAsCiAgICAgICAgICAgICAgIkVFWElTVCI6IDIwLAogICAgICAgICAgICAgICJFWERFViI6IDc1LAogICAgICAgICAgICAgICJFTk9ERVYiOiA0MywKICAgICAgICAgICAgICAiRU5PVERJUiI6IDU0LAogICAgICAgICAgICAgICJFSVNESVIiOiAzMSwKICAgICAgICAgICAgICAiRUlOVkFMIjogMjgsCiAgICAgICAgICAgICAgIkVORklMRSI6IDQxLAogICAgICAgICAgICAgICJFTUZJTEUiOiAzMywKICAgICAgICAgICAgICAiRU5PVFRZIjogNTksCiAgICAgICAgICAgICAgIkVUWFRCU1kiOiA3NCwKICAgICAgICAgICAgICAiRUZCSUciOiAyMiwKICAgICAgICAgICAgICAiRU5PU1BDIjogNTEsCiAgICAgICAgICAgICAgIkVTUElQRSI6IDcwLAogICAgICAgICAgICAgICJFUk9GUyI6IDY5LAogICAgICAgICAgICAgICJFTUxJTksiOiAzNCwKICAgICAgICAgICAgICAiRVBJUEUiOiA2NCwKICAgICAgICAgICAgICAiRURPTSI6IDE4LAogICAgICAgICAgICAgICJFUkFOR0UiOiA2OCwKICAgICAgICAgICAgICAiRU5PTVNHIjogNDksCiAgICAgICAgICAgICAgIkVJRFJNIjogMjQsCiAgICAgICAgICAgICAgIkVDSFJORyI6IDEwNiwKICAgICAgICAgICAgICAiRUwyTlNZTkMiOiAxNTYsCiAgICAgICAgICAgICAgIkVMM0hMVCI6IDEwNywKICAgICAgICAgICAgICAiRUwzUlNUIjogMTA4LAogICAgICAgICAgICAgICJFTE5STkciOiAxMDksCiAgICAgICAgICAgICAgIkVVTkFUQ0giOiAxMTAsCiAgICAgICAgICAgICAgIkVOT0NTSSI6IDExMSwKICAgICAgICAgICAgICAiRUwySExUIjogMTEyLAogICAgICAgICAgICAgICJFREVBRExLIjogMTYsCiAgICAgICAgICAgICAgIkVOT0xDSyI6IDQ2LAogICAgICAgICAgICAgICJFQkFERSI6IDExMywKICAgICAgICAgICAgICAiRUJBRFIiOiAxMTQsCiAgICAgICAgICAgICAgIkVYRlVMTCI6IDExNSwKICAgICAgICAgICAgICAiRU5PQU5PIjogMTA0LAogICAgICAgICAgICAgICJFQkFEUlFDIjogMTAzLAogICAgICAgICAgICAgICJFQkFEU0xUIjogMTAyLAogICAgICAgICAgICAgICJFREVBRExPQ0siOiAxNiwKICAgICAgICAgICAgICAiRUJGT05UIjogMTAxLAogICAgICAgICAgICAgICJFTk9TVFIiOiAxMDAsCiAgICAgICAgICAgICAgIkVOT0RBVEEiOiAxMTYsCiAgICAgICAgICAgICAgIkVUSU1FIjogMTE3LAogICAgICAgICAgICAgICJFTk9TUiI6IDExOCwKICAgICAgICAgICAgICAiRU5PTkVUIjogMTE5LAogICAgICAgICAgICAgICJFTk9QS0ciOiAxMjAsCiAgICAgICAgICAgICAgIkVSRU1PVEUiOiAxMjEsCiAgICAgICAgICAgICAgIkVOT0xJTksiOiA0NywKICAgICAgICAgICAgICAiRUFEViI6IDEyMiwKICAgICAgICAgICAgICAiRVNSTU5UIjogMTIzLAogICAgICAgICAgICAgICJFQ09NTSI6IDEyNCwKICAgICAgICAgICAgICAiRVBST1RPIjogNjUsCiAgICAgICAgICAgICAgIkVNVUxUSUhPUCI6IDM2LAogICAgICAgICAgICAgICJFRE9URE9UIjogMTI1LAogICAgICAgICAgICAgICJFQkFETVNHIjogOSwKICAgICAgICAgICAgICAiRU5PVFVOSVEiOiAxMjYsCiAgICAgICAgICAgICAgIkVCQURGRCI6IDEyNywKICAgICAgICAgICAgICAiRVJFTUNIRyI6IDEyOCwKICAgICAgICAgICAgICAiRUxJQkFDQyI6IDEyOSwKICAgICAgICAgICAgICAiRUxJQkJBRCI6IDEzMCwKICAgICAgICAgICAgICAiRUxJQlNDTiI6IDEzMSwKICAgICAgICAgICAgICAiRUxJQk1BWCI6IDEzMiwKICAgICAgICAgICAgICAiRUxJQkVYRUMiOiAxMzMsCiAgICAgICAgICAgICAgIkVOT1NZUyI6IDUyLAogICAgICAgICAgICAgICJFTk9URU1QVFkiOiA1NSwKICAgICAgICAgICAgICAiRU5BTUVUT09MT05HIjogMzcsCiAgICAgICAgICAgICAgIkVMT09QIjogMzIsCiAgICAgICAgICAgICAgIkVPUE5PVFNVUFAiOiAxMzgsCiAgICAgICAgICAgICAgIkVQRk5PU1VQUE9SVCI6IDEzOSwKICAgICAgICAgICAgICAiRUNPTk5SRVNFVCI6IDE1LAogICAgICAgICAgICAgICJFTk9CVUZTIjogNDIsCiAgICAgICAgICAgICAgIkVBRk5PU1VQUE9SVCI6IDUsCiAgICAgICAgICAgICAgIkVQUk9UT1RZUEUiOiA2NywKICAgICAgICAgICAgICAiRU5PVFNPQ0siOiA1NywKICAgICAgICAgICAgICAiRU5PUFJPVE9PUFQiOiA1MCwKICAgICAgICAgICAgICAiRVNIVVRET1dOIjogMTQwLAogICAgICAgICAgICAgICJFQ09OTlJFRlVTRUQiOiAxNCwKICAgICAgICAgICAgICAiRUFERFJJTlVTRSI6IDMsCiAgICAgICAgICAgICAgIkVDT05OQUJPUlRFRCI6IDEzLAogICAgICAgICAgICAgICJFTkVUVU5SRUFDSCI6IDQwLAogICAgICAgICAgICAgICJFTkVURE9XTiI6IDM4LAogICAgICAgICAgICAgICJFVElNRURPVVQiOiA3MywKICAgICAgICAgICAgICAiRUhPU1RET1dOIjogMTQyLAogICAgICAgICAgICAgICJFSE9TVFVOUkVBQ0giOiAyMywKICAgICAgICAgICAgICAiRUlOUFJPR1JFU1MiOiAyNiwKICAgICAgICAgICAgICAiRUFMUkVBRFkiOiA3LAogICAgICAgICAgICAgICJFREVTVEFERFJSRVEiOiAxNywKICAgICAgICAgICAgICAiRU1TR1NJWkUiOiAzNSwKICAgICAgICAgICAgICAiRVBST1RPTk9TVVBQT1JUIjogNjYsCiAgICAgICAgICAgICAgIkVTT0NLVE5PU1VQUE9SVCI6IDEzNywKICAgICAgICAgICAgICAiRUFERFJOT1RBVkFJTCI6IDQsCiAgICAgICAgICAgICAgIkVORVRSRVNFVCI6IDM5LAogICAgICAgICAgICAgICJFSVNDT05OIjogMzAsCiAgICAgICAgICAgICAgIkVOT1RDT05OIjogNTMsCiAgICAgICAgICAgICAgIkVUT09NQU5ZUkVGUyI6IDE0MSwKICAgICAgICAgICAgICAiRVVTRVJTIjogMTM2LAogICAgICAgICAgICAgICJFRFFVT1QiOiAxOSwKICAgICAgICAgICAgICAiRVNUQUxFIjogNzIsCiAgICAgICAgICAgICAgIkVOT1RTVVAiOiAxMzgsCiAgICAgICAgICAgICAgIkVOT01FRElVTSI6IDE0OCwKICAgICAgICAgICAgICAiRUlMU0VRIjogMjUsCiAgICAgICAgICAgICAgIkVPVkVSRkxPVyI6IDYxLAogICAgICAgICAgICAgICJFQ0FOQ0VMRUQiOiAxMSwKICAgICAgICAgICAgICAiRU5PVFJFQ09WRVJBQkxFIjogNTYsCiAgICAgICAgICAgICAgIkVPV05FUkRFQUQiOiA2MiwKICAgICAgICAgICAgICAiRVNUUlBJUEUiOiAxMzUKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FzbUltcG9ydHMgPSB7CiAgICAgICAgICAgICAgIkMiOiBfX2FzeW5janNfX3dhaXRGb3JSZWFkUmVzdWx0QXN5bmMsCiAgICAgICAgICAgICAgIm0iOiBfX19jeGFfdGhyb3csCiAgICAgICAgICAgICAgIkQiOiBfX19zeXNjYWxsX19uZXdzZWxlY3QsCiAgICAgICAgICAgICAgIlMiOiBfX19zeXNjYWxsX2ZhY2Nlc3NhdCwKICAgICAgICAgICAgICAicCI6IF9fX3N5c2NhbGxfZmNudGw2NCwKICAgICAgICAgICAgICAiUCI6IF9fX3N5c2NhbGxfZnN0YXQ2NCwKICAgICAgICAgICAgICAiRiI6IF9fX3N5c2NhbGxfZ2V0ZGVudHM2NCwKICAgICAgICAgICAgICAidSI6IF9fX3N5c2NhbGxfaW9jdGwsCiAgICAgICAgICAgICAgIk0iOiBfX19zeXNjYWxsX2xzdGF0NjQsCiAgICAgICAgICAgICAgIk4iOiBfX19zeXNjYWxsX25ld2ZzdGF0YXQsCiAgICAgICAgICAgICAgInMiOiBfX19zeXNjYWxsX29wZW5hdCwKICAgICAgICAgICAgICAiRSI6IF9fX3N5c2NhbGxfcmVuYW1lYXQsCiAgICAgICAgICAgICAgInEiOiBfX19zeXNjYWxsX3JtZGlyLAogICAgICAgICAgICAgICJPIjogX19fc3lzY2FsbF9zdGF0NjQsCiAgICAgICAgICAgICAgInIiOiBfX19zeXNjYWxsX3VubGlua2F0LAogICAgICAgICAgICAgICJRIjogX19lbXNjcmlwdGVuX2dldF9ub3dfaXNfbW9ub3RvbmljLAogICAgICAgICAgICAgICJ5IjogX19lbXNjcmlwdGVuX3Rocm93X2xvbmdqbXAsCiAgICAgICAgICAgICAgIkciOiBfX2dtdGltZV9qcywKICAgICAgICAgICAgICAiSCI6IF9fbG9jYWx0aW1lX2pzLAogICAgICAgICAgICAgICJJIjogX19ta3RpbWVfanMsCiAgICAgICAgICAgICAgIkEiOiBfX3R6c2V0X2pzLAogICAgICAgICAgICAgICJhIjogX2Fib3J0LAogICAgICAgICAgICAgICJpIjogX2Vtc2NyaXB0ZW5fYXNtX2NvbnN0X2FzeW5jX29uX21haW5fdGhyZWFkLAogICAgICAgICAgICAgICJlIjogX2Vtc2NyaXB0ZW5fYXNtX2NvbnN0X2ludCwKICAgICAgICAgICAgICAiaCI6IF9lbXNjcmlwdGVuX2RhdGVfbm93LAogICAgICAgICAgICAgICJCIjogX2Vtc2NyaXB0ZW5fZ2V0X2hlYXBfbWF4LAogICAgICAgICAgICAgICJuIjogX2Vtc2NyaXB0ZW5fZ2V0X25vdywKICAgICAgICAgICAgICAiUiI6IF9lbXNjcmlwdGVuX21lbWNweV9iaWcsCiAgICAgICAgICAgICAgInoiOiBfZW1zY3JpcHRlbl9yZXNpemVfaGVhcCwKICAgICAgICAgICAgICAiSyI6IF9lbnZpcm9uX2dldCwKICAgICAgICAgICAgICAiTCI6IF9lbnZpcm9uX3NpemVzX2dldCwKICAgICAgICAgICAgICAiYyI6IF9leGl0LAogICAgICAgICAgICAgICJqIjogX2ZkX2Nsb3NlLAogICAgICAgICAgICAgICJKIjogX2ZkX2Zkc3RhdF9nZXQsCiAgICAgICAgICAgICAgInQiOiBfZmRfcmVhZCwKICAgICAgICAgICAgICAidiI6IF9mZF9zZWVrLAogICAgICAgICAgICAgICJvIjogX2ZkX3dyaXRlLAogICAgICAgICAgICAgICJVIjogaW52b2tlX2ksCiAgICAgICAgICAgICAgIlQiOiBpbnZva2VfaWksCiAgICAgICAgICAgICAgImIiOiBpbnZva2VfaWlpLAogICAgICAgICAgICAgICJsIjogaW52b2tlX2lpaWlpaWlpaSwKICAgICAgICAgICAgICAieCI6IGludm9rZV9paWlpamosCiAgICAgICAgICAgICAgImciOiBpbnZva2VfdmksCiAgICAgICAgICAgICAgImYiOiBpbnZva2VfdmlpLAogICAgICAgICAgICAgICJkIjogaW52b2tlX3ZpaWlpLAogICAgICAgICAgICAgICJ3IjogaW52b2tlX3ZpampqaWQsCiAgICAgICAgICAgICAgImsiOiBfc3RyZnRpbWUKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgYXNtID0gY3JlYXRlV2FzbSgpOwogICAgICAgICAgdmFyIF9fX3dhc21fY2FsbF9jdG9ycyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX19fd2FzbV9jYWxsX2N0b3JzID0gTW9kdWxlWyJhc20iXVsiVyJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9fX2Vycm5vX2xvY2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfX19lcnJub19sb2NhdGlvbiA9IE1vZHVsZVsiYXNtIl1bIlkiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZnJlZSA9IE1vZHVsZVsiX2ZyZWUiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2ZyZWUgPSBNb2R1bGVbIl9mcmVlIl0gPSBNb2R1bGVbImFzbSJdWyJaIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX21hbGxvYyA9IE1vZHVsZVsiX21hbGxvYyJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfbWFsbG9jID0gTW9kdWxlWyJfbWFsbG9jIl0gPSBNb2R1bGVbImFzbSJdWyJfIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2NyZWF0ZUNMSUZpbGVIYW5kbGUgPSBNb2R1bGVbIl9jcmVhdGVDTElGaWxlSGFuZGxlIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9jcmVhdGVDTElGaWxlSGFuZGxlID0gTW9kdWxlWyJfY3JlYXRlQ0xJRmlsZUhhbmRsZSJdID0gTW9kdWxlWyJhc20iXVsiJCJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9yZW9wZW5DTElGaWxlSGFuZGxlID0gTW9kdWxlWyJfcmVvcGVuQ0xJRmlsZUhhbmRsZSJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfcmVvcGVuQ0xJRmlsZUhhbmRsZSA9IE1vZHVsZVsiX3Jlb3BlbkNMSUZpbGVIYW5kbGUiXSA9IE1vZHVsZVsiYXNtIl1bImFhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX3JlcG9ydENMSVByb2dyZXNzID0gTW9kdWxlWyJfcmVwb3J0Q0xJUHJvZ3Jlc3MiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX3JlcG9ydENMSVByb2dyZXNzID0gTW9kdWxlWyJfcmVwb3J0Q0xJUHJvZ3Jlc3MiXSA9IE1vZHVsZVsiYXNtIl1bImJhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX3JlZGlyZWN0Q0xJT3V0cHV0ID0gTW9kdWxlWyJfcmVkaXJlY3RDTElPdXRwdXQiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX3JlZGlyZWN0Q0xJT3V0cHV0ID0gTW9kdWxlWyJfcmVkaXJlY3RDTElPdXRwdXQiXSA9IE1vZHVsZVsiYXNtIl1bImNhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2RlbGl2ZXJGaWxlSGFuZGxlUmVhZFJlc3VsdCA9IE1vZHVsZVsiX2RlbGl2ZXJGaWxlSGFuZGxlUmVhZFJlc3VsdCJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfZGVsaXZlckZpbGVIYW5kbGVSZWFkUmVzdWx0ID0gTW9kdWxlWyJfZGVsaXZlckZpbGVIYW5kbGVSZWFkUmVzdWx0Il0gPSBNb2R1bGVbImFzbSJdWyJkYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9mZm1wZWdjbWRfYmcgPSBNb2R1bGVbIl9mZm1wZWdjbWRfYmciXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2ZmbXBlZ2NtZF9iZyA9IE1vZHVsZVsiX2ZmbXBlZ2NtZF9iZyJdID0gTW9kdWxlWyJhc20iXVsiZWEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZ2V0RkZBdWRpb0RhdGEgPSBNb2R1bGVbIl9nZXRGRkF1ZGlvRGF0YSJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfZ2V0RkZBdWRpb0RhdGEgPSBNb2R1bGVbIl9nZXRGRkF1ZGlvRGF0YSJdID0gTW9kdWxlWyJhc20iXVsiZmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfc3RhcnRGRlZpZGVvRGVjb2RlciA9IE1vZHVsZVsiX3N0YXJ0RkZWaWRlb0RlY29kZXIiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX3N0YXJ0RkZWaWRlb0RlY29kZXIgPSBNb2R1bGVbIl9zdGFydEZGVmlkZW9EZWNvZGVyIl0gPSBNb2R1bGVbImFzbSJdWyJnYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9nZXRGRlZpZGVvRGVjb2RlckZyYW1lV2lkdGggPSBNb2R1bGVbIl9nZXRGRlZpZGVvRGVjb2RlckZyYW1lV2lkdGgiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2dldEZGVmlkZW9EZWNvZGVyRnJhbWVXaWR0aCA9IE1vZHVsZVsiX2dldEZGVmlkZW9EZWNvZGVyRnJhbWVXaWR0aCJdID0gTW9kdWxlWyJhc20iXVsiaGEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZUhlaWdodCA9IE1vZHVsZVsiX2dldEZGVmlkZW9EZWNvZGVyRnJhbWVIZWlnaHQiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2dldEZGVmlkZW9EZWNvZGVyRnJhbWVIZWlnaHQgPSBNb2R1bGVbIl9nZXRGRlZpZGVvRGVjb2RlckZyYW1lSGVpZ2h0Il0gPSBNb2R1bGVbImFzbSJdWyJpYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9nZXRGRlZpZGVvRGVjb2RlckZyYW1lUm90YXRpb24gPSBNb2R1bGVbIl9nZXRGRlZpZGVvRGVjb2RlckZyYW1lUm90YXRpb24iXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2dldEZGVmlkZW9EZWNvZGVyRnJhbWVSb3RhdGlvbiA9IE1vZHVsZVsiX2dldEZGVmlkZW9EZWNvZGVyRnJhbWVSb3RhdGlvbiJdID0gTW9kdWxlWyJhc20iXVsiamEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZ2V0RkZWaWRlb0RlY29kZXJEdXJhdGlvbiA9IE1vZHVsZVsiX2dldEZGVmlkZW9EZWNvZGVyRHVyYXRpb24iXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2dldEZGVmlkZW9EZWNvZGVyRHVyYXRpb24gPSBNb2R1bGVbIl9nZXRGRlZpZGVvRGVjb2RlckR1cmF0aW9uIl0gPSBNb2R1bGVbImFzbSJdWyJrYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9nZXRGRlZpZGVvRGVjb2RlckZyYW1lID0gTW9kdWxlWyJfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZSJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfZ2V0RkZWaWRlb0RlY29kZXJGcmFtZSA9IE1vZHVsZVsiX2dldEZGVmlkZW9EZWNvZGVyRnJhbWUiXSA9IE1vZHVsZVsiYXNtIl1bImxhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2Nsb3NlRkZWaWRlb0RlY29kZXIgPSBNb2R1bGVbIl9jbG9zZUZGVmlkZW9EZWNvZGVyIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9jbG9zZUZGVmlkZW9EZWNvZGVyID0gTW9kdWxlWyJfY2xvc2VGRlZpZGVvRGVjb2RlciJdID0gTW9kdWxlWyJhc20iXVsibWEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZmlsZUhhc1ZpZGVvID0gTW9kdWxlWyJfZmlsZUhhc1ZpZGVvIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9maWxlSGFzVmlkZW8gPSBNb2R1bGVbIl9maWxlSGFzVmlkZW8iXSA9IE1vZHVsZVsiYXNtIl1bIm5hIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2ZpbGVIYXNBdWRpbyA9IE1vZHVsZVsiX2ZpbGVIYXNBdWRpbyJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfZmlsZUhhc0F1ZGlvID0gTW9kdWxlWyJfZmlsZUhhc0F1ZGlvIl0gPSBNb2R1bGVbImFzbSJdWyJvYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9kaXNhYmxlTG9nZ2luZyA9IE1vZHVsZVsiX2Rpc2FibGVMb2dnaW5nIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9kaXNhYmxlTG9nZ2luZyA9IE1vZHVsZVsiX2Rpc2FibGVMb2dnaW5nIl0gPSBNb2R1bGVbImFzbSJdWyJwYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9vcGVuRmlsZSA9IE1vZHVsZVsiX29wZW5GaWxlIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9vcGVuRmlsZSA9IE1vZHVsZVsiX29wZW5GaWxlIl0gPSBNb2R1bGVbImFzbSJdWyJxYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9zZXRSZWFkeVRvUmVjZWl2ZVByb3h5RnJhbWVzID0gTW9kdWxlWyJfc2V0UmVhZHlUb1JlY2VpdmVQcm94eUZyYW1lcyJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfc2V0UmVhZHlUb1JlY2VpdmVQcm94eUZyYW1lcyA9IE1vZHVsZVsiX3NldFJlYWR5VG9SZWNlaXZlUHJveHlGcmFtZXMiXSA9IE1vZHVsZVsiYXNtIl1bInJhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2NhbmNlbFByb3h5R2VuID0gTW9kdWxlWyJfY2FuY2VsUHJveHlHZW4iXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2NhbmNlbFByb3h5R2VuID0gTW9kdWxlWyJfY2FuY2VsUHJveHlHZW4iXSA9IE1vZHVsZVsiYXNtIl1bInNhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX3N0YXJ0UHJveHlHZW4gPSBNb2R1bGVbIl9zdGFydFByb3h5R2VuIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9zdGFydFByb3h5R2VuID0gTW9kdWxlWyJfc3RhcnRQcm94eUdlbiJdID0gTW9kdWxlWyJhc20iXVsidGEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfc3BsaXRBdWRpbyA9IE1vZHVsZVsiX3NwbGl0QXVkaW8iXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX3NwbGl0QXVkaW8gPSBNb2R1bGVbIl9zcGxpdEF1ZGlvIl0gPSBNb2R1bGVbImFzbSJdWyJ1YSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9mZm1wZWdjbWQgPSBNb2R1bGVbIl9mZm1wZWdjbWQiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2ZmbXBlZ2NtZCA9IE1vZHVsZVsiX2ZmbXBlZ2NtZCJdID0gTW9kdWxlWyJhc20iXVsidmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfc3RhcnRfdmlkZW9fd3JpdGUgPSBNb2R1bGVbIl9zdGFydF92aWRlb193cml0ZSJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfc3RhcnRfdmlkZW9fd3JpdGUgPSBNb2R1bGVbIl9zdGFydF92aWRlb193cml0ZSJdID0gTW9kdWxlWyJhc20iXVsid2EiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfY2FuX2FjY2VwdF92aWRlb2J1ZmZlciA9IE1vZHVsZVsiX2Nhbl9hY2NlcHRfdmlkZW9idWZmZXIiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2Nhbl9hY2NlcHRfdmlkZW9idWZmZXIgPSBNb2R1bGVbIl9jYW5fYWNjZXB0X3ZpZGVvYnVmZmVyIl0gPSBNb2R1bGVbImFzbSJdWyJ4YSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9zZXRfaDI2NF9yYXdfY29sb3JzcGFjZSA9IE1vZHVsZVsiX3NldF9oMjY0X3Jhd19jb2xvcnNwYWNlIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9zZXRfaDI2NF9yYXdfY29sb3JzcGFjZSA9IE1vZHVsZVsiX3NldF9oMjY0X3Jhd19jb2xvcnNwYWNlIl0gPSBNb2R1bGVbImFzbSJdWyJ5YSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF93cml0ZV92aWRlb19yYXdfcGFja2V0ID0gTW9kdWxlWyJfd3JpdGVfdmlkZW9fcmF3X3BhY2tldCJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfd3JpdGVfdmlkZW9fcmF3X3BhY2tldCA9IE1vZHVsZVsiX3dyaXRlX3ZpZGVvX3Jhd19wYWNrZXQiXSA9IE1vZHVsZVsiYXNtIl1bInphIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2Nhbl9hY2NlcHRfYXVkaW9idWZmZXIgPSBNb2R1bGVbIl9jYW5fYWNjZXB0X2F1ZGlvYnVmZmVyIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9jYW5fYWNjZXB0X2F1ZGlvYnVmZmVyID0gTW9kdWxlWyJfY2FuX2FjY2VwdF9hdWRpb2J1ZmZlciJdID0gTW9kdWxlWyJhc20iXVsiQWEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZ2VuZXJhdGVUZXN0VmlkZW9CdWZmZXIgPSBNb2R1bGVbIl9nZW5lcmF0ZVRlc3RWaWRlb0J1ZmZlciJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfZ2VuZXJhdGVUZXN0VmlkZW9CdWZmZXIgPSBNb2R1bGVbIl9nZW5lcmF0ZVRlc3RWaWRlb0J1ZmZlciJdID0gTW9kdWxlWyJhc20iXVsiQmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZ2VuZXJhdGVUZXN0QXVkaW9CdWZmZXIgPSBNb2R1bGVbIl9nZW5lcmF0ZVRlc3RBdWRpb0J1ZmZlciJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfZ2VuZXJhdGVUZXN0QXVkaW9CdWZmZXIgPSBNb2R1bGVbIl9nZW5lcmF0ZVRlc3RBdWRpb0J1ZmZlciJdID0gTW9kdWxlWyJhc20iXVsiQ2EiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfc3RhcnRfYmdfZW5jb2RlID0gTW9kdWxlWyJfc3RhcnRfYmdfZW5jb2RlIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9zdGFydF9iZ19lbmNvZGUgPSBNb2R1bGVbIl9zdGFydF9iZ19lbmNvZGUiXSA9IE1vZHVsZVsiYXNtIl1bIkRhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX3N0YXJ0X2JnX2VuY29kZTIgPSBNb2R1bGVbIl9zdGFydF9iZ19lbmNvZGUyIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9zdGFydF9iZ19lbmNvZGUyID0gTW9kdWxlWyJfc3RhcnRfYmdfZW5jb2RlMiJdID0gTW9kdWxlWyJhc20iXVsiRWEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfc3RhcnRfdmlkZW9fZnJhbWVfZW5jb2RlID0gTW9kdWxlWyJfc3RhcnRfdmlkZW9fZnJhbWVfZW5jb2RlIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9zdGFydF92aWRlb19mcmFtZV9lbmNvZGUgPSBNb2R1bGVbIl9zdGFydF92aWRlb19mcmFtZV9lbmNvZGUiXSA9IE1vZHVsZVsiYXNtIl1bIkZhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX3F1ZXVlX3ZpZGVvX3BhY2tldF9tdXggPSBNb2R1bGVbIl9xdWV1ZV92aWRlb19wYWNrZXRfbXV4Il0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9xdWV1ZV92aWRlb19wYWNrZXRfbXV4ID0gTW9kdWxlWyJfcXVldWVfdmlkZW9fcGFja2V0X211eCJdID0gTW9kdWxlWyJhc20iXVsiR2EiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfc3RhcnRfYXVkaW9fZnJhbWVfZW5jb2RlID0gTW9kdWxlWyJfc3RhcnRfYXVkaW9fZnJhbWVfZW5jb2RlIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9zdGFydF9hdWRpb19mcmFtZV9lbmNvZGUgPSBNb2R1bGVbIl9zdGFydF9hdWRpb19mcmFtZV9lbmNvZGUiXSA9IE1vZHVsZVsiYXNtIl1bIkhhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2ZpbmlzaF9iZ19lbmNvZGUgPSBNb2R1bGVbIl9maW5pc2hfYmdfZW5jb2RlIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9maW5pc2hfYmdfZW5jb2RlID0gTW9kdWxlWyJfZmluaXNoX2JnX2VuY29kZSJdID0gTW9kdWxlWyJhc20iXVsiSWEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfcmVtdXggPSBNb2R1bGVbIl9yZW11eCJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfcmVtdXggPSBNb2R1bGVbIl9yZW11eCJdID0gTW9kdWxlWyJhc20iXVsiSmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZW1zY3JpcHRlbl9idWlsdGluX21lbWFsaWduID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfZW1zY3JpcHRlbl9idWlsdGluX21lbWFsaWduID0gTW9kdWxlWyJhc20iXVsiS2EiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfc2V0VGhyZXcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9zZXRUaHJldyA9IE1vZHVsZVsiYXNtIl1bIkxhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2Vtc2NyaXB0ZW5fc3RhY2tfc2V0X2xpbWl0cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2Vtc2NyaXB0ZW5fc3RhY2tfc2V0X2xpbWl0cyA9IE1vZHVsZVsiYXNtIl1bImVtc2NyaXB0ZW5fc3RhY2tfc2V0X2xpbWl0cyJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9lbXNjcmlwdGVuX3N0YWNrX2dldF9iYXNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfZW1zY3JpcHRlbl9zdGFja19nZXRfYmFzZSA9IE1vZHVsZVsiYXNtIl1bImVtc2NyaXB0ZW5fc3RhY2tfZ2V0X2Jhc2UiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZW1zY3JpcHRlbl9zdGFja19nZXRfZW5kID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfZW1zY3JpcHRlbl9zdGFja19nZXRfZW5kID0gTW9kdWxlWyJhc20iXVsiZW1zY3JpcHRlbl9zdGFja19nZXRfZW5kIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgc3RhY2tTYXZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChzdGFja1NhdmUgPSBNb2R1bGVbImFzbSJdWyJNYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHN0YWNrUmVzdG9yZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoc3RhY2tSZXN0b3JlID0gTW9kdWxlWyJhc20iXVsiTmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBzdGFja0FsbG9jID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChzdGFja0FsbG9jID0gTW9kdWxlWyJhc20iXVsiT2EiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfX19jeGFfaXNfcG9pbnRlcl90eXBlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfX19jeGFfaXNfcG9pbnRlcl90eXBlID0gTW9kdWxlWyJhc20iXVsiUGEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBkeW5DYWxsX2lpID0gTW9kdWxlWyJkeW5DYWxsX2lpIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKGR5bkNhbGxfaWkgPSBNb2R1bGVbImR5bkNhbGxfaWkiXSA9IE1vZHVsZVsiYXNtIl1bIlFhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZHluQ2FsbF9paWkgPSBNb2R1bGVbImR5bkNhbGxfaWlpIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKGR5bkNhbGxfaWlpID0gTW9kdWxlWyJkeW5DYWxsX2lpaSJdID0gTW9kdWxlWyJhc20iXVsiUmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBkeW5DYWxsX3ZpID0gTW9kdWxlWyJkeW5DYWxsX3ZpIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKGR5bkNhbGxfdmkgPSBNb2R1bGVbImR5bkNhbGxfdmkiXSA9IE1vZHVsZVsiYXNtIl1bIlNhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZHluQ2FsbF92aWkgPSBNb2R1bGVbImR5bkNhbGxfdmlpIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKGR5bkNhbGxfdmlpID0gTW9kdWxlWyJkeW5DYWxsX3ZpaSJdID0gTW9kdWxlWyJhc20iXVsiVGEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBkeW5DYWxsX3ZpaWlpID0gTW9kdWxlWyJkeW5DYWxsX3ZpaWlpIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKGR5bkNhbGxfdmlpaWkgPSBNb2R1bGVbImR5bkNhbGxfdmlpaWkiXSA9IE1vZHVsZVsiYXNtIl1bIlVhIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZHluQ2FsbF9paWlpamogPSBNb2R1bGVbImR5bkNhbGxfaWlpaWpqIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKGR5bkNhbGxfaWlpaWpqID0gTW9kdWxlWyJkeW5DYWxsX2lpaWlqaiJdID0gTW9kdWxlWyJhc20iXVsiVmEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBkeW5DYWxsX2lpaWlpaWlpaSA9IE1vZHVsZVsiZHluQ2FsbF9paWlpaWlpaWkiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoZHluQ2FsbF9paWlpaWlpaWkgPSBNb2R1bGVbImR5bkNhbGxfaWlpaWlpaWlpIl0gPSBNb2R1bGVbImFzbSJdWyJXYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGR5bkNhbGxfdmlqamppZCA9IE1vZHVsZVsiZHluQ2FsbF92aWpqamlkIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKGR5bkNhbGxfdmlqamppZCA9IE1vZHVsZVsiZHluQ2FsbF92aWpqamlkIl0gPSBNb2R1bGVbImFzbSJdWyJYYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGR5bkNhbGxfaSA9IE1vZHVsZVsiZHluQ2FsbF9pIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKGR5bkNhbGxfaSA9IE1vZHVsZVsiZHluQ2FsbF9pIl0gPSBNb2R1bGVbImFzbSJdWyJZYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9hc3luY2lmeV9zdGFydF91bndpbmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9hc3luY2lmeV9zdGFydF91bndpbmQgPSBNb2R1bGVbImFzbSJdWyJaYSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF9hc3luY2lmeV9zdG9wX3Vud2luZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAoX2FzeW5jaWZ5X3N0b3BfdW53aW5kID0gTW9kdWxlWyJhc20iXVsiX2EiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfYXN5bmNpZnlfc3RhcnRfcmV3aW5kID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIChfYXN5bmNpZnlfc3RhcnRfcmV3aW5kID0gTW9kdWxlWyJhc20iXVsiJGEiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfYXN5bmNpZnlfc3RvcF9yZXdpbmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gKF9hc3luY2lmeV9zdG9wX3Jld2luZCA9IE1vZHVsZVsiYXNtIl1bImFiIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX2ZmX2gyNjRfY2FiYWNfdGFibGVzID0gTW9kdWxlWyJfZmZfaDI2NF9jYWJhY190YWJsZXMiXSA9IDMzNTM2ODsKICAgICAgICAgIHZhciBfX19zdGFydF9lbV9qcyA9IE1vZHVsZVsiX19fc3RhcnRfZW1fanMiXSA9IDg2MzcwODsKICAgICAgICAgIHZhciBfX19zdG9wX2VtX2pzID0gTW9kdWxlWyJfX19zdG9wX2VtX2pzIl0gPSA4NjM4NTU7CgogICAgICAgICAgZnVuY3Rpb24gaW52b2tlX3ZpaShpbmRleCwgYTEsIGEyKSB7CiAgICAgICAgICAgICAgdmFyIHNwID0gc3RhY2tTYXZlKCk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgZHluQ2FsbF92aWkoaW5kZXgsIGExLCBhMikKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIHN0YWNrUmVzdG9yZShzcCk7CiAgICAgICAgICAgICAgICAgIGlmIChlICE9PSBlICsgMCkgdGhyb3cgZTsKICAgICAgICAgICAgICAgICAgX3NldFRocmV3KDEsIDApCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGludm9rZV9paWkoaW5kZXgsIGExLCBhMikgewogICAgICAgICAgICAgIHZhciBzcCA9IHN0YWNrU2F2ZSgpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkeW5DYWxsX2lpaShpbmRleCwgYTEsIGEyKQogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgc3RhY2tSZXN0b3JlKHNwKTsKICAgICAgICAgICAgICAgICAgaWYgKGUgIT09IGUgKyAwKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICBfc2V0VGhyZXcoMSwgMCkKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gaW52b2tlX2lpaWlpaWlpaShpbmRleCwgYTEsIGEyLCBhMywgYTQsIGE1LCBhNiwgYTcsIGE4KSB7CiAgICAgICAgICAgICAgdmFyIHNwID0gc3RhY2tTYXZlKCk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGR5bkNhbGxfaWlpaWlpaWlpKGluZGV4LCBhMSwgYTIsIGEzLCBhNCwgYTUsIGE2LCBhNywgYTgpCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBzdGFja1Jlc3RvcmUoc3ApOwogICAgICAgICAgICAgICAgICBpZiAoZSAhPT0gZSArIDApIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIF9zZXRUaHJldygxLCAwKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBpbnZva2VfdmkoaW5kZXgsIGExKSB7CiAgICAgICAgICAgICAgdmFyIHNwID0gc3RhY2tTYXZlKCk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgZHluQ2FsbF92aShpbmRleCwgYTEpCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBzdGFja1Jlc3RvcmUoc3ApOwogICAgICAgICAgICAgICAgICBpZiAoZSAhPT0gZSArIDApIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIF9zZXRUaHJldygxLCAwKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBpbnZva2VfdmlpaWkoaW5kZXgsIGExLCBhMiwgYTMsIGE0KSB7CiAgICAgICAgICAgICAgdmFyIHNwID0gc3RhY2tTYXZlKCk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgZHluQ2FsbF92aWlpaShpbmRleCwgYTEsIGEyLCBhMywgYTQpCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBzdGFja1Jlc3RvcmUoc3ApOwogICAgICAgICAgICAgICAgICBpZiAoZSAhPT0gZSArIDApIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIF9zZXRUaHJldygxLCAwKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBpbnZva2VfaShpbmRleCkgewogICAgICAgICAgICAgIHZhciBzcCA9IHN0YWNrU2F2ZSgpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkeW5DYWxsX2koaW5kZXgpCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBzdGFja1Jlc3RvcmUoc3ApOwogICAgICAgICAgICAgICAgICBpZiAoZSAhPT0gZSArIDApIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIF9zZXRUaHJldygxLCAwKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBpbnZva2VfaWkoaW5kZXgsIGExKSB7CiAgICAgICAgICAgICAgdmFyIHNwID0gc3RhY2tTYXZlKCk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGR5bkNhbGxfaWkoaW5kZXgsIGExKQogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgc3RhY2tSZXN0b3JlKHNwKTsKICAgICAgICAgICAgICAgICAgaWYgKGUgIT09IGUgKyAwKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICBfc2V0VGhyZXcoMSwgMCkKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gaW52b2tlX2lpaWlqaihpbmRleCwgYTEsIGEyLCBhMywgYTQsIGE1LCBhNiwgYTcpIHsKICAgICAgICAgICAgICB2YXIgc3AgPSBzdGFja1NhdmUoKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZHluQ2FsbF9paWlpamooaW5kZXgsIGExLCBhMiwgYTMsIGE0LCBhNSwgYTYsIGE3KQogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgc3RhY2tSZXN0b3JlKHNwKTsKICAgICAgICAgICAgICAgICAgaWYgKGUgIT09IGUgKyAwKSB0aHJvdyBlOwogICAgICAgICAgICAgICAgICBfc2V0VGhyZXcoMSwgMCkKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gaW52b2tlX3ZpampqaWQoaW5kZXgsIGExLCBhMiwgYTMsIGE0LCBhNSwgYTYsIGE3LCBhOCwgYTkpIHsKICAgICAgICAgICAgICB2YXIgc3AgPSBzdGFja1NhdmUoKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBkeW5DYWxsX3ZpampqaWQoaW5kZXgsIGExLCBhMiwgYTMsIGE0LCBhNSwgYTYsIGE3LCBhOCwgYTkpCiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBzdGFja1Jlc3RvcmUoc3ApOwogICAgICAgICAgICAgICAgICBpZiAoZSAhPT0gZSArIDApIHRocm93IGU7CiAgICAgICAgICAgICAgICAgIF9zZXRUaHJldygxLCAwKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIE1vZHVsZVsiYWRkUnVuRGVwZW5kZW5jeSJdID0gYWRkUnVuRGVwZW5kZW5jeTsKICAgICAgICAgIE1vZHVsZVsicmVtb3ZlUnVuRGVwZW5kZW5jeSJdID0gcmVtb3ZlUnVuRGVwZW5kZW5jeTsKICAgICAgICAgIE1vZHVsZVsiRlNfY3JlYXRlUGF0aCJdID0gRlMuY3JlYXRlUGF0aDsKICAgICAgICAgIE1vZHVsZVsiRlNfY3JlYXRlRGF0YUZpbGUiXSA9IEZTLmNyZWF0ZURhdGFGaWxlOwogICAgICAgICAgTW9kdWxlWyJGU19jcmVhdGVMYXp5RmlsZSJdID0gRlMuY3JlYXRlTGF6eUZpbGU7CiAgICAgICAgICBNb2R1bGVbIkZTX2NyZWF0ZURldmljZSJdID0gRlMuY3JlYXRlRGV2aWNlOwogICAgICAgICAgTW9kdWxlWyJGU191bmxpbmsiXSA9IEZTLnVubGluazsKICAgICAgICAgIE1vZHVsZVsiVVRGOFRvU3RyaW5nIl0gPSBVVEY4VG9TdHJpbmc7CiAgICAgICAgICBNb2R1bGVbImludEFycmF5RnJvbVN0cmluZyJdID0gaW50QXJyYXlGcm9tU3RyaW5nOwogICAgICAgICAgTW9kdWxlWyJGU19jcmVhdGVQcmVsb2FkZWRGaWxlIl0gPSBGUy5jcmVhdGVQcmVsb2FkZWRGaWxlOwogICAgICAgICAgTW9kdWxlWyJGUyJdID0gRlM7CiAgICAgICAgICBNb2R1bGVbIkFMTE9DX05PUk1BTCJdID0gQUxMT0NfTk9STUFMOwogICAgICAgICAgTW9kdWxlWyJhbGxvY2F0ZSJdID0gYWxsb2NhdGU7CiAgICAgICAgICB2YXIgY2FsbGVkUnVuOwogICAgICAgICAgZGVwZW5kZW5jaWVzRnVsZmlsbGVkID0gZnVuY3Rpb24gcnVuQ2FsbGVyKCkgewogICAgICAgICAgICAgIGlmICghY2FsbGVkUnVuKSBydW4oKTsKICAgICAgICAgICAgICBpZiAoIWNhbGxlZFJ1bikgZGVwZW5kZW5jaWVzRnVsZmlsbGVkID0gcnVuQ2FsbGVyCiAgICAgICAgICB9OwoKICAgICAgICAgIGZ1bmN0aW9uIHJ1bigpIHsKICAgICAgICAgICAgICBpZiAocnVuRGVwZW5kZW5jaWVzID4gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJlUnVuKCk7CiAgICAgICAgICAgICAgaWYgKHJ1bkRlcGVuZGVuY2llcyA+IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBmdW5jdGlvbiBkb1J1bigpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNhbGxlZFJ1bikgcmV0dXJuOwogICAgICAgICAgICAgICAgICBjYWxsZWRSdW4gPSB0cnVlOwogICAgICAgICAgICAgICAgICBNb2R1bGVbImNhbGxlZFJ1biJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgaWYgKEFCT1JUKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIGluaXRSdW50aW1lKCk7CiAgICAgICAgICAgICAgICAgIHJlYWR5UHJvbWlzZVJlc29sdmUoTW9kdWxlKTsKICAgICAgICAgICAgICAgICAgaWYgKE1vZHVsZVsib25SdW50aW1lSW5pdGlhbGl6ZWQiXSkgTW9kdWxlWyJvblJ1bnRpbWVJbml0aWFsaXplZCJdKCk7CiAgICAgICAgICAgICAgICAgIHBvc3RSdW4oKQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoTW9kdWxlWyJzZXRTdGF0dXMiXSkgewogICAgICAgICAgICAgICAgICBNb2R1bGVbInNldFN0YXR1cyJdKCJSdW5uaW5nLi4uIik7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIE1vZHVsZVsic2V0U3RhdHVzIl0oIiIpCiAgICAgICAgICAgICAgICAgICAgICB9LCAxKTsKICAgICAgICAgICAgICAgICAgICAgIGRvUnVuKCkKICAgICAgICAgICAgICAgICAgfSwgMSkKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkb1J1bigpCiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKE1vZHVsZVsicHJlSW5pdCJdKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBNb2R1bGVbInByZUluaXQiXSA9PSAiZnVuY3Rpb24iKSBNb2R1bGVbInByZUluaXQiXSA9IFtNb2R1bGVbInByZUluaXQiXV07CiAgICAgICAgICAgICAgd2hpbGUgKE1vZHVsZVsicHJlSW5pdCJdLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgTW9kdWxlWyJwcmVJbml0Il0ucG9wKCkoKQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJ1bigpOwoKCiAgICAgICAgICByZXR1cm4gRkZtcGVnTW9kdWxlQ3JlYXRlLnJlYWR5CiAgICAgIH0KCiAgKTsKfSkoKTsKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JykKICBtb2R1bGUuZXhwb3J0cyA9IEZGbXBlZ01vZHVsZUNyZWF0ZTsKZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmVbJ2FtZCddKQogIGRlZmluZShbXSwgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBGRm1wZWdNb2R1bGVDcmVhdGU7CiAgfSk7CmVsc2UgaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykKICBleHBvcnRzWyJGRm1wZWdNb2R1bGVDcmVhdGUiXSA9IEZGbXBlZ01vZHVsZUNyZWF0ZTsKYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGFzeW5jICh7IGRhdGEgfSkgPT4gewovLyAgICBjb25zb2xlLmxvZygiZmZ3b3JrZXIgZ290IG1zZzogIixkYXRhKTsKICAgIGlmIChkYXRhLmNtZCA9PSAncGluZycpIHsKICAgIAogICAgICAgIHNlbGYucG9zdE1lc3NhZ2UoIHsncmVzJyA6ICdwb25nJ30pOwogICAgICAgIAogICAgfSBlbHNlIGlmIChkYXRhLmNtZCA9PSAnaW5pdCcpIHsKCQl0cnkgewoJCQlpZiAoV2ViQXNzZW1ibHkudmFsaWRhdGUobmV3IFVpbnQ4QXJyYXkoWzAsOTcsMTE1LDEwOSwxLDAsMCwwLDEsNSwxLDk2LDAsMSwxMjMsMywyLDEsMCwxMCwxMCwxLDgsMCw2NSwwLDI1MywxNSwyNTMsOTgsMTFdKSkpIHsKCQkJCXNlbGYuaW1wb3J0U2NyaXB0cygnaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL2phY2tiMGJhY2svc3RyZWFtaW5nQXNzZXRzQG1haW4vVmlkbWl4L2ZmbXBlZy1zaW1kLW5vc2FiLTE2OTk5ODUxNzIuanMnKTsKCQkJfSBlbHNlIHsKCQkJCXNlbGYuaW1wb3J0U2NyaXB0cygnaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL2phY2tiMGJhY2svc3RyZWFtaW5nQXNzZXRzQG1haW4vVmlkbWl4L2ZmbXBlZy1ub3NhYi0xNjk5OTg1MTcyLmpzJyk7CSAgICAKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJY29uc29sZS5sb2coIkZhaWxlZCB0byBsb2FkIGZmbXBlZyAoanMpIik7CgkJfQoJICAgIAoJICAgIEZGbXBlZ01vZHVsZSA9IGF3YWl0IEZGbXBlZ01vZHVsZUNyZWF0ZSgpOwogICAgICAgIHNlbGYucG9zdE1lc3NhZ2UoeyAnY21kJyA6ICdpbml0JywgJ3JlcycgOiAncmVhZHknIH0pOwoKLy8JICAgIGNvbnNvbGUubG9nKCJmZndvcmtlciBpbml0IGRvbmUiKTsKICAgIH0gZWxzZSBpZiAoZGF0YS5jbWQgPT0gJ29wZW5maWxlJykgewoJCQoJCUZGbXBlZ01vZHVsZS5fb3BlbkZpbGUoZGF0YS5hcmdzLmZpbGVIYW5kbGVJRCwgZGF0YS5hcmdzLm9mZnNldF9oLCBkYXRhLmFyZ3Mub2Zmc2V0X2wsIGRhdGEuYXJncy5zaXplX2gsIGRhdGEuYXJncy5zaXplX2wsIDAsIGRhdGEuYXJncy5yZWYpOwoKICAgIH0gZWxzZSBpZiAoZGF0YS5jbWQgPT0gJ2ZpbGVyZWFkcmVzJykgewogICAgCQogICAgCWxldCBidWZmbGVuID0gZGF0YS5idWZmLmxlbmd0aDsKCQl2YXIgcHRyID0gRkZtcGVnTW9kdWxlLl9tYWxsb2MoYnVmZmxlbik7CgkJRkZtcGVnTW9kdWxlLkhFQVBVOC5zZXQoZGF0YS5idWZmLCBwdHIpOwoJICAgIEZGbXBlZ01vZHVsZS5fZGVsaXZlckZpbGVIYW5kbGVSZWFkUmVzdWx0KGRhdGEucmVxSUQsIHB0ciwgYnVmZmxlbik7CgkgICAgRkZtcGVnTW9kdWxlLl9mcmVlKHB0cik7CiAgICAJc2VsZi5maWxlcmVhZHJlc29sdmUoKTsKICAgIH0gZWxzZSBpZiAoZGF0YS5jbWQgPT0gJ3N0YXJ0RkZWaWRlb0RlY29kZXInKSB7CgkJdmFyIGZpbGVuYW1lX3N0cl9wdHIgID0gRkZtcGVnTW9kdWxlLmFsbG9jYXRlKEZGbXBlZ01vZHVsZS5pbnRBcnJheUZyb21TdHJpbmcoZGF0YS5hcmdzLmZpbGVuYW1lKSwgRkZtcGVnTW9kdWxlLkFMTE9DX05PUk1BTCk7CgkJCgkJdmFyIGZmaW5mb19wdHIgPSBGRm1wZWdNb2R1bGUuX21hbGxvYyhkYXRhLmFyZ3MuaW5mb2J1ZmYubGVuZ3RoKTsKCQlGRm1wZWdNb2R1bGUuSEVBUFU4LnNldChkYXRhLmFyZ3MuaW5mb2J1ZmYsIGZmaW5mb19wdHIpOwoJCQoJCUZGbXBlZ01vZHVsZS5fc3RhcnRGRlZpZGVvRGVjb2RlcihmaWxlbmFtZV9zdHJfcHRyLCBkYXRhLmFyZ3MudmlkLCBmZmluZm9fcHRyKTsKCQlGRm1wZWdNb2R1bGUuX2ZyZWUoZmlsZW5hbWVfc3RyX3B0cik7CiAgICAKICAgIH0gZWxzZSBpZiAoZGF0YS5jbWQgPT0gJ2dldEZGQXVkaW9EYXRhJykgewoJCUZGbXBlZ01vZHVsZS5fZ2V0RkZBdWRpb0RhdGEoZGF0YS5hcmdzLnZpZCwgZGF0YS5hcmdzLnJlcWlkLCBkYXRhLmFyZ3Mub2Zmc19sLCBkYXRhLmFyZ3Mub2Zmc19oLCBkYXRhLmFyZ3Muc2NudCk7CiAgICB9IGVsc2UgaWYgKGRhdGEuY21kID09ICdnZXRGRlZpZGVvRGVjb2RlckZyYW1lJykgewoJCUZGbXBlZ01vZHVsZS5fZ2V0RkZWaWRlb0RlY29kZXJGcmFtZShkYXRhLmFyZ3MudmlkLCBkYXRhLmFyZ3MucmVxaWQsIGRhdGEuYXJncy50cyk7CiAgICB9IGVsc2UgaWYgKGRhdGEuY21kID09ICdjbG9zZUZGVmlkZW9EZWNvZGVyJykgewoJCUZGbXBlZ01vZHVsZS5fY2xvc2VGRlZpZGVvRGVjb2RlcihkYXRhLmFyZ3MudmlkKTsKICAgIH0gZWxzZSBpZiAoZGF0YS5jbWQgPT0gJ2ZpcnN0ZnJhbWUnKSB7CgkJbGV0IGgyNjRmaWxlc3RyZWFtID0gRkZtcGVnTW9kdWxlLkZTLm9wZW4oImZpcnN0ZnJhbWUuaDI2NCIsICd3KycpOwoJCWxldCB1YXJyID0gZGF0YS5idWZmOwoJCUZGbXBlZ01vZHVsZS5GUy53cml0ZShoMjY0ZmlsZXN0cmVhbSwgdWFyciwgMCwgdWFyci5sZW5ndGgsIDApOyAgICAJCiAgICB9IGVsc2UgaWYgKGRhdGEuY21kID09ICdzdGFydF9iZ19lbmNvZGUyJykgewogICAgCXZhciBmaWxlbmFtZV9zdHJfcHRyICA9IEZGbXBlZ01vZHVsZS5hbGxvY2F0ZShGRm1wZWdNb2R1bGUuaW50QXJyYXlGcm9tU3RyaW5nKGRhdGEuYXJncy5mbiksIEZGbXBlZ01vZHVsZS5BTExPQ19OT1JNQUwpOwogICAgCUZGbXBlZ01vZHVsZS5fc3RhcnRfYmdfZW5jb2RlMihkYXRhLmFyZ3MucmlkLCBmaWxlbmFtZV9zdHJfcHRyLCBkYXRhLmFyZ3Mud2lkdGgsIGRhdGEuYXJncy5oZWlnaHQsIGRhdGEuYXJncy5mcHMsIGRhdGEuYXJncy5mb3JtYXQsIGRhdGEuYXJncy5iaXRyYXRlLCBkYXRhLmFyZ3MucGl4Zm9ybWF0LCBkYXRhLmFyZ3MuYXVkaW9jaGFubmVscyk7CgkJRkZtcGVnTW9kdWxlLl9mcmVlKGZpbGVuYW1lX3N0cl9wdHIpOwogICAgfSBlbHNlIGlmIChkYXRhLmNtZCA9PSAncXVldWVfdmlkZW9fcGFja2V0X211eCcpIHsKCQl2YXIgcHRyID0gRkZtcGVnTW9kdWxlLl9tYWxsb2MoZGF0YS5hcmdzLmJ1ZmYubGVuZ3RoKTsKCQlGRm1wZWdNb2R1bGUuSEVBUFU4LnNldChkYXRhLmFyZ3MuYnVmZiwgcHRyKTsKICAgIAlGRm1wZWdNb2R1bGUuX3F1ZXVlX3ZpZGVvX3BhY2tldF9tdXgoZGF0YS5hcmdzLnJpZCwgcHRyLCBkYXRhLmFyZ3MuYnVmZi5sZW5ndGgsIGRhdGEuYXJncy5pc2tleSk7CiAgICB9IGVsc2UgaWYgKGRhdGEuY21kID09ICdzZXRfaDI2NF9yYXdfY29sb3JzcGFjZScpIHsKICAgIAlGRm1wZWdNb2R1bGUuX3NldF9oMjY0X3Jhd19jb2xvcnNwYWNlKGRhdGEuYXJnc1sicCJdLGRhdGEuYXJnc1sidCJdLGRhdGEuYXJnc1sibSJdLGRhdGEuYXJnc1siciJdKTsKICAgIH0gZWxzZSBpZiAoZGF0YS5jbWQgPT0gJ3N0YXJ0X2F1ZGlvX2ZyYW1lX2VuY29kZScpIHsKICAgIAl2YXIgYXVkYnVmZl9wdHIgPSBGRm1wZWdNb2R1bGUuX21hbGxvYyhkYXRhLmFyZ3MuYnVmZi5sZW5ndGgpOwogICAgICAgIEZGbXBlZ01vZHVsZS5IRUFQVTguc2V0KGRhdGEuYXJncy5idWZmLCBhdWRidWZmX3B0cik7CiAgICAJRkZtcGVnTW9kdWxlLl9zdGFydF9hdWRpb19mcmFtZV9lbmNvZGUoZGF0YS5hcmdzLnJpZCwgYXVkYnVmZl9wdHIsIGRhdGEuYXJncy5idWZmLmxlbmd0aCk7CiAgICB9IGVsc2UgaWYgKGRhdGEuY21kID09ICdmaW5pc2hfYmdfZW5jb2RlJykgewogICAgCUZGbXBlZ01vZHVsZS5fZmluaXNoX2JnX2VuY29kZShkYXRhLmFyZ3MucmlkKTsKICAgIH0KfSk7Cg=="
				const blob = b64toBlob(b64, "application/wasm");
				const blobUrl = URL.createObjectURL(blob);
				FFworker = new Worker(blobUrl);
	 			FFworker.postMessage({"cmd":"init"});
	  			FFworker.addEventListener('message',function(event) {
					if (event.data.cmd == "init") {
						_jsFFWorkerFinishedLoading();
					}
	  			});


			}
			 
		}
		
		window.addEventListener('beforeunload', function (e) {
		  e.preventDefault();
		  e.returnValue = '';
		});
		
		function quoteMarkThatDoesntKillEmscripten() {
			return "\"";
		}
		
		function jsChromeVersion() {
		    var raw = navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);

			if (raw) {
				return parseInt(raw[2], 10);
				
			}
			return 0;		
		}

		function jsIsOldChrome() {
		    var raw = navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);
			if (raw) {
				var parsed = parseInt(raw[2], 10);
				if (parsed < 92)
					return 1;
			}
			return 0;
		}
		
		function receiveOpenedFile(file /*buffer,filename*/) {
			(async () => {
				var fnarg  = allocate(intArrayFromString(file.name),  ALLOC_NORMAL);
				if (_jsOpenFileNeedsCopy(fnarg)) {
					let buffer = await file.arrayBuffer();
					FS.writeFile("/dnd-"+file.name,new Uint8Array(buffer));
					const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
					const hashArray = Array.from(new Uint8Array(hashBuffer));
					const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
					var arg1  = allocate(intArrayFromString("/dnd-"+file.name),  ALLOC_NORMAL);
					var arg2  = allocate(intArrayFromString(hashHex),  ALLOC_NORMAL);
					_jsReceiveDragAndDropFile(-1,-1,-1,arg1,arg2);
					_free(arg1);
					_free(arg2);
				} else {
					if (typeof window.openFileHandles === 'undefined') {
						window.openFileHandles = {};
						window.openFiles = {};
					}
					let fid = _jsGetNextFileHandleID();
					window.openFiles[fid] = file;
	                let fsize_lo = file.size & 0x0fffffff;
    	            let fsize_hi = (file.size - fsize_lo) / 0x0fffffff;
					var argname  = allocate(intArrayFromString(file.name),  ALLOC_NORMAL);
					_jsReceiveDragAndDropFile(fid, fsize_lo, fsize_hi, argname, 0);
					_free(argname);
				}
				
				_free(fnarg);
			})();
		}
		
		if ('launchQueue' in window) {
//			console.log('File handling API is supported!');

			launchQueue.setConsumer(launchParams => {
				for (const f of launchParams.files) {
					(async (file) => {
//						console.log('${file.name} received');
						const blob = await file.getFile();
						var buffer = await blob.arrayBuffer();
						receiveOpenedFile(buffer,file.name);
					})(f);
				}
			});
		} else {
//			console.error('File handling API is not supported!');
		}

		
		if (console.loghistory === undefined) {
	
			function submitLogHistory() {
				if (console.errorsent === undefined) {
					console.errorsent = 1;
					setTimeout(() => {
						var s = "";
	
						console.loghistory.forEach((it) => {
							s += it.value + "\n";
						});
//						navigator.sendBeacon(window.beaconURL, s);
						var xhr = new XMLHttpRequest();
						xhr.open("POST", window.beaconURL, true);
						xhr.send(s);

					},500);
				}			
			};

			console.loghistory = [];
			function TS(){
				return (new Date).toLocaleString("sv", { timeZone: 'UTC' }) + "Z"
			}
			window.onerror = function (message, source, line, col, error) {
				console.loghistory.push({
				  type: "exception",
				  timeStamp: TS(),
				  value:  source + ":"+line +" "+message
				});
				if (console.errorsent === undefined) {	
					console.errorsent = 1;
//					navigator.sendBeacon(window.beaconURL, source + ":"+line +" "+message);			
					var xhr = new XMLHttpRequest();
					xhr.open("POST", window.beaconURL, true);
					let errs = "";
					try {
//						console.log("window.onerror");
						console.log(error);
						if (error) {
// 							console.log(error);
// 							console.log(error.stack);
							errs = error + " ::: " +error.stack;
						}
						else
							errs = "-";
					} catch (e) {
						errs = "?";
					}
//					console.log("window.onerror e: "+errs);
					xhr.send(source + ":"+line +":"+col+":"+message+" ; e: "+errs);
				}
				return false;
			}
			window.onunhandledrejection = function (e) {
				console.loghistory.push({
				  type: "promiseRejection",
				  timeStamp: TS(),
				  value: e.reason
				});
				submitLogHistory();
			} 

			function hookLogType(logType) {
				const original = console[logType].bind(console);
				return function(){
				  console.loghistory.push({ 
					type: logType, 
					timeStamp: TS(), 
					value: Array.from(arguments) 
				  });
				  original.apply(console, arguments);
				  if (logType == "error") {
					submitLogHistory();
				  }	
				}
			}

			['error', 'warn', 'debug'].forEach(logType=>{
				console[logType] = hookLogType(logType)
			});
		}       
	
        var canv = document.getElementById('canvas');

        var Module = {
            canvas: canv,
            preRun: [function() {
				FS.mkdir("/LayerAssets");
            }],
		    onRuntimeInitialized: function() {

		    	startFF();

				_jsSetupUIEventHandlers();
				
				
		    }
        };


		canv.style.width = window.innerWidth + "px";
		canv.style.height = window.innerHeight + "px";

		var devicePixelRatio = window.devicePixelRatio || 1;
		canv.width = window.innerWidth * devicePixelRatio;
		canv.height = window.innerHeight * devicePixelRatio;
        
        canv.addEventListener('webglcontextlost', function(e) {
			var xhr = new XMLHttpRequest();
			xhr.open("POST", window.beaconURL, true);
			xhr.send("webglcontextlost");        
			console.log("webglcontextlost");
		    e.preventDefault();
		}, false);
		
        canv.addEventListener('webglcontextrestored', function(e) {
			var xhr = new XMLHttpRequest();
			xhr.open("POST", window.beaconURL, true);
			xhr.send("webglcontextrestored");        
			console.log("webglcontextrestored");
		}, false);
        
	    (async () => {
// 		    let isIframe = window.self !== window.top;
// 	    	console.log("isIframe: ",isIframe);
// 	    	
// 	    	if (isIframe) {
// 		    	console.log("referrer: ",document.location.ancestorOrigins[0]);
// 	    	}
// 	    
	    	let mainScript = "index-02381ede1db7.js";
			if ((typeof SharedArrayBuffer === "undefined") || (window.location.hash == "#nosab")) {
				mainScript = "index-nosab-5010e84dde7a.js";
			}	    
			await loadScript(mainScript);

			gl = canv.getContext('webgl2');				
		
			lastVideoID = 0;
			videos = {};
			videoBlobs = {};
			videoObjectUrls = {};
			audioBuffers = {};

			fileparts = {};
			
		})();
		
		